<!DOCTYPE html>
<html lang="en" aria-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Vitra AI – Dietetics & Nutrition</title>
  <!-- Montserrat + FontAwesome -->
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;700&display=swap" rel="stylesheet">
  <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
  /*──────────────────────────────────────────────────────────────────────────────
    PALE YELLOW THEME & RESET
  ──────────────────────────────────────────────────────────────────────────────*/
  *, *::before, *::after {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }
  html {
    font-family: 'Montserrat', sans-serif;
    font-size: 16px;
    scroll-behavior: smooth;
    --primary: #F7DC6F;          /* Pale Yellow */
    --primary-alt: #D4AC0D;      /* Rich Golden */
    --secondary: #C39BD3;        /* Soft Lavender */
    --accent: rgba(255, 249, 230, 0.9); /* Cream */
    --bg: #FEF9E7;               /* Light Cream */
    --surface: #FFFFFF;          /* White */
    --text: #2C3E50;             /* Dark Slate */
    --muted: #7D6608;            /* Earth Brown */
    --radius: 0.75rem;
    --padding: 1rem;
    --transition: 0.3s ease;
    --sidebar-width: 280px;
    --sidebar-collapsed-width: 80px;
    --header-height: 64px;
    --shadow: 0 4px 16px rgba(0, 0, 0, 0.06);
  }
  html.dark {
    --bg: #2C2C2C;
    --surface: #3A3A3A;
    --text: #ECECEC;
    --muted: #AAA;
  }
  body {
    display: flex;
    min-height: 100vh;
    background: var(--bg);
    color: var(--text);
    overflow-x: hidden;
    transition: background var(--transition), color var(--transition);
  }
  a {
    color: var(--primary);
    text-decoration: none;
    transition: color var(--transition);
  }
  a:hover {
    color: var(--primary-alt);
  }
  img {
    max-width: 100%;
    display: block;
  }
  button, input, textarea, select {
    font-family: inherit;
    transition: var(--transition);
  }
  button {
    cursor: pointer;
    border: none;
    background: none;
  }
  ul, ol {
    list-style: none;
  }

  /*──────────────────────────────────────────────────────────────────────────────
    SIDEBAR
  ──────────────────────────────────────────────────────────────────────────────*/
   aside#sidebar {
   position: fixed;
   top: 0;
   left: 0;
   width: var(--sidebar-width);
   height: 100vh;
   background: var(--surface);
   box-shadow: var(--shadow);
   display: flex;
   flex-direction: column;
   transition: width var(--transition), transform var(--transition);
   z-index: 1000;
   overflow: hidden;
 }
  aside#sidebar.collapsed {
    width: var(--sidebar-collapsed-width);
  }
   aside#sidebar .logo {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 1rem 0.5rem;
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--primary-alt);
  }
  aside#sidebar .logo svg {
    width: 2rem;
    height: 2rem;
    flex-shrink: 0;
  }
  aside#sidebar .logo .logo-text {
    font-size: 1.25rem;
    transition: opacity var(--transition);
  }
  aside#sidebar.collapsed .logo .logo-text {
    opacity: 0;
  }
  aside#sidebar nav {
    margin-top: 2rem;
    flex: 1;
    overflow: hidden;
  }
  aside#sidebar nav a {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem 0.5rem;   
    border-radius: var(--radius);
    color: var(--text);
    font-weight: 500;
    transition: background var(--transition), transform var(--transition);
  }
  aside#sidebar nav a.active i,
  aside#sidebar nav a:hover i {
    color: #fff;  
  }
  aside#sidebar nav a i {
    font-size: 1.2rem;
    width: 1.2rem;
    text-align: center;
    color: var(--primary-alt);
  }
 
  aside#sidebar.collapsed nav a span {
    opacity: 0;
  }
  aside#sidebar nav a:hover,
  aside#sidebar nav a.active {
    background: var(--primary-alt);
    color: #fff;
    transform: translateX(8px);
  }
  aside#sidebar nav a.active {
    font-weight: 700;
  }
 aside#sidebar.collapsed {
    flex: 0 0 var(--sidebar-collapsed-width);
  }
aside#sidebar.collapsed .logo .logo-text,
  aside#sidebar.collapsed nav a span {
    display: none;
  }
  aside#sidebar.collapsed nav a {
    justify-content: center;
  }

 
  #shrinkBtn {
    margin: 1rem auto;
    background: var(--primary);
    color: #fff;
    border-radius: 50%;
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: var(--shadow);
    transition: background var(--transition), transform var(--transition);
  }
  #shrinkBtn:hover {
    background: var(--primary-alt);
    transform: scale(1.1);
  }

  /*──────────────────────────────────────────────────────────────────────────────
    HEADER
  ──────────────────────────────────────────────────────────────────────────────*/
  header {
    position: fixed;
    top: 0;
    left: var(--sidebar-width);
    right: 0;
    height: var(--header-height);
    background: var(--surface);
    box-shadow: var(--shadow);
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 var(--padding);
    z-index: 999;
    transition: left var(--transition), background var(--transition);
  }
  aside#sidebar.collapsed ~ header {
    left: var(--sidebar-collapsed-width);
  }
  header h1 {
    font-size: 1.6rem;
    font-weight: 600;
    color: var(--text);
  }
  header .hamburger,
  header .theme-toggle {
    font-size: 1.5rem;
    color: var(--primary-alt);
    cursor: pointer;
    transition: color var(--transition), transform var(--transition);
  }
  header .hamburger:hover,
  header .theme-toggle:hover {
    color: var(--primary);
    transform: scale(1.1);
  }

  /*──────────────────────────────────────────────────────────────────────────────
    MAIN
  ──────────────────────────────────────────────────────────────────────────────*/
  main {
    flex: 1;
    margin-top: var(--header-height);
    margin-left: var(--sidebar-width);
    padding: var(--padding);
    background: var(--bg);
    transition: margin-left var(--transition);
  }
  aside#sidebar.collapsed ~ main {
    margin-left: var(--sidebar-collapsed-width);
  }

  /*──────────────────────────────────────────────────────────────────────────────
    MODULE BASE STYLES
  ──────────────────────────────────────────────────────────────────────────────*/
  section.module {
    background: var(--surface);
    border-radius: var(--radius);
    padding: var(--padding);
    margin-bottom: 1.5rem;
    box-shadow: var(--shadow);
    transition: transform var(--transition), box-shadow var(--transition);
  }
  section.module:hover {
    transform: translateY(-4px);
    box-shadow: 0 6px 24px rgba(0, 0, 0, 0.1);
  }
  section.module h2 {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 0.75rem;
    font-size: 1.5rem;
    color: var(--primary-alt);
  }
  section.module p.desc {
    font-size: 0.95rem;
    color: var(--muted);
    margin-bottom: 1rem;
  }
  section.module form {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    align-items: flex-end;
  }
  section.module form label {
    font-size: 0.95rem;
    color: var(--text);
    margin-bottom: 0.25rem;
    display: block;
    font-weight: 500;
  }
  section.module form input,
  section.module form select,
  section.module form textarea {
    flex: 1 1 200px;
    padding: 0.75rem;
    border: 1.5px solid rgba(0, 0, 0, 0.1);
    background: var(--bg);
    color: var(--text);
    font-size: 0.95rem;
    border-radius: var(--radius);
    transition: border-color var(--transition), box-shadow var(--transition);
  }
  section.module form input:focus,
  section.module form select:focus,
  section.module form textarea:focus {
    outline: none;
    border-color: var(--primary-alt);
    box-shadow: 0 0 8px var(--primary-alt);
  }
  section.module form button {
    background: var(--primary);
    color: #fff;
    padding: 0.7rem 1.4rem;
    border-radius: var(--radius);
    font-size: 0.95rem;
    font-weight: 600;
    cursor: pointer;
    box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
    transition: background var(--transition), transform var(--transition), box-shadow var(--transition);
  }
  section.module form button:hover:not([disabled]) {
    background: var(--primary-alt);
    transform: scale(1.03);
    box-shadow: 0 5px 14px rgba(0, 0, 0, 0.12);
  }
  section.module form button[disabled] {
    opacity: 0.6;
    cursor: not-allowed;
  }
  .hint {
    width: 100%;
    font-size: 0.85rem;
    color: var(--muted);
  }

  /*──────────────────────────────────────────────────────────────────────────────
    RESPONSE PANELS
  ──────────────────────────────────────────────────────────────────────────────*/
  .response {
    background: var(--accent);
    border-left: 4px solid var(--secondary);
    padding: var(--padding);
    border-radius: var(--radius);
    margin-top: 1rem;
    position: relative;
    box-shadow: var(--shadow);
    transition: background var(--transition);
  }
  .response .close-btn {
    position: absolute;
    top: var(--padding);
    right: var(--padding);
    background: none;
    color: var(--secondary);
    font-size: 1.2rem;
    border: none;
    cursor: pointer;
    transition: color var(--transition), transform var(--transition);
  }
  .response .close-btn:hover {
    color: var(--primary-alt);
    transform: scale(1.1);
  }
  .response .result-content {
    margin-top: 1.5rem; /* space for close button */
    color: var(--text);
    line-height: 1.5;
    margin-bottom: 2rem;
  }
  html.dark .response {
    background: rgba(60, 60, 60, 0.9);
  }
  html.dark .response .result-content {
    color: var(--text);
  }
  .tool-row {
    position: static;
   margin-top: 0.5rem;
    display: flex;
    gap: 0.5rem;
  }
  .tool-row button {
    background: var(--surface);
    border: 1px solid var(--muted);
    border-radius: 50%;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--secondary);
    transition: background var(--transition), color var(--transition), transform var(--transition);
  }
  .tool-row button:hover {
    background: var(--primary-alt);
    color: #fff;
    transform: scale(1.1);
  }

  /*──────────────────────────────────────────────────────────────────────────────
    HERO SECTION
  ──────────────────────────────────────────────────────────────────────────────*/
  #hero {
    background: url('hero-food.jpg') center/cover no-repeat;
    position: relative;
    border-radius: var(--radius);
    overflow: hidden;
    padding: 2rem var(--padding) 4rem;
    box-shadow: var(--shadow);
    color: #fff;
  }
  #hero::before {
    content: "";
    position: absolute;
    inset: 0;
    background: rgba(44, 62, 80, 0.6);
    z-index: 1;
  }
 #hero-chat .chat-controls button {
   background: var(--primary-alt);
    border: 2px solid var(--primary);
    border-radius: 0.5rem;
    padding: 0.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #fff;
    font-size: 1rem;
    transition: background var(--transition), transform var(--transition);
  }
 #hero-chat .chat-controls button:hover {
    background: var(--primary);
    transform: translateY(-2px);
  }
#hero .hero-inner {
  display: flex;
  align-items: center;
  justify-content: space-between;
  position: relative;
  z-index: 2;
  max-width: 1200px;
  margin: 0 auto;
  gap: 2rem;
}
#hero .hero-content {
  flex: 1;
  text-align: left;
}
#hero h1 {
  font-size: 3rem;      /* increased */
  margin-bottom: 1rem;
  color: #fff;
  line-height: 1.1;
}
#hero .hero-subtitle {
  font-size: 1.25rem;
  color: rgba(255, 255, 255, 0.9);
  margin-bottom: 2rem;
}
  
  #hero .hero-actions {
    display: flex;
    justify-content: center;
    gap: 1rem;
    flex-wrap: wrap;
    margin-bottom: 2rem;
  }
  #hero .hero-actions .btn {
    background: var(--secondary);
    color: #fff;
    padding: 0.75rem 1.5rem;
    border-radius: var(--radius);
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    transition: background var(--transition), transform var(--transition), box-shadow var(--transition);
  }
  #hero .hero-actions .btn:hover {
    background: var(--primary-alt);
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
  }
  #hero .hero-tip {
    position: relative;
    z-index: 2;
    background: transparent;
    border-radius: 0;
    padding: 0;
    max-width: 600px;
    margin: 0 auto 2rem;
    box-shadow: none;
  }
  #hero .hero-tip h3 {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 1.3rem;
    color: #fff; 
    margin-bottom: 0.25rem;
    text-shadow: 0 1px 3px rgba(0, 0, 0, 0.7);
  }
  #hero .hero-tip p {
    font-size: 1rem;
    color: #fff; 
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.6);
    margin-bottom: 1rem;
  }
  #hero .hero-image {
  flex: 1;
  display: flex;
  justify-content: flex-end;
}
#hero .hero-image img {
  max-width: 100%;
  border-radius: var(--radius);
  box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
}
  /* Nationality input smaller and at bottom */
  #nat-form {
    position: relative;
    z-index: 2;
    margin-top: 2rem;
    display: flex;
    justify-content: center;
    gap: 0.5rem;
    flex-wrap: wrap;
  }
  #nat-form input {
    width: 200px;
    padding: 0.6rem;
    border: 1.5px solid rgba(0, 0, 0, 0.1);
    border-radius: var(--radius);
    background: var(--bg);
    color: var(--text);
    font-size: 0.95rem;
    transition: border-color var(--transition), box-shadow var(--transition);
  }
  #nat-form button {
    background: var(--primary-alt);
    color: #fff;
    padding: 0.6rem 1.2rem;
    border-radius: var(--radius);
    font-weight: 600;
    transition: background var(--transition), transform var(--transition);
  }
  #nat-form button:hover {
    background: var(--primary);
    transform: translateY(-2px);
  }

  /*──────────────────────────────────────────────────────────────────────────────
    CHATBOT SECTION
  ──────────────────────────────────────────────────────────────────────────────*/
 #hero-chat .chat-controls {
    display: flex;
    justify-content: flex-end;
    gap: 0.5rem;
    margin-bottom: 0.5rem;
    /* do not allow wrapping—always keep both buttons on one line */
    flex-wrap: nowrap;
  }
  #hero-chat .chat-controls button {
    background: var(--surface);
    border: 1px solid var(--muted);
    border-radius: 50%;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--secondary);
    transition: background var(--transition), transform var(--transition);
  }
  #hero-chat .chat-controls button:hover {
    background: var(--primary-alt);
    color: #fff;
    transform: scale(1.1);
  }
 .chat-box {
    background: var(--bg);
    border: 1px solid rgba(0, 0, 0, 0.1);
    border-radius: var(--radius);
    padding: var(--padding);
    min-height: 250px;
    max-height: 450px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    transition: background var(--transition), border-color var(--transition);
  }
  .user-msg,
  .bot-msg {
    max-width: 80%;
    margin: 0.5rem 0;
    padding: 0.8rem 1rem;
    border-radius: 1.2rem;
    position: relative;
    line-height: 1.4;
    transition: background var(--transition), color var(--transition);
  }
  .user-msg {
    background: var(--primary-alt);
    color: #fff;
    align-self: flex-end;
    border-bottom-right-radius: 0.2rem;
  }
  .bot-msg {
    background: var(--accent);
    color: var(--text);
    align-self: flex-start;
    border-bottom-left-radius: 0.2rem;
  }
  html.dark .bot-msg {
    background: var(--surface);
    color: var(--text);
  }
  .timestamp {
    font-size: 0.7rem;
    color: var(--muted);
    position: absolute;
    bottom: -1.2rem;
    right: 0.8rem;
  }
  
   .chat-input-row {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-top: 0.75rem;
  }
  .chat-input-row input {
    flex: 1;
    padding: 0.8rem 1rem;
    border: 1px solid var(--muted);
    border-radius: var(--radius);
    background: var(--bg);
    color: var(--text);
    font-size: 0.95rem;
    transition: border-color var(--transition), box-shadow var(--transition);
  }
  .chat-input-row input:focus {
    outline: none;
    border-color: var(--primary-alt);
    box-shadow: 0 0 8px var(--primary-alt);
  }
  .chat-input-row button {
    background: var(--primary);
    border-radius: 50%;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #fff;
    font-size: 1rem;
    transition: background var(--transition), transform var(--transition);
  }
  .chat-input-row button:hover {
    background: var(--primary-alt);
    transform: scale(1.1);
  }
 #chatHint {
    font-size: 0.9rem;
    color: var(--muted);
    margin-top: 0.5rem;
    display: none;
  }

  /*──────────────────────────────────────────────────────────────────────────────
    “OTHER” INPUT FIELDS
  ──────────────────────────────────────────────────────────────────────────────*/
  .other-input {
    display: none;
    margin-top: 0.5rem;
    padding: 0.75rem;
    border: 1.5px solid rgba(0, 0, 0, 0.1);
    background: var(--bg);
    color: var(--text);
    font-size: 0.95rem;
    border-radius: var(--radius);
    transition: border-color var(--transition), box-shadow var(--transition);
  }
  .other-input:focus {
    outline: none;
    border-color: var(--primary-alt);
    box-shadow: 0 0 8px var(--primary-alt);
  }

  /*──────────────────────────────────────────────────────────────────────────────
    CHARTS & ANALYTICS
  ──────────────────────────────────────────────────────────────────────────────*/
  .charts {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1.25rem;
    margin-top: 1rem;
  }
  .chart-card {
    background: var(--surface);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    overflow: hidden;
    display: flex;
    flex-direction: column;
    transition: box-shadow var(--transition);
    min-height: 300px; 
  }
  .chart-card:hover {
    box-shadow: 0 6px 24px rgba(0, 0, 0, 0.1);
  }
  .chart-card canvas {
    width: 100% !important;
    height: 250px !important;
  }
  .chart-card figcaption {
    padding: 0.5rem 0.75rem;
    background: var(--bg);
    font-size: 0.9rem;
    color: var(--text);
    border-top: 1px solid rgba(0, 0, 0, 0.05);
  }
  .chart-desc {
    padding: 0 0.75rem 0.75rem;
    font-size: 0.85rem;
    color: var(--muted);
  }
  #exportData, .export-chart-btn {
    margin-top: 1rem;
    background: var(--primary-alt);
    color: #fff;
    padding: 0.6rem 1.2rem;
    border-radius: var(--radius);
    font-weight: 600;
    box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
    transition: transform var(--transition), background var(--transition);
  }
  #exportData:hover, .export-chart-btn:hover {
    background: var(--primary);
    transform: translateY(-2px);
  }

  /*──────────────────────────────────────────────────────────────────────────────
    “Meet a Nutrition Expert” SECTION
  ──────────────────────────────────────────────────────────────────────────────*/
  .meet-module {
    background: linear-gradient(135deg, rgba(247, 220, 111, 0.1), rgba(195, 155, 211, 0.1));
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 2rem;
    border-radius: var(--radius);
    margin-bottom: 2rem;
  }
  .meet-content {
    display: flex;
    align-items: center;
    max-width: 900px;
    width: 100%;
    gap: 2rem;
  }
  .meet-icon {
    flex: 0 0 80px;
    height: 80px;
    background: var(--primary-alt);
    color: #fff;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2.5rem;
    box-shadow: var(--shadow);
  }
  .meet-text h2 {
    font-size: 2rem;
    margin-bottom: 0.5rem;
    color: var(--secondary);
    line-height: 1.2;
  }
  .meet-text p {
    font-size: 1rem;
    margin-bottom: 1rem;
    color: var(--text);
    line-height: 1.4;
  }
  .btn-schedule {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    background: linear-gradient(45deg, var(--primary), var(--primary-alt));
    color: #fff;
    padding: 0.75rem 1.5rem;
    border-radius: var(--radius);
    font-weight: 600;
    font-size: 1rem;
    transition: transform var(--transition), box-shadow var(--transition);
  }
  .btn-schedule:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
  }

  /*──────────────────────────────────────────────────────────────────────────────
    PROGRESS CHARTS SECTION
  ──────────────────────────────────────────────────────────────────────────────*/
  #progressCharts {
    margin-top: 2rem;
    background: var(--surface);
    border-radius: var(--radius);
    padding: var(--padding);
    box-shadow: var(--shadow);
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
  }
  #progressCharts h2 {
    grid-column: 1 / -1;
    font-size: 1.5rem;
    color: var(--primary-alt);
    margin-bottom: 1rem;
  }
  #progressCharts canvas {
    background: var(--bg);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    width: 100% !important;
    height: 250px !important;
  }
  #progressCharts .export-chart-btn {
    grid-column: span 1;
    justify-self: center;
  }

  /*──────────────────────────────────────────────────────────────────────────────
    HISTORY MODAL
  ──────────────────────────────────────────────────────────────────────────────*/
  .history-modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 2000;
  }
  .history-modal .history-content {
    background: var(--surface);
    border-radius: var(--radius);
    width: 100%;
    max-width: 600px;
    max-height: 80vh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    box-shadow: var(--shadow);
  }
  .history-modal .history-content h3 {
    padding: 1rem;
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--primary-alt);
    border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    background: var(--surface);
  }
  .history-modal .history-table-wrapper {
    flex: 1;
    overflow-y: auto;
    padding: 0 1rem;
    background: var(--bg);
  }
  .history-modal .history-table-wrapper .history-date {
    text-align: center;
    font-weight: 600;
    color: var(--muted);
    margin: 1rem 0 0.5rem;
  }
  .history-modal .history-row {
    display: grid;
    grid-template-columns: 1fr auto auto;
    gap: 0.5rem;
    align-items: center;
    padding: 0.5rem 0;
    border-bottom: 1px solid rgba(0, 0, 0, 0.05);
  }
  .history-modal .history-row .history-sender {
    font-weight: 500;
    color: var(--text);
  }
  .history-modal .history-row .history-text {
    color: var(--text);
  }
  .history-modal .history-row .del-msg {
    background: none;
    border: none;
    color: var(--muted);
    font-size: 1rem;
    cursor: pointer;
    transition: color var(--transition), transform var(--transition);
  }
  .history-modal .history-row .del-msg:hover {
    color: var(--primary-alt);
    transform: scale(1.1);
  }
  .history-modal .history-actions {
    display: flex;
    justify-content: space-between;
    gap: 0.5rem;
    padding: 0.75rem 1rem;
    background: var(--surface);
    border-top: 1px solid rgba(0, 0, 0, 0.05);
    position: sticky;
    bottom: 0;
  }
  .history-modal .history-actions button {
    flex: 1;
    background: var(--primary-alt);
    color: #fff;
    padding: 0.5rem;
    font-size: 0.9rem;
    font-weight: 500;
    border: none;
    border-radius: var(--radius);
    cursor: pointer;
    transition: background var(--transition), transform var(--transition);
  }
  .history-modal .history-actions button:hover {
    background: var(--primary);
    transform: translateY(-1px);
  }

  /*──────────────────────────────────────────────────────────────────────────────
    FORMS & INPUT STYLING
  ──────────────────────────────────────────────────────────────────────────────*/
  input, textarea, select {
    width: 100%;
    padding: 0.75rem;
    border: 2px solid var(--primary-alt);
    border-radius: var(--radius);
    background: #fff;
    color: var(--text);
    font-size: 1rem;
 transition: border-color .2s, box-shadow .2s, background .2s, color .2s;
  }
  input:focus, textarea:focus, select:focus {
    border-color: var(--secondary);
    box-shadow: 0 0 0 3px rgba(195, 155, 211, 0.2);
    background: var(--accent);
  }
  html.dark input, html.dark textarea, html.dark select {
    background: var(--surface);
    color: var(--text);
    border-color: var(--muted);
  }
  textarea { resize: vertical; }
  button.btn {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1.25rem;
    background: var(--primary-alt);
    color: #000;
    font-weight: 600;
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    transition: background var(--transition), transform var(--transition);
  }
  button.btn:hover {
    background: var(--primary);
    transform: translateY(-2px);
  }
  button.btn-secondary {
    background: var(--secondary);
    color: #fff;
  }
  button.btn-secondary:hover {
    background: var(--primary-alt);
  }

  /*──────────────────────────────────────────────────────────────────────────────
    FIELDSETS & CHECKBOX GROUPS
  ──────────────────────────────────────────────────────────────────────────────*/
  fieldset {
    border: 1px solid var(--muted);
    border-radius: var(--radius);
    padding: 0.75rem;
    margin-bottom: 1rem;
  }
  legend {
    padding: 0 0.5rem;
    font-weight: 600;
    color: var(--secondary);
  }
  .checkbox-group {
   display: grid;
    grid-template-columns: repeat(4, 1fr);  
    gap: 0.75rem;
    align-items: flex-start;
  }
  @media(max-width: 992px) {
   .checkbox-group {
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    }
  }
  .checkbox-group label {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 0.75rem;
    background: var(--accent);
    border: 1px solid var(--muted);
    border-radius: var(--radius);
    cursor: pointer;
  }
  .checkbox-group input[type="checkbox"] {
    width: 1rem;
    height: 1rem;
    accent-color: var(--secondary);
  }
  .checkbox-group input[type="text"].other-input {
    grid-column: 1 / -1;
    margin-top: 0.5rem;
    padding: 0.5rem;
  }
  html.dark .checkbox-group label {
    background: var(--surface);
    border: 1px solid var(--muted);
    color: var(--text);
  }
  html.dark .checkbox-group input[type="checkbox"] {
    background: var(--bg);
    accent-color: var(--secondary);
  }
  /*──────────────────────────────────────────────────────────────────────────────
    SPINNER ICON & TOAST
  ──────────────────────────────────────────────────────────────────────────────*/
  .spinner {
    display: inline-block;
    width: 1em;
    height: 1em;
    border: 2px solid var(--primary-alt);
    border-top-color: transparent;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    vertical-align: middle;
    margin-left: 0.25em;
  }
  @keyframes spin {
    to { transform: rotate(360deg); }
  }
  .spin-text {
    text-align: center;
    margin-top: 0.5rem;
    font-style: italic;
    color: var(--muted);
  }
  .toast {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%) translateY(100%);
    background: var(--primary-alt);
    color: #fff;
    padding: 0.75rem 1.5rem;
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    opacity: 0;
    transition: transform 0.3s, opacity 0.3s;
    z-index: 2000;
  }
  .toast.visible {
    transform: translateX(-50%) translateY(0);
    opacity: 1;
  }

    /*──────────────────────────────────────────────────────────────────────────────
    RESPONSE PANELS
  ──────────────────────────────────────────────────────────────────────────────*/
  .response {
    background: var(--accent);
    border-left: 4px solid var(--secondary);
    padding: var(--padding);
    border-radius: var(--radius);
    margin-top: 1rem;
    position: relative;
    box-shadow: var(--shadow);
    transition: background var(--transition);
  }
  .response.loading .close-btn {
    display: none;
  }
  .response .close-btn {
    position: absolute;
    top: var(--padding);
    right: var(--padding);
    background: none;
    color: var(--secondary);
    font-size: 1.2rem;
    border: none;
    cursor: pointer;
    transition: color var(--transition), transform var(--transition);
  }
  .response .close-btn:hover {
    color: var(--primary-alt);
    transform: scale(1.1);
  }
  .response .result-content {
    margin-top: 1.5rem; /* space for close button */
    color: var(--text);
    line-height: 1.5;
    margin-bottom: 2rem;
  }

  /*──────────────────────────────────────────────────────────────────────────────
    STICKERS (DECORATIVE ICONS)
  ──────────────────────────────────────────────────────────────────────────────*/
  .hero-bg-icon {
    position: absolute;
    font-size: 6rem; /* bigger icons */
    opacity: 0.14;
    transition: transform 0.3s, opacity 0.3s;
    color: var(--primary-alt);
  }
  .sticker:hover {
    opacity: 0.3;
    transform: scale(1.1) rotate(0deg);
  }
 #risk-form {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
   gap: 1rem;
  }
  @media(max-width: 768px) {
  #risk-form {
     grid-template-columns: 1fr;
   }
 }
  /*──────────────────────────────────────────────────────────────────────────────
    MEET A NUTRITION EXPERT SECTION
  ──────────────────────────────────────────────────────────────────────────────*/
  .meet-module {
    background: linear-gradient(135deg, rgba(247, 220, 111, 0.1), rgba(195, 155, 211, 0.1));
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 2rem;
    border-radius: var(--radius);
    margin-bottom: 2rem;
  }
  .meet-content {
    display: flex;
    align-items: center;
    max-width: 900px;
    width: 100%;
    gap: 2rem;
  }
  .meet-icon {
    flex: 0 0 80px;
    height: 80px;
    background: var(--primary-alt);
    color: #fff;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2.5rem;
    box-shadow: var(--shadow);
  }
  .meet-text h2 {
    font-size: 2rem;
    margin-bottom: 0.5rem;
    color: var(--secondary);
    line-height: 1.2;
  }
  .meet-text p {
    font-size: 1rem;
    margin-bottom: 1rem;
    color: var(--text);
    line-height: 1.4;
  }
  .btn-schedule {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    background: linear-gradient(45deg, var(--primary), var(--primary-alt));
    color: #fff;
    padding: 0.75rem 1.5rem;
    border-radius: var(--radius);
    font-weight: 600;
    font-size: 1rem;
    transition: transform var(--transition), box-shadow var(--transition);
  }
  .btn-schedule:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
  }

  /*──────────────────────────────────────────────────────────────────────────────
    RESPONSIVE ADJUSTMENTS
  ──────────────────────────────────────────────────────────────────────────────*/
  @media(max-width: 1024px) {
    header {
      left: 0 !important;
    }
    aside#sidebar {
      transform: translateX(-100%);
      transition: transform var(--transition);
    }
    aside#sidebar.open {
      transform: translateX(0);
    }
    main {
      margin-left: 0 !important;
    }
    #hero h2 {
      font-size: 2rem;
    }
    #hero p.desc {
      font-size: 0.95rem;
    }
    #hero .hero-tip {
      width: 90%;
    }
    .meet-content {
      flex-direction: column;
      gap: 1rem;
    }
    .meet-text h2 {
      font-size: 1.75rem;
      text-align: center;
    }
    .meet-text p {
      text-align: center;
    }
    #progressCharts {
      grid-template-columns: 1fr !important;
    }
  }
  @media(max-width: 768px) {
    #shrinkBtn {
      margin: 0.75rem auto;
    }
    header h1 {
      font-size: 1.2rem;
    }
    .chat-input, .chat-controls {
      flex-direction: column;
    }
    .chat-controls button, .chat-input button {
      width: 100%;
      margin-top: 0.5rem;
    }
    .chart-card canvas {
      height: 200px !important;
    }
  }
  @media(max-width: 640px) {
    .meet-content {
      flex-direction: column;
      text-align: center;
    }
    .meet-icon {
      margin: 0 auto;
    }
    #hero {
      padding: 1.5rem var(--padding) 3rem;
    }
    #hero h2 {
      font-size: 1.8rem;
    }
    #hero p.desc {
      font-size: 0.9rem;
    }
    #hero .hero-actions .btn {
      width: 100%;
      justify-content: center;
    }
    #hero .hero-tip {
      width: 100%;
      padding: 0.75rem;
    }
  }
  @media(max-width: 480px) {
    header h1 {
      font-size: 1rem;
    }
    aside#sidebar.collapsed .brand i {
      font-size: 1.5rem;
    }
    #hero .hero-actions {
      flex-direction: column;
    }
    #hero .hero-actions .btn {
      font-size: 0.9rem;
      padding: 0.6rem 1rem;
    }
    .meet-text h2 {
      font-size: 1.5rem;
    }
  }
</style>



</head>


<body>
  <!-- SIDEBAR -->
  <aside id="sidebar">
   <div class="logo">
      <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg" fill="var(--primary)">
        <polygon points="10,10 25,90 50,40 75,90 90,10 65,10 50,70 35,10"/>
      </svg>
      <span class="logo-text">Vitra AI</span>
    </div>
    <nav role="navigation">
      <a href="herbal.html" id="link-herbal">
        <i class="fas fa-seedling"></i>
        <span>Herbal Medicine</span>
      </a>
      <a href="psychology.html" id="link-psych">
        <i class="fas fa-brain"></i>
        <span>Psychology &amp; Mental Health</span>
      </a>
      <a href="dietetics.html" id="link-diet" class="active">
        <i class="fas fa-utensils"></i>
        <span>Dietetics</span>
      </a>
      <a href="epharmacy.html" id="link-epharm">
        <i class="fas fa-prescription-bottle-alt"></i>
        <span>E-Pharmacy</span>
      </a>
      <a href="consult.html" id="link-consult">
        <i class="fas fa-calendar-check"></i>
        <span>Consultation Booking</span>
      </a>
    </nav>
    <button id="shrinkBtn" aria-label="Toggle sidebar">
      <i class="fas fa-angle-double-left"></i>
    </button>
  </aside>

  <!-- HEADER -->
  <header>
    <div style="display:flex; align-items:center; gap:1rem;">
      <i id="hamburger" class="fas fa-bars hamburger" aria-label="Toggle navigation"></i>
      <h1>Dietetics &amp; Nutrition Hub</h1>
    </div>
    <div>
      <i id="themeToggle" class="fas fa-moon theme-toggle" aria-label="Toggle theme"></i>
    </div>
  </header>

  <!-- MAIN CONTENT -->
  <main role="main">
    <!-- HERO SECTION -->
    <section id="hero" class="module hero-module">
      <div class="hero-inner">
        <div class="hero-content">
          <h1><i class="fas fa-utensils"></i> Nourish Your Wellness</h1>
          <p class="hero-subtitle">
            Discover AI-powered meal planning, nutrient insights, recipe inspiration, and expert guidance—all in one place.
          </p>
          <div class="hero-actions">
            <!-- Today's Nutrition Tip (static placeholder; refreshed via script) -->
            <a href="#hero-tip" class="btn-primary">
              <i class="fas fa-lightbulb"></i> Today's Nutrition Tip
            </a>
            <!-- Nationality input (must be filled before using modules) -->
            <a href="#hero-nat" class="btn-tertiary">
              <i class="fas fa-globe"></i> Set Nationality
            </a>
          </div>
        </div>
        <div class="hero-image">
          <!-- Hero image for Dietetics -->
          <img src="diet.jpg" alt="Assortment of healthy foods and utensils">
        </div>
      </div>
      <!-- SUBTLE BACKGROUND ICONS (foody style) -->
      <i class="fas fa-apple-alt hero-bg-icon" style="top: 10%; left: 10%;"></i>
    <i class="fas fa-carrot hero-bg-icon" style="top: 12%; right: 15%;"></i>
    <i class="fas fa-lemon hero-bg-icon" style="bottom: 15%; left: 12%;"></i>
    <i class="fas fa-fish hero-bg-icon" style="bottom: 12%; right: 18%;"></i>
    <i class="fas fa-bread-slice hero-bg-icon" style="top: 50%; left: 40%;"></i>
    </section>

    <!-- 1. User Nationality (required) -->
    <section id="hero-nat" class="module">
      <h2><i class="fas fa-globe"></i> Set Your Nationality</h2>
      <p class="desc">
        Please enter your nationality so that all AI modules tailor recommendations (e.g., regional foods, pricing).
      </p>
      <form id="nat-form">
        <div class="field">
          <label for="nationality">Nationality:</label>
          <input id="nationality" name="nationality" type="text" placeholder="e.g. Ghanaian" required/>
        </div>
        <button type="submit" class="btn-primary">Save Nationality</button>
      </form>
      
    </section>

    <!-- 2. Nutrition Chatbot -->
    <section id="hero-chat" class="module">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
        <h2><i class="fas fa-comments"></i> Nutrition Chatbot</h2>
        <div class="chat-controls">
          <button id="viewHistory" title="View History"><i class="fas fa-history"></i></button>
          <button id="clearChat" title="Clear Chat"><i class="fas fa-trash-alt"></i></button>
        </div>
      </div>
      <div id="chatBox" class="chat-box" role="log" aria-live="polite"></div>
      <div class="chat-input-row">
        <input id="chatInput" placeholder="Ask about diet, meals, or nutrients…" aria-label="Type your question" required/>
        <button id="sendChat" aria-label="Send message"><i class="fas fa-paper-plane"></i></button>
      </div>
    </section>

    <!-- 3. Meal Plan Generator -->
    <section id="meal-planner" class="module">
      <h2><i class="fas fa-calendar-alt"></i> Meal Plan Generator</h2>
      <p class="desc">
        Create a 7-day meal plan fitting your calories, dietary style, and restrictions.
      </p>
      <form id="planner-form">
        <div class="field">
          <label for="calories">Daily Calories:</label>
          <input type="number" id="calories" min="800" max="4000" value="2000" required/>
        </div>
        <div class="field">
          <label for="dietType">Diet Type:</label>
          <select id="dietType">
            <option>Balanced</option>
            <option>Low-Carb</option>
            <option>Vegan</option>
            <option>Ketogenic</option>
            <option>Mediterranean</option>
            <option>Plant-Based</option>
            <option value="Other">Other</option>
          </select>
          <input class="other-input" placeholder="Specify diet…" style="display:none;"/>
        </div>
        <div class="field">
          <label for="allergyList">Allergies &amp; Intolerances:</label>
          <select id="allergyList" multiple>
            <option>Gluten</option>
            <option>Dairy</option>
            <option>Nuts</option>
            <option>Shellfish</option>
            <option>Soy</option>
            <option>Eggs</option>
            <option>Sesame</option>
            <option>Other</option>
          </select>
          <input class="other-input" placeholder="Specify others…" style="display:none;"/>
        </div>
        <div class="field">
          <label for="budget">Budget:</label>
          <select id="budget">
            <option>Low</option>
            <option>Medium</option>
            <option>High</option>
          </select>
        </div>
 <button type="button" id="genPlan" class="btn-primary"><i class="fas fa-utensils"></i> Generate Plan</button>
      </form>
      <div id="planResult" class="response" hidden>
        <button class="close-btn" aria-label="Close result">×</button>
        <div class="result-content"></div>
       
      </div>
    </section>

    <!-- 4. Nutrient Analyzer -->
    <section id="nutri-analyzer" class="module">
      <h2><i class="fas fa-vial"></i> Nutrient Analyzer</h2>
      <p class="desc">
        Get a full macro and micronutrient breakdown of any recipe or meal log.
      </p>
      <form id="nutri-form">
        <div class="field">
          <label for="foodLog">Ingredients / Food Log:</label>
          <textarea id="foodLog" rows="4" placeholder="e.g. 200g rice, 1 egg, spinach…" required></textarea>
        </div>
        <div class="field">
          <label for="unitSelect">Portion Size Units:</label>
          <select id="unitSelect">
            <option>grams</option>
            <option>pieces</option>
            <option>cups</option>
            <option>tablespoons</option>
            <option>servings</option>
          </select>
        </div>
    <button type="button" id="analyzeNutri" class="btn-primary"><i class="fas fa-chart-bar"></i> Analyze Nutrition</button>
      </form>
      <div id="nutriResult" class="response" hidden>
        <button class="close-btn" aria-label="Close result">×</button>
        <div class="result-content"></div>
             </div>
    </section>

    <!-- 5. Recipe Recommender -->
    <section id="recipe-rec" class="module">
      <h2><i class="fas fa-book-open"></i> Recipe Recommender</h2>
      <p class="desc">
        Transform your pantry into delicious meals—globally inspired and easy to cook.
      </p>
      <form id="recipe-form">
        <div class="field">
          <label for="pantry">Pantry Items:</label>
          <input id="pantry" type="text" placeholder="e.g. Rice, Beans, Plantain" required/>
        </div>
        <div class="field">
          <label for="cuisineType">Cuisine Style:</label>
          <select id="cuisineType">
            <option>West African</option>
            <option>Italian</option>
            <option>Asian Fusion</option>
            <option>Mexican</option>
            <option>Middle Eastern</option>
            <option value="Other">Other</option>
          </select>
          <input class="other-input" placeholder="Specify cuisine…" style="display:none;"/>
        </div>
        <div class="field">
          <label for="recipeDifficulty">Difficulty:</label>
          <select id="recipeDifficulty">
            <option>Easy</option>
            <option>Medium</option>
            <option>Advanced</option>
          </select>
        </div>
        <div class="field">
          <label for="maxTime">Max Prep Time:</label>
          <input type="number" id="maxTime" min="5" max="180" value="30"/> minutes
        </div>
    <button type="button" id="getRecipes" class="btn-primary"><i class="fas fa-hamburger"></i> Get Recipes</button>
      </form>
      <div id="recipeResult" class="response" hidden>
        <button class="close-btn" aria-label="Close result">×</button>
        <div class="result-content"></div>
             </div>
    </section>

    <!-- 6. Deficiency Risk Scanner -->
    <section id="def-risk" class="module">
      <h2><i class="fas fa-exclamation-triangle"></i> Deficiency Risk Scanner</h2>
      <p class="desc">
        Identify potential nutrient shortfalls based on your symptoms and diet.
      </p>
      <form id="def-form">
        <div class="field">
          <label>Select Symptoms (up to 5):</label>
          <div class="checkbox-group">
            <label><input type="checkbox" name="symptom" value="Fatigue"/> Fatigue</label>
            <label><input type="checkbox" name="symptom" value="Hair Loss"/> Hair Loss</label>
            <label><input type="checkbox" name="symptom" value="Muscle Cramps"/> Muscle Cramps</label>
            <label><input type="checkbox" name="symptom" value="Pale Skin"/> Pale Skin</label>
            <label><input type="checkbox" name="symptom" value="Bleeding Gums"/> Bleeding Gums</label>
            <label><input type="checkbox" name="symptom" value="Bone Pain"/> Bone Pain</label>
            <label><input type="checkbox" name="symptom" value="Bruising"/> Bruising</label>
            <label>
              <input type="checkbox" name="symptom" value="Other"/> Other
              <input type="text" id="otherSymptom" placeholder="Specify…" style="display:none; margin-left:.5rem;"/>
            </label>
          </div>
        </div>
        <div class="field">
          <label for="dietOverview">Brief Diet Overview:</label>
          <textarea id="dietOverview" rows="3" placeholder="e.g. Mostly rice, occasional veggies…" required></textarea>
        </div>
    <button type="button" id="scanDef" class="btn-primary"><i class="fas fa-stethoscope"></i> Scan Deficiency</button>
      </form>
      <div id="defResult" class="response" hidden>
        <button class="close-btn" aria-label="Close result">×</button>
        <div class="result-content"></div>
             </div>
    </section>

    <!-- 7. Metabolomic Risk Radar -->
    <section id="risk-radar" class="module">
      <h2><i class="fas fa-chart-pie"></i> Metabolomic Risk Radar</h2>
      <p class="desc">
        Track biomarkers (e.g., glucose, lipids) over time. Generate an interactive radar chart and predictive health alerts.
      </p>
      <form id="risk-form">
        <div class="field">
          <label>Date Range:</label>
          <input type="date" id="riskFrom" required/> – <input type="date" id="riskTo" required/>
        </div>
        <div class="field">
          <label><input type="checkbox" id="syncBiomarkers"/> Enable Continuous Biomarker Sync</label>
        </div>
        <div class="field">
          <label for="biomarkers">Biomarkers (comma-sep):</label>
          <input id="biomarkers" type="text" placeholder="e.g. glucose, LDL…" required/>
        </div>
        <div class="field">
          <label for="conditions">Conditions:</label>
          <input id="conditions" type="text" placeholder="e.g. prediabetes…" required/>
        </div>
        <div class="field">
          <label for="context">Context:</label>
          <input id="context" type="text" placeholder="e.g. routine check…" required/>
        </div>
    <button type="button" id="runRisk" class="btn-primary"><i class="fas fa-biohazard"></i> Run Radar</button>
      </form>
      <div id="riskResult" class="response" hidden>
        <button class="close-btn" aria-label="Close result">×</button>
        <div class="result-content"></div>
        <!-- Radar chart will be injected here by script -->
      </div>
    </section>

    <!-- 8. Fitness Nutrition Coach -->
    <section id="fitness-coach" class="module">
      <h2><i class="fas fa-dumbbell"></i> Fitness Nutrition Coach</h2>
      <p class="desc">
        Tailor your macros, pre/post-workout blends, and recovery support.
      </p>
      <form id="fitness-form">
        <fieldset>
          <legend>1. Performance Profiling</legend>
          <div class="field">
            <label for="fitGoal">Workout Goal:</label>
            <select id="fitGoal" required>
              <option>Endurance</option>
              <option>Strength</option>
              <option>Hybrid</option>
              <option>Weight Loss</option>
              <option>General Health</option>
              <option value="Other">Other</option>
            </select>
            <input class="other-input" placeholder="Specify goal…" style="display:none;"/>
          </div>
          <div class="field">
            <label for="fitFreq">Weekly Workouts:</label>
            <select id="fitFreq">
              <option>1–2</option>
              <option>3–4</option>
              <option>5–7</option>
            </select>
          </div>
        </fieldset>
        <fieldset>
          <legend>2. Pre/Post-Workout Micro-Blends</legend>
          <div class="field">
            <label for="blendIngredients">Available Ingredients:</label>
            <select id="blendIngredients" multiple>
              <option>Pea Protein</option>
              <option>Beetroot Powder</option>
              <option>Taurine</option>
              <option>Banana</option>
              <option>Oats</option>
              <option>Other</option>
            </select>
            <input class="other-input" placeholder="Add ingredient…" style="display:none;"/>
          </div>
        </fieldset>
        <fieldset>
          <legend>3. Carb-Timing Calendar</legend>
          <div class="field">
            <label for="carbDate">Start Date:</label>
            <input type="date" id="carbDate" required/>
          </div>
          <div class="field">
            <label for="intensity">Intensity Level:</label>
            <select id="intensity">
              <option>Low</option>
              <option>Moderate</option>
              <option>High</option>
            </select>
          </div>
        </fieldset>
        <fieldset>
          <legend>4. Recovery &amp; Inflammation</legend>
          <div class="field">
            <label for="crpLevel">Track CRP &amp; CK Levels (mg/L):</label>
            <input type="number" id="crpLevel" placeholder="CRP"/>
          </div>
          <div class="field">
            <label for="nutraPref">Nutraceutical Preference:</label>
            <select id="nutraPref">
              <option>Curcumin</option>
              <option>Omega-3</option>
              <option>Turmeric</option>
              <option>Ginger</option>
              <option>Other</option>
            </select>
            <input class="other-input" placeholder="Specify…" style="display:none;"/>
          </div>
        </fieldset>
    <button type="button" id="runFitness" class="btn-primary"><i class="fas fa-running"></i> Generate Plan</button>
      </form>
      <div id="fitnessResult" class="response" hidden>
        <button class="close-btn" aria-label="Close result">×</button>
        <div class="result-content"></div>
             </div>
    </section>

    <!-- 9. Pharma-Integrated Nutrient Suite -->
    <section id="pharma-suite" class="module">
      <h2><i class="fas fa-pills"></i> Pharma-Integrated Nutrient &amp; Medication Suite</h2>
      <p class="desc">
        Drug–nutrient interactions, compounding suggestions, reminders &amp; analytics—all in one.
      </p>
      <form id="pharma-form">
        <fieldset>
          <legend>1. Interaction Engine</legend>
          <div class="field">
            <label for="medList">Medications (comma-sep):</label>
            <input id="medList" type="text" placeholder="e.g. Warfarin, Metformin" required/>
          </div>
          <div class="field">
            <label for="foodList">Food Items (comma-sep):</label>
            <input id="foodList" type="text" placeholder="e.g. Grapefruit, Spinach" required/>
          </div>
        </fieldset>
        <fieldset>
          <legend>2. Custom Compounding</legend>
          <div class="field">
            <label for="compoundGoal">Desired Outcome:</label>
            <select id="compoundGoal">
              <option>Increased Absorption</option>
              <option>Anti-inflammatory</option>
              <option>Energy Boost</option>
              <option>Other</option>
            </select>
            <input class="other-input" placeholder="Specify…" style="display:none;"/>
          </div>
        </fieldset>
        <fieldset>
          <legend>3. Adherence &amp; Reminder Hub</legend>
          <div class="field">
            <label for="doseFreq">Dosage Frequency:</label>
            <select id="doseFreq">
              <option>Once daily</option>
              <option>Twice daily</option>
              <option>With meals</option>
              <option>Other</option>
            </select>
          </div>
          <div class="field">
            <label for="scheduleNotes">Custom Schedule Notes:</label>
            <textarea id="scheduleNotes" rows="2" placeholder="e.g. take with water, avoid night…" ></textarea>
          </div>
        </fieldset>
        <fieldset>
          <legend>4. Outcome Analytics</legend>
          <div class="field">
            <label for="cohortSelect">Compare Cohort:</label>
            <select id="cohortSelect">
              <option>Diet-only</option>
              <option>Diet+Supplements</option>
              <option>Diet+Meds</option>
              <option>Other</option>
            </select>
            <input class="other-input" placeholder="Specify…" style="display:none;"/>
          </div>
        </fieldset>
   <button type="button" id="runPharma" class="btn-primary"><i class="fas fa-flask"></i> Run Suite</button>
      </form>
      <div id="pharmaResult" class="response" hidden>
        <button class="close-btn" aria-label="Close result">×</button>
        <div class="result-content"></div>
            </div>
    </section>

    <!-- 10. Symptom-to-Treatment Advisor -->
    <section id="symptom-advisor" class="module">
      <h2><i class="fas fa-user-md"></i> Symptom-to-Treatment Advisor</h2>
      <p class="desc">
        Describe symptoms and receive drug suggestions plus Ghanaian food recommendations.
      </p>
      <form id="symptom-form">
        <div class="field">
          <label for="sympAge">Your Age:</label>
          <input id="sympAge" type="number" min="1" max="120" required/>
        </div>
        <div class="field">
          <label for="sympDesc">Describe Symptoms:</label>
          <textarea id="sympDesc" rows="4" placeholder="e.g. headache, fever, cough…" required></textarea>
        </div>
        <div class="field">
          <label for="foodPref">Food Preferences (comma-sep):</label>
          <input id="foodPref" type="text" placeholder="e.g. Jollof rice, Pizza, Burger"/>
        </div>
    <button type="button" id="runSymptom" class="btn-primary"><i class="fas fa-stethoscope"></i> Get Advice</button>
      </form>
      <div id="symptomResult" class="response" hidden>
        <button class="close-btn" aria-label="Close result">×</button>
        <div class="result-content"></div>
             </div>
    </section>

    <!-- 11. Progress Charts -->
    <section id="progress-charts" class="module">
      <h2><i class="fas fa-chart-line"></i> Progress Charts</h2>
      <div class="charts">
        <figure class="chart-card">
          <canvas id="calorieChart"></canvas>
          <figcaption><strong>Weekly Calorie Intake:</strong> Track your daily calorie consumption.</figcaption>
          <p class="chart-desc">This line chart shows your calories in for the last 7 days.</p>
        </figure>
        <figure class="chart-card">
          <canvas id="macroChart"></canvas>
          <figcaption><strong>Macro Distribution:</strong> Current macro breakdown (%) of your diet.</figcaption>
          <p class="chart-desc">This pie chart displays the proportion of Carbs, Protein, and Fat.</p>
        </figure>
      </div>
      <button id="exportData" class="btn-primary">Export Data CSV</button>
    </section>

    <!-- 12. Meet a Dietetics Health Expert -->
    <section id="meet-professional" class="module meet-module">
      <div class="meet-content">
        <div class="meet-icon">
          <i class="fas fa-user-md"></i>
        </div>
        <div class="meet-text">
          <h2>Meet a<br>Dietetics Health Expert</h2>
          <p>
            Get one-on-one guidance from our licensed dietitians. Discover personalized meal plans, tailored nutrition advice, and ongoing support.
          </p>
          <a href="consult.html" class="btn-schedule">
            <i class="fas fa-calendar-check"></i>
            Schedule Consultation
          </a>
        </div>
      </div>
    </section>

    <!-- FOOTER -->
    <footer>
      <p>&copy; 2025 Vitra AI. <a href="#privacy">Privacy Policy</a> | <a href="#terms">Terms &amp; Conditions</a></p>
    </footer>
  </main>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  //──────────────────────────────────────────────────────────────────────────────
  // THEME PERSISTENCE & TOGGLE
  //──────────────────────────────────────────────────────────────────────────────
  (function() {
    const savedTheme = localStorage.getItem("diet-theme");
    if (savedTheme === "dark") {
      document.documentElement.classList.add("dark");
      document.documentElement.setAttribute("aria-theme", "dark");
      const icon = document.getElementById("themeToggle");
      if (icon) icon.classList.replace("fa-moon", "fa-sun");
    }
  })();
  const themeToggle = document.getElementById("themeToggle");
  themeToggle.addEventListener("click", () => {
    const htmlEl = document.documentElement;
    const isDark = htmlEl.classList.toggle("dark");
    themeToggle.classList.toggle("fa-sun", isDark);
    themeToggle.classList.toggle("fa-moon", !isDark);
    htmlEl.setAttribute("aria-theme", isDark ? "dark" : "light");
    localStorage.setItem("diet-theme", isDark ? "dark" : "light");
  });

  //──────────────────────────────────────────────────────────────────────────────
  // SIDEBAR COLLAPSE & HAMBURGER (MOBILE)
  //──────────────────────────────────────────────────────────────────────────────
  const sidebar = document.getElementById("sidebar");
  const shrinkBtn = document.getElementById("shrinkBtn");
  const hamburger = document.getElementById("hamburger");
  const header = document.querySelector("header");
  // Persist sidebar collapsed state
  if (localStorage.getItem("sidebar-collapsed") === "true") {
    sidebar.classList.add("collapsed");
    shrinkBtn.querySelector("i").classList.replace("fa-angle-double-left", "fa-angle-double-right");
    header.classList.add("sidebar-collapsed");
  }
  shrinkBtn.addEventListener("click", () => {
    sidebar.classList.toggle("collapsed");
    const icon = shrinkBtn.querySelector("i");
    icon.classList.toggle("fa-angle-double-left");
    icon.classList.toggle("fa-angle-double-right");
    header.classList.toggle("sidebar-collapsed");
    localStorage.setItem("sidebar-collapsed", sidebar.classList.contains("collapsed"));
  });
  // Hamburger for mobile
  function updateHamburgerVisibility() {
    hamburger.style.display = window.matchMedia("(max-width: 1024px)").matches ? "block" : "none";
  }
  window.matchMedia("(max-width: 1024px)").addListener(updateHamburgerVisibility);
  updateHamburgerVisibility();
  hamburger.addEventListener("click", e => {
    e.stopPropagation();
    sidebar.classList.toggle("open");
  });
  document.addEventListener("click", e => {
    if (!sidebar.classList.contains("open")) return;
    if (sidebar.contains(e.target) || hamburger.contains(e.target)) return;
    sidebar.classList.remove("open");
  });

  //──────────────────────────────────────────────────────────────────────────────
  // NAVLINK HIGHLIGHTING
  //──────────────────────────────────────────────────────────────────────────────
  document.querySelectorAll('aside#sidebar nav a').forEach(link => {
    const linkHref = link.getAttribute("href").split("/").pop();
    const pageNow = window.location.pathname.split("/").pop();
    if (linkHref === pageNow) link.classList.add("active");
    else link.classList.remove("active");
  });

  //──────────────────────────────────────────────────────────────────────────────
  // TOAST FUNCTION
  //──────────────────────────────────────────────────────────────────────────────
  function showToast(message) {
    const toast = document.createElement("div");
    toast.className = "toast";
    toast.textContent = message;
    document.body.append(toast);
    requestAnimationFrame(() => toast.classList.add("visible"));
    setTimeout(() => toast.classList.remove("visible"), 1800);
    setTimeout(() => toast.remove(), 2200);
  }

  //──────────────────────────────────────────────────────────────────────────────
  // TODAY'S NUTRITION TIP (STATIC RANDOMIZED)
  //──────────────────────────────────────────────────────────────────────────────
  const nutritionTips = [
    "Add a handful of leafy greens to every meal for extra fiber and vitamins.",
    "Start your day with a high‐protein breakfast to stay fuller longer.",
    "Swap sugary drinks for infused water with fresh fruits and herbs.",
    "Choose whole grains instead of refined grains.",
    "Include a colorful variety of vegetables on your plate each day.",
    "Snack on nuts and seeds for healthy fats and sustained energy.",
    "Rotate your proteins: try beans, lentils, meat, and fish across the week.",
    "Cook with olive oil instead of butter to boost heart‐healthy monounsaturated fats.",
    "Portion your meals: use a smaller plate to help control serving sizes.",
    "Stay hydrated—aim for at least 8 cups of water daily."
  ];
  function displayRandomTip() {
    const existing = document.getElementById("heroTip");
    if (existing) existing.remove();
    const tipArea = document.createElement("div");
    tipArea.id = "heroTip";
    tipArea.className = "hero-tip";
    const idx = Math.floor(Math.random() * nutritionTips.length);
    tipArea.innerHTML = `
      <h3><i class="fas fa-lightbulb"></i> Today’s Nutrition Tip</h3>
      <p>${nutritionTips[idx]}</p>
    `;
    document.querySelector("#hero .hero-actions").insertAdjacentElement("afterend", tipArea);
 }
  displayRandomTip();

  //──────────────────────────────────────────────────────────────────────────────
  // NATIONALITY FORM HANDLER
  //──────────────────────────────────────────────────────────────────────────────
  let userNationality = localStorage.getItem("userNationality") || "";
  const natInput = document.getElementById("nationality");
  if (userNationality && natInput) natInput.value = userNationality;
  const natForm = document.getElementById("nat-form");
  natForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const val = natInput.value.trim();
     if (!val) return showToast("Please enter your nationality.");
    userNationality = val;
    localStorage.setItem("userNationality", val);
    showToast(`Nationality set to ${val}!`);
  });
  

  //──────────────────────────────────────────────────────────────────────────────
  // “OTHER” INPUT REVEAL FOR SELECTS
  //──────────────────────────────────────────────────────────────────────────────
  document.querySelectorAll("select").forEach(sel => {
    sel.addEventListener("change", () => {
      const otherField = sel.parentElement.querySelector(".other-input");
      if (!otherField) return;
      if (sel.value === "Other") {
        otherField.style.display = "block";
        otherField.required = true;
      } else {
        otherField.style.display = "none";
        otherField.required = false;
      }
    });
  });

  //──────────────────────────────────────────────────────────────────────────────
  // CHATBOT: NUTRITION ASSISTANT (SIMILAR TO herbal.html)
  //──────────────────────────────────────────────────────────────────────────────
  (function() {
    const chatBox = document.getElementById("chatBox");
    const chatInput = document.getElementById("chatInput");
    const sendChatBtn = document.getElementById("sendChat");
    const viewHistoryBtn = document.getElementById("viewHistory");
    const clearChatBtn = document.getElementById("clearChat");
    let lastDateHeader = null;

    // Load persisted chat history
    let chatHistory = JSON.parse(localStorage.getItem("dietChatHistory") || "[]");
    function formatDateSeparator(date) {
      const today = new Date();
      const diffDays = Math.floor((today.setHours(0, 0, 0, 0) - date.setHours(0, 0, 0, 0)) / 86400000);
      if (diffDays === 0) return "Today";
      if (diffDays === 1) return "Yesterday";
      return date.toLocaleDateString();
    }
    function addMessage(who, text, timestamp = new Date()) {
      const msgDate = timestamp instanceof Date ? timestamp : new Date(timestamp);
      const msgDay = msgDate.toDateString();
      if (msgDay !== lastDateHeader) {
        const sep = document.createElement("div");
        sep.className = "chat-date-separator";
        sep.textContent = formatDateSeparator(msgDate);
        chatBox.append(sep);
        lastDateHeader = msgDay;
      }
      const msgDiv = document.createElement("div");
      msgDiv.className = who === "You" ? "user-msg" : "bot-msg";
      msgDiv.innerHTML = `
        ${sanitizeHTML(text)}
        <div class="timestamp">${msgDate.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit", hour12: true })}</div>
      `;
      chatBox.append(msgDiv);
      chatBox.scrollTop = chatBox.scrollHeight;
    }
    // Sanitize and format simple markdown
    function sanitizeHTML(unsafe) {
      if (!unsafe) return "";
      return unsafe
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/\*\*(.+?)\*\*/g, "<strong>$1</strong>")
        .replace(/\*(.+?)\*/g, "<em>$1</em>")
        .replace(/`([^`]+)`/g, "<code>$1</code>")
        .split(/\n{2,}/)
        .map(p => `<p>${p.trim()}</p>`)
        .join("");
    }

    //──────────────────────────────────────────────────────────────────────────────
  // FUNCTION: addCloseCopyDownload(panel)
  // Adds “Copy” and “Download” buttons after a generated response
  //──────────────────────────────────────────────────────────────────────────────
  function addCloseCopyDownload(panel) {
    // Ensure we don’t insert duplicates
    if (panel.querySelector(".tool-row")) return;

    const toolRow = document.createElement("div");
    toolRow.className = "tool-row";

    // COPY button
    const copyBtn = document.createElement("button");
    copyBtn.className = "copy-btn";
    copyBtn.type = "button";
    copyBtn.title = "Copy response";
    copyBtn.innerHTML = '<i class="fas fa-copy"></i>';
    toolRow.append(copyBtn);

    // DOWNLOAD button
    const dlBtn = document.createElement("button");
    dlBtn.className = "dl-btn";
    dlBtn.type = "button";
    dlBtn.title = "Download response";
    dlBtn.innerHTML = '<i class="fas fa-download"></i>';
    toolRow.append(dlBtn);

    panel.append(toolRow);
  }
   
    // Render existing history
    chatHistory.forEach(m => {
      const ts = m.timestamp ? new Date(m.timestamp) : new Date();
      addMessage(m.who, m.text, ts);
    });

    // Send chat
    sendChatBtn.onclick = async (e) => {
      e.preventDefault();
      const userText = chatInput.value.trim();
      if (!userText) return;
      const userTime = new Date();
      addMessage("You", userText, userTime);
      chatHistory.push({ who: "You", text: userText, timestamp: userTime.toISOString() });
      localStorage.setItem("dietChatHistory", JSON.stringify(chatHistory));
      chatInput.value = "";

      // Show spinner
      const spinnerDiv = document.createElement("div");
      spinnerDiv.className = "bot-msg";
      spinnerDiv.innerHTML = `<div class="spinner"></div>`;
      chatBox.append(spinnerDiv);
      chatBox.scrollTop = chatBox.scrollHeight;

      const systemPrompt = `
You are a professional Dietetics AI with expertise in meal planning, nutrient analysis, and culinary guidance.
When responding to user questions:
  • Acknowledge user’s context empathetically.
  • Provide evidence-based dietary advice (e.g., macronutrient ratios, portion control).
  • Reference user’s nationality if known (e.g., “As a Ghanaian diet, you can include...").
  • Suggest at least two actionable, practical steps (recipes, shopping lists, meal timing).
  • If user input is unclear, ask a clarifying question.
  • Maintain a friendly, encouraging tone. Keep replies under 200 words unless asked for more detail.
      `.trim();

      try {
        const aiReply = await callOpenAI([
          { role: "system", content: `Nationality: ${userNationality}` },
          { role: "system", content: systemPrompt },
          { role: "user", content: userText }
        ]);
        const replyTime = new Date();
        spinnerDiv.innerHTML = `
          ${sanitizeHTML(aiReply)}
          <div class="timestamp">${replyTime.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit", hour12: true })}</div>
        `;
        chatHistory.push({ who: "AI", text: aiReply, timestamp: replyTime.toISOString() });
        localStorage.setItem("dietChatHistory", JSON.stringify(chatHistory));
      } catch (err) {
        spinnerDiv.innerHTML = `<div class="result-content">⚠️ Something went wrong. Please try again.</div>`;
      }
      chatBox.scrollTop = chatBox.scrollHeight;
    };

    // Clear chat
    clearChatBtn.onclick = () => {
      chatBox.innerHTML = "";
      chatHistory = [];
      localStorage.removeItem("dietChatHistory");
      lastDateHeader = null;
    };

    // View history modal
    viewHistoryBtn.onclick = () => {
      const modal = document.createElement("div");
      modal.className = "history-modal";
      const grouped = {};
      chatHistory.forEach((m, i) => {
        const dt = new Date(m.timestamp);
        const label = formatDateSeparator(dt);
        if (!grouped[label]) grouped[label] = [];
        grouped[label].push({ who: m.who, text: m.text, idx: i, ts: m.timestamp });
      });

      let listHTML = "";
      Object.keys(grouped).forEach(label => {
        listHTML += `<div class="history-date">${label}</div>`;
        grouped[label].forEach(m => {
          listHTML += `
            <div class="history-row" data-index="${m.idx}">
              <div class="history-sender"><strong>${m.who}:</strong></div>
              <div class="history-text">${sanitizeHTML(m.text)}</div>
              <button class="del-msg" data-index="${m.idx}" title="Delete"><i class="fas fa-trash-alt"></i></button>
            </div>
          `;
        });
      });

      modal.innerHTML = `
        <div class="history-content">
          <h3>Chat History</h3>
          <div class="history-table-wrapper">${listHTML}</div>
          <div class="history-actions">
            <button class="clear-history"><i class="fas fa-trash"></i> Clear All</button>
            <button class="close-history"><i class="fas fa-times"></i> Close</button>
          </div>
        </div>
      `;
      document.body.append(modal);

      // Delete single message
      modal.querySelectorAll(".del-msg").forEach(btn => {
        btn.onclick = () => {
          const idx = +btn.dataset.index;
          chatHistory.splice(idx, 1);
          localStorage.setItem("dietChatHistory", JSON.stringify(chatHistory));
          // Remove all rows and rebuild
          modal.querySelector(".history-table-wrapper").innerHTML = "";
          Object.keys(grouped).forEach(label => {
            grouped[label].forEach(m => {
              if (m.idx !== idx) {
                modal.querySelector(".history-table-wrapper").innerHTML += `
                  <div class="history-row" data-index="${m.idx}">
                    <div class="history-sender"><strong>${m.who}:</strong></div>
                    <div class="history-text">${sanitizeHTML(m.text)}</div>
                    <button class="del-msg" data-index="${m.idx}" title="Delete"><i class="fas fa-trash-alt"></i></button>
                  </div>
                `;
              }
            });
          });
        };
      });

      // Clear all history
      modal.querySelector(".clear-history").onclick = () => {
        chatHistory = [];
        localStorage.removeItem("dietChatHistory");
        modal.querySelector(".history-table-wrapper").innerHTML = "";
      };

      // Close modal
      modal.querySelector(".close-history").onclick = () => modal.remove();
    };
  })();

  //──────────────────────────────────────────────────────────────────────────────
  // GENERIC OPENAI CALL (with retry)
  //──────────────────────────────────────────────────────────────────────────────
  async function callOpenAI(messages, retries = 1) {
    try {
      const response = await fetch("/.netlify/functions/openai-proxy", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ messages })
      });
      if (!response.ok) {
        const errText = await response.text();
        throw new Error(`OpenAI error ${response.status}: ${errText}`);
      }
      const data = await response.json();
      if (!data.choices?.[0]?.message?.content) {
        throw new Error("Malformed OpenAI response");
      }
      return data.choices[0].message.content.trim();
    } catch (err) {
      if (retries > 0 && err.message.includes("Sandbox.Timedout")) {
        await new Promise(r => setTimeout(r, 1000));
        return callOpenAI(messages, retries - 1);
      }
      throw err;
    }
  }

  //──────────────────────────────────────────────────────────────────────────────
  // MODULE WIRING HELPER
  //──────────────────────────────────────────────────────────────────────────────
  function wireModule(buttonId, fieldIds, requiredIds, systemContent) {
    const btn = document.getElementById(buttonId);
    btn.type = "button";
    btn.addEventListener("click", async () => {
      // Validate required fields
      for (const req of requiredIds) {
        if (req === "symptoms") {
          if (!document.querySelector('input[name="symptom"]:checked')) {
            return showToast("Select at least one symptom.");
          }
        } else {
          const el = document.getElementById(req);
          if (!el || !el.value.trim()) {
            return showToast("Please fill in all required fields.");
          }
        }
      }
      // Determine panel ID
      let panelId;
      if (buttonId === "getRecipes") panelId = "recipeResult";
      else panelId = buttonId.replace(/^(send|gen|analyze|get|scan|run)/, match => "").replace(/^./, c => c.toLowerCase()) + "Result";

      const panel = document.getElementById(panelId);
      panel.hidden = false;
      // **1)** Enter “loading” state so the close‐button is hidden
      panel.classList.add("loading");
      panel.querySelector(".result-content").innerHTML =
        `<div class="spinner"></div><div class="spin-text">Please wait…</div>`;
      // Build user content
      let userContent = "";
      for (const fid of fieldIds) {
        if (fid === "symptoms") {
          let vals = Array.from(document.querySelectorAll('input[name="symptom"]:checked')).map(cb => cb.value);
          const otherSym = document.getElementById("otherSymptom");
          if (otherSym && otherSym.value.trim()) vals.push(otherSym.value.trim());
          userContent += `symptoms: ${vals.join(", ")}\n`;
        } else {
          const el = document.getElementById(fid);
          if (!el) continue;
          if (el.tagName === "SELECT" && el.multiple) {
            userContent += `${fid}: ${[...el.selectedOptions].map(o => o.value).join(", ")}\n`;
          } else if (el.tagName === "SELECT") {
            const oi = el.parentElement.querySelector(".other-input");
            const val = (oi && el.value === "Other") ? oi.value.trim() : el.value;
            userContent += `${fid}: ${val}\n`;
          } else {
            userContent += `${fid}: ${el.value}\n`;
          }
        }
      }
      try {
        const aiReply = await callOpenAI([
          { role: "system", content: `Nationality: ${userNationality}` },
          { role: "system", content: systemContent },
          { role: "user", content: userContent }
        ]);
        panel.classList.remove("loading");
        panel.querySelector(".result-content").innerHTML = sanitizeHTML(aiReply);
        addCloseCopyDownload(panel);
      } catch (err) {
        panel.classList.remove("loading");
        panel.querySelector(
          ".result-content"
        ).innerText = err.message.includes("Sandbox.Timedout")
          ? "⚠️ Server busy—please try again."
          : `⚠️ ${err.message}`;
        addCloseCopyDownload(panel);

      }
    });
  }

  //──────────────────────────────────────────────────────────────────────────────
  // SANITIZE & FORMAT SIMPLE MARKDOWN
  //──────────────────────────────────────────────────────────────────────────────
  function sanitizeHTML(unsafe) {
    if (!unsafe) return "";
    return unsafe
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/\*\*(.+?)\*\*/g, "<strong>$1</strong>")
      .replace(/\*(.+?)\*/g, "<em>$1</em>")
      .replace(/`([^`]+)`/g, "<code>$1</code>")
      .split(/\n{2,}/)
      .map(p => `<p>${p.trim()}</p>`)
      .join("");
  }

  //──────────────────────────────────────────────────────────────────────────────
// WIRE ALL MODULES WITH SYSTEM PROMPTS (UPDATED “Other” HANDLING)
//──────────────────────────────────────────────────────────────────────────────

// 1. Meal Plan Generator
wireModule("genPlan",
  ["calories", "dietType", "allergyList", "budget"],
  ["calories", "dietType"],
  `
You are a registered Dietitian AI. Given the user’s daily calorie target, diet type (if they chose “Other,” use exactly the custom text they provided), allergies/intolerances, and budget, generate a detailed 7-day meal plan including:
  • Macronutrient breakdowns
  • A complete shopping list
  • Simple, easy-to-follow recipes

• Do NOT ever output the single word “Other.” If the user selected “Other,” substitute the user’s exact text instead of “Other.”
• Offer culturally relevant options based on the user’s nationality whenever possible.
  `.trim()
);

// 2. Nutrient Analyzer
wireModule("analyzeNutri",
  ["foodLog", "unitSelect"],
  ["foodLog"],
  `
You are a Nutrition Scientist AI. Analyze the user’s food log and their chosen unit (if they selected “Other,” use that custom text verbatim). Produce a comprehensive macro- and micronutrient breakdown with:
  • Total amounts and percentages
  • Commentary on adequacy or imbalance
  • Suggestions for balancing deficiencies or excesses

• Do NOT ever output “Other.” If the user’s unit was “Other,” use their exact custom unit name instead.
• Frame recommendations using the user’s nationality to reference typical local foods.
  `.trim()
);

// 3. Recipe Recommender
wireModule("getRecipes",
  ["pantry", "cuisineType", "recipeDifficulty", "maxTime"],
  ["pantry"],
  `
You are a Culinary AI Chef. Given the user’s pantry items, chosen cuisine style (if “Other,” substitute exactly what they typed), difficulty level, and maximum prep time, recommend three original recipes that include:
  • Full ingredient lists
  • Step-by-step instructions
  • Estimated cooking times
  • Dietary analysis (macros, major micronutrients)
  • Local ingredient substitutions based on the user’s nationality

• Do NOT ever output “Other.” If the user chose “Other” for “cuisineType,” use their exact custom text instead.
  `.trim()
);

// 4. Deficiency Risk Scanner
wireModule("scanDef",
  ["symptoms", "dietOverview"],
  ["symptoms"],
  `
You are a Clinical Dietitian AI. Identify potential nutrient deficiencies based on the user’s selected symptoms (if they checked “Other,” include their exact text) and their brief diet overview. Then:
  • Rank the likely deficiencies in order of probability (e.g., iron deficiency, vitamin B12)
  • Provide reasoning for each ranking
  • Offer dietary sources or supplement suggestions
  • Suggest simple meal modifications to address each deficiency

• Do NOT output “Other.” If the user typed a custom symptom, include that exact text instead.
  Tailor all suggestions to the user’s nationality and typical regional diet.
  `.trim()
);

// 5. Metabolomic Risk Radar
wireModule("runRisk",
  ["riskFrom", "riskTo", "biomarkers", "conditions", "context"],
  ["riskFrom", "riskTo", "biomarkers", "conditions", "context"],
  `
You are a Metabolomic Health Analyst AI. Analyze the user’s specified date range (riskFrom → riskTo), biomarkers (e.g., “glucose, LDL”; if “Other,” use their exact text), diagnosed conditions (if “Other,” use their exact text), and context (if “Other,” use their exact text). Perform the following:
  • Generate a detailed radar-chart interpretation of biomarker trends
  • Highlight any predictive health alerts (e.g., “glucose trending upward”)
  • Provide targeted dietary adjustments using local foods based on the user’s nationality
  • Recommend relevant local testing resources for follow-up

• Do NOT ever output “Other.” Whenever the user’s input was “Other,” substitute the precise custom text they provided.
  `.trim()
);

  //──────────────────────────────────────────────────────────────────────────────
  // AFTER runRisk, INJECT RADAR CHART BASED ON AI RESPONSE
  //──────────────────────────────────────────────────────────────────────────────
  {
 
  const runRiskBtn = document.getElementById("runRisk");
    let radarChartInstance = null;
    runRiskBtn.addEventListener("click", () => {
      const panel = document.getElementById("riskResult");
      // Delay so AI text appears first
      setTimeout(() => {
        const text = panel.querySelector(".result-content").innerText || "";
        const matches = [...text.matchAll(/(\w+):\s*(\d+)/g)];
        if (!matches.length) return;
        const labels = matches.map(m => m[1]);
        const data = matches.map(m => Number(m[2]));

        // If a previous radar chart exists, destroy it before creating a new one
        if (radarChartInstance) {
          radarChartInstance.destroy();
          radarChartInstance = null;
        }

        // Remove any existing <canvas> then add a fresh one
        const existingCanvas = panel.querySelector("canvas");
        if (existingCanvas) existingCanvas.remove();
        const canvas = document.createElement("canvas");
        panel.appendChild(canvas);

        radarChartInstance = new Chart(canvas.getContext("2d"), {
          type: "radar",
          data: {
            labels,
            datasets: [{
              label: "Biomarker Levels",
              data
            }]
          },
          options: { responsive: true, maintainAspectRatio: false }
        });
      }, 700);
    });
}

 // 6. Fitness Nutrition Coach
wireModule("runFitness",
  ["fitGoal", "fitFreq", "blendIngredients", "carbDate", "intensity", "crpLevel", "nutraPref"],
  ["fitGoal", "fitFreq"],
  `
You are a Certified Sports Nutritionist AI. Based on the user’s:
  • Workout goal (if “Other,” use their exact wording)
  • Weekly workout frequency
  • Available ingredients for pre/post-workout blends (if “Other,” use their exact text)
  • Carb-timing start date
  • Training intensity
  • CRP / CK lab values
  • Nutraceutical preference (if “Other,” use their exact text)
Construct a complete fitness nutrition plan that includes:
  • Balanced macronutrient targets
  • Pre- and post-workout blend recipes
  • Recovery guidelines for inflammation
  • Monitoring tips for CRP / CK levels

• Do NOT ever output “Other.” If any field was “Other,” insert exactly what they typed instead.
  Adjust all guidance for the user’s nationality (e.g., local supplement availability).
  `.trim()
);

// 7. Pharma-Integrated Nutrient Suite
wireModule("runPharma",
  ["medList", "foodList", "compoundGoal", "doseFreq", "scheduleNotes", "cohortSelect"],
  ["medList"],
  `
You are a Pharmacist-Dietitian AI. Analyze potential drug–nutrient interactions given the user’s:
  • Medications (if “Other,” use exact text)
  • Food items (if “Other,” use exact text)
  • Desired compounding goal (if “Other,” use exact text)
  • Dosage frequency (if “Other,” use exact text)
  • Custom schedule notes (free text)
  • Cohort to compare (if “Other,” use exact text)

Do the following:
  • Identify any critical drug-nutrient interactions
  • Provide compounding suggestions to achieve the desired outcome
  • Create a dosing schedule that optimizes nutrient absorption
  • Generate outcome analytics comparing the specified cohort (e.g., diet-only vs diet+meds)

• Do NOT output “Other.” Replace every “Other” selection with exactly what the user typed.
  Tailor all advice to their nationality and local healthcare guidelines.
  `.trim()
);

// 8. Symptom-to-Treatment Advisor
wireModule("runSymptom",
  ["sympAge", "sympDesc", "foodPref"],
  ["sympAge", "sympDesc"],
  `
You are a Medical Nutrition Therapist AI. Based on:
  • The user’s age
  • The symptom description (if they typed “Other,” use their exact text)
  • Their food preferences (if “Other,” use exact text)
Provide:
  • Possible diagnoses or conditions
  • Over-the-counter treatment suggestions
  • Tailored food and meal recommendations using local cuisine
  • Advice on when to seek professional medical care

• Do NOT output “Other.” If any input field was “Other,” substitute the exact text the user provided.
  `.trim()
);

  //──────────────────────────────────────────────────────────────────────────────
  // CHART.JS: PROGRESS CHARTS (Calories & Macro Distribution)
  //──────────────────────────────────────────────────────────────────────────────
// Ensure we only create these once
  let calorieChartInstance = null;
  let macroChartInstance = null;

  if (!calorieChartInstance && !macroChartInstance) {
    // 1) Weekly Calorie Intake line chart
    const ctxCal = document.getElementById("calorieChart").getContext("2d");
    const weekdays = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
    const today = new Date();
    const last7Labels = [];
    const last7Data = [];
    for (let i = 6; i >= 0; i--) {
      const d = new Date(today);
      d.setDate(d.getDate() - i);
      last7Labels.push(weekdays[d.getDay()]);
      last7Data.push(Math.floor(Math.random() * 800) + 1500); // random 1500-2300 kcal
    }
    calorieChartInstance = new Chart(ctxCal, {
      type: "line",
      data: {
        labels: last7Labels,
        datasets: [{
          label: "Calories In",
          data: last7Data,
          borderColor: getComputedStyle(document.documentElement).getPropertyValue("--primary").trim(),
          backgroundColor: "rgba(212, 172, 13, 0.1)",
          fill: true
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: { ticks: { color: getComputedStyle(document.documentElement).getPropertyValue("--text").trim() } },
          y: {
            ticks: { color: getComputedStyle(document.documentElement).getPropertyValue("--text").trim() },
            beginAtZero: false,
            suggestedMin: 1200,
            suggestedMax: 2500
          }
       },
        plugins: { legend: { display: false } }
      }
    });
    // Export Calorie CSV (only once)
    const expCalBtn = document.createElement("button");
    expCalBtn.innerText = "Export Chart";
    expCalBtn.className = "export-chart-btn";
    expCalBtn.type = "button";
    document.getElementById("calorieChart").after(expCalBtn);
    expCalBtn.addEventListener("click", () => {
      let csv = "Day,Calories\n";
      calorieChartInstance.data.labels.forEach((d,i) => {
        csv += `"${d}",${calorieChartInstance.data.datasets[0].data[i]}\n`;
      });
     const blob = new Blob([csv], { type: "text/csv" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "calorie-intake.csv";
      a.click();
    });

    // 2) Macro Distribution pie chart
    const ctxMacro = document.getElementById("macroChart").getContext("2d");
    const rand1 = Math.floor(Math.random() * 40) + 30;      // carbs 30–70
    const rand2 = Math.floor(Math.random() * (100 - rand1));
    const rand3 = 100 - rand1 - rand2;
    macroChartInstance = new Chart(ctxMacro, {
      type: "pie",
      data: {
        labels: ["Carbs","Protein","Fat"],
        datasets: [{ data: [rand1, rand2, rand3], backgroundColor: [
          getComputedStyle(document.documentElement).getPropertyValue("--secondary").trim(),
          getComputedStyle(document.documentElement).getPropertyValue("--primary-alt").trim(),
          getComputedStyle(document.documentElement).getPropertyValue("--accent").trim()
        ] }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { position: "bottom" } }
      }
    });
    // Export Macro CSV (only once)
    const expMacroBtn = document.createElement("button");
    expMacroBtn.innerText = "Export Chart";
    expMacroBtn.className = "export-chart-btn";
    expMacroBtn.type = "button";
    document.getElementById("macroChart").after(expMacroBtn);
    expMacroBtn.addEventListener("click", () => {
      let csv = "Macro,Percent\n";
      macroChartInstance.data.labels.forEach((m,i) => {
        csv += `"${m}",${macroChartInstance.data.datasets[0].data[i]}\n`;
      });
     const blob = new Blob([csv], { type: "text/csv" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "macro-distribution.csv";
      a.click();
    });
  }
  
  
  //──────────────────────────────────────────────────────────────────────────────
  // EXPORT ALL MODULE CHARTS BUTTON (Example: ID "exportData")
  //──────────────────────────────────────────────────────────────────────────────
  const exportAllBtn = document.getElementById("exportData");
  exportAllBtn.addEventListener("click", () => {
    // Combine calorieChart and macroChart data into one CSV
    const exportAllBtn = document.getElementById("exportData");
  exportAllBtn.addEventListener("click", () => {
    // Combine calorieChartInstance and macroChartInstance data into one CSV
    let csv = "Chart,Label,Value\n";
    if (calorieChartInstance) {
      calorieChartInstance.data.labels.forEach((lab, i) => {
        csv += `"Calories","${lab}",${calorieChartInstance.data.datasets[0].data[i]}\n`;
      });
    }
    if (macroChartInstance) {
      macroChartInstance.data.labels.forEach((lab, i) => {
        csv += `"Macro","${lab}",${macroChartInstance.data.datasets[0].data[i]}\n`;
      });
    }
    const blob = new Blob([csv], { type: "text/csv" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "dietetics-progress.csv";
    a.click();
  });

  //──────────────────────────────────────────────────────────────────────────────
  // RESPONSE PANEL CONTROLS (CLOSE, COPY, DOWNLOAD)
  //──────────────────────────────────────────────────────────────────────────────
  document.body.addEventListener("click", e => {
    const rp = e.target.closest(".response");
    if (!rp) return;
    if (e.target.closest(".close-btn")) {
      rp.hidden = true;
      return;
    }
    if (e.target.closest(".copy-btn")) {
      const txt = rp.querySelector(".result-content").innerText;
      navigator.clipboard.writeText(txt).then(() => showToast("Copied!"));
      return;
    }
    if (e.target.closest(".dl-btn")) {
      const txt = rp.querySelector(".result-content").innerText;
      const blob = new Blob([txt], { type: "text/plain" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "response.txt";
      a.click();
    }
  });

  //──────────────────────────────────────────────────────────────────────────────
  // UTILITY: SANITIZE & FORMAT MARKDOWN
  //──────────────────────────────────────────────────────────────────────────────
  function sanitizeHTML(unsafe) {
    if (!unsafe) return "";
    return unsafe
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/\*\*(.+?)\*\*/g, "<strong>$1</strong>")
      .replace(/\*(.+?)\*/g, "<em>$1</em>")
      .replace(/`([^`]+)`/g, "<code>$1</code>")
      .split(/\n{2,}/)
      .map(p => `<p>${p.trim()}</p>`)
      .join("");
  }
});
</script>


  
</body>

</html>
