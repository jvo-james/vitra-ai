<!DOCTYPE html>
<html lang="en" aria-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Vitra AI – Dietetics & Nutrition</title>
  <!-- Montserrat + FontAwesome -->
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;700&display=swap" rel="stylesheet">
  <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>

/*────────────────────── Theme & Reset ──────────────────────*/
:root {
  --color-primary: #D4AC0D;
  --color-primary-alt: #B7950B;
  --color-secondary: #884EA0;
  --color-accent: rgba(255,255,224,0.8);
  --color-bg: #FEF9E7;
  --color-surface: rgba(255,255,240,0.9);
  --color-text: #3E3E3E;
  --color-muted: #7D6608;
  --radius: 1rem;
  --padding: 1rem;
  --transition: 0.3s ease;
  --shadow: 0 6px 20px rgba(0,0,0,0.1);
  --sidebar-width: 220px;
  --sidebar-collapsed: 60px;
}
html.dark {
  --color-bg: #1A1A1A;
  --color-surface: rgba(30,30,30,0.9);
  --color-text: #ECECEC;
  --color-muted: #AAA;
}
    html.dark input,
html.dark textarea,
html.dark select {
 background: var(--color-surface);
 color: var(--color-text);
 border-color: var(--color-muted);
}
/* Chat bubbles already inherit var(--color-text) but just in case: */
html.dark .user-msg { color: #111; }
html.dark .bot-msg  { color: var(--color-text); }
* {
  margin: 0; padding: 0; box-sizing: border-box;
  font-family: 'Montserrat', sans-serif;
}
body {
  display: flex; min-height: 100vh;
  background: var(--color-bg);
  color: var(--color-text);
  overflow-x: hidden;
  transition: background var(--transition), color var(--transition);
}
a { color: inherit; text-decoration: none; }
button, input, textarea, select { font: inherit; transition: var(--transition); }
:focus { outline: none; }

/*────────────────────── Sidebar ──────────────────────*/
aside#sidebar {
  position: fixed; top: 0; left: 0; bottom: 0;
  width: var(--sidebar-width);
  background: var(--color-surface);
  box-shadow: var(--shadow);
  display: flex; flex-direction: column;
  z-index: 1000;
}
aside#sidebar .brand {
  display: flex; align-items: center; gap: .75rem;
  padding: var(--padding);
  font-size: 1.25rem; font-weight: 700;
  color: var(--color-primary);
}
aside#sidebar nav ul {
  list-style: none; flex: 1; overflow-y: auto;
}
aside#sidebar nav li { }
aside#sidebar nav a {
  display: flex; align-items: center; gap: .75rem;
  padding: .75rem var(--padding);
  border-radius: var(--radius);
  color: var(--color-text);
  transition: background var(--transition), transform var(--transition);
}
aside#sidebar nav a:hover,
aside#sidebar nav .active a {
  background: var(--color-primary-alt);
  color: #fff;
  transform: translateX(4px);
}
#shrinkSidebar {
  margin: var(--padding); align-self: center;
  background: var(--color-primary);
  border: none; border-radius: 50%;
  width: 36px; height: 36px;
  color: #fff; box-shadow: var(--shadow);
  cursor: pointer;
}
aside#sidebar.collapsed {
width: var(--sidebar-collapsed);
 }
 aside#sidebar.collapsed .brand span,
 aside#sidebar.collapsed nav a span {  display: none;
 }
 aside#sidebar.collapsed nav a {
 justify-content: center;
 }
/*────────────────────── Header ──────────────────────*/
header {
  position: fixed; top: 0; left: var(--sidebar-width); right: 0;
  height: 60px;
  background: var(--color-surface);
  box-shadow: var(--shadow);
  display: flex; align-items: center; justify-content: space-between;
  padding: 0 var(--padding);
  z-index: 1001;
  transition: left var(--transition), background var(--transition);
}
header #hamburger {
  display: none; font-size: 1.5rem; color: var(--color-primary);
  cursor: pointer;
}
header #themeToggle {
  font-size: 1.5rem; color: var(--color-primary);
  cursor: pointer;
}
@media(max-width: 768px) {
  header #hamburger { display: block; }
  body.sidebar-open aside#sidebar { transform: translateX(0); }
  aside#sidebar { transform: translateX(-100%); transition: transform var(--transition); }
  header, main { left: 0 !important; }
}

/*────────────────────── Main & Modules ──────────────────────*/
main {
  flex: 1;
  margin-top: 60px;
  margin-left: var(--sidebar-width);
  padding: var(--padding);
  transition: margin-left var(--transition);
}
section.module {
  background: var(--color-surface);
  border-radius: var(--radius);
  padding: var(--padding);
  margin-bottom: 1.5rem;
  box-shadow: var(--shadow);
  transition: transform var(--transition);
}
section.module:hover {
  transform: translateY(-4px);
}
h2 {
  display: flex; align-items: center; gap: .5rem;
  font-size: 1.6rem; color: var(--color-primary);
  margin-bottom: .75rem;
}
.desc {
  color: var(--color-muted);
  margin-bottom: 1rem;
}

/*────────────────────── Hero ──────────────────────*/
#hero .hero-features {
  display: grid;
  grid-template-columns: repeat(auto-fit,minmax(240px,1fr));
  gap: 1rem;
  margin-top: 1rem;
}
.feature-card {
  background: var(--color-bg);
  border-radius: var(--radius);
  padding: var(--padding);
  box-shadow: var(--shadow);
  display: flex; flex-direction: column; align-items: flex-start;
  transition: transform var(--transition), box-shadow var(--transition);
}
.feature-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 8px 30px rgba(0,0,0,0.15);
}
.feature-card i {
  font-size: 2rem; color: var(--color-primary-alt);
  margin-bottom: .5rem;
}
.feature-card h3 {
  margin-bottom: .75rem;
  font-size: 1.2rem;
}
.feature-card input,
.feature-card select {
  width: 100%; margin-bottom: .5rem;
}
.feature-card button {
  align-self: flex-end;
}

/*────────────────────── Chatbot ──────────────────────*/
.chat-controls {
  display: flex; gap: .5rem; margin-bottom: .5rem;
}
.chat-box {
  background: var(--color-bg);
  border: 1px solid var(--color-muted);
  border-radius: var(--radius);
  padding: var(--padding);
  max-height: 500px; overflow-y: auto;
  min-height: 250px;
  display: flex; flex-direction: column; gap: .5rem;
}
.chat-input {
  display: flex; gap: .5rem; margin-top: .5rem;
}
.chat-input input {
  flex: 1;
}
.user-msg, .bot-msg {
  max-width: 80%;
  padding: .75rem 1rem;
  border-radius: var(--radius);
  position: relative;
}
.user-msg {
  background: var(--color-primary-alt);
  color: #000; align-self: flex-end;
}
.bot-msg {
  background: var(--color-accent);
  color: var(--color-text); align-self: flex-start;
}
.timestamp {
  font-size: .65rem;
  color: var(--color-muted);
  position: absolute;
  bottom: -1.2rem; right: 1rem;
}

    .history-modal .modal-content {
  display: flex;
  flex-direction: column;
}
.history-modal .modal-content ul {
  flex: 1 1 auto;
  overflow-y: auto;
  margin-bottom: 1rem;
}
.history-modal .modal-content .button-row {
  display: flex;
  justify-content: space-between;
  gap: .5rem;
  flex-shrink: 0;
  position: sticky;
  bottom: 0;
  background: var(--color-surface);
  padding-top: .5rem;
}
    .history-modal {
  position: fixed;
 top: 0; left: 0; right: 0; bottom: 0;
 background: rgba(0,0,0,0.5);
 display: flex;
 align-items: center;
 justify-content: center;
 z-index: 2000;
}
.history-modal .modal-content {
  background: var(--color-surface);
 padding: var(--padding);
border-radius: var(--radius);
 max-width: 90%;
 max-height: 80%;
}
    
/*────────────────────── Forms & Inputs ──────────────────────*/
input, textarea, select {
  width: 100%;
  padding: .75rem;
  border: 1px solid var(--color-muted);
  border-radius: var(--radius);
  background: var(--color-accent);
  color: var(--color-text);
  box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
}
select + .other-input {
  margin-top: .5rem;
  display: none;
}
button.btn {
  display: inline-flex; align-items: center; gap: .5rem;
  padding: .75rem 1.25rem;
  border: none; border-radius: var(--radius);
  background: var(--color-primary); color: #000; font-weight: 600;
  box-shadow: var(--shadow);
  cursor: pointer;
  transition: background var(--transition), transform var(--transition);
}
button.btn:hover {
  background: var(--color-primary-alt);
  transform: translateY(-2px);
}
button.btn-secondary {
  background: var(--color-secondary); color: #fff;
}
button.btn-secondary:hover {
  background: var(--color-secondary-alt, #733d91);
}

/*────────────────────── Response Panels ──────────────────────*/
.response {
  background: var(--color-surface);
  border-left: 4px solid var(--color-secondary);
  border-radius: var(--radius);
  padding: var(--padding);
  margin-top: 1rem;
  position: relative;
  box-shadow: var(--shadow);
}
.response .result-content {
  white-space: pre-wrap;
  line-height: 1.5;
}
.tool-row {
  position: absolute; bottom: var(--padding); right: var(--padding);
  display: flex; gap: .5rem;
}

    #dailyTip, #recipeSearchPanel {
  position: relative; 
}


#dailyTip .close-btn,
#recipeSearchPanel .close-btn {
  position: absolute;
  top: 0.5rem;
  right: 0.5rem;
}


#dailyTip .tool-row,
#recipeSearchPanel .tool-row {
  position: absolute;
  bottom: 0.5rem;
  right: 0.5rem;
  display: flex;
  gap: .5rem;
}


#dailyTip .result-content,
#recipeSearchPanel .result-content {
  padding-bottom: 2.5rem;  /* enough room for those bottom buttons */
}
.close-btn, .copy-btn, .dl-btn {
  background: none; border: none; cursor: pointer;
}
.copy-btn, .dl-btn {
  width: 1.6rem; height: 1.6rem;
  display: flex; align-items: center; justify-content: center;
  border: 1px solid var(--color-muted);
  border-radius: 50%;
  background: var(--color-accent);
}
.copy-btn:hover, .dl-btn:hover {
  background: var(--color-primary-alt);
}

/*────────────────────── Fieldsets & Checkbox Groups ──────────────────────*/
fieldset {
  border: 1px solid var(--color-muted);
  border-radius: var(--radius);
  padding: .75rem;
  margin-bottom: 1rem;
}
legend {
  padding: 0 .5rem; font-weight: 600; color: var(--color-secondary);
}
.checkbox-group {
  display: flex; flex-wrap: wrap; gap: .5rem;
}
.checkbox-group label {
  display: flex; align-items: center; gap: .25rem;
}

/*────────────────────── Metabolomic & Fitness Sections ──────────────────────*/
#risk-form label, #fitness-form fieldset label {
  margin-bottom: .75rem;
}
#risk-form input[type="date"],
#fitness-form input[type="date"],
#fitness-form input[type="time"] {
  width: auto; display: inline-block; margin-left: .5rem;
}

/*────────────────────── Responsive Adjustments ──────────────────────*/
@media(max-width: 1024px) {
 main { padding: .5rem; margin-left: 0; }
  #hero .hero-features { grid-template-columns: 1fr; }
 }
@media(max-width: 640px) {
  section.module { padding: .75rem; margin-left: 0; }
  .chat-input, .chat-controls { flex-direction: column; }
  .tool-row { position: static; margin-top: .5rem; }
}

    .copy-tooltip {
  position: absolute;
  top: 0.5rem; right: 0.5rem;
  background: var(--color-primary-alt);
  color: #fff;
  padding: 0.25rem 0.5rem;
  border-radius: var(--radius);
  font-size: 0.75rem;
  animation: fadeOut 1.5s forwards;
}
@keyframes fadeOut {
  0% { opacity: 1; }
  100% { opacity: 0; transform: translateY(-10px); }
}
    /* under your CSS */
.spinner {
  border: 4px solid rgba(0,0,0,0.1);
  border-top: 4px solid var(--color-primary);
  border-radius: 50%;
  width: 24px; height: 24px;
  animation: spin 0.8s linear infinite;
  margin: 1rem auto;
}
@keyframes spin { to { transform: rotate(360deg); } }
.spin-text {
  text-align: center;
  margin-top: .5rem;
  font-style: italic;
  color: var(--color-muted);
}
    #hero { position: relative; overflow: hidden; }
.sticker {
  position: absolute;
  font-size: 3rem;
  opacity: .2;
}
.sticker-1 { top: 1rem; left: 2rem; transform: rotate(-15deg); }
.sticker-2 { top: 3rem; right: 3rem; transform: rotate(10deg); }
.sticker-3 { bottom: 2rem; left: 50%; transform: translateX(-50%) rotate(-5deg); }

/* Nationality label */
#nationality-label {
  display: inline-flex; align-items: center;
  gap: .5rem; margin-bottom: 1rem;
  font-weight: 600; color: var(--color-secondary);
}
#nationality { width: auto; flex: 1; }

/* Hero response panels styling */
#dailyTip, #recipeSearchPanel {
  margin-top: 1rem;
}

    .btn-secondary {
  background: linear-gradient(135deg, var(--color-secondary), var(--color-secondary-alt));
  color: #fff; padding: .75rem 1rem;
  border-radius: .5rem; box-shadow: var(--shadow);
}
.chat-controls .btn-secondary {
  background: none; border: 2px solid var(--color-primary);
  color: var(--color-primary); font-weight: 600;
}
.chat-controls .btn-secondary:hover {
  background: var(--color-primary); color:#fff;
}
    .checkbox-group label { padding: .5rem; background: var(--color-surface); border-radius: var(--radius); }

    html.dark .chat-box {
  background: var(--color-surface);
}
html.dark .user-msg {
  background: var(--color-primary-alt);
  color: #111;
}
html.dark .bot-msg {
  background: var(--color-accent);
  color: var(--color-text);
}

 
    .response .result-content {
  margin-top: 2.5rem;  /* enough space for the close button */
}
    /* Limit the hero macro chart size */
.feature-card #heroMacroChart {
  width: 100%;
  max-width: 280px;
  height: 200px;
  margin: 0.5rem auto;
  display: block;
}
/* Optional: center the text under it */
.feature-card .macro-desc {
  text-align: center;
  font-size: 0.9rem;
  color: var(--color-muted);
  margin-top: 0.25rem;
}

/* Dark mode tweak */
html.dark #hero {
  background: linear-gradient(135deg, #333, #555);
}
    html.dark .bot-msg {
  color: #000 !important;
}
     .checkbox-group {
  display: flex;
  flex-wrap: wrap;
  align-items: center;
  gap: 1rem; }
 .checkbox-group label {
   display: inline-flex;
  align-items: center;
  gap: .5rem;
 white-space: nowrap;
 }
     @media(max-width: 640px) {
   section.module { padding: .75rem; margin-left: 0; }
   .chat-input, .chat-controls { flex-direction: column; }
   .tool-row { position: static; margin-top: .5rem; }
  canvas { max-width: 100% !important; height: auto !important; }
 #hero .feature-card { flex-direction: column; }
  #hero .feature-card button,
  #hero .feature-card input { width: 100%; }
 }
    #dailyTip .close-btn,
#recipeSearchPanel .close-btn {
  position: absolute;
  top: 0.5rem;
  right: 0.5rem;
  background: none;
  border: none;
  font-size: 1rem;
  cursor: pointer;
}

#dailyTip .tool-row,
#recipeSearchPanel .tool-row {
  position: absolute;
  bottom: 0.5rem;
  right: 0.5rem;
  display: flex;
  gap: .5rem;
}
   .history-modal .modal-content {
  box-shadow: var(--shadow);
  display: grid;
  grid-template-rows: auto 1fr auto;
  gap: .5rem;
}
.history-modal .modal-content h3 {
  text-align: center;
  color: var(--color-primary);
}
.history-modal ul {
  list-style: none;
  overflow-y: auto;
  padding: 0 .5rem;
}
.history-modal ul li {
  display: flex;
  justify-content: space-between;
  padding: .5rem 0;
  border-bottom: 1px solid var(--color-muted);
}
.history-modal .button-row {
  position: sticky;
  bottom: 0;
  background: var(--color-surface);
  padding: .5rem 0;
}
.history-modal button {
  flex: 1;
  margin: 0 .25rem;
  padding: .5rem;
 border: none;
 border-radius: var(--radius);
 cursor: pointer;
}
.history-modal .clear-all-btn {
  background: var(--color-primary);
  color: #fff;
}
.history-modal .close-modal {
  background: var(--color-secondary);
 color: #fff;
}

    /* overwrite the canvas sizing so it never overflows */
.feature-card #heroMacroChart {
  width: 180px !important;
  height: 180px !important;
  display: block;
  margin: 0.5rem auto;
}
     #dailyTip .close-btn i,
 #dailyTip .copy-btn i,
 #dailyTip .dl-btn i,
 #recipeSearchPanel .copy-btn i,
 #recipeSearchPanel .dl-btn i {  width: 1.2rem; height: 1.2rem;
  font-size: 0.9rem;
}
  </style>
</head>

<body>
  <!-- Sidebar -->
  <aside id="sidebar">
    <div class="brand">
      <i class="fas fa-utensils"></i>
      <span>Vitra AI Dietetics</span>
    </div>
    <nav>
      <ul>
        <li><a href="herbal.html"><i class="fas fa-seedling"></i> Herbal Medicine</a></li>
        <li><a href="psych.html"><i class="fas fa-brain"></i> Psychology & MH</a></li>
        <li class="active"><a href="#"><i class="fas fa-apple-alt"></i> Dietetics</a></li>
        <li><a href="pharmacy.html"><i class="fas fa-prescription-bottle-alt"></i> E-Pharmacy</a></li>
        <li><a href="consult.html"><i class="fas fa-calendar-check"></i> Consult Booking</a></li>
      </ul>
    </nav>
    <button id="shrinkSidebar" aria-label="Toggle sidebar">
      <i class="fas fa-angle-double-left"></i>
    </button>
  </aside>

  <!-- Header -->
  <header>
    <i id="hamburger" class="fas fa-bars" aria-label="Open menu"></i>
    <h1>Dietetics & Nutrition</h1>
    <i id="themeToggle" class="fas fa-moon" aria-label="Toggle dark mode"></i>
  </header>

  <!-- Main Content -->
  <main>
    <!-- Hero Section -->
    <section id="hero" class="module">
      <h2><i class="fas fa-apple-alt"></i> Empower Your Nutrition</h2>
      <p class="desc">AI-driven tools for meal planning, nutrient insights, recipe inspiration & more.</p>
      <div class="hero-features">
        <!-- Recipe Search -->
        <div class="feature-card">
          <i class="fas fa-search"></i>
          <h3>Recipe Search</h3>
          <input type="text" id="heroRecipeSearch" placeholder="e.g. Jollof rice with chicken">
          <button id="heroSearchBtn" class="btn">Search</button>
        <!-- Recipe Search response panel -->
<div id="recipeSearchPanel" class="response" hidden>
  <button class="close-btn"><i class="fas fa-times"></i></button>
  <div class="result-content"></div>
  <div class="tool-row">
    <button class="copy-btn"><i class="fas fa-copy"></i></button>
    <button class="dl-btn"><i class="fas fa-download"></i></button>
  </div>
</div>
        </div>
        <!-- Today's Tip -->
        <div class="feature-card">
          <i class="fas fa-lightbulb"></i>
          <h3>Today's Nutrition Tip</h3>
        <div id="dailyTip" class="response">
   <div class="tool-row">
     <button class="close-btn"><i class="fas fa-times"></i></button>
     <button class="copy-btn"><i class="fas fa-copy"></i></button>
     <button class="dl-btn"><i class="fas fa-download"></i></button>
   </div>
   <div class="result-content">Loading tip…</div>
 </div>
          <button id="refreshTip" class="btn-secondary">Refresh Tip</button>
        </div>
        <!-- Quick Macro Snapshot -->
        <div class="feature-card">
          <i class="fas fa-chart-pie"></i>
          <h3>Macro Snapshot</h3>
          <div id="macroSnapshot">Protein: – g / Carbs: – g / Fat: – g</div>
          <button id="refreshMacro" class="btn-secondary">Update</button>
        </div>
        <!-- Nationality input (point 4) -->
<label id="nationality-label">
  <i class="fas fa-globe"></i>
  Nationality:
  <input type="text" id="nationality" placeholder="e.g. Ghanaian">
</label>
<button id="setNationality" class="btn-secondary">Set Nationality</button>


<!-- Add decorative “stickers” -->
<i class="fas fa-pepper-hot sticker sticker-1"></i>
<i class="fas fa-carrot sticker sticker-2"></i>
<i class="fas fa-ice-cream sticker sticker-3"></i>
  <!-- Inside <section id="hero">, add after the existing 3 stickers: -->
<i class="fas fa-apple-alt sticker" style="top:10%;left:15%;"></i>
<i class="fas fa-bread-slice sticker" style="top:20%;right:20%;"></i>
<i class="fas fa-lemon sticker" style="bottom:25%;left:10%;"></i>
<i class="fas fa-fish sticker" style="bottom:15%;right:15%;"></i>
<i class="fas fa-bacon sticker" style="top:50%;left:50%;"></i>
<!-- …and so on—just copy/paste with different icons & positions -->   
      </div>
    </section>

    <!-- 1. Nutrition Chatbot -->
    <section id="dietBot" class="module">
      <h2><i class="fas fa-comments"></i> Nutrition Chatbot</h2>
      <p class="desc">Ask any diet or nutrition question and get instant, tailored advice.</p>
      <div class="chat-controls">
        <button id="clearDiet" class="btn-secondary"><i class="fas fa-trash"></i> Clear Chat</button>
        <button id="viewDietHistory" class="btn-secondary"><i class="fas fa-history"></i> Chat History</button>
      </div>
      <div id="dietChatBox" class="chat-box"></div>
      <form id="diet-form" class="chat-input">
        <input id="dietInput" type="text" placeholder="Type your question…" required>
        <button id="sendDiet" class="btn"><i class="fas fa-paper-plane"></i></button>
      </form>
      <div id="dietHint" class="desc" style="display:none;">AI is thinking…</div>
    </section>

    <!-- 2. Meal Plan Generator -->
    <section id="mealPlanner" class="module">
      <h2><i class="fas fa-calendar-alt"></i> Meal Plan Generator</h2>
      <p class="desc">Create a 7-day meal plan that fits your calories, style, and restrictions.</p>
      <form id="planner-form">
        <label>Daily Calories:
          <input type="number" id="calories" min="800" max="4000" value="2000" required>
        </label>
        <label>Diet Type:
          <select id="dietType">
            <option>Balanced</option>
            <option>Low-Carb</option>
            <option>Vegan</option>
            <option>Ketogenic</option>
            <option>Mediterranean</option>
            <option>Plant-Based</option>
            <option value="Other">Other</option>
          </select>
          <input class="other-input" placeholder="Specify diet…" style="display:none;">
        </label>
        <label>Allergies & Intolerances:
          <select id="allergyList" multiple>
            <option>Gluten</option><option>Dairy</option><option>Nuts</option>
            <option>Shellfish</option><option>Soy</option><option>Eggs</option>
            <option>Sesame</option><option>Other</option>
          </select>
          <input class="other-input" placeholder="Specify others…" style="display:none;">
        </label>
        <label>Budget:
          <select id="budget">
            <option>Low</option><option>Medium</option><option>High</option>
          </select>
        </label>
        <button id="genPlan" class="btn"><i class="fas fa-utensils"></i> Generate Plan</button>
      </form>
      <div id="planPanel" class="response" hidden>
        <button class="close-btn"><i class="fas fa-times"></i></button>
        <div class="tool-row">
          <button class="copy-btn"><i class="fas fa-copy"></i></button>
          <button class="dl-btn"><i class="fas fa-download"></i></button>
        </div>
        <div class="result-content"></div>
      </div>
    </section>

    <!-- 3. Nutrient Analyzer -->
    <section id="nutriAnalyzer" class="module">
      <h2><i class="fas fa-vial"></i> Nutrient Analyzer</h2>
      <p class="desc">Get a complete macro and micronutrient breakdown of any recipe or meal log.</p>
      <form id="analyze-form">
        <label>Ingredients / Food Log:
          <textarea id="foodLog" rows="4" placeholder="e.g. 200g yam, 1 egg, spinach…"></textarea>
        </label>
        <label>Portion Size Units:
          <select id="unitSelect">
            <option>grams</option><option>pieces</option><option>cups</option>
            <option>tablespoons</option><option>servings</option>
          </select>
        </label>
        <button id="analyzeNutri" class="btn"><i class="fas fa-chart-bar"></i> Analyze</button>
      </form>
      <div id="nutriPanel" class="response" hidden>
        <button class="close-btn"><i class="fas fa-times"></i></button>
        <div class="tool-row">
          <button class="copy-btn"><i class="fas fa-copy"></i></button>
          <button class="dl-btn"><i class="fas fa-download"></i></button>
        </div>
        <div class="result-content"></div>
      </div>
    </section>

    <!-- 4. Recipe Recommender -->
    <section id="recipeRec" class="module">
      <h2><i class="fas fa-book-open"></i> Recipe Recommender</h2>
      <p class="desc">Transform your pantry into delicious meals across global cuisines.</p>
      <form id="recipe-form">
        <label>Pantry Items:
          <input id="pantry" type="text" placeholder="e.g. Rice, Beans, Plantain">
        </label>
        <label>Cuisine Style:
          <select id="cuisineType">
            <option>West African</option><option>Italian</option><option>Asian Fusion</option>
            <option>Mexican</option><option>Middle Eastern</option><option value="Other">Other</option>
          </select>
          <input class="other-input" placeholder="Specify cuisine…" style="display:none;">
        </label>
        <label>Difficulty:
          <select id="recipeDifficulty">
            <option>Easy</option><option>Medium</option><option>Advanced</option>
          </select>
        </label>
        <label>Max Prep Time:
          <input type="number" id="maxTime" min="5" max="180" value="30"> minutes
        </label>
        <button id="getRecipes" class="btn"><i class="fas fa-hamburger"></i> Get Recipes</button>
      </form>
      <div id="recipePanel" class="response" hidden>
        <button class="close-btn"><i class="fas fa-times"></i></button>
        <div class="tool-row">
          <button class="copy-btn"><i class="fas fa-copy"></i></button>
          <button class="dl-btn"><i class="fas fa-download"></i></button>
        </div>
        <div class="result-content"></div>
      </div>
    </section>

    <!-- 5. Deficiency Risk Scanner -->
    <section id="deficiency" class="module">
      <h2><i class="fas fa-exclamation-triangle"></i> Deficiency Risk Scanner</h2>
      <p class="desc">Identify potential nutrient shortfalls based on symptoms and diet.</p>
      <form id="def-form">
        <label>Select Symptoms (up to 5):
          <div class="checkbox-group">
            <label><input type="checkbox" name="symptom" value="Fatigue"> Fatigue</label>
            <label><input type="checkbox" name="symptom" value="Hair Loss"> Hair Loss</label>
            <label><input type="checkbox" name="symptom" value="Muscle Cramps"> Muscle Cramps</label>
            <label><input type="checkbox" name="symptom" value="Pale Skin"> Pale Skin</label>
            <label><input type="checkbox" name="symptom" value="Bleeding Gums"> Bleeding Gums</label>
            <label><input type="checkbox" name="symptom" value="Bone Pain"> Bone Pain</label>
            <label><input type="checkbox" name="symptom" value="Bruising"> Bruising</label>
            <label><input type="checkbox" name="symptom" value="Other"> Other</label>
          </div>
        </label>
        <label>Brief Diet Overview:
          <textarea id="dietOverview" rows="3" placeholder="e.g. Mostly rice, occasional vegetables…"></textarea>
        </label>
        <button id="scanDef" class="btn"><i class="fas fa-stethoscope"></i> Scan Deficiency</button>
      </form>
      <div id="defPanel" class="response" hidden>
        <button class="close-btn"><i class="fas fa-times"></i></button>
        <div class="tool-row">
          <button class="copy-btn"><i class="fas fa-copy"></i></button>
          <button class="dl-btn"><i class="fas fa-download"></i></button>
        </div>
        <div class="result-content"></div>
      </div>
    </section>

    <!-- 6. Metabolomic Risk Radar -->
    <section id="riskRadar" class="module">
      <h2><i class="fas fa-chart-pie"></i> Metabolomic Risk Radar</h2>
     <p class="desc">
  Continuous biomarker tracking (e.g. glucose, lipids) over any date range.
  Generates an interactive risk “radar” chart and predictive health alerts based
  on your trends. Enable “sync” for live updates.
</p>
      <form id="risk-form">
        <label>Date Range:
          <input type="date" id="riskFrom"> – <input type="date" id="riskTo">
        </label>
        <label><input type="checkbox" id="syncBiomarkers"> Enable Continuous Biomarker Sync</label>
       <label>Biomarkers (comma-sep):
  <input id="biomarkers" type="text" placeholder="e.g. glucose, LDL…">
</label>
<label>Conditions:
  <input id="conditions" type="text" placeholder="e.g. prediabetes…">
</label>
<label>Context:
  <input id="context" type="text" placeholder="e.g. routine check…">
</label>
        <button id="runRisk" class="btn"><i class="fas fa-biohazard"></i> Run Radar</button>
      </form>
      <div id="riskPanel" class="response" hidden>
        <button class="close-btn"><i class="fas fa-times"></i></button>
        <div class="tool-row">
          <button class="copy-btn"><i class="fas fa-copy"></i></button>
          <button class="dl-btn"><i class="fas fa-download"></i></button>
        </div>
        <div class="result-content"></div>
      </div>
    </section>

    <!-- 7. AI-Driven Fitness Nutrition Coach -->
    <section id="fitnessCoach" class="module">
      <h2><i class="fas fa-dumbbell"></i> Fitness Nutrition Coach</h2>
      <p class="desc">Tailor your macros, pre/post-workout blends, and recovery support.</p>
      <form id="fitness-form">
        <!-- 1. Performance Profiling -->
        <fieldset>
          <legend>1. Performance Profiling</legend>
          <label>Workout Goal:
            <select id="fitGoal">
              <option>Endurance</option>
              <option>Strength</option>
              <option>Hybrid</option>
              <option>Weight Loss</option>
              <option>General Health</option>
              <option value="Other">Other</option>
            </select>
            <input class="other-input" placeholder="Specify goal…" style="display:none;">
          </label>
          <label>Weekly Workouts:
            <select id="fitFreq">
              <option>1–2</option><option>3–4</option><option>5–7</option>
            </select>
          </label>
        </fieldset>
        <!-- 2. Pre/Post-Workout -->
        <fieldset>
          <legend>2. Pre/Post-Workout Micro-Blends</legend>
          <label>Available Ingredients:
            <select id="blendIngredients" multiple>
              <option>Pea Protein</option><option>Beetroot Powder</option>
              <option>Taurine</option><option>Banana</option>
              <option>Oats</option><option>Other</option>
            </select>
            <input class="other-input" placeholder="Add ingredient…" style="display:none;">
          </label>
        </fieldset>
        <!-- 3. Carb-Timing Calendar -->
        <fieldset>
          <legend>3. Carb-Timing Calendar</legend>
          <label>Start Date:
            <input type="date" id="carbDate">
          </label>
          <label>Intensity Level:
            <select id="intensity">
              <option>Low</option><option>Moderate</option><option>High</option>
            </select>
          </label>
        </fieldset>
        <!-- 4. Recovery Monitor -->
        <fieldset>
          <legend>4. Recovery & Inflammation</legend>
          <label>Track CRP & CK Levels:
            <input type="number" id="crpLevel" placeholder="CRP mg/L">
          </label>
          <label>Nutraceutical Preference:
            <select id="nutraPref">
              <option>Curcumin</option><option>Omega-3</option>
              <option>Turmeric</option><option>Ginger</option>
              <option>Other</option>
            </select>
            <input class="other-input" placeholder="Specify…"
                   style="display:none;">
          </label>
        </fieldset>
        <button id="runFitness" class="btn"><i class="fas fa-running"></i> Generate Plan</button>
      </form>
      <div id="fitnessPanel" class="response" hidden>
        <button class="close-btn"><i class="fas fa-times"></i></button>
        <div class="tool-row">
          <button class="copy-btn"><i class="fas fa-copy"></i></button>
          <button class="dl-btn"><i class="fas fa-download"></i></button>
        </div>
        <div class="result-content"></div>
      </div>
    </section>

    <!-- 8. Pharma-Integrated Nutrient & Medication Suite -->
    <section id="pharmaSuite" class="module">
      <h2><i class="fas fa-pills"></i> Pharma-Integrated Nutrient & Medication Suite</h2>
      <p class="desc">Drug–nutrient interactions, compounding suggestions, reminders & analytics.</p>
      <form id="pharma-form">
        <!-- 1. Drug–Nutrient Interaction -->
        <fieldset>
          <legend>1. Interaction Engine</legend>
          <label>Medications (comma-sep):
            <input id="medList" type="text" placeholder="e.g. Warfarin, Metformin">
          </label>
          <label>Food Items (comma-sep):
            <input id="foodList" type="text" placeholder="e.g. Grapefruit, Spinach">
          </label>
        </fieldset>
        <!-- 2. Custom Compounding -->
        <fieldset>
          <legend>2. Compounding Suggestions</legend>
          <label>Desired Outcome:
            <select id="compoundGoal">
              <option>Increased Absorption</option><option>Anti-inflammatory</option>
              <option>Energy Boost</option><option>Other</option>
            </select>
            <input class="other-input" placeholder="Specify…" style="display:none;">
          </label>
        </fieldset>
        <!-- 3. Adherence & Reminder Hub -->
        <fieldset>
          <legend>3. Adherence & Reminders</legend>
          <label>Reminder Method:
            <select id="reminderMethod">
              <option>SMS</option><option>Email</option><option>App Notification</option>
            </select>
          </label>
          <label>Reminder Times:
            <input type="time" id="reminderTime1">,
            <input type="time" id="reminderTime2">
          </label>
        </fieldset>
        <!-- 4. Outcome Analytics -->
        <fieldset>
          <legend>4. Outcome Analytics</legend>
          <label>Compare Cohort:
            <select id="cohortSelect">
              <option>Diet-only</option><option>Diet+Supplements</option>
              <option>Diet+Meds</option><option>Other</option>
            </select>
            <input class="other-input" placeholder="Specify…" style="display:none;">
          </label>
        </fieldset>
        <button id="runPharma" class="btn"><i class="fas fa-flask"></i> Run Suite</button>
      </form>
      <div id="pharmaPanel" class="response" hidden>
        <button class="close-btn"><i class="fas fa-times"></i></button>
        <div class="tool-row">
          <button class="copy-btn"><i class="fas fa-copy"></i></button>
          <button class="dl-btn"><i class="fas fa-download"></i></button>
        </div>
        <div class="result-content"></div>
      </div>
    </section>

    <!-- 9. Symptom-to-Treatment Advisor -->
    <section id="symptomAdvisor" class="module">
      <h2><i class="fas fa-user-md"></i> Symptom-to-Treatment Advisor</h2>
      <p class="desc">Describe your symptoms and receive drug suggestions & suitable foods eaten in Ghana.</p>
      <form id="symptom-form">
        <label>Your Age:
          <input type="number" id="sympAge" min="1" max="120" required>
        </label>
        <label>Describe Symptoms:
          <textarea id="sympDesc" rows="4" placeholder="e.g. headache, fever, cough…"></textarea>
        </label>
        <label>Food Preferences (comma-sep):
          <input id="foodPref" type="text" placeholder="e.g. Jollof rice, Pizza, Burger">
        </label>
        <button id="runSymptom" class="btn"><i class="fas fa-stethoscope"></i> Get Advice</button>
      </form>
      <div id="symptomPanel" class="response" hidden>
        <button class="close-btn"><i class="fas fa-times"></i></button>
        <div class="tool-row">
          <button class="copy-btn"><i class="fas fa-copy"></i></button>
          <button class="dl-btn"><i class="fas fa-download"></i></button>
        </div>
        <div class="result-content"></div>
      </div>
    </section>
    <!-- 6. Progress Charts -->
<section class="module">
  <h2><i class="fas fa-chart-line"></i> Progress Charts</h2>
  <canvas id="intakeChart"></canvas>
  <canvas id="macroChart"></canvas>
</section>
  </main>

 <!-- Chart.js & App Logic -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  // Prevent any form from actually submitting and reloading the page
  document.querySelectorAll('form').forEach(form => {
    form.addEventListener('submit', e => e.preventDefault());
  });

  // ── Global State & Persistence ───────────────────────────────────
  let userNationality = localStorage.getItem('nationality') || ''; 
  // if we have one, prefill the input so it survives refresh
 if (userNationality) {
   const ni = document.getElementById('nationality');
   ni.value = userNationality;
 }
  // ── Shared CSS for Toasts, Spinners & Panels ─────────────────────
  (function(){
    const css = `
      .toast { position: fixed; bottom: 2rem; left: 50%; transform: translateX(-50%) translateY(100%); background: var(--color-primary-alt); color: #fff; padding: .75rem 1.5rem; border-radius: var(--radius); opacity: 0; transition: transform .3s, opacity .3s; z-index:2000; }
      .toast.visible { transform: translateX(-50%) translateY(0); opacity:1; }
      .spinner { border:4px solid rgba(0,0,0,0.1); border-top:4px solid var(--color-primary); border-radius:50%; width:24px; height:24px; animation:spin .8s linear infinite; margin:1rem auto; }
      @keyframes spin { to{transform:rotate(360deg);} }
      .spin-text { text-align:center; margin-top:.5rem; font-style:italic; color:var(--color-muted); }
      .response .close-btn { position:absolute; top:var(--padding); right:var(--padding); }
      .response .tool-row { display:flex; gap:.5rem; position:absolute; bottom:var(--padding); right:var(--padding); }
      .response.waiting .close-btn,
      .response.waiting .tool-row { display:none!important; }
      .export-chart-btn { margin-top:.5rem; padding:.25rem .5rem; background:var(--color-secondary); color:#fff; border:none; border-radius:.5rem; cursor:pointer; }
    `;
    const s = document.createElement('style');
    s.textContent = css;
    document.head.appendChild(s);
  })();

  // ── Helpers ───────────────────────────────────────────────────────
  function showToast(msg) {
    const t = document.createElement('div');
    t.className = 'toast';
    t.innerText = msg;
    document.body.appendChild(t);
    requestAnimationFrame(() => t.classList.add('visible'));
    setTimeout(() => t.classList.remove('visible'), 1800);
    setTimeout(() => t.remove(), 2200);
  }

  async function callOpenAI(messages) {
    const res = await fetch('/.netlify/functions/openai-proxy', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ messages })
    });
    if (!res.ok) throw new Error('OpenAI error');
    const j = await res.json();
    return j.choices[0].message.content;
  }

  function formatHTML(txt) {
    return txt
      .replace(/^### (.*$)/gm, '<h3>$1</h3>')
      .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
      .replace(/\*(.+?)\*/g, '<em>$1</em>')
      .split(/\n{2,}/).map(p => `<p>${p.trim()}</p>`).join('');
  }

  function getSelectValue(sel) {
    const oi = sel.parentElement.querySelector('.other-input');
    return (oi && sel.value === 'Other') ? oi.value.trim() : sel.value;
  }

  // ── Phase texts for each button ───────────────────────────────────
  const PHASE_TEXT = {
    heroSearchBtn: 'Searching recipes…',
    refreshTip: 'Loading tip…',
    refreshMacro: 'Updating macro snapshot…',
    genPlan: 'Generating plan…',
    analyzeNutri: 'Analyzing nutrition…',
    getRecipes: 'Recommending recipes…',
    scanDef: 'Scanning deficiencies…',
    runRisk: 'Running radar…',
    runFitness: 'Generating fitness plan…',
    runPharma: 'Running pharma suite…',
    runSymptom: 'Diagnosing symptoms…'
  };

  // ── Common fetch / UI wiring for hero panels ─────────────────────
  async function handleHero(btnId, panelId, sysPrompt, qFn) {
    const q = qFn();
    if (!q) return showToast('Please enter a value.');
    const panel = document.getElementById(panelId);
    panel.classList.add('waiting');
    panel.hidden = false;
    panel.classList.add('waiting');
    panel.querySelector('.result-content').innerHTML =
      `<div class="spinner"></div><div class="spin-text">${PHASE_TEXT[btnId] || 'Please wait…'}</div>`;
    try {
      const reply = await callOpenAI([
        { role: 'system', content: `Nationality: ${userNationality}` },
        { role: 'system', content: sysPrompt },
        { role: 'user', content: q }
      ]);
      panel.querySelector('.result-content').innerHTML = formatHTML(reply);
    } catch {
        panel.querySelector('.result-content').innerText = '⚠️ Oops! Could not fetch the recipe. Please try again.';
     }
     finally {
      panel.classList.remove('waiting');
    }
  }

  // ── Hero: Recipe Search ──────────────────────────────────────────
  document.getElementById('heroSearchBtn').type = 'button';
  document.getElementById('heroSearchBtn').onclick = () => handleHero(
    'heroSearchBtn',
    'recipeSearchPanel',
    'You are a recipe finder.',
    () => document.getElementById('heroRecipeSearch').value.trim()
  );

  // ── Hero: Daily Tip ─────────────────────────────────────────────
  document.getElementById('refreshTip').type = 'button';
  document.getElementById('refreshTip').onclick = () => handleHero(
    'refreshTip',
    'dailyTip',
    'You are a nutrition tip generator.',
    () => 'Give one daily nutrition tip.'
  );
  // auto-load tip on page load
  handleHero('refreshTip', 'dailyTip', 'You are a nutrition tip generator.', () => 'Give one daily nutrition tip.');

  // ── Hero: Macro Snapshot Chart ──────────────────────────────────
  // inject canvas, wire Chart.js, and hook Update button
  const heroMacroCanvas = document.createElement('canvas');
  heroMacroCanvas.id = 'heroMacroChart';
  document.querySelector('#hero .feature-card:nth-child(3)').append(heroMacroCanvas);
   // description under the chart
  const macroDesc = document.createElement('p');
  macroDesc.className = 'macro-desc';
  macroDesc.innerText = 'This pie chart shows your macro distribution (%).';
  document.querySelector('#hero .feature-card:nth-child(3)').append(macroDesc);
  const heroMacroChart = new Chart(heroMacroCanvas.getContext('2d'), {
    type: 'pie',
    data: { labels: ['Carbs','Protein','Fat'], datasets: [{ data: [1,1,1] }] },
    options: {
      animation: false,
      maintainAspectRatio: false,
      layout: { padding: 10 }
    }
  });

  const refreshMacroBtn = document.getElementById('refreshMacro');
  refreshMacroBtn.type = 'button';
  refreshMacroBtn.onclick = async () => {
    const panel = document.getElementById('macroSnapshot');
    panel.classList.add('waiting');
    panel.innerHTML = `<div class="spinner"></div><div class="spin-text">${PHASE_TEXT.refreshMacro}</div>`;
    try {
      const reply = await callOpenAI([
        { role: 'system', content: `Nationality: ${userNationality}` },
        { role: 'system', content: 'You are a macro snapshot AI.' },
        { role: 'user', content: 'Provide protein/carbs/fat percentages.' }
      ]);
      const nums = reply.match(/\d+/g).map(Number);
      if (nums.length >= 3) {
        heroMacroChart.data.datasets[0].data = [nums[0], nums[1], nums[2]];
        heroMacroChart.update();
        panel.innerText = `Protein: ${nums[1]}% / Carbs: ${nums[0]}% / Fat: ${nums[2]}%`;
      } else {
        panel.innerText = '⚠️ Unexpected response.';
      }
    } catch {
      panel.innerText = '⚠️ Error';
    } finally {
      panel.classList.remove('waiting');
    }
  };
  // auto-load macro snapshot on page load
  refreshMacroBtn.click();

  // ── Standard module wiring helper ───────────────────────────────
  function wire(btnId, fields, required, sysPrompt) {
    const btn = document.getElementById(btnId);
    btn.type = 'button';
    btn.onclick = async () => {
      // validation
      for (const id of required) {
        if (id === 'symptoms') {
          if (!document.querySelector('input[name="symptom"]:checked')) {
            return showToast('Select at least one symptom.');
          }
        } else {
          const el = document.getElementById(id);
          if (!el || !el.value.trim()) {
            return showToast('Please fill in all required fields.');
          }
        }
      }
      // panel lookup, with special case for getRecipes
      let pid;
      if (btnId === 'getRecipes') {
        pid = 'recipePanel';
      } else {
        const raw = btnId.replace(/^(send|gen|analyze|get|scan|run)/, '');
        pid = raw.charAt(0).toLowerCase() + raw.slice(1) + 'Panel';
      }
      const panel = document.getElementById(pid);
      panel.classList.add('waiting');
      panel.hidden = false;
      panel.classList.add('waiting');
      panel.querySelector('.result-content').innerHTML =
        `<div class="spinner"></div><div class="spin-text">${PHASE_TEXT[btnId] || 'Please wait…'}</div>`;

      // gather content
      let content = '';
      for (const id of fields) {
        if (id === 'symptoms') {
          const vals = Array.from(document.querySelectorAll('input[name="symptom"]:checked'))
            .map(cb => cb.value).join(', ');
          content += `symptoms: ${vals}\n`;
        } else {
          const el = document.getElementById(id);
          if (!el) continue;
          if (el.tagName === 'SELECT' && el.multiple) {
            content += `${id}: ${Array.from(el.selectedOptions).map(o => o.value).join(', ')}\n`;
          } else if (el.tagName === 'SELECT') {
            content += `${id}: ${getSelectValue(el)}\n`;
          } else {
            content += `${id}: ${el.value}\n`;
          }
        }
      }

      // call AI
      try {
        const reply = await callOpenAI([
          { role: 'system', content: `Nationality: ${userNationality}` },
          { role: 'system', content: sysPrompt },
          { role: 'user', content }
        ]);
        panel.querySelector('.result-content').innerHTML = formatHTML(reply);
      } catch {
        panel.querySelector('.result-content').innerText = '⚠️ Something went wrong.';
      } finally {
        panel.classList.remove('waiting');
      }
    };
  }

  // ── Wire all modules ───────────────────────────────────────────
  wire(
    'genPlan',
    ['calories','dietType','allergyList','budget'],
    ['calories','dietType'],
    'You are an expert registered dietitian. Given the user’s daily calorie target, diet type, allergies/intolerances, and budget, generate a detailed 7-day meal plan. ' +
    'For each day, list breakfast, lunch, dinner (with approximate calories and macro breakdown), plus a consolidated shopping list at the end.'
  );

  wire(
    'analyzeNutri',
   ['foodLog','unitSelect'],
    ['foodLog'],
    'You are a nutrition scientist. Analyze the user’s food log and unit preference, and produce a complete macro- and micronutrient breakdown. ' +
    'Present totals for calories, protein, carbs, fats, fiber, vitamins, and minerals in a clear table format, and comment on any notable deficiencies or excesses.'
  );

  wire(
    'getRecipes',
    ['pantry','cuisineType','recipeDifficulty','maxTime'],
   ['pantry'],
    'You are a professional chef AI. Given the user’s pantry items, desired cuisine style, difficulty, and maximum prep time, recommend 3 original recipes. ' +
    'For each recipe, include title, ingredients list, step-by-step instructions, and approximate prep & cook times.'
 );

  wire(
    'scanDef',
   ['symptoms','dietOverview'],
    ['symptoms'],
    'You are a clinical dietitian. Based on the user’s selected symptoms and diet overview, identify potential nutrient deficiencies. ' +
    'Provide a ranked list of likely deficiencies, rationale for each, and dietary recommendations (foods or supplements) to address them.'
  );

  wire(
    'runRisk',
    ['riskFrom','riskTo','syncBiomarkers','biomarkers','conditions','context'],
    ['riskFrom','riskTo','biomarkers','conditions','context'],
    'You are a metabolomic health analyst. Given the date range, biomarkers (e.g. glucose, lipids), sync status, conditions, and context, generate an interactive risk radar. ' +
    'Interpret trends, highlight any values outside optimal ranges, and provide actionable health alerts or recommendations.'
  );

  wire(
    'runFitness',
    ['fitGoal','fitFreq','blendIngredients','carbDate','intensity','crpLevel','nutraPref'],
    ['fitGoal','fitFreq'],
    'You are a certified sports nutritionist. Based on the user’s fitness goal, weekly workout frequency, available ingredients, carb-timing start date, intensity level, CRP level, and preferred nutraceuticals, create a customized ‘fitness nutrition coach’ plan. ' +
    'Include daily macro targets, pre/post-workout blend recipes, and recovery recommendations.'
  );

  wire(
    'runPharma',
    ['medList','foodList','compoundGoal','reminderMethod','reminderTime1','reminderTime2','cohortSelect'],
   ['medList'],
    'You are a pharmacologist-dietitian. Analyze drug–food interactions for the given medications and food items, suggest compounding strategies for the desired outcome, schedule reminders per user preference, and deliver analytics comparing the selected cohort.'
  );

  wire(
    'runSymptom',
    ['sympAge','sympDesc','foodPref'],
    ['sympAge','sympDesc'],
    'You are a medical nutrition therapist. Given the user’s age, symptom description, and food preferences, diagnose possible conditions, recommend first-line OTC treatments and appropriate Ghanaian foods to support recovery, with safety notes.'
  );
  
  // ── Chatbot wiring ─────────────────────────────────────────────
  const chatBox  = document.getElementById('dietChatBox'),
        chatHint = document.getElementById('dietHint');
  let history = JSON.parse(localStorage.getItem('chatHistory') || '[]');
  // render past history
  history.forEach(m => addChat(m.who, m.text));

  function addChat(who, txt) {
    const m = document.createElement('div');
    m.className = who === 'You' ? 'user-msg' : 'bot-msg';
    m.innerHTML = `${formatHTML(txt)}<div class="timestamp">${new Date().toLocaleTimeString()}</div>`;
    chatBox.append(m);
    chatBox.scrollTop = chatBox.scrollHeight;
  }

  document.getElementById('sendDiet').type = 'button';
  document.getElementById('sendDiet').onclick = async () => {
    const q = document.getElementById('dietInput').value.trim();
    if (!q) return showToast('Please type a question.');
    addChat('You', q);    
    history.push({ who: 'You', text: q });
    localStorage.setItem('chatHistory', JSON.stringify(history));
    document.getElementById('dietInput').value = '';
    chatHint.style.display = 'block';
    try {
      const reply = await callOpenAI([
        { role: 'system', content: `Nationality: ${userNationality}` },
        { role: 'system', content: 'You are a dietetics assistant.' },
        { role: 'user', content: q }
      ]);
      addChat('AI', reply);
      history.push({ who: 'AI', text: reply });
      localStorage.setItem('chatHistory', JSON.stringify(history));
    } catch {
      addChat('AI', '⚠️ Something went wrong.');
    } finally {
      chatHint.style.display = 'none';
    }
  };

  document.getElementById('clearDiet').type = 'button';
  document.getElementById('clearDiet').onclick = () => {
   chatBox.innerHTML = '';
   history = [];
  };

  document.getElementById('viewDietHistory').type = 'button';
  document.getElementById('viewDietHistory').onclick = () => {
    const modal = document.createElement('div');
    modal.className = 'history-modal';
    modal.innerHTML = `
      <div class="modal-content">
        <h3>Chat History</h3>
        <ul>
          ${history.map((m,i) => `
            <li>
              <span><strong>${m.who}:</strong> ${m.text}</span>
              <button class="delete-btn" data-i="${i}"><i class="fas fa-trash"></i></button>
            </li>`).join('')}
        </ul>
        <div class="button-row">
          <button class="clear-all-btn">Delete Chat History</button>
          <button class="close-modal">Close</button>
        </div>
      </div>`;
    document.body.append(modal);
    modal.querySelectorAll('.delete-btn').forEach(btn => {
      btn.onclick = () => {
        history.splice(btn.dataset.i, 1);
        btn.closest('li').remove();
      };
    });
    modal.querySelector('.clear-all-btn').onclick = () => {
      history = [];
      modal.querySelector('ul').innerHTML = '';
    };
    modal.querySelector('.close-modal').onclick = () => modal.remove();
  };

  // ── Response panel copy/download/close ─────────────────────────
  document.body.addEventListener('click', e => {
    const rp = e.target.closest('.response');
    if (!rp) return;
    if (e.target.closest('.close-btn')) {
      rp.hidden = true;
      return;
    }
    if (e.target.closest('.copy-btn')) {
      const txt = rp.querySelector('.result-content').innerText;
      navigator.clipboard.writeText(txt).then(() => showToast('Copied!'));
      return;
    }
    if (e.target.closest('.dl-btn')) {
      const txt = rp.querySelector('.result-content').innerText;
      const blob = new Blob([txt], { type:'text/plain' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'response.txt';
      a.click();
      return;
    }
  });

  // ── Sidebar & Dark Mode ───────────────────────────────────────
  document.getElementById('hamburger').type = 'button';
  document.getElementById('hamburger').onclick = () => document.body.classList.toggle('sidebar-open');
  document.getElementById('shrinkSidebar').type = 'button';
  document.getElementById('shrinkSidebar').onclick = () => {
    const sb = document.getElementById('sidebar');
    sb.classList.toggle('collapsed');
    const left = sb.classList.contains('collapsed') ? 'var(--sidebar-collapsed)' : 'var(--sidebar-width)';
    document.querySelector('header').style.left = left;
    document.querySelector('main').style.marginLeft = left;
  };
  document.getElementById('themeToggle').type = 'button';
  document.getElementById('themeToggle').onclick = () => {
    document.documentElement.classList.toggle('dark');
    const icon = document.getElementById('themeToggle');
 icon.classList.toggle('fa-moon');
 icon.classList.toggle('fa-sun');
  };

  // ── “Other” inputs visibility ──────────────────────────────────
  document.querySelectorAll('select').forEach(sel => {
    sel.onchange = () => {
      const oi = sel.parentElement.querySelector('.other-input');
      if (oi) oi.style.display = sel.value === 'Other' ? 'block' : 'none';
    };
  });

  // ── Nationality persistence & set button ──────────────────────
  document.getElementById('setNationality').type = 'button';
  document.getElementById('setNationality').onclick = () => {
    const v = document.getElementById('nationality').value.trim();
    if (!v) return showToast('Enter your nationality.');
    localStorage.setItem('nationality', v);
    userNationality = v;
    showToast(`Nationality set to ${v}`);
  };

  // ── Charts + Export Buttons for Progress Charts ───────────────
  // Intake Chart
  const ctx1 = document.getElementById('intakeChart').getContext('2d');
  const intakeChart = new Chart(ctx1, {
    type: 'line',
    data: {
      labels: ['Mon','Tue','Wed','Thu','Fri'],
      datasets: [{
        label: 'Calories In',
        data: [2000,1800,2100,1900,2050],
        borderColor: getComputedStyle(document.documentElement).getPropertyValue('--color-secondary').trim(),
        fill: false
      }]
    }
  });
  const exp1 = document.createElement('button');
  exp1.innerText = 'Export Chart';
  exp1.className = 'export-chart-btn';
  exp1.type = 'button';
  document.getElementById('intakeChart').after(exp1);
  exp1.onclick = () => {
    const a = document.createElement('a');
    a.href = intakeChart.toBase64Image();
    a.download = 'intake-chart.png';
    a.click();
  };

  // Macro Chart
  const ctx2 = document.getElementById('macroChart').getContext('2d');
  const macroChart = new Chart(ctx2, {
    type: 'pie',
    data: {
      labels: ['Carbs','Protein','Fat'],
      datasets: [{ data: [50,25,25] }]
    }
  });
  const exp2 = document.createElement('button');
  exp2.innerText = 'Export Chart';
  exp2.className = 'export-chart-btn';
  exp2.type = 'button';
  document.getElementById('macroChart').after(exp2);
  exp2.onclick = () => {
    const a = document.createElement('a');
    a.href = macroChart.toBase64Image();
    a.download = 'macro-chart.png';
    a.click();
  };
});
</script>
  
</body>
</html>
