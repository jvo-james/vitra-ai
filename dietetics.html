<!DOCTYPE html>
<html lang="en" aria-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Vitra AI – Dietetics & Nutrition</title>
  <!-- Montserrat + FontAwesome -->
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;700&display=swap" rel="stylesheet">
  <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
  /*──────────────────────────────────────────────────────────────────────────────
    RESET & GLOBAL VARIABLES
  ──────────────────────────────────────────────────────────────────────────────*/
  *, *::before, *::after {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }
  html {
    font-family: 'Montserrat', sans-serif;
    font-size: 16px;
    scroll-behavior: smooth;

    /* Color Palette (Pale Yellow primary, Rich Purple secondary) */
    --color-primary: #FDE68A;          /* Pale Yellow */
    --color-primary-alt: #FCD34D;      /* Medium Yellow */
    --color-secondary: #9333EA;        /* Rich Purple */
    --color-secondary-alt: #7E22CE;    /* Deep Purple */
    --color-accent: rgba(255, 250, 235, 0.9); /* Soft Cream */
    --color-bg: #FEFCE8;               /* Very Light Cream */
    --color-surface: #FFFFFF;          /* White Surface */
    --color-text: #3E3E3E;             /* Dark Gray Text */
    --color-muted: #776C5B;            /* Warm Gray */
    --color-disabled: rgba(200,200,200,0.4);
    --radius: 1rem;
    --padding: 1rem;
    --transition: 0.3s ease;
    --shadow-light: 0 4px 12px rgba(0, 0, 0, 0.05);
    --shadow-medium: 0 6px 20px rgba(0, 0, 0, 0.1);
    --sidebar-width: 220px;
    --sidebar-collapsed: 60px;
    --header-height: 60px;
  }
  html.dark {
    --color-bg: #1A1A1A;
    --color-surface: rgba(30, 30, 30, 0.95);
    --color-text: #ECECEC;
    --color-muted: #AAA;
    --color-disabled: rgba(100,100,100,0.4);
  }
  body {
    display: flex;
    min-height: 100vh;
    background: var(--color-bg);
    color: var(--color-text);
    overflow-x: hidden;
    transition: background var(--transition), color var(--transition);
  }
  a {
    color: var(--color-secondary);
    text-decoration: none;
    transition: color var(--transition);
  }
  a:hover {
    color: var(--color-secondary-alt);
  }
  button, input, textarea, select {
    font-family: inherit;
    transition: var(--transition);
  }
  button:disabled,
  input:disabled,
  select:disabled,
  textarea:disabled {
    cursor: not-allowed;
    opacity: 0.6;
  }
  img {
    max-width: 100%;
    display: block;
  }
  ul, ol {
    list-style: none;
  }

  /*──────────────────────────────────────────────────────────────────────────────
    SIDEBAR
  ──────────────────────────────────────────────────────────────────────────────*/
  aside#sidebar {
    position: fixed;
    top: 0;
    left: 0;
    bottom: 0;
    width: var(--sidebar-width);
    background: var(--color-surface);
    box-shadow: var(--shadow-medium);
    display: flex;
    flex-direction: column;
    z-index: 1000;
    transition: width var(--transition), background var(--transition);
  }
  aside#sidebar .brand {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: var(--padding);
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--color-secondary);
  }
  aside#sidebar .brand i {
    font-size: 1.5rem;
  }
  aside#sidebar nav {
    flex: 1;
    overflow-y: auto;
  }
  aside#sidebar nav ul {
    padding: 0;
  }
  aside#sidebar nav li {
    margin-bottom: 0.25rem;
  }
  aside#sidebar nav a {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem var(--padding);
    border-radius: var(--radius);
    color: var(--color-text);
    transition: background var(--transition), transform var(--transition);
  }
  aside#sidebar nav a i {
    width: 1.25rem;
    text-align: center;
    font-size: 1.25rem;
    color: var(--color-secondary);
  }
  aside#sidebar nav a:hover,
  aside#sidebar nav .active a {
    background: var(--color-primary);
    color: var(--color-text);
    transform: translateX(4px);
  }
  aside#sidebar nav .active a i {
    color: var(--color-text);
  }
  #shrinkSidebar {
    margin: var(--padding) auto;
    background: var(--color-secondary);
    border: none;
    border-radius: 50%;
    width: 36px;
    height: 36px;
    color: #fff;
    box-shadow: var(--shadow-medium);
    cursor: pointer;
    transition: background var(--transition), transform var(--transition);
  }
  #shrinkSidebar:hover {
    background: var(--color-secondary-alt);
    transform: scale(1.05);
  }
  aside#sidebar.collapsed {
    width: var(--sidebar-collapsed);
  }
  aside#sidebar.collapsed .brand span,
  aside#sidebar.collapsed nav a span {
    display: none;
  }
  aside#sidebar.collapsed nav a {
    justify-content: center;
  }

  /*──────────────────────────────────────────────────────────────────────────────
    HEADER
  ──────────────────────────────────────────────────────────────────────────────*/
  header {
    position: fixed;
    top: 0;
    left: var(--sidebar-width);
    right: 0;
    height: var(--header-height);
    background: var(--color-surface);
    box-shadow: var(--shadow-medium);
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 var(--padding);
    z-index: 1001;
    transition: left var(--transition), background var(--transition);
  }
  header h1 {
    font-size: 1.5rem;
    font-weight: 600;
    color: var(--color-secondary);
  }
  header #hamburger,
  header #themeToggle {
    font-size: 1.5rem;
    color: var(--color-secondary);
    cursor: pointer;
    transition: transform var(--transition), color var(--transition);
  }
  header #hamburger:hover,
  header #themeToggle:hover {
    transform: scale(1.1);
    color: var(--color-secondary-alt);
  }
  @media (max-width: 768px) {
    header #hamburger {
      display: block;
    }
    header, main {
      left: 0 !important;
    }
    aside#sidebar {
      transform: translateX(-100%);
      transition: transform var(--transition);
    }
    aside#sidebar.open {
      transform: translateX(0);
    }
  }

  /*──────────────────────────────────────────────────────────────────────────────
    MAIN CONTENT & MODULES
  ──────────────────────────────────────────────────────────────────────────────*/
  main {
    flex: 1;
    margin-top: var(--header-height);
    margin-left: var(--sidebar-width);
    padding: var(--padding);
    transition: margin-left var(--transition);
  }
  section.module {
    background: var(--color-surface);
    border-radius: var(--radius);
    padding: var(--padding);
    margin-bottom: 1.5rem;
    box-shadow: var(--shadow-medium);
    transition: transform var(--transition), background var(--transition);
    position: relative;
  }
  section.module:hover:not(.disabled) {
    transform: translateY(-4px);
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
  }
  section.module.disabled {
    opacity: 0.4;
    pointer-events: none;
  }
  h2 {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 1.6rem;
    color: var(--color-secondary);
    margin-bottom: 0.75rem;
  }
  .desc {
    color: var(--color-muted);
    margin-bottom: 1rem;
    font-size: 0.95rem;
  }

  /*──────────────────────────────────────────────────────────────────────────────
    HERO SECTION
  ──────────────────────────────────────────────────────────────────────────────*/
  #hero {
    position: relative;
    overflow: hidden;
    background: url('dietetics-hero.jpg') center/cover no-repeat; /* Replace with actual image path */
    border-radius: var(--radius);
    padding: 3rem 2rem;
    box-shadow: var(--shadow-medium);
    margin-bottom: 1.5rem;
  }
  #hero::after {
    content: '';
    position: absolute;
    inset: 0;
    background: rgba(254, 252, 232, 0.7);
    pointer-events: none;
  }
  #hero .hero-inner {
    position: relative;
    z-index: 1;
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    max-width: 1200px;
    margin: 0 auto;
    gap: 2rem;
  }
  #hero .hero-content {
    flex: 1;
    min-width: 280px;
  }
  #hero h2 {
    font-size: 2.4rem;
    color: var(--color-secondary);
  }
  #hero p.desc {
    font-size: 1.05rem;
    margin-top: 0.5rem;
    color: var(--color-text);
  }
  #hero .hero-features {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    gap: 1rem;
    margin-top: 2rem;
    width: 100%;
  }
  .feature-card {
    background: var(--color-accent);
    border-radius: var(--radius);
    padding: var(--padding);
    box-shadow: var(--shadow-light);
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    transition: transform var(--transition), box-shadow var(--transition);
  }
  .feature-card:hover {
    transform: translateY(-5px);
    box-shadow: var(--shadow-medium);
  }
  .feature-card i {
    font-size: 1.75rem;
    color: var(--color-secondary);
  }
  .feature-card h3 {
    font-size: 1.25rem;
    margin-bottom: 0.5rem;
    color: var(--color-secondary);
  }
  .feature-card input[type="text"],
  .feature-card input[type="number"],
  .feature-card select {
    width: 100%;
    padding: 0.75rem;
    border: 2px solid var(--color-primary-alt);
    border-radius: var(--radius);
    background: #fff;
    color: var(--color-text);
    font-size: 0.95rem;
    transition: border-color var(--transition), box-shadow var(--transition);
  }
  .feature-card input:focus,
  .feature-card select:focus {
    border-color: var(--color-secondary);
    box-shadow: 0 0 8px var(--color-secondary);
    outline: none;
  }
  .feature-card button.btn {
    align-self: flex-end;
    background: var(--color-secondary);
    color: #fff;
    padding: 0.7rem 1.4rem;
    border: none;
    font-size: 0.95rem;
    font-weight: 600;
    border-radius: var(--radius);
    cursor: pointer;
    box-shadow: var(--shadow-light);
    transition: background var(--transition), transform var(--transition), box-shadow var(--transition);
  }
  .feature-card button.btn:hover {
    background: var(--color-secondary-alt);
    transform: translateY(-2px);
    box-shadow: var(--shadow-medium);
  }

  /* Decorative Stickers */
  .sticker {
    position: absolute;
    font-size: 4rem;
    color: var(--color-primary-alt);
    opacity: 0.25;
    transition: transform var(--transition), opacity var(--transition);
  }
  .sticker:hover {
    transform: scale(1.1) rotate(0deg);
    opacity: 0.4;
  }
  .sticker-1 { top: 1rem; left: 2rem; transform: rotate(-15deg); }
  .sticker-2 { top: 3rem; right: 3rem; transform: rotate(10deg); }
  .sticker-3 { bottom: 2rem; left: 50%; transform: translateX(-50%) rotate(-5deg); }
  /* Additional stickers positions can be customized as needed */

  /*──────────────────────────────────────────────────────────────────────────────
    “Nationalit​y” LABEL & BUTTON
  ──────────────────────────────────────────────────────────────────────────────*/
  #nationality-label {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    font-weight: 600;
    color: var(--color-secondary);
    margin-bottom: 0.75rem;
  }
  #nationality {
    flex: 1;
    padding: 0.75rem;
    border: 2px solid var(--color-primary-alt);
    border-radius: var(--radius);
    background: #fff;
    color: var(--color-text);
    font-size: 0.95rem;
    transition: border-color var(--transition), box-shadow var(--transition);
  }
  #nationality:focus {
    border-color: var(--color-secondary);
    box-shadow: 0 0 8px var(--color-secondary);
    outline: none;
  }
  #setNationality {
    margin-top: 0.5rem;
    background: var(--color-secondary);
    color: #fff;
    border: none;
    border-radius: var(--radius);
    padding: 0.75rem 1rem;
    font-weight: 600;
    cursor: pointer;
    box-shadow: var(--shadow-light);
    transition: background var(--transition), transform var(--transition), box-shadow var(--transition);
  }
  #setNationality:hover {
    background: var(--color-secondary-alt);
    transform: translateY(-2px);
    box-shadow: var(--shadow-medium);
  }

  /*──────────────────────────────────────────────────────────────────────────────
    CHATBOT SECTION
  ──────────────────────────────────────────────────────────────────────────────*/
  #dietBot .chat-controls {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 0.75rem;
  }
  #dietBot .chat-controls button {
    background: none;
    border: 2px solid var(--color-secondary);
    color: var(--color-secondary);
    border-radius: 50%;
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1rem;
    cursor: pointer;
    transition: background var(--transition), color var(--transition), transform var(--transition);
  }
  #dietBot .chat-controls button:hover {
    background: var(--color-secondary);
    color: #fff;
    transform: scale(1.1);
  }
  .chat-box {
    background: var(--color-accent);
    border: 1px solid var(--color-muted);
    border-radius: var(--radius);
    padding: var(--padding);
    max-height: 400px;
    overflow-y: auto;
    min-height: 200px;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    transition: background var(--transition), border-color var(--transition);
  }
  .chat-input {
    display: flex;
    gap: 0.5rem;
    margin-top: 0.5rem;
  }
  .chat-input input {
    flex: 1;
    padding: 0.75rem;
    border: 2px solid var(--color-primary-alt);
    border-radius: var(--radius);
    background: #fff;
    color: var(--color-text);
    font-size: 0.95rem;
    transition: border-color var(--transition), box-shadow var(--transition);
  }
  .chat-input input:focus {
    border-color: var(--color-secondary);
    box-shadow: 0 0 8px var(--color-secondary);
    outline: none;
  }
  .chat-input button {
    background: var(--color-secondary);
    border: none;
    border-radius: 50%;
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #fff;
    font-size: 1rem;
    cursor: pointer;
    transition: background var(--transition), transform var(--transition);
  }
  .chat-input button:hover {
    background: var(--color-secondary-alt);
    transform: scale(1.1);
  }
  .user-msg,
  .bot-msg {
    max-width: 80%;
    padding: 0.75rem 1rem;
    border-radius: var(--radius);
    position: relative;
    line-height: 1.4;
    transition: background var(--transition), color var(--transition);
  }
  .user-msg {
    background: var(--color-secondary);
    color: #fff;
    align-self: flex-end;
    border-bottom-right-radius: 0.2rem;
  }
  .bot-msg {
    background: var(--color-accent);
    color: var(--color-text);
    align-self: flex-start;
    border-bottom-left-radius: 0.2rem;
  }
  html.dark .bot-msg {
    background: var(--color-surface);
    color: var(--color-text);
  }
  .timestamp {
    font-size: 0.7rem;
    color: var(--color-muted);
    position: absolute;
    bottom: -1.2rem;
    right: 0.8rem;
  }
  .date-separator {
    text-align: center;
    margin: 1rem 0;
    font-weight: bold;
    color: var(--color-secondary);
    user-select: none;
  }

  /*──────────────────────────────────────────────────────────────────────────────
    “OTHER” INPUT FIELDS
  ──────────────────────────────────────────────────────────────────────────────*/
  .other-input {
    display: none;
    margin-top: 0.5rem;
    padding: 0.75rem;
    border: 2px solid var(--color-primary-alt);
    background: #fff;
    color: var(--color-text);
    font-size: 0.95rem;
    border-radius: var(--radius);
    transition: border-color var(--transition), box-shadow var(--transition);
  }
  .other-input:focus {
    border-color: var(--color-secondary);
    box-shadow: 0 0 8px var(--color-secondary);
    outline: none;
  }

  /*──────────────────────────────────────────────────────────────────────────────
    FORMS, LABELS & INPUTS
  ──────────────────────────────────────────────────────────────────────────────*/
  label {
    display: flex;
    flex-direction: column;
    font-size: 0.95rem;
    color: var(--color-text);
    margin-bottom: 0.75rem;
  }
  input[type="text"],
  input[type="number"],
  input[type="date"],
  input[type="time"],
  textarea,
  select {
    padding: 0.75rem;
    border: 2px solid var(--color-primary-alt);
    border-radius: var(--radius);
    background: #fff;
    color: var(--color-text);
    font-size: 0.95rem;
    transition: border-color var(--transition), box-shadow var(--transition);
  }
  input:focus,
  textarea:focus,
  select:focus {
    border-color: var(--color-secondary);
    box-shadow: 0 0 8px var(--color-secondary);
    outline: none;
  }
  textarea {
    resize: vertical;
  }
  button.btn {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1.25rem;
    background: var(--color-primary);
    color: var(--color-text);
    border: none;
    border-radius: var(--radius);
    font-weight: 600;
    box-shadow: var(--shadow-light);
    cursor: pointer;
    transition: background var(--transition), transform var(--transition), box-shadow var(--transition);
  }
  button.btn:hover:not([disabled]) {
    background: var(--color-primary-alt);
    transform: translateY(-2px);
    box-shadow: var(--shadow-medium);
  }
  button.btn-secondary {
    background: var(--color-secondary);
    color: #fff;
  }
  button.btn-secondary:hover:not([disabled]) {
    background: var(--color-secondary-alt);
  }

  /*──────────────────────────────────────────────────────────────────────────────
    RESPONSE PANELS
  ──────────────────────────────────────────────────────────────────────────────*/
  .response {
    background: var(--color-surface);
    border-left: 4px solid var(--color-secondary);
    border-radius: var(--radius);
    padding: var(--padding);
    margin-top: 1rem;
    position: relative;
    box-shadow: var(--shadow-medium);
    transition: background var(--transition), box-shadow var(--transition);
  }
  .response.waiting {
    opacity: 0.8;
  }
  .response .close-btn {
    position: absolute;
    top: var(--padding);
    right: var(--padding);
    background: none;
    border: none;
    font-size: 1.25rem;
    color: var(--color-secondary);
    cursor: pointer;
    transition: color var(--transition), transform var(--transition);
  }
  .response .close-btn:hover {
    color: var(--color-secondary-alt);
    transform: scale(1.1);
  }
  .response .result-content {
    margin-top: 1.5rem;
    color: var(--color-text);
    line-height: 1.5;
    white-space: pre-wrap;
  }
  .tool-row {
    position: absolute;
    bottom: var(--padding);
    right: var(--padding);
    display: flex;
    gap: 0.5rem;
  }
  .copy-btn, .dl-btn {
    background: none;
    border: none;
    cursor: pointer;
    padding: 0.25rem;
    color: var(--color-secondary);
    font-size: 1rem;
    transition: background var(--transition), color var(--transition), transform var(--transition);
  }
  .copy-btn:hover, .dl-btn:hover {
    background: var(--color-primary);
    color: var(--color-text);
    transform: scale(1.1);
  }

  /*──────────────────────────────────────────────────────────────────────────────
    CHECKBOX GROUPS
  ──────────────────────────────────────────────────────────────────────────────*/
  .checkbox-group {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: 0.75rem;
    align-items: flex-start;
  }
  .checkbox-group label {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 0.75rem;
    background: var(--color-surface);
    border: 1px solid var(--color-muted);
    border-radius: var(--radius);
    cursor: pointer;
    transition: background var(--transition), transform var(--transition);
  }
  .checkbox-group input[type="checkbox"] {
    width: 1rem;
    height: 1rem;
    accent-color: var(--color-secondary);
  }
  .checkbox-group label:hover {
    background: var(--color-accent);
    transform: translateY(-2px);
  }
  .checkbox-group input[type="checkbox"][value="Other"]:checked ~ 
  input.other-input {
    display: block;
    width: 100%;
    margin-top: 0.5rem;
  }

  /*──────────────────────────────────────────────────────────────────────────────
    HISTORY MODAL (CHAT HISTORY)
  ──────────────────────────────────────────────────────────────────────────────*/
  .history-modal {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 2000;
  }
  .history-content {
    background: var(--color-surface);
    border-radius: var(--radius);
    width: 90%;
    max-width: 600px;
    max-height: 80vh;
    display: grid;
    grid-template-rows: auto 1fr auto;
    box-shadow: var(--shadow-medium);
    overflow: hidden;
  }
  .history-content h3 {
    padding: 1rem;
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--color-secondary);
    border-bottom: 1px solid var(--color-muted);
  }
  .history-content ul {
    flex: 1 1 auto;
    overflow-y: auto;
    padding: 0 1rem;
    list-style: none;
  }
  .history-content ul li {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem 0;
    border-bottom: 1px solid var(--color-muted);
    font-size: 0.95rem;
  }
  .history-content ul li .history-date {
    color: var(--color-muted);
    font-size: 0.85rem;
    margin-top: 0.25rem;
  }
  .history-content .del-msg {
    background: none;
    border: none;
    color: var(--color-secondary);
    font-size: 1rem;
    cursor: pointer;
    transition: color var(--transition), transform var(--transition);
  }
  .history-content .del-msg:hover {
    color: var(--color-secondary-alt);
    transform: scale(1.1);
  }
  .history-content .button-row {
    display: flex;
    gap: 0.5rem;
    padding: 0.75rem 1rem;
    background: var(--color-surface);
    border-top: 1px solid var(--color-muted);
  }
  .history-content .button-row button {
    flex: 1;
    padding: 0.5rem;
    border: none;
    border-radius: var(--radius);
    cursor: pointer;
    transition: background var(--transition), transform var(--transition);
    font-size: 0.95rem;
    font-weight: 600;
  }
  .history-content .clear-history {
    background: var(--color-secondary);
    color: #fff;
  }
  .history-content .clear-history:hover {
    background: var(--color-secondary-alt);
    transform: translateY(-2px);
  }
  .history-content .close-history {
    background: var(--color-primary);
    color: var(--color-text);
  }
  .history-content .close-history:hover {
    background: var(--color-primary-alt);
    transform: translateY(-2px);
  }

  /*──────────────────────────────────────────────────────────────────────────────
    CHECKBOX-OTHER INPUTS (SYMPTOMS)
  ──────────────────────────────────────────────────────────────────────────────*/
  #otherSymptom {
    display: none;
    margin-left: 0.5rem;
    padding: 0.5rem;
    border: 2px solid var(--color-primary-alt);
    border-radius: var(--radius);
    background: #fff;
    color: var(--color-text);
    font-size: 0.9rem;
    transition: border-color var(--transition), box-shadow var(--transition);
  }
  #otherSymptom:focus {
    border-color: var(--color-secondary);
    box-shadow: 0 0 8px var(--color-secondary);
    outline: none;
  }

  /*──────────────────────────────────────────────────────────────────────────────
    PROGRESS CHARTS & EXPORT BUTTONS
  ──────────────────────────────────────────────────────────────────────────────*/
  #progressCharts {
    display: grid;
    grid-template-columns: 1fr;
    gap: 1rem;
  }
  #progressCharts canvas {
    background: var(--color-surface);
    border-radius: var(--radius);
    box-shadow: var(--shadow-light);
    padding: 0.5rem;
  }
  @media (min-width: 1025px) {
    #progressCharts {
      grid-template-columns: 1fr 1fr;
    }
    #progressCharts canvas {
      height: 300px !important;
    }
  }

  /*──────────────────────────────────────────────────────────────────────────────
    RESPONSIVE ADJUSTMENTS
  ──────────────────────────────────────────────────────────────────────────────*/
  @media (max-width: 1024px) {
    main {
      margin-left: 0;
      padding: var(--padding) 0.5rem;
    }
    #hero .hero-inner {
      flex-direction: column;
      gap: 2rem;
    }
    #hero h2 {
      font-size: 2rem;
    }
    #hero p.desc {
      font-size: 1rem;
    }
    .hero-features {
      grid-template-columns: 1fr;
    }
  }
  @media (max-width: 768px) {
    section.module {
      padding: 0.75rem;
    }
    .chat-controls,
    .chat-input {
      flex-direction: column;
      gap: 0.75rem;
    }
    .tool-row {
      position: static;
      margin-top: 0.5rem;
    }
    .feature-card input,
    .feature-card button {
      width: 100%;
    }
  }
  @media (max-width: 640px) {
    header h1 {
      font-size: 1.25rem;
    }
    #hero h2 {
      font-size: 1.8rem;
    }
    #hero p.desc {
      font-size: 0.95rem;
    }
    #hero {
      padding: 2rem 1rem;
    }
    #hero .hero-features {
      gap: 1rem;
    }
    #shrinkSidebar {
      width: 32px;
      height: 32px;
    }
  }
</style>


</head>


  <body>
  <!-- Sidebar -->
  <aside id="sidebar">
    <div class="brand">
      <i class="fas fa-utensils"></i>
      <span>Vitra AI Dietetics</span>
    </div>
    <nav>
      <ul>
        <li><a href="herbal.html"><i class="fas fa-seedling"></i> <span>Herbal Medicine</span></a></li>
        <li><a href="psych.html"><i class="fas fa-brain"></i> <span>Psychology &amp; MH</span></a></li>
        <li class="active"><a href="#"><i class="fas fa-apple-alt"></i> <span>Dietetics</span></a></li>
        <li><a href="pharmacy.html"><i class="fas fa-prescription-bottle-alt"></i> <span>E-Pharmacy</span></a></li>
        <li><a href="consult.html"><i class="fas fa-calendar-check"></i> <span>Consult Booking</span></a></li>
      </ul>
    </nav>
    <button id="shrinkSidebar" aria-label="Toggle sidebar">
      <i class="fas fa-angle-double-left"></i>
    </button>
  </aside>

  <!-- Header -->
  <header>
    <i id="hamburger" class="fas fa-bars" aria-label="Open menu"></i>
    <h1>Dietetics &amp; Nutrition</h1>
    <i id="themeToggle" class="fas fa-moon" aria-label="Toggle dark mode"></i>
  </header>

  <!-- Main Content -->
  <main>
    <!-- Hero Section -->
    <section id="hero" class="module hero-module">
      <div class="hero-inner">
        <!-- Left Content -->
        <div class="hero-content">
          <h1><i class="fas fa-apple-alt"></i> Nourish Your Body, Empower Your Life</h1>
          <p class="hero-subtitle">Delicious, science-backed guidance—tailored to you.</p>
          <!-- Today's Nutrition Tip & Nationality Input -->
          <div class="hero-features">
            <!-- Today's Nutrition Tip Card -->
            <div class="feature-card">
              <i class="fas fa-lightbulb"></i>
              <h3>Today's Nutrition Tip</h3>
              <div id="dailyTip" class="response">
                <button class="close-btn"><i class="fas fa-times"></i></button>
                <div class="tool-row">
                  <button class="copy-btn"><i class="fas fa-copy"></i></button>
                  <button class="dl-btn"><i class="fas fa-download"></i></button>
                </div>
                <div class="result-content">Enjoy a handful of mixed berries at breakfast to boost your antioxidant intake and support healthy digestion.</div>
              </div>
              <button id="refreshTip" class="btn-secondary">Refresh Tip</button>
            </div>
            <!-- Nationality Input Card -->
            <div class="feature-card">
              <i class="fas fa-globe"></i>
              <h3>Your Nationality</h3>
              <input type="text" id="nationality" placeholder="e.g. Ghanaian" required>
              <button id="setNationality" class="btn-secondary">Set Nationality</button>
            </div>
          </div>
        </div>
        <!-- Right Hero Image -->
        <div class="hero-image">
          <img src="https://images.unsplash.com/photo-1512058564366-c9e7b6d1de30?auto=format&fit=crop&w=800&q=80" alt="Vibrant plate of healthy food">
        </div>
      </div>
      <!-- Decorative Stickers (Avoid Overlapping Image) -->
      <i class="fas fa-pepper-hot sticker sticker-1"></i>
      <i class="fas fa-carrot sticker sticker-2"></i>
      <i class="fas fa-ice-cream sticker sticker-3"></i>
      <i class="fas fa-bread-slice sticker" style="top:5%;right:10%;"></i>
      <i class="fas fa-lemon sticker" style="bottom:10%;left:12%;"></i>
      <i class="fas fa-fish sticker" style="bottom:15%;right:15%;"></i>
    </section>

    <!-- Nutrition Chatbot -->
    <section id="dietBot" class="module">
      <h2><i class="fas fa-comments"></i> Nutrition Chatbot</h2>
      <p class="desc">Ask your diet or nutrition questions for instant, expert advice.</p>
      <div class="chat-controls">
        <button id="clearDiet" class="btn-secondary"><i class="fas fa-trash"></i> Clear Chat</button>
        <button id="viewDietHistory" class="btn-secondary"><i class="fas fa-history"></i> Chat History</button>
      </div>
      <div id="dietChatBox" class="chat-box"></div>
      <form id="diet-form" class="chat-input">
        <input id="dietInput" type="text" placeholder="Type your question…" required>
        <button id="sendDiet" class="btn"><i class="fas fa-paper-plane"></i></button>
      </form>
      <div id="dietHint" class="desc" style="display:none;">AI is thinking…</div>
    </section>

    <!-- Meal Plan Generator -->
    <section id="mealPlanner" class="module">
      <h2><i class="fas fa-calendar-alt"></i> Meal Plan Generator</h2>
      <p class="desc">Create a 7-day plan that fits your calories, style, and restrictions.</p>
      <form id="planner-form">
        <label>Daily Calories:
          <input type="number" id="calories" min="800" max="4000" value="2000" required>
        </label>
        <label>Diet Type:
          <select id="dietType">
            <option>Balanced</option>
            <option>Low-Carb</option>
            <option>Vegan</option>
            <option>Ketogenic</option>
            <option>Mediterranean</option>
            <option>Plant-Based</option>
            <option value="Other">Other</option>
          </select>
          <input class="other-input" placeholder="Specify diet…" style="display:none;">
        </label>
        <label>Allergies &amp; Intolerances:
          <select id="allergyList" multiple>
            <option>Gluten</option><option>Dairy</option><option>Nuts</option>
            <option>Shellfish</option><option>Soy</option><option>Eggs</option>
            <option>Sesame</option><option>Other</option>
          </select>
          <input class="other-input" placeholder="Specify others…" style="display:none;">
        </label>
        <label>Budget:
          <select id="budget">
            <option>Low</option><option>Medium</option><option>High</option>
          </select>
        </label>
        <button id="genPlan" class="btn"><i class="fas fa-utensils"></i> Generate Plan</button>
      </form>
      <div id="planPanel" class="response" hidden>
        <button class="close-btn"><i class="fas fa-times"></i></button>
        <div class="tool-row">
          <button class="copy-btn"><i class="fas fa-copy"></i></button>
          <button class="dl-btn"><i class="fas fa-download"></i></button>
        </div>
        <div class="result-content"></div>
      </div>
    </section>

    <!-- Nutrient Analyzer -->
    <section id="nutriAnalyzer" class="module">
      <h2><i class="fas fa-vial"></i> Nutrient Analyzer</h2>
      <p class="desc">Get a complete macro and micronutrient breakdown of any recipe or meal log.</p>
      <form id="analyze-form">
        <label>Ingredients / Food Log:
          <textarea id="foodLog" rows="4" placeholder="e.g. 200g yam, 1 egg, spinach…"></textarea>
        </label>
        <label>Portion Size Units:
          <select id="unitSelect">
            <option>grams</option><option>pieces</option><option>cups</option>
            <option>tablespoons</option><option>servings</option>
          </select>
        </label>
        <button id="analyzeNutri" class="btn"><i class="fas fa-chart-bar"></i> Analyze</button>
      </form>
      <div id="nutriPanel" class="response" hidden>
        <button class="close-btn"><i class="fas fa-times"></i></button>
        <div class="tool-row">
          <button class="copy-btn"><i class="fas fa-copy"></i></button>
          <button class="dl-btn"><i class="fas fa-download"></i></button>
        </div>
        <div class="result-content"></div>
      </div>
    </section>

    <!-- Recipe Recommender -->
    <section id="recipeRec" class="module">
      <h2><i class="fas fa-book-open"></i> Recipe Recommender</h2>
      <p class="desc">Turn your pantry into delicious meals across global cuisines.</p>
      <form id="recipe-form">
        <label>Pantry Items:
          <input id="pantry" type="text" placeholder="e.g. Rice, Beans, Plantain">
        </label>
        <label>Cuisine Style:
          <select id="cuisineType">
            <option>West African</option><option>Italian</option><option>Asian Fusion</option>
            <option>Mexican</option><option>Middle Eastern</option><option value="Other">Other</option>
          </select>
          <input class="other-input" placeholder="Specify cuisine…" style="display:none;">
        </label>
        <label>Difficulty:
          <select id="recipeDifficulty">
            <option>Easy</option><option>Medium</option><option>Advanced</option>
          </select>
        </label>
        <label>Max Prep Time:
          <input type="number" id="maxTime" min="5" max="180" value="30"> minutes
        </label>
        <button id="getRecipes" class="btn"><i class="fas fa-hamburger"></i> Get Recipes</button>
      </form>
      <div id="recipePanel" class="response" hidden>
        <button class="close-btn"><i class="fas fa-times"></i></button>
        <div class="tool-row">
          <button class="copy-btn"><i class="fas fa-copy"></i></button>
          <button class="dl-btn"><i class="fas fa-download"></i></button>
        </div>
        <div class="result-content"></div>
      </div>
    </section>

    <!-- Deficiency Risk Scanner -->
    <section id="deficiency" class="module">
      <h2><i class="fas fa-exclamation-triangle"></i> Deficiency Risk Scanner</h2>
      <p class="desc">Identify potential nutrient shortfalls based on symptoms and diet.</p>
      <form id="def-form">
        <label>Select Symptoms (up to 5):
          <div class="checkbox-group">
            <label><input type="checkbox" name="symptom" value="Fatigue"> Fatigue</label>
            <label><input type="checkbox" name="symptom" value="Hair Loss"> Hair Loss</label>
            <label><input type="checkbox" name="symptom" value="Muscle Cramps"> Muscle Cramps</label>
            <label><input type="checkbox" name="symptom" value="Pale Skin"> Pale Skin</label>
            <label><input type="checkbox" name="symptom" value="Bleeding Gums"> Bleeding Gums</label>
            <label><input type="checkbox" name="symptom" value="Bone Pain"> Bone Pain</label>
            <label><input type="checkbox" name="symptom" value="Bruising"> Bruising</label>
            <label>
              <input type="checkbox" name="symptom" value="Other"> Other
              <input type="text" id="otherSymptom" class="other-input" placeholder="Specify…">
            </label>
          </div>
        </label>
        <label>Brief Diet Overview:
          <textarea id="dietOverview" rows="3" placeholder="e.g. Mostly rice, occasional vegetables…"></textarea>
        </label>
        <button id="scanDef" class="btn"><i class="fas fa-stethoscope"></i> Scan Deficiency</button>
      </form>
      <div id="defPanel" class="response" hidden>
        <button class="close-btn"><i class="fas fa-times"></i></button>
        <div class="tool-row">
          <button class="copy-btn"><i class="fas fa-copy"></i></button>
          <button class="dl-btn"><i class="fas fa-download"></i></button>
        </div>
        <div class="result-content"></div>
      </div>
    </section>

    <!-- Metabolomic Risk Radar -->
    <section id="riskRadar" class="module">
      <h2><i class="fas fa-chart-pie"></i> Metabolomic Risk Radar</h2>
      <p class="desc">
        Track biomarkers (e.g., glucose, lipids) over any date range to generate an interactive radar chart and predictive alerts.
      </p>
      <form id="risk-form">
        <label>Date Range:
          <input type="date" id="riskFrom"> – <input type="date" id="riskTo">
        </label>
        <label><input type="checkbox" id="syncBiomarkers"> Enable Continuous Biomarker Sync</label>
        <label>Biomarkers (comma-sep):
          <input id="biomarkers" type="text" placeholder="e.g. glucose, LDL…">
        </label>
        <label>Conditions:
          <input id="conditions" type="text" placeholder="e.g. prediabetes…">
        </label>
        <label>Context:
          <input id="context" type="text" placeholder="e.g. routine check…">
        </label>
        <button id="runRisk" class="btn"><i class="fas fa-biohazard"></i> Run Radar</button>
      </form>
      <div id="riskPanel" class="response" hidden>
        <button class="close-btn"><i class="fas fa-times"></i></button>
        <div class="tool-row">
          <button class="copy-btn"><i class="fas fa-copy"></i></button>
          <button class="dl-btn"><i class="fas fa-download"></i></button>
        </div>
        <div class="result-content"></div>
      </div>
    </section>

    <!-- AI-Driven Fitness Nutrition Coach -->
    <section id="fitnessCoach" class="module">
      <h2><i class="fas fa-dumbbell"></i> Fitness Nutrition Coach</h2>
      <p class="desc">Customize your macros, pre/post-workout blends, and recovery support.</p>
      <form id="fitness-form">
        <!-- 1. Performance Profiling -->
        <fieldset>
          <legend>1. Performance Profiling</legend>
          <label>Workout Goal:
            <select id="fitGoal">
              <option>Endurance</option>
              <option>Strength</option>
              <option>Hybrid</option>
              <option>Weight Loss</option>
              <option>General Health</option>
              <option value="Other">Other</option>
            </select>
            <input class="other-input" placeholder="Specify goal…" style="display:none;">
          </label>
          <label>Weekly Workouts:
            <select id="fitFreq">
              <option>1–2</option><option>3–4</option><option>5–7</option>
            </select>
          </label>
        </fieldset>
        <!-- 2. Pre/Post-Workout -->
        <fieldset>
          <legend>2. Pre/Post-Workout Micro-Blends</legend>
          <label>Available Ingredients:
            <select id="blendIngredients" multiple>
              <option>Pea Protein</option><option>Beetroot Powder</option>
              <option>Taurine</option><option>Banana</option>
              <option>Oats</option><option value="Other">Other</option>
            </select>
            <input class="other-input" placeholder="Add ingredient…" style="display:none;">
          </label>
        </fieldset>
        <!-- 3. Carb-Timing Calendar -->
        <fieldset>
          <legend>3. Carb-Timing Calendar</legend>
          <label>Start Date:
            <input type="date" id="carbDate">
          </label>
          <label>Intensity Level:
            <select id="intensity">
              <option>Low</option><option>Moderate</option><option>High</option>
            </select>
          </label>
        </fieldset>
        <!-- 4. Recovery Monitor -->
        <fieldset>
          <legend>4. Recovery &amp; Inflammation</legend>
          <label>Track CRP &amp; CK Levels:
            <input type="number" id="crpLevel" placeholder="CRP mg/L">
          </label>
          <label>Nutraceutical Preference:
            <select id="nutraPref">
              <option>Curcumin</option><option>Omega-3</option>
              <option>Turmeric</option><option>Ginger</option>
              <option value="Other">Other</option>
            </select>
            <input class="other-input" placeholder="Specify…" style="display:none;">
          </label>
        </fieldset>
        <button id="runFitness" class="btn"><i class="fas fa-running"></i> Generate Plan</button>
      </form>
      <div id="fitnessPanel" class="response" hidden>
        <button class="close-btn"><i class="fas fa-times"></i></button>
        <div class="tool-row">
          <button class="copy-btn"><i class="fas fa-copy"></i></button>
          <button class="dl-btn"><i class="fas fa-download"></i></button>
        </div>
        <div class="result-content"></div>
      </div>
    </section>

    <!-- Pharma-Integrated Nutrient & Medication Suite -->
    <section id="pharmaSuite" class="module">
      <h2><i class="fas fa-pills"></i> Pharma-Integrated Nutrient &amp; Medication Suite</h2>
      <p class="desc">Check drug–nutrient interactions, compounding suggestions, reminders &amp; analytics.</p>
      <form id="pharma-form">
        <!-- 1. Drug–Nutrient Interaction -->
        <fieldset>
          <legend>1. Interaction Engine</legend>
          <label>Medications (comma-sep):
            <input id="medList" type="text" placeholder="e.g. Warfarin, Metformin">
          </label>
          <label>Food Items (comma-sep):
            <input id="foodList" type="text" placeholder="e.g. Grapefruit, Spinach">
          </label>
        </fieldset>
        <!-- 2. Custom Compounding -->
        <fieldset>
          <legend>2. Compounding Suggestions</legend>
          <label>Desired Outcome:
            <select id="compoundGoal">
              <option>Increased Absorption</option><option>Anti-inflammatory</option>
              <option>Energy Boost</option><option value="Other">Other</option>
            </select>
            <input class="other-input" placeholder="Specify…" style="display:none;">
          </label>
        </fieldset>
        <!-- 3. Adherence & Reminder Hub -->
        <fieldset>
          <legend>3. Medication Scheduling</legend>
          <label>Dosage Frequency:
            <select id="doseFreq">
              <option>Once daily</option><option>Twice daily</option>
              <option>With meals</option><option value="Other">Other</option>
            </select>
          </label>
          <label>Custom Schedule Notes:
            <textarea id="scheduleNotes" rows="2" placeholder="e.g. take with water, avoid night…"></textarea>
          </label>
        </fieldset>
        <!-- 4. Outcome Analytics -->
        <fieldset>
          <legend>4. Outcome Analytics</legend>
          <label>Compare Cohort:
            <select id="cohortSelect">
              <option>Diet-only</option><option>Diet+Supplements</option>
              <option>Diet+Meds</option><option value="Other">Other</option>
            </select>
            <input class="other-input" placeholder="Specify…" style="display:none;">
          </label>
        </fieldset>
        <button id="runPharma" class="btn"><i class="fas fa-flask"></i> Run Suite</button>
      </form>
      <div id="pharmaPanel" class="response" hidden>
        <button class="close-btn"><i class="fas fa-times"></i></button>
        <div class="tool-row">
          <button class="copy-btn"><i class="fas fa-copy"></i></button>
          <button class="dl-btn"><i class="fas fa-download"></i></button>
        </div>
        <div class="result-content"></div>
      </div>
    </section>

    <!-- Symptom-to-Treatment Advisor -->
    <section id="symptomAdvisor" class="module">
      <h2><i class="fas fa-user-md"></i> Symptom-to-Treatment Advisor</h2>
      <p class="desc">Describe your symptoms and receive food &amp; OTC suggestions suitable for Ghana.</p>
      <form id="symptom-form">
        <label>Your Age:
          <input type="number" id="sympAge" min="1" max="120" required>
        </label>
        <label>Describe Symptoms:
          <textarea id="sympDesc" rows="4" placeholder="e.g. headache, fever, cough…"></textarea>
        </label>
        <label>Food Preferences (comma-sep):
          <input id="foodPref" type="text" placeholder="e.g. Jollof rice, Pizza, Burger">
        </label>
        <button id="runSymptom" class="btn"><i class="fas fa-stethoscope"></i> Get Advice</button>
      </form>
      <div id="symptomPanel" class="response" hidden>
        <button class="close-btn"><i class="fas fa-times"></i></button>
        <div class="tool-row">
          <button class="copy-btn"><i class="fas fa-copy"></i></button>
          <button class="dl-btn"><i class="fas fa-download"></i></button>
        </div>
        <div class="result-content"></div>
      </div>
    </section>

    <!-- Progress Charts -->
    <section id="progressCharts" class="module">
      <h2><i class="fas fa-chart-line"></i> Progress Charts</h2>
      <canvas id="intakeChart"></canvas>
      <button class="export-chart-btn" type="button">Export Chart</button>
      <canvas id="macroChart"></canvas>
      <button class="export-chart-btn" type="button">Export Chart</button>
    </section>

    <!-- Meet a Nutrition Expert -->
    <section id="meet-expert" class="module meet-module">
      <div class="meet-content">
        <div class="meet-icon">
          <i class="fas fa-user-md"></i>
        </div>
        <div class="meet-text">
          <h2>Meet a Nutrition Expert</h2>
          <p>Schedule a one-on-one with our registered dietitian for personalized meal guidance, supplement advice, and evidence-based strategies.</p>
          <a href="consult.html" class="btn-schedule">
            <i class="fas fa-calendar-check"></i> Schedule Consultation
          </a>
        </div>
      </div>
    </section>
  </main>


  <!-- Chart.js & App Logic -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
 
</body>
<script>
document.addEventListener('DOMContentLoaded', () => {
  //────────────────── Global State & Helpers ──────────────────
  let userNationality = '';
  // Disable all interactive modules until nationality is set
  const moduleSections = [
    'dietBot', 'mealPlanner', 'nutriAnalyzer', 'recipeRec',
    'deficiency', 'riskRadar', 'fitnessCoach', 'pharmaSuite',
    'symptomAdvisor', 'progressCharts'
  ];
  moduleSections.forEach(id => {
    const sec = document.getElementById(id);
    if (sec) sec.classList.add('disabled');
  });

  // Retrieve saved nationality (if any)
  if (localStorage.getItem('dieteticsNationality')) {
    userNationality = localStorage.getItem('dieteticsNationality');
    document.getElementById('nationality').value = userNationality;
    enableModules();
  }

  // Inject toast & spinner CSS (if not already present in <style>)
  (function(){
    const css = `
      .toast {
        position: fixed;
        bottom: 2rem;
        left: 50%;
        transform: translateX(-50%) translateY(100%);
        background: var(--color-primary-alt);
        color: #fff;
        padding: .75rem 1.5rem;
        border-radius: var(--radius);
        opacity: 0;
        transition: transform .3s, opacity .3s;
        z-index: 2000;
      }
      .toast.visible {
        transform: translateX(-50%) translateY(0);
        opacity: 1;
      }
      .spinner {
        border: 4px solid rgba(0,0,0,0.1);
        border-top: 4px solid var(--color-primary);
        border-radius: 50%;
        width: 24px;
        height: 24px;
        animation: spin 0.8s linear infinite;
        margin: 1rem auto;
      }
      @keyframes spin { to { transform: rotate(360deg); } }
      .spin-text {
        text-align: center;
        margin-top: .5rem;
        font-style: italic;
        color: var(--color-muted);
      }
      .response.waiting .close-btn,
      .response.waiting .tool-row {
        display: none !important;
      }
      .export-chart-btn {
        margin-top: .5rem;
        padding: .25rem .5rem;
        background: var(--color-secondary);
        color: #fff;
        border: none;
        border-radius: .5rem;
        cursor: pointer;
      }
    `;
    const styleTag = document.createElement('style');
    styleTag.textContent = css;
    document.head.append(styleTag);
  })();

  function showToast(msg) {
    const t = document.createElement('div');
    t.className = 'toast';
    t.innerText = msg;
    document.body.appendChild(t);
    requestAnimationFrame(() => t.classList.add('visible'));
    setTimeout(() => t.classList.remove('visible'), 1800);
    setTimeout(() => t.remove(), 2200);
  }

  async function callOpenAI(messages, retries = 1) {
    try {
      const res = await fetch('/.netlify/functions/openai-proxy', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ messages })
      });
      if (!res.ok) {
        const errText = await res.text();
        throw new Error(`OpenAI error ${res.status}: ${errText}`);
      }
      const j = await res.json();
      if (!j.choices?.[0]?.message?.content) {
        throw new Error(`Malformed response: ${JSON.stringify(j)}`);
      }
      return j.choices[0].message.content;
    } catch (err) {
      if (retries > 0 && err.message.includes('Sandbox.Timedout')) {
        await new Promise(r => setTimeout(r, 1000));
        return callOpenAI(messages, retries - 1);
      }
      throw err;
    }
  }

  function escapeHTML(str) {
    return str.replace(/&/g,'&amp;')
              .replace(/</g,'&lt;')
              .replace(/>/g,'&gt;');
  }

  function formatHTML(txt) {
    const lines = txt.split('\n');
    let html = '', i = 0;
    function inline(s) {
      return escapeHTML(s)
        .replace(/`([^`]+)`/g, '<code>$1</code>')
        .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.+?)\*/g, '<em>$1</em>')
        .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>');
    }
    function renderList(idx, ordered) {
      const tag = ordered ? 'ol' : 'ul';
      html += `<${tag}>`;
      while (idx < lines.length) {
        const line = lines[idx];
        const m = ordered
          ? line.match(/^\s*\d+\.\s+(.*)/)
          : line.match(/^\s*[-+*]\s+(.*)/);
        if (!m) break;
        html += `<li>${inline(m[1].trim())}</li>`;
        idx++;
      }
      html += `</${tag}>`;
      return idx;
    }
    while (i < lines.length) {
      const line = lines[i].trim();
      if (line.startsWith('```')) {
        const lang = line.slice(3).trim();
        i++;
        let code = '';
        while (i < lines.length && !lines[i].startsWith('```')) {
          code += escapeHTML(lines[i]) + '\n';
          i++;
        }
        html += `<pre><code class="language-${lang}">${code}</code></pre>`;
        i++;
        continue;
      }
      if (/^(-{3,}|\*{3,})$/.test(line)) {
        html += '<hr>';
        i++;
        continue;
      }
      if (/^#{1,4}\s/.test(line)) {
        const lvl = line.match(/^#+/)[0].length;
        const text = line.slice(lvl).trim();
        html += `<h${lvl}>${inline(text)}</h${lvl}>`;
        i++;
        continue;
      }
      if (line.startsWith('>')) {
        html += `<blockquote>${inline(line.slice(1).trim())}</blockquote>`;
        i++;
        continue;
      }
      if (/^\s*\d+\.\s+/.test(line)) {
        i = renderList(i, true);
        continue;
      }
      if (/^\s*[-+*]\s+/.test(line)) {
        i = renderList(i, false);
        continue;
      }
      if (line.includes('|') && i + 1 < lines.length) {
        const delim = lines[i+1].trim();
        if (/^\|?[:\- ]+\|[:\- ]+(\|[:\- ]+)*$/.test(delim)) {
          const headers = lines[i].replace(/^\||\|$/g,'').split('|').map(h=>h.trim());
          i += 2;
          const rows = [];
          while (i < lines.length && lines[i].includes('|')) {
            rows.push(lines[i].replace(/^\||\|$/g,'').split('|').map(c=>c.trim()));
            i++;
          }
          html += '<table><thead><tr>' + headers.map(h=>`<th>${inline(h)}</th>`).join('') + '</tr></thead><tbody>';
          rows.forEach(r => {
            html += '<tr>' + r.map(c=>`<td>${inline(c)}</td>`).join('') + '</tr>';
          });
          html += '</tbody></table>';
          continue;
        }
      }
      if (line) {
        html += `<p>${inline(line)}</p>`;
      }
      i++;
    }
    return html;
  }

  function enableModules() {
    moduleSections.forEach(id => {
      const sec = document.getElementById(id);
      if (sec) sec.classList.remove('disabled');
    });
  }

  //────────────────── Hero: Nationality & Tip ──────────────────
  const tipPanel = document.getElementById('dailyTip');
  const tipContent = tipPanel.querySelector('.result-content');
  const tipClose = tipPanel.querySelector('.close-btn');
  tipClose.addEventListener('click', () => tipPanel.hidden = true);

  document.getElementById('setNationality').addEventListener('click', () => {
    const v = document.getElementById('nationality').value.trim();
    if (!v) return showToast('Please enter your nationality.');
    userNationality = v;
    localStorage.setItem('dieteticsNationality', v);
    showToast(`Nationality set to ${v}`);
    enableModules();
  });

  async function loadNutritionTip() {
    tipPanel.hidden = false;
    tipPanel.classList.add('waiting');
    tipContent.innerHTML = `<div class="spinner"></div><div class="spin-text">Loading tip…</div>`;
    try {
      // Generate a simple nutrition tip based on nationality context
      const tip = await callOpenAI([
        { role: 'system', content: `Nationality: ${userNationality}` },
        { role: 'system', content: 'You are a nutrition expert. Provide one concise daily nutrition tip that might resonate with someone of the given nationality.' },
        { role: 'user', content: 'Generate a nutrition tip.' }
      ]);
      tipContent.innerHTML = formatHTML(tip);
    } catch (err) {
      console.error(err);
      tipContent.innerText = err.message.includes('Sandbox.Timedout')
        ? '⚠️ Server busy, please try again.'
        : `⚠️ ${err.message}`;
    } finally {
      tipPanel.classList.remove('waiting');
    }
  }

  // Auto-load tip on page load if nationality is set
  if (userNationality) loadNutritionTip();
  document.getElementById('refreshTip').addEventListener('click', () => {
    if (!userNationality) return showToast('Set nationality first.');
    loadNutritionTip();
  });

  //────────────────── Generic Wiring Utility ──────────────────
  function getSelectValue(sel) {
    const other = sel.parentElement.querySelector('.other-input');
    return (other && sel.value === 'Other') ? other.value.trim() : sel.value;
  }

  const PHASE_TEXT = {
    genPlan: 'Generating meal plan…',
    analyzeNutri: 'Analyzing nutrients…',
    getRecipes: 'Recommending recipes…',
    scanDef: 'Scanning deficiencies…',
    runRisk: 'Running risk radar…',
    runFitness: 'Generating fitness plan…',
    runPharma: 'Running pharma suite…',
    runSymptom: 'Diagnosing symptoms…'
  };

  async function handleModule(btnId, fieldIds, requiredIds, sysPrompt, panelId) {
    if (!userNationality) return showToast('Set your nationality before proceeding.');
    // Validate required fields
    for (const rid of requiredIds) {
      if (rid === 'symptoms') {
        const checked = document.querySelectorAll('input[name="symptom"]:checked');
        if (checked.length === 0) return showToast('Select at least one symptom.');
      } else {
        const el = document.getElementById(rid);
        if (!el || !el.value.trim()) return showToast('Please fill all required fields.');
      }
    }
    const panel = document.getElementById(panelId);
    panel.hidden = false;
    panel.classList.add('waiting');
    panel.querySelector('.result-content').innerHTML =
      `<div class="spinner"></div><div class="spin-text">${PHASE_TEXT[btnId] || 'Processing…'}</div>`;
    // Build user content block
    let userContent = '';
    for (const fid of fieldIds) {
      if (fid === 'symptoms') {
        let vals = Array.from(document.querySelectorAll('input[name="symptom"]:checked'))
          .map(cb => cb.value).join(', ');
        const otherSym = document.getElementById('otherSymptom')?.value.trim();
        if (otherSym) vals += `, ${otherSym}`;
        userContent += `symptoms: ${vals}\n`;
      } else {
        const el = document.getElementById(fid);
        if (!el) continue;
        if (el.tagName === 'SELECT' && el.multiple) {
          userContent += `${fid}: ${[...el.selectedOptions].map(o => o.value).join(', ')}\n`;
        } else if (el.tagName === 'SELECT') {
          userContent += `${fid}: ${getSelectValue(el)}\n`;
        } else {
          userContent += `${fid}: ${el.value}\n`;
        }
      }
    }
    try {
      const reply = await callOpenAI([
        { role: 'system', content: `Nationality: ${userNationality}` },
        { role: 'system', content: sysPrompt },
        { role: 'user', content: userContent }
      ]);
      panel.querySelector('.result-content').innerHTML = formatHTML(reply);
    } catch (err) {
      console.error(err);
      panel.querySelector('.result-content').innerText =
        err.message.includes('Sandbox.Timedout')
          ? '⚠️ Server busy, please try again.'
          : `⚠️ ${err.message}`;
    } finally {
      panel.classList.remove('waiting');
    }
  }

  //────────────────── Wire Each Module ──────────────────
  // Meal Plan Generator
  document.getElementById('genPlan').addEventListener('click', () => {
    handleModule(
      'genPlan',
      ['calories', 'dietType', 'allergyList', 'budget'],
      ['calories', 'dietType'],
      `You are an expert registered dietitian. Given the user’s daily calorie target, diet type, allergies/intolerances, and budget, generate a detailed 7-day meal plan with macros and a shopping list.`,
      'planPanel'
    );
  });

  // Nutrient Analyzer
  document.getElementById('analyzeNutri').addEventListener('click', () => {
    handleModule(
      'analyzeNutri',
      ['foodLog', 'unitSelect'],
      ['foodLog'],
      `You are a nutrition scientist. Analyze the user’s food log and unit preference; produce a macro and micronutrient breakdown with totals and commentary.`,
      'nutriPanel'
    );
  });

  // Recipe Recommender
  document.getElementById('getRecipes').addEventListener('click', () => {
    handleModule(
      'getRecipes',
      ['pantry', 'cuisineType', 'recipeDifficulty', 'maxTime'],
      ['pantry'],
      `You are a professional chef AI. Given pantry items, cuisine style, difficulty, and max prep time, recommend 3 original recipes with ingredients, steps, and approximate times.`,
      'recipePanel'
    );
  });

  // Deficiency Risk Scanner
  document.getElementById('scanDef').addEventListener('click', () => {
    handleModule(
      'scanDef',
      ['symptoms', 'dietOverview'],
      ['symptoms'],
      `You are a clinical dietitian. Identify potential nutrient deficiencies from the provided symptoms and brief diet overview, rank them by likelihood, and give actionable recommendations.`,
      'defPanel'
    );
  });

  // Metabolomic Risk Radar
  document.getElementById('runRisk').addEventListener('click', async () => {
    await handleModule(
      'runRisk',
      ['riskFrom', 'riskTo', 'syncBiomarkers', 'biomarkers', 'conditions', 'context'],
      ['riskFrom', 'riskTo', 'biomarkers', 'conditions', 'context'],
      `You are a metabolomic health analyst. Generate a risk radar chart for the user’s biomarkers over the given date range; interpret trends and highlight potential concerns.`,
      'riskPanel'
    );
    // After content appears, parse numeric values and render radar chart
    setTimeout(() => {
      const panel = document.getElementById('riskPanel');
      const text = panel.querySelector('.result-content').innerText;
      const matches = [...text.matchAll(/([A-Za-z]+):\s*([\d.]+)/g)];
      if (!matches.length) return;
      const labels = matches.map(m => m[1]);
      const data = matches.map(m => Number(m[2]));
      const oldCanvas = panel.querySelector('canvas');
      if (oldCanvas) oldCanvas.remove();
      const canvas = document.createElement('canvas');
      canvas.style.marginTop = '1rem';
      panel.appendChild(canvas);
      new Chart(canvas.getContext('2d'), {
        type: 'radar',
        data: {
          labels,
          datasets: [{
            label: 'Biomarker Levels',
            data
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false
        }
      });
    }, 500);
  });

  // Fitness Nutrition Coach
  document.getElementById('runFitness').addEventListener('click', () => {
    handleModule(
      'runFitness',
      ['fitGoal', 'fitFreq', 'blendIngredients', 'carbDate', 'intensity', 'crpLevel', 'nutraPref'],
      ['fitGoal', 'fitFreq'],
      `You are a certified sports nutritionist. Based on the user’s workout goal, weekly frequency, available blend ingredients, carb-timing date/intensity, CRP level, and nutraceutical preference, generate a tailored fitness nutrition plan.`,
      'fitnessPanel'
    );
  });

  // Pharma-Integrated Nutrient & Medication Suite
  document.getElementById('runPharma').addEventListener('click', () => {
    handleModule(
      'runPharma',
      ['medList', 'foodList', 'compoundGoal', 'doseFreq', 'scheduleNotes', 'cohortSelect'],
      ['medList'],
      `You are a pharmacologist-dietitian. Analyze drug–nutrient interactions, suggest compounding options, schedule medication reminders, and provide outcome analytics for the chosen cohort.`,
      'pharmaPanel'
    );
  });

  // Symptom-to-Treatment Advisor
  document.getElementById('runSymptom').addEventListener('click', () => {
    handleModule(
      'runSymptom',
      ['sympAge', 'sympDesc', 'foodPref'],
      ['sympAge', 'sympDesc'],
      `You are a medical nutrition therapist. Based on the user’s age, described symptoms, and food preferences, diagnose possible conditions and recommend OTC treatments and culturally appropriate foods.`,
      'symptomPanel'
    );
  });

  //────────────────── Dietetics Chatbot Wiring ──────────────────
  const dietChatBox = document.getElementById('dietChatBox');
  const dietHint = document.getElementById('dietHint');
  let dietHistory = JSON.parse(localStorage.getItem('dieteticsChatHistory') || '[]');
  dietHistory.forEach(m => addDietChat(m.who, m.text, m.timestamp));

  function addDietChat(who, text, isoTs) {
    const time = new Date(isoTs).toLocaleTimeString();
    const msg = document.createElement('div');
    msg.className = who === 'You' ? 'user-msg' : 'bot-msg';
    msg.innerHTML = `${formatHTML(text)}<div class="timestamp">${time}</div>`;
    dietChatBox.appendChild(msg);
    dietChatBox.scrollTop = dietChatBox.scrollHeight;
  }

  document.getElementById('sendDiet').addEventListener('click', async () => {
    const q = document.getElementById('dietInput').value.trim();
    if (!q) return showToast('Please type a question.');
    addDietChat('You', q, new Date().toISOString());
    dietHistory.push({ who: 'You', text: q, timestamp: new Date().toISOString() });
    localStorage.setItem('dieteticsChatHistory', JSON.stringify(dietHistory));
    document.getElementById('dietInput').value = '';
    dietHint.style.display = 'block';
    try {
      const reply = await callOpenAI([
        { role: 'system', content: `Nationality: ${userNationality}` },
        { role: 'system', content: 'You are a dietetics assistant. Provide clear, evidence-based nutrition advice.' },
        { role: 'user', content: q }
      ]);
      addDietChat('AI', reply, new Date().toISOString());
      dietHistory.push({ who: 'AI', text: reply, timestamp: new Date().toISOString() });
      localStorage.setItem('dieteticsChatHistory', JSON.stringify(dietHistory));
    } catch (err) {
      console.error(err);
      addDietChat('AI', err.message.includes('Sandbox.Timedout') ? '⚠️ Server busy—try again.' : `⚠️ ${err.message}`, new Date().toISOString());
    } finally {
      dietHint.style.display = 'none';
    }
  });

  document.getElementById('clearDiet').addEventListener('click', () => {
    dietChatBox.innerHTML = '';
  });

  document.getElementById('viewDietHistory').addEventListener('click', () => {
    const modal = document.createElement('div');
    modal.className = 'history-modal';
    modal.innerHTML = `
      <div class="history-content">
        <h3>Chat History</h3>
        <ul>
          ${dietHistory.map((m,i) => `
            <li>
              <div>
                <strong>${m.who}:</strong> ${escapeHTML(m.text)}
                <div class="history-date">${new Date(m.timestamp).toLocaleString()}</div>
              </div>
              <button class="del-msg" data-index="${i}" title="Delete"><i class="fas fa-trash"></i></button>
            </li>
          `).join('')}
        </ul>
        <button class="close-history">Close</button>
      </div>
    `;
    document.body.appendChild(modal);
    modal.querySelectorAll('.del-msg').forEach(btn => {
      btn.addEventListener('click', () => {
        const idx = Number(btn.dataset.index);
        dietHistory.splice(idx, 1);
        localStorage.setItem('dieteticsChatHistory', JSON.stringify(dietHistory));
        btn.closest('li').remove();
      });
    });
    modal.querySelector('.close-history').addEventListener('click', () => modal.remove());
  });

  //────────────────── Response Panel Controls ──────────────────
  document.body.addEventListener('click', e => {
    const rp = e.target.closest('.response');
    if (!rp) return;
    if (e.target.closest('.close-btn')) { rp.hidden = true; return; }
    if (e.target.closest('.copy-btn')) {
      const txt = rp.querySelector('.result-content').innerText;
      navigator.clipboard.writeText(txt).then(() => showToast('Copied!'));
      return;
    }
    if (e.target.closest('.dl-btn')) {
      const txt = rp.querySelector('.result-content').innerText;
      const blob = new Blob([txt], { type: 'text/plain' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'response.txt';
      a.click();
    }
  });

  //────────────────── Sidebar & Dark Mode ──────────────────
  document.getElementById('hamburger').addEventListener('click', () => {
    document.getElementById('sidebar').classList.toggle('open');
  });
  document.getElementById('shrinkSidebar').addEventListener('click', () => {
    const sb = document.getElementById('sidebar');
    sb.classList.toggle('collapsed');
    const left = sb.classList.contains('collapsed')
      ? 'var(--sidebar-collapsed)' : 'var(--sidebar-width)';
    document.querySelector('header').style.left = left;
    document.querySelector('main').style.marginLeft = left;
    const icon = document.querySelector('#shrinkSidebar i');
    icon.classList.toggle('fa-angle-double-left');
    icon.classList.toggle('fa-angle-double-right');
  });
  document.getElementById('themeToggle').addEventListener('click', () => {
    document.documentElement.classList.toggle('dark');
    const icon = document.getElementById('themeToggle');
    icon.classList.toggle('fa-moon');
    icon.classList.toggle('fa-sun');
  });

  //────────────────── “Other” Input Logic ──────────────────
  document.querySelectorAll('select').forEach(sel => {
    sel.addEventListener('change', () => {
      const other = sel.parentElement.querySelector('.other-input');
      if (other) other.style.display = sel.value === 'Other' ? 'block' : 'none';
    });
  });
  const symptomOtherCheckbox = document.querySelector('input[value="Other"][name="symptom"]');
  if (symptomOtherCheckbox) {
    symptomOtherCheckbox.addEventListener('change', e => {
      document.getElementById('otherSymptom').style.display = e.target.checked ? 'inline-block' : 'none';
    });
  }

  //────────────────── Progress Charts (Realistic Sample Data) ──────────────────
  const intakeCtx = document.getElementById('intakeChart').getContext('2d');
  const intakeChart = new Chart(intakeCtx, {
    type: 'line',
    data: {
      labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
      datasets: [{
        label: 'Calories In',
        data: [2100, 1800, 2200, 2000, 1950, 2300, 2050],
        borderColor: getComputedStyle(document.documentElement).getPropertyValue('--color-secondary').trim(),
        fill: false
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false
    }
  });
  const expIntake = document.createElement('button');
  expIntake.innerText = 'Export Chart';
  expIntake.className = 'export-chart-btn';
  expIntake.type = 'button';
  document.getElementById('intakeChart').after(expIntake);
  expIntake.addEventListener('click', () => {
    const csv = [
      ['Day','Calories'],
      ...intakeChart.data.labels.map((d,i) => [d, intakeChart.data.datasets[0].data[i]])
    ].map(r => r.join(',')).join('\n');
    const blob = new Blob([csv], { type: 'text/csv' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'calories-intake.csv';
    a.click();
  });

  const macroCtx = document.getElementById('macroChart').getContext('2d');
  const macroChart = new Chart(macroCtx, {
    type: 'pie',
    data: {
      labels: ['Carbs', 'Protein', 'Fat'],
      datasets: [{ data: [50, 25, 25] }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false
    }
  });
  const expMacro = document.createElement('button');
  expMacro.innerText = 'Export Chart';
  expMacro.className = 'export-chart-btn';
  expMacro.type = 'button';
  document.getElementById('macroChart').after(expMacro);
  expMacro.addEventListener('click', () => {
    const csv = [
      ['Macro','Percent'],
      ...macroChart.data.labels.map((m,i) => [m, macroChart.data.datasets[0].data[i]])
    ].map(r => r.join(',')).join('\n');
    const blob = new Blob([csv], { type: 'text/csv' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'macro-distribution.csv';
    a.click();
  });
});
</script>

</html>
