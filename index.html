<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Vitra AI – Herbal Medicine Hub</title>
  <!-- Montserrat + FontAwesome -->
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;700&display=swap" rel="stylesheet"/>
  <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;700&display=swap" rel="stylesheet"/>
  <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;700&display=swap" rel="stylesheet"/>
  <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
/*────────────────── RESET & BASE ──────────────────*/
*,
*::before,
*::after {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}
html {
  font-family: 'Montserrat', sans-serif;
  font-size: 16px;
  scroll-behavior: smooth;
}
body {
  display: flex;
  gap: 0;
  min-height: 100vh;
  background: var(--bg);
  color: var(--text);
  overflow-x: hidden;
}

/*────────────────── VARIABLES ──────────────────*/
:root {
  /* Colors */
  --primary:          #2fa9a1;
  --primary-20:       rgba(47,169,161,0.2);
  --bg:               #f5f8fa;
  --surface:          #ffffff;
  --text:             #333333;
  --muted:            #7a8a93;
  /* Dark mode overrides */
  --bg-dark:          #1e1e1e;
  --surface-dark:     #2a2a2a;
  --text-dark:        #ececec;
  --muted-dark:       #888888;

  /* Spacing & sizing */
  --radius:           0.75rem;
  --padding:          1rem;
  --transition:       0.3s ease;
  --sidebar-w:        280px;
  --sidebar-collapsed-w: 80px;
  --header-h:         64px;
}

/*────────────────── DARK MODE ──────────────────*/
html.dark {
  --bg:    var(--bg-dark);
  --surface: var(--surface-dark);
  --text:  var(--text-dark);
  --muted: var(--muted-dark);
}

/*────────────────── SIDEBAR ──────────────────*/
aside {
  flex: 0 0 var(--sidebar-w);
  position: sticky;
  top: 0;
  height: 100vh;
  background: var(--surface);
  box-shadow: 2px 0 12px rgba(0,0,0,0.05);
  transition: flex var(--transition);
  overflow: hidden;
}
aside.collapsed {
  flex: 0 0 var(--sidebar-collapsed-w);
}
aside .brand {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  padding: var(--padding);
  font-size: 1.4rem;
  font-weight: 700;
  color: var(--primary);
}
aside.collapsed .brand span {
  display: none;
}
aside nav {
  margin-top: 2rem;
}
aside nav a {
  display: flex;
  align-items: center;
  gap: 1rem;
  padding: 0.75rem var(--padding);
  border-radius: var(--radius);
  color: var(--text);
  font-weight: 500;
  text-decoration: none;
  transition: background var(--transition), padding-left var(--transition);
}
aside nav a i {
  font-size: 1.2rem;
}
aside nav a:hover,
aside nav a.active {
  background: var(--primary-20);
  color: var(--primary);
  padding-left: calc(var(--padding) + 0.5rem);
}
aside.collapsed nav a span {
  display: none;
}

/* Shrink toggle */
#shrinkBtn {
  position: absolute;
  bottom: var(--padding);
  right: -18px;
  width: 36px;
  height: 36px;
  background: var(--primary);
  color: #fff;
  border: none;
  border-radius: 50%;
  box-shadow: 0 3px 8px rgba(0,0,0,0.15);
  cursor: pointer;
  transition: transform var(--transition);
}
#shrinkBtn:hover {
  transform: scale(1.1);
}

/*────────────────── HEADER ──────────────────*/
header {
  position: fixed;
  top: 0;
  left: var(--sidebar-w);
  right: 0;
  height: var(--header-h);
  background: var(--surface);
  border-bottom: 1px solid #e1e8ed;
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 var(--padding);
  z-index: 1000;
  transition: left var(--transition);
}
aside.collapsed ~ header {
  left: var(--sidebar-collapsed-w);
}
header h1 {
  font-size: 1.5rem;
  font-weight: 600;
  color: var(--text);
}
header .hamburger,
header .theme-toggle {
  font-size: 1.4rem;
  color: var(--primary);
  cursor: pointer;
  margin-left: 1rem;
  transition: transform var(--transition);
}
header .hamburger:hover,
header .theme-toggle:hover {
  transform: scale(1.1);
}

/* Hamburger visibility */
header .hamburger {
  display: none;
}
@media (max-width: 1024px) {
  header .hamburger {
    display: inline-block;
  }
}

/*────────────────── MAIN CONTENT ──────────────────*/
main {
  flex: 1;
  padding: calc(var(--header-h) + var(--padding)) var(--padding) var(--padding);
  background: var(--bg);
}

/*────────────────── MODULE CARDS ──────────────────*/
.module {
  background: var(--surface);
  border-radius: var(--radius);
  padding: var(--padding);
  box-shadow: 0 2px 8px rgba(0,0,0,0.03);
  margin-bottom: 1.5rem;
  transition: transform var(--transition), box-shadow var(--transition);
}
.module:hover {
  transform: translateY(-4px);
  box-shadow: 0 4px 16px rgba(0,0,0,0.06);
}
.module h2 {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  margin-bottom: 0.75rem;
  font-size: 1.25rem;
  color: var(--primary);
}
.module p.desc {
  font-size: 0.95rem;
  color: var(--muted);
  margin-bottom: 1rem;
}

/*────────────────── FORMS & INPUTS ──────────────────*/
.module form {
  display: flex;
  flex-wrap: wrap;
  gap: 1rem;
  align-items: flex-end;
}
.module input,
.module select,
.module textarea {
  flex: 1 1 200px;
  padding: 0.75rem;
  border: 1.5px solid #d1dce5;
  border-radius: var(--radius);
  background: var(--bg);
  color: var(--text);
  font-size: 0.95rem;
  transition: border-color var(--transition), box-shadow var(--transition);
}
.module input:focus,
.module select:focus,
.module textarea:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 8px var(--primary-20);
}
.module .hint {
  width: 100%;
  font-size: 0.85rem;
  color: var(--muted);
  margin-top: 0.25rem;
}

/*────────────────── BUTTONS ──────────────────*/
button,
button[type="submit"] {
  background: var(--primary);
  color: #fff;
  padding: 0.7rem 1.4rem;
  border: none;
  border-radius: var(--radius);
  font-size: 0.95rem;
  font-weight: 600;
  cursor: pointer;
  box-shadow: 0 3px 10px rgba(0,0,0,0.1);
  transition: transform var(--transition), box-shadow var(--transition);
}
button:hover {
  transform: scale(1.03);
  box-shadow: 0 5px 14px rgba(0,0,0,0.12);
}

/*────────────────── RESPONSE PANELS ──────────────────*/
.response {
  background: var(--primary-20);
  border-left: 4px solid var(--primary);
  padding: var(--padding);
  border-radius: var(--radius);
  position: relative;
  margin-top: 1rem;
}


/*────────────────── CHATBOX ──────────────────*/
#chatBox {
  width: 100%;
  min-height: 200px;
  max-height: 300px;
  padding: var(--padding);
  background: var(--bg);
  border: 1px solid #d1dce5;
  border-radius: var(--radius);
  overflow-y: auto;
  margin-bottom: 0.5rem;
}

/*────────────────── CHARTS GRID ──────────────────*/
.charts {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 1.5rem;
}
.chart-card {
  background: var(--surface);
  border-radius: var(--radius);
  padding: var(--padding);
  box-shadow: 0 2px 8px rgba(0,0,0,0.03);
}
.chart-card h2 {
  font-size: 1.1rem;
  margin-bottom: 0.75rem;
  color: var(--primary);
}

/*────────────────── RESPONSIVE ──────────────────*/
@media (max-width: 1024px) {
  aside {
    position: fixed;
    transform: translateX(-100%);
    z-index: 900;
  }
  aside.open {
    transform: translateX(0);
  }
  header {
    left: 0 !important;
  }
  main {
    padding: calc(var(--header-h) + var(--padding)) var(--padding);
  }
  #shrinkBtn {
    display: none;
  }
}
@media (max-width: 640px) {
  .module form {
    flex-direction: column;
  }
}
/*──────────────────────────────────────────────────*/
/* 1. Shrink-button: always sits just outside sidebar */
/*──────────────────────────────────────────────────*/
#shrinkBtn {
  /* move it to the left side of the sidebar */
  right: auto;
  left: -18px;
  z-index: 1001;                /* above everything */
}

/*──────────────────────────────────────────────────*/
/* 2. Pie-chart: constrain height & center */
/*──────────────────────────────────────────────────*/
.chart-card canvas {
  max-height: 200px;            /* pull it in */
  margin: 0 auto !important;    /* center horizontally */
  display: block;
}

/*──────────────────────────────────────────────────*/
/* 3. Loading spinner: animated circle */
/*──────────────────────────────────────────────────*/
.spinner {
  display: inline-block;
  width: 1em;
  height: 1em;
  border: 2px solid var(--primary);
  border-top-color: transparent;
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
  vertical-align: middle;
  margin-left: 0.25em;
}
@keyframes spin {
  to { transform: rotate(360deg); }
}

/*──────────────────────────────────────────────────*/
/* 4. Response-close button: bold circular pill */
/*──────────────────────────────────────────────────*/
.response .close-btn {
  width: 24px;
  height: 24px;
  background: var(--primary);
  color: #fff;
  font-size: 0.9rem;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 2px 6px rgba(0,0,0,0.2);
  position: absolute;
  top: 0.5rem;
  right: 0.5rem;
  transition: background var(--transition), transform var(--transition);
}
.response .close-btn:hover {
  background: darken(var(--primary),10%);
  transform: scale(1.1);
}

/*──────────────────────────────────────────────────*/
/* 5. & 6. Mobile sidebar & responsive tweaks */
/*──────────────────────────────────────────────────*/
@media (max-width: 1024px) {
  aside {
    position: fixed;
    top: 0; left: 0;
    height: 100vh;
    transform: translateX(-100%);
    width: var(--sidebar-w);
    transition: transform var(--transition);
    z-index: 1000;
  }
  aside.open {
    transform: translateX(0);
  }
  /* hamburger shows automatically, header spans full */
  header {
    left: 0 !important;
  }
  main {
    padding: calc(var(--header-h) + var(--padding)) var(--padding);
  }
}
@media (max-width: 640px) {
  /* stack modules full width to avoid squishing */
  .module {
    padding: 0.75rem;
  }
  .module form {
    flex-direction: column;
  }
  /* slightly larger touch areas */
  header .hamburger,
  header .theme-toggle {
    font-size: 1.6rem;
  }
}

</style>

  
</head>

<body>
  <!-- SIDEBAR / NAVIGATION -->
  <aside id="sidebar">
    <div class="brand" aria-label="Vitra AI Home">
      <i class="fas fa-leaf"></i><span>Vitra AI</span>
    </div>
    <nav role="navigation" aria-label="Main menu">
      <a href="#" class="active"><i class="fas fa-seedling"></i><span>Herbal Medicine</span></a>
      <a href="#"><i class="fas fa-brain"></i><span>Psychology &amp; Mental Health</span></a>
      <a href="#"><i class="fas fa-utensils"></i><span>Dietetics</span></a>
      <a href="#"><i class="fas fa-pills"></i><span>E-Pharmacy</span></a>
      <a href="#"><i class="fas fa-calendar-check"></i><span>Consultation Booking</span></a>
      <hr/>
      <a href="#"><i class="fas fa-user"></i><span>Profile</span></a>
      <a href="#"><i class="fas fa-cog"></i><span>Settings</span></a>
    </nav>
    <button id="shrinkBtn" class="shrink-btn" aria-label="Toggle sidebar">
  <i class="fas fa-angle-double-left"></i>
</button>

  </aside>

   <header>
      <div>
        <i id="hamburger" class="fas fa-bars hamburger" aria-label="Toggle navigation"></i>
        <h1 style="display:inline; margin-left:0.5rem;">Herbal Medicine</h1>
      </div>
      <i id="themeToggle" class="fas fa-moon theme-toggle" aria-label="Toggle dark mode"></i>
    </header>
  
  <!-- MAIN CONTENT -->
 <main role="main">
   

    <!-- Example Module: Diagnostics -->
    <section class="module" id="module-dx">
      <h2><i class="fas fa-stethoscope"></i> AI Diagnostics</h2>
      <p class="desc">Describe your symptoms; our AI will recommend herbs.</p>
      <form id="dx-form">
        <textarea id="dxInput" rows="2" placeholder="e.g. Persistent headaches & fatigue…" required></textarea>
        <button type="submit">Analyze</button>
        <div class="hint">Be specific: mention duration & intensity.</div>
      </form>
      <div id="dxResult" class="response" hidden>
        <button class="close-btn" aria-label="Close result">×</button>
        <div class="result-content"></div>
      </div>
    </section>

    

    <!-- 2. Formulations -->
    <section class="module">
      <h2><i class="fas fa-user-shield"></i> Personalized Formulations</h2>
      <p class="desc">Pick herbs, age & weight for a custom blend.</p>
      <form id="pf-form">
        <select id="pfHerbs" multiple size="5">
          <!-- 20+ herbs -->
          <option>Ashwagandha</option><option>Astragalus</option><option>Basil</option><option>Chamomile</option>
          <option>Echinacea</option><option>Ginkgo Biloba</option><option>Ginseng</option><option>Lavender</option>
          <option>Licorice</option><option>Milk Thistle</option><option>Neem</option><option>Oregano</option>
          <option>Peppermint</option><option>Rosemary</option><option>St. John’s Wort</option><option>Turmeric</option>
          <option>Valerian</option><option>Holy Basil</option><option>Green Tea</option><option>Aloe Vera</option>
          <option>Gotu Kola</option><option>Skullcap</option><option>Thyme</option><option>Yarrow</option>
        </select>
        <input id="pfAge" type="number" min="1" max="120" placeholder="Age (years)"/>
        <input id="pfWeight" type="number" min="10" max="300" placeholder="Weight (kg)"/>
        <button type="submit">Generate</button>
        <div class="hint">Hold Ctrl/Cmd to select multiple herbs.</div>
      </form>
      <div id="pfResult" class="response" hidden>
        <button class="close-btn" aria-label="Close result">×</button>
        <div class="result-content"></div>
      </div>
    </section>

    <!-- 3. Identification -->
    <section class="module">
      <h2><i class="fas fa-leaf"></i> Herb Identification</h2>
      <p class="desc">Upload a photo; we’ll name your plant.</p>
      <form id="ing-form">
        <input id="ingUpload" type="file" accept="image/*"/>
        <button type="submit">Identify</button>
       <div class="hint">Use a clear, close-up photo of a leaf or flower.</div>
      </form>
      <div id="ingResult" class="response" hidden>
        <button class="close-btn" aria-label="Close result">×</button>
        <div class="result-content"></div>
      </div>
    </section>

    <!-- 4. Efficacy Prediction -->
    <section class="module">
      <h2><i class="fas fa-chart-pie"></i> Efficacy Prediction</h2>
      <p class="desc">See how well an herb works for your condition.</p>
      <form id="pred-form">
        <input id="predInput" placeholder="e.g. Turmeric for arthritis"/>
        <button type="submit">Predict</button>
        <div class="hint">Format: “Herb for condition”.</div>
      </form>
      <div id="predResult" class="response" hidden>
        <button class="close-btn" aria-label="Close result">×</button>
        <div class="result-content"></div>
      </div>
    </section>

    <!-- 5. Chatbot -->
    <section class="module">
      <h2><i class="fas fa-graduation-cap"></i> Education Chatbot</h2>
      <p class="desc">Ask anything about herbal medicine.</p>
      <div id="chatBox"></div>
      <div style="display:flex; gap:0.5rem; margin-top:0.5rem;">
        <input id="chatInput" placeholder="Type your question…"/>
        <button id="sendChat"><i class="fas fa-paper-plane"></i></button>
      </div>
      <div id="chatHint" class="hint" hidden>Our bot is thinking… hang tight!</div>
    </section>

    <!-- 6. Research Summaries -->
    <section class="module">
      <h2><i class="fas fa-book-reader"></i> Research Summaries</h2>
      <p class="desc">Paste study titles or keywords for a summary.</p>
      <form id="research-form">
        <input id="researchQuery" placeholder="e.g. ‘Ashwagandha anxiety RCT’"/>
        <button type="submit">Summarize</button>
        <div class="hint">Be specific: include herb and focus (e.g. stress, sleep)</div>
      </form>
      <div id="researchResults" class="response" hidden>
        <button class="close-btn" aria-label="Close result">×</button>
        <div class="result-content"></div>
      </div>
    </section>

    <!-- 7. Inventory Forecast -->
    <section class="module">
      <h2><i class="fas fa-warehouse"></i> Inventory Forecast</h2>
      <p class="desc">Predict your stock needs weeks ahead.</p>
      <form id="inventory-form">
        <select id="forecastHerb">
          <!-- 20+ herbs -->
          <option>Turmeric</option><option>Ginkgo Biloba</option><option>Ashwagandha</option><option>Echinacea</option>
          <option>Valerian</option><option>Chamomile</option><option>Lavender</option><option>Basil</option>
          <option>Milk Thistle</option><option>Neem</option><option>Rosemary</option><option>Oregano</option>
          <option>Peppermint</option><option>Holy Basil</option><option>Green Tea</option><option>Aloe Vera</option>
          <option>Skullcap</option><option>Yarrow</option><option>Gotu Kola</option><option>Licorice</option>
        </select>
        <input id="forecastPeriod" type="number" min="1" max="52" value="4" placeholder="Weeks ahead"/>
        <button type="submit">Forecast</button>
      <div class="hint">Choose 1–52 weeks into the future.</div>
      </form>
      <div id="inventoryResult" class="response" hidden>
        <button class="close-btn" aria-label="Close result">×</button>
        <div class="result-content"></div>
      </div>
    </section>

    <!-- 8. Genetics Match -->
    <section class="module">
      <h2><i class="fas fa-dna"></i> Genetics Match</h2>
      <p class="desc">Upload your genetic report for tailored herbs.</p>
      <form id="genetics-form">
        <input id="geneticUpload" type="file" accept=".csv,.json"/>
        <button type="submit">Analyze</button>
     <div class="hint">CSV or JSON with SNPs is ideal.</div>
      </form>
      <div id="geneticResult" class="response" hidden>
        <button class="close-btn" aria-label="Close result">×</button>
        <div class="result-content"></div>
      </div>
    </section>

    <!-- 9. Dosage Calculator -->
    <section class="module">
      <h2><i class="fas fa-calculator"></i> Dosage Calculator</h2>
      <p class="desc">Get daily dosage advice based on weight.</p>
      <form id="dose-form">
        <input id="weight" type="number" min="10" max="300" placeholder="Weight (kg)"/>
        <input id="symptom" placeholder="Symptom (e.g. headache)"/>
        <button type="submit">Calculate</button>
    <div class="hint">Weight 10–300 kg. Describe symptom briefly.</div>
      </form>
      <div id="dosageResult" class="response" hidden>
        <button class="close-btn" aria-label="Close result">×</button>
        <div class="result-content"></div>
      </div>
    </section>

    <!-- 10. Interaction Checker -->
    <section class="module">
      <h2><i class="fas fa-exchange-alt"></i> Interaction Checker</h2>
      <p class="desc">Select two herbs to check for interactions.</p>
      <form id="int-form">
        <select id="herbA">
          <!-- 20+ options -->
          <option>Turmeric</option><option>Ashwagandha</option><option>Ginkgo Biloba</option><option>St. John’s Wort</option>
          <option>Echinacea</option><option>Valerian</option><option>Chamomile</option><option>Lavender</option>
          <option>Milk Thistle</option><option>Neem</option><option>Rosemary</option><option>Oregano</option>
          <option>Peppermint</option><option>Holy Basil</option><option>Green Tea</option><option>Aloe Vera</option>
          <option>Skullcap</option><option>Yarrow</option><option>Gotu Kola</option><option>Licorice</option>
        </select>
        <select id="herbB">
          <!-- same 20+ options -->
          <option>Turmeric</option><option>Ashwagandha</option><option>Ginkgo Biloba</option><option>St. John’s Wort</option>
          <option>Echinacea</option><option>Valerian</option><option>Chamomile</option><option>Lavender</option>
          <option>Milk Thistle</option><option>Neem</option><option>Rosemary</option><option>Oregano</option>
          <option>Peppermint</option><option>Holy Basil</option><option>Green Tea</option><option>Aloe Vera</option>
          <option>Skullcap</option><option>Yarrow</option><option>Gotu Kola</option><option>Licorice</option>
        </select>
        <button type="submit">Check</button>
      <div class="hint">Pick two distinct herbs.</div>
      </form>
      <div id="interactionResult" class="response" hidden>
        <button class="close-btn" aria-label="Close result">×</button>
        <div class="result-content"></div>
      </div>
    </section>

    <!-- CHARTS -->
   <!-- Charts Area -->
    <div class="charts">
      <div class="chart-card">
        <h2><i class="fas fa-chart-bar"></i> Top Growing Herbs</h2>
        <canvas id="barChart"></canvas>
      </div>
      <div class="chart-card">
        <h2><i class="fas fa-chart-pie"></i> Category Breakdown</h2>
        <canvas id="pieChart"></canvas>
      </div>
    </div>
  </main>

 <script>
  // ──────── ELEMENT REFERENCES & UTILITIES ────────
  const sidebar   = document.getElementById('sidebar');
  const hamburger = document.getElementById('hamburger');
  const themeBtn  = document.getElementById('themeToggle');

  function toggleSidebar() {
    sidebar.classList.toggle('closed');
  }
hamburger.onclick = () => sidebar.classList.toggle('open');

// inside DOMContentLoaded:
const shrinkBtn = document.getElementById('shrinkBtn');
shrinkBtn.onclick = () => {
  sidebar.classList.toggle('collapsed');
  // optionally flip the arrow:
  shrinkBtn.querySelector('i').classList.toggle('fa-angle-double-left');
  shrinkBtn.querySelector('i').classList.toggle('fa-angle-double-right');
};

function toggleTheme() {
  document.documentElement.classList.toggle('dark');
  document.documentElement.classList.toggle('light');
  // swap both icon classes
  themeBtn.classList.toggle('fa-moon');
  themeBtn.classList.toggle('fa-sun');
}

  // Attach “close” handlers to any response panels
  function attachCloseButtons() {
    document.querySelectorAll('.response .close-btn').forEach(btn => {
      btn.onclick = () => btn.parentElement.hidden = true;
    });
  }

  // Render a loading spinner & message inside a panel
  function setLoading(panel) {
    panel.querySelector('.result-content').innerHTML =
      'Brewing your herbal wisdom… <span class="spinner"></span>';
    panel.hidden = false;
  }

  // Show the AI’s reply inside a panel
  function showResult(panel, text) {
    panel.querySelector('.result-content').textContent = text;
    panel.hidden = false;
  }

  // Call your OpenAI proxy function
  async function callOpenAI(messages) {
    const res = await fetch('/.netlify/functions/openai-proxy', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ messages })
    });
    if (!res.ok) {
      const errorText = await res.text();
      throw new Error(errorText || 'Network error');
    }
    const { choices } = await res.json();
    return choices[0].message.content.trim();
  }

  // Wire a form to OpenAI + result panel
  function wireModule({ formId, systemPrompt, getUserInput, resultPanelId }) {
    const form  = document.getElementById(formId);
    const panel = document.getElementById(resultPanelId);
    form.addEventListener('submit', async e => {
      e.preventDefault();
      setLoading(panel);
      try {
        const userContent = getUserInput();
        const reply = await callOpenAI([
          { role: 'system',  content: systemPrompt },
          { role: 'user',    content: userContent }
        ]);
        showResult(panel, reply);
      } catch (err) {
        showResult(panel, '⚠️ ' + err.message);
        console.error(err);
      }
    });
    // allow closing
    panel.querySelector('.close-btn').onclick = () => panel.hidden = true;
  }

  // ──────── INITIALIZATION ────────
  document.addEventListener('DOMContentLoaded', () => {
    // Sidebar & theme toggles
    hamburger.onclick = toggleSidebar;
    themeBtn.onclick  = toggleTheme;

    // Close buttons
    attachCloseButtons();

    // 1. AI Diagnostics
    wireModule({
      formId:        'dx-form',
      systemPrompt:  'You are a top-tier herbal diagnostic AI.',
      getUserInput:  () => document.getElementById('dxInput').value,
      resultPanelId: 'dxResult'
    });

    // 2. Personalized Formulations
    wireModule({
      formId:       'pf-form',
      systemPrompt: 'You are an expert at formulating personalized herbal blends.',
      getUserInput: () => {
        const herbs  = Array.from(document.getElementById('pfHerbs').selectedOptions)
                             .map(o => o.value)
                             .join(', ');
        const age    = document.getElementById('pfAge').value;
        const weight = document.getElementById('pfWeight').value;
        return `Herbs: ${herbs}; Age: ${age}; Weight: ${weight}kg`;
      },
      resultPanelId:'pfResult'
    });

    // 3. Herb Identification
    wireModule({
      formId:       'ing-form',
      systemPrompt: 'You are an accurate plant species identifier.',
      getUserInput: () => {
        const file = document.getElementById('ingUpload').files[0];
        // TODO: send actual file bytes via FormData in future
        return file ? file.name : '';
      },
      resultPanelId:'ingResult'
    });

    // 4. Efficacy Prediction
    wireModule({
      formId:       'pred-form',
      systemPrompt: 'You predict efficacy scores (0–100) for herbs against conditions.',
      getUserInput: () => document.getElementById('predInput').value,
      resultPanelId:'predResult'
    });

    // 5. Education Chatbot
    (function() {
      const chatBox  = document.getElementById('chatBox');
      const chatHint = document.getElementById('chatHint');
      const chatInput= document.getElementById('chatInput');
      const sendBtn  = document.getElementById('sendChat');
      let history = [{ role:'system', content:'You are a friendly herbal medicine tutor.' }];

      sendBtn.onclick = async () => {
        const msg = chatInput.value.trim();
        if (!msg) return;
        chatBox.innerHTML += `<p><strong>You:</strong> ${msg}</p>`;
        chatInput.value = '';
        history.push({ role:'user', content: msg });
        chatHint.hidden = false;

        try {
          const reply = await callOpenAI(history);
          history.push({ role:'assistant', content: reply });
          chatBox.innerHTML += `<p><strong>Vitra AI:</strong> ${reply}</p>`;
        } catch {
          chatBox.innerHTML += `<p><strong>Vitra AI:</strong> Sorry, something went wrong.</p>`;
        }
        chatHint.hidden = true;
        chatBox.scrollTop = chatBox.scrollHeight;
      };
    })();

    // 6. Research Summaries
    wireModule({
      formId:       'research-form',
      systemPrompt: 'You summarize clinical research findings concisely.',
      getUserInput: () => document.getElementById('researchQuery').value,
      resultPanelId:'researchResults'
    });

    // 7. Inventory Forecast
    wireModule({
      formId:       'inventory-form',
      systemPrompt: 'You forecast weekly herb demand based on trends.',
      getUserInput: () => {
        const herb  = document.getElementById('forecastHerb').value;
        const weeks = document.getElementById('forecastPeriod').value;
        return `Herb: ${herb}; Weeks ahead: ${weeks}`;
      },
      resultPanelId:'inventoryResult'
    });

    // 8. Genetics Match
    wireModule({
      formId:       'genetics-form',
      systemPrompt: 'You interpret genetic reports to recommend suitable herbs.',
      getUserInput: () => {
        const file = document.getElementById('geneticUpload').files[0];
        return file ? file.name : '';
      },
      resultPanelId:'geneticResult'
    });

    // 9. Dosage Calculator
    wireModule({
      formId:       'dose-form',
      systemPrompt: 'You calculate daily herbal dosages based on weight and symptom.',
      getUserInput: () => {
        const w = document.getElementById('weight').value;
        const s = document.getElementById('symptom').value;
        return `Weight: ${w}kg; Symptom: ${s}`;
      },
      resultPanelId:'dosageResult'
    });

    // 10. Interaction Checker
    wireModule({
      formId:       'int-form',
      systemPrompt: 'You check for interactions between two herbs.',
      getUserInput: () => {
        const a = document.getElementById('herbA').value;
        const b = document.getElementById('herbB').value;
        return `${a} & ${b}`;
      },
      resultPanelId:'interactionResult'
    });

    // ──────── CHARTS ────────
    new Chart(document.getElementById('barChart'), {
      type: 'bar',
      data: {
        labels: ['Turmeric','Ginkgo','Echinacea','Valerian','Ashwagandha'],
        datasets: [{
          data: [200,160,140,120,100],
          backgroundColor: 'rgba(142,205,241,0.8)'
        }]
      },
      options: {
        plugins: { legend: { display:false } },
        scales: { y: { beginAtZero:true } }
      }
    });

    new Chart(document.getElementById('pieChart'), {
      type: 'pie',
      data: {
        labels: ['Roots','Leaves','Flowers','Seeds','Barks'],
        datasets: [{
          data: [30,25,20,15,10],
          backgroundColor: ['#8ECDF1','#A0E0E0','#C0F0F0','#E0FFFF','#F0FFFF']
        }]
      }
    });
  });
</script>

</body>
</html>
