<!DOCTYPE html>
<html lang="en" aria-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>E-Pharmacy AI Portal</title>

  <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;700&display=swap" rel="stylesheet">
  <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<!-- +————— Add MathJax for real math rendering —————+ -->
<script>
window.MathJax = {
  tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] },
  svg: { fontCache: 'global' }
};
</script>
<style>
  /*──────────────────────────────────────────────────────────────────────────────
    BASE & VARIABLES
  ──────────────────────────────────────────────────────────────────────────────*/
  :root {
    --pharm-primary: #005f73;
    --pharm-primary-alt: #0a9396;
    --pharm-secondary: #94d2bd;
    --pharm-accent: #e9d8a6;
    --pharm-bg: #f0efeb;
    --pharm-surface: #ffffff;
    --pharm-text: #001219;
    --pharm-muted: #555555;
    --radius: 0.75rem;
    --padding: 1rem;
    --transition: 0.3s ease;
    --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  }
  html.dark {
    --pharm-bg: #001219;
    --pharm-surface: #002e2e;
    --pharm-text: #e0fbfc;
    --pharm-muted: #889999;
    --shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
  }
  *, *::before, *::after {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }
  html {
    font-family: 'Montserrat', sans-serif;
    font-size: 16px;
    scroll-behavior: smooth;
    background: var(--pharm-bg);
    color: var(--pharm-text);
    transition: background var(--transition), color var(--transition);
  }
  body {
    display: flex;
    min-height: 100vh;
    background: var(--pharm-bg);
    color: var(--pharm-text);
    overflow-x: hidden;
  }
  a {
    color: inherit;
    text-decoration: none;
    transition: color var(--transition);
  }
  a:hover {
    color: var(--pharm-primary-alt);
  }
  img {
    max-width: 100%;
    display: block;
  }
  button, input, textarea, select {
    font-family: inherit;
    transition: var(--transition);
  }
  button {
    cursor: pointer;
    border: none;
    background: none;
  }
  ul, ol {
    list-style: none;
  }
  h1, h2, h3, h4 {
    color: var(--pharm-primary);
    margin-bottom: 0.5rem;
  }
  p.desc {
    color: var(--pharm-muted);
    margin-bottom: 0.75rem;
  }
  small {
    color: var(--pharm-muted);
    font-size: 0.85rem;
  }

  /*──────────────────────────────────────────────────────────────────────────────
    SCROLLBAR STYLING (WEBKIT)
  ──────────────────────────────────────────────────────────────────────────────*/
  ::-webkit-scrollbar {
    width: 8px;
    height: 8px;
  }
  ::-webkit-scrollbar-track {
    background: var(--pharm-surface);
    border-radius: 4px;
  }
  ::-webkit-scrollbar-thumb {
    background: var(--pharm-primary-alt);
    border-radius: 4px;
  }
  ::-webkit-scrollbar-thumb:hover {
    background: var(--pharm-primary);
  }

  /*──────────────────────────────────────────────────────────────────────────────
    SIDEBAR
  ──────────────────────────────────────────────────────────────────────────────*/
  aside#sidebar {
    position: fixed;
    top: 0;
    left: 0;
    width: 220px;
    height: 100vh;
    background: var(--pharm-surface);
    box-shadow: var(--shadow);
    display: flex;
    flex-direction: column;
    transition: width var(--transition), transform var(--transition);
    z-index: 1000;
    overflow: hidden;
  }
  aside#sidebar.collapsed {
    width: 60px;
  }
  aside#sidebar .brand {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: var(--padding);
    font-size: 1.25rem;
    background: var(--pharm-primary);
    color: #fff;
  }
  aside#sidebar .brand i {
    font-size: 1.5rem;
  }
  aside#sidebar .brand span {
    transition: opacity var(--transition);
  }
  aside#sidebar.collapsed .brand span {
    opacity: 0;
  }
  aside#sidebar nav {
    flex: 1;
    overflow-y: auto;
  }
  aside#sidebar nav ul {
    padding: 0 var(--padding);
  }
  aside#sidebar nav li {
    margin-bottom: 0.25rem;
  }
  aside#sidebar nav li a {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem;
    border-radius: var(--radius);
    color: var(--pharm-text);
    font-weight: 500;
    transition: background var(--transition), color var(--transition);
  }
  aside#sidebar nav li.active a,
  aside#sidebar nav li a:hover {
    background: var(--pharm-primary-alt);
    color: #fff;
  }
  aside#sidebar nav li a i {
    font-size: 1.2rem;
    width: 1.2rem;
    text-align: center;
    color: var(--pharm-primary-alt);
  }
  aside#sidebar.collapsed nav li a span {
    display: none;
  }
  aside#sidebar.collapsed nav li a {
    justify-content: center;
  }
  #shrinkSidebar {
    margin: 0.5rem auto;
    background: var(--pharm-secondary);
    color: var(--pharm-surface);
    border-radius: 50%;
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: var(--shadow);
    transition: background var(--transition), transform var(--transition);
  }
  #shrinkSidebar:hover {
    background: var(--pharm-primary);
    transform: scale(1.1);
  }

  /*──────────────────────────────────────────────────────────────────────────────
    HEADER
  ──────────────────────────────────────────────────────────────────────────────*/
  header {
    position: fixed;
    top: 0;
    left: 220px;
    right: 0;
    height: 64px;
    background: var(--pharm-surface);
    box-shadow: var(--shadow);
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 var(--padding);
    z-index: 999;
    transition: left var(--transition);
  }
  aside#sidebar.collapsed ~ header {
    left: 60px;
  }
  header i#hamburger,
  header i#themeToggle {
    font-size: 1.5rem;
    color: var(--pharm-primary-alt);
    cursor: pointer;
    transition: transform var(--transition), color var(--transition);
  }
  header i#hamburger:hover,
  header i#themeToggle:hover {
    color: var(--pharm-primary);
    transform: scale(1.1);
  }
  header h1 {
    font-size: 1.6rem;
    font-weight: 600;
    color: var(--pharm-text);
  }

  /*──────────────────────────────────────────────────────────────────────────────
    MAIN CONTENT
  ──────────────────────────────────────────────────────────────────────────────*/
  main {
    flex: 1;
    margin-top: 80px;
    margin-left: 240px;
    padding: var(--padding);
    background: var(--pharm-bg);
    transition: margin-left var(--transition);
  }
  aside#sidebar.collapsed ~ main {
    margin-left: 80px;
  }
  @media (max-width: 768px) {
    header {
      left: 0 !important;
    }
    aside#sidebar {
      transform: translateX(-100%);
      width: 220px;
    }
    body.sidebar-open aside#sidebar {
      transform: translateX(0);
    }
    main {
      margin-left: 0 !important;
    }
  }

  /*──────────────────────────────────────────────────────────────────────────────
    MODULE BASE STYLES
  ──────────────────────────────────────────────────────────────────────────────*/
  section.module {
    background: var(--pharm-surface);
    border-radius: var(--radius);
    padding: var(--padding);
    margin-bottom: 1.5rem;
    box-shadow: var(--shadow);
    transition: transform var(--transition), box-shadow var(--transition);
  }
  section.module:hover {
    transform: translateY(-4px);
    box-shadow: 0 6px 24px rgba(0, 0, 0, 0.1);
  }
  section.module h2 {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 0.75rem;
    font-size: 1.5rem;
    color: var(--pharm-primary-alt);
  }
  section.module p.desc {
    font-size: 0.95rem;
    color: var(--pharm-muted);
    margin-bottom: 1rem;
  }
  section.module label {
    display: block;
    margin-bottom: 1rem;
    color: var(--pharm-text);
    font-weight: 500;
  }
  section.module label input,
  section.module label select,
  section.module label textarea {
    width: 100%;
    padding: 0.75rem;
    margin-top: 0.5rem;
    border: 2px solid var(--pharm-primary-alt);
    border-radius: var(--radius);
    background: var(--pharm-bg);
    color: var(--pharm-text);
    font-size: 1rem;
    transition: border-color var(--transition), box-shadow var(--transition), background var(--transition);
  }
  section.module label input:focus,
  section.module label select:focus,
  section.module label textarea:focus {
    outline: none;
    border-color: var(--pharm-secondary);
    box-shadow: 0 0 0 3px rgba(148, 210, 189, 0.3);
    background: var(--pharm-accent);
  }
  html.dark section.module label input,
  html.dark section.module label select,
  html.dark section.module label textarea {
    background: var(--pharm-surface);
    color: var(--pharm-text);
    border-color: var(--pharm-secondary);
  }
  section.module button.btn {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    background: var(--pharm-primary);
    color: #fff;
    padding: 0.75rem 1.25rem;
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    font-weight: 600;
    transition: background var(--transition), transform var(--transition);
  }
  section.module button.btn:hover {
    background: var(--pharm-primary-alt);
    transform: translateY(-2px);
  }

  /*──────────────────────────────────────────────────────────────────────────────
    RESPONSE PANELS
  ──────────────────────────────────────────────────────────────────────────────*/
  .response {
    background: var(--pharm-surface);
    border-left: 4px solid var(--pharm-secondary);
    padding: var(--padding);
    border-radius: var(--radius);
    margin-top: 1rem;
    position: relative;
    box-shadow: var(--shadow);
    transition: background var(--transition);
    word-wrap: break-word;
    white-space: pre-wrap;
  }
  .response .close-btn {
    position: absolute;
    top: var(--padding);
    right: var(--padding);
    background: none;
    color: var(--pharm-secondary);
    font-size: 1.2rem;
    border: none;
    cursor: pointer;
    transition: color var(--transition), transform var(--transition);
    display: none;
  }
  .response .close-btn:hover {
    color: var(--pharm-primary-alt);
    transform: scale(1.1);
  }
  .response .result-content {
    margin-top: 1.5rem;
    line-height: 1.5;
    color: var(--pharm-text);
  }
  .response.loading .close-btn {
    display: none;
  }
   .response.loading {
    max-height: 120px;
 }
  .response.loading .result-content {
   max-height: 80px;
    overflow-y: auto;
  }
.response.error {
    border-color: #e53e3e;
  }

  html.dark .response {
    background: var(--pharm-surface);
  }
  html.dark .response .result-content {
    color: var(--pharm-text);
  }
  .tool-row {
    margin-top: 0.5rem;
    display: flex;
    gap: 0.5rem;
  }
  .tool-row button {
    background: var(--pharm-surface);
    border: 1px solid var(--pharm-muted);
    border-radius: 50%;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--pharm-primary-alt);
    transition: background var(--transition), color var(--transition), transform var(--transition);
  }
  .tool-row button:hover {
    background: var(--pharm-primary-alt);
    color: #fff;
    transform: scale(1.1);
  }

  /*──────────────────────────────────────────────────────────────────────────────
    HERO SECTION
  ──────────────────────────────────────────────────────────────────────────────*/
  #hero {
    background: var(--pharm-surface);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    margin-bottom: 1.5rem;
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--padding);
    max-width: 1200px;
    margin-left: auto;
    margin-right: auto;
    overflow: hidden;
    position: relative;
    padding: var(--padding);
  }
  #hero .hero-text {
    display: flex;
    flex-direction: column;
    justify-content: center;
    gap: 1rem;
  }
  #hero h2 {
    font-size: 2rem;
    color: var(--pharm-primary);
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  #hero p.desc {
    font-size: 1rem;
    color: var(--pharm-muted);
  }
  #hero .hero-actions {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
    margin-top: 1rem;
  }
  #hero .hero-actions a.btn {
    background: var(--pharm-primary-alt);
    color: #fff;
    padding: 0.75rem 1.5rem;
    border-radius: var(--radius);
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    transition: background var(--transition), transform var(--transition), box-shadow var(--transition);
  }
  #hero .hero-actions a.btn:hover {
    background: var(--pharm-primary);
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
  }
  #hero .hero-image {
    display: flex;
    align-items: center;
    justify-content: center;
  }
  #hero .hero-image img {
    width: 100%;
    border-radius: var(--radius);
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
  }
  /* Decorative stickers */
  .sticker {
    position: absolute;
    font-size: 3rem;
    opacity: 0.15;
    color: var(--pharm-primary-alt);
    transition: transform var(--transition), opacity var(--transition);
  }
  .sticker:hover {
    opacity: 0.25;
    transform: scale(1.1);
  }

  /*──────────────────────────────────────────────────────────────────────────────
    CHATBOX & CHATBOT SECTION
  ──────────────────────────────────────────────────────────────────────────────*/
  .chat-box {
    background: var(--pharm-bg);
    border: 2px solid var(--pharm-primary-alt);
    border-radius: var(--radius);
    padding: var(--padding);
    max-height: 300px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    transition: background var(--transition), border-color var(--transition);
  }
  html.dark .chat-box {
    background: var(--pharm-surface);
    border-color: var(--pharm-secondary);
  }
  .chat-controls {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 0.5rem;
    flex-wrap: wrap;
  }
  .chat-controls button {
    background: var(--pharm-surface);
    border: 1px solid var(--pharm-muted);
    border-radius: 50%;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--pharm-secondary);
    transition: background var(--transition), transform var(--transition);
  }
  .chat-controls button:hover {
    background: var(--pharm-primary-alt);
    color: #fff;
    transform: scale(1.1);
  }
  .chat-input {
    display: flex;
    gap: 0.5rem;
    margin-top: 0.5rem;
  }
  .chat-input input {
    flex: 1;
    padding: 0.75rem;
    border: 2px solid var(--pharm-primary-alt);
    border-radius: var(--radius) 0 0 var(--radius);
    background: var(--pharm-bg);
    color: var(--pharm-text);
    font-size: 1rem;
  }
  html.dark .chat-input input {
    background: var(--pharm-surface);
    border-color: var(--pharm-secondary);
  }
  .chat-input button {
    border-radius: 0 var(--radius) var(--radius) 0;
    background: var(--pharm-primary);
    color: #fff;
    padding: 0 1rem;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background var(--transition), transform var(--transition);
  }
  .chat-input button:hover {
    background: var(--pharm-primary-alt);
    transform: scale(1.1);
  }
  .user-msg,
  .bot-msg {
    max-width: 70%;
    padding: 0.75rem;
    border-radius: var(--radius);
    line-height: 1.4;
    position: relative;
    word-wrap: break-word;
    transition: background var(--transition), color var(--transition);
  }
  .user-msg {
    align-self: flex-end;
    background: var(--pharm-primary);
    color: #fff;
    border-bottom-right-radius: 0;
  }
  .bot-msg {
    align-self: flex-start;
    background: var(--pharm-surface);
    color: var(--pharm-text);
    border-bottom-left-radius: 0;
  }
  html.dark .bot-msg {
    background: var(--pharm-surface);
    color: var(--pharm-text);
  }
  .timestamp,
  .msg-ts {
    font-size: 0.75rem;
    color: var(--pharm-muted);
    position: absolute;
    bottom: -1.2rem;
    right: 0.8rem;
  }
  .chat-date {
    text-align: center;
    margin: 1rem 0;
    font-size: 0.85rem;
    color: var(--pharm-muted);
  }
section.module label textarea {
    background: var(--pharm-bg);
    color: var(--pharm-text);
  }
  html.dark section.module label textarea {
   background: var(--pharm-surface);
    color: var(--pharm-text);
  }
html.dark .chat-input textarea {
    background: var(--pharm-surface);
  border-color: var(--pharm-secondary);
   color: var(--pharm-text);
  }

  /*──────────────────────────────────────────────────────────────────────────────
    HISTORY MODAL
  ──────────────────────────────────────────────────────────────────────────────*/
  .modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 2000;
  }
  .modal-content {
    background: var(--pharm-surface);
    border-radius: var(--radius);
    width: 90%;
    max-width: 500px;
    max-height: 80vh;
    overflow-y: auto;
    box-shadow: var(--shadow);
    position: relative;
    padding: var(--padding);
  }
  .modal-content h3 {
    margin-bottom: 1rem;
    color: var(--pharm-primary-alt);
  }
  .close-modal {
    position: absolute;
    top: 0.5rem;
    right: 0.75rem;
    font-size: 1.5rem;
    color: var(--pharm-muted);
    cursor: pointer;
    transition: color var(--transition), transform var(--transition);
  }
  .close-modal:hover {
    color: var(--pharm-primary-alt);
    transform: scale(1.1);
  }
  .history-item {
    margin-bottom: 1rem;
    border-bottom: 1px solid var(--pharm-secondary);
    padding-bottom: 0.5rem;
  }
  .delete-history {
    background: none;
    border: none;
    font-size: 1rem;
    color: var(--pharm-muted);
    cursor: pointer;
    transition: color var(--transition), transform var(--transition);
  }
  .delete-history:hover {
    color: var(--pharm-primary-alt);
    transform: scale(1.1);
  }
 .modal:not([hidden]) {
    display: flex;
  }

  /*──────────────────────────────────────────────────────────────────────────────
    CHARTS & EXPORT BUTTON
  ──────────────────────────────────────────────────────────────────────────────*/
  .chart-wrapper {
    background: var(--pharm-surface);
    border-radius: var(--radius);
    padding: var(--padding);
    box-shadow: var(--shadow);
  }
  .chart-wrapper h3 {
    margin-bottom: 0.75rem;
    color: var(--pharm-primary-alt);
    font-size: 1.25rem;
  }
  #chart1,
  #chart2 {
    width: 100% !important;
    height: 250px !important;
  }
  button#exportChartsData {
    margin-top: 1rem;
    background: var(--pharm-primary-alt);
    color: #fff;
    padding: 0.75rem 1.25rem;
    border-radius: var(--radius);
    font-weight: 600;
    box-shadow: var(--shadow);
    transition: background var(--transition), transform var(--transition);
  }
  button#exportChartsData:hover {
    background: var(--pharm-primary);
    transform: translateY(-2px);
  }

  /*──────────────────────────────────────────────────────────────────────────────
    “TALK TO A LICENSED PHARMACIST” SECTION
  ──────────────────────────────────────────────────────────────────────────────*/
  #pharmacyExpert .expert-features {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
    gap: 1.5rem;
    margin-top: 1rem;
  }
  #pharmacyExpert .feature-card {
    background: var(--pharm-surface);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    padding: var(--padding);
    text-align: center;
    transition: transform var(--transition), box-shadow var(--transition);
  }
  #pharmacyExpert .feature-card:hover {
    transform: translateY(-6px);
    box-shadow: 0 6px 24px rgba(0, 0, 0, 0.1);
  }
  #pharmacyExpert .feature-card i {
    font-size: 2.5rem;
    margin-bottom: 0.75rem;
    color: var(--pharm-primary-alt);
  }
  #pharmacyExpert .feature-card h3 {
    margin-bottom: 0.5rem;
    color: var(--pharm-secondary);
    font-size: 1.25rem;
  }
  #pharmacyExpert .feature-card p {
    color: var(--pharm-text);
    margin-bottom: 1rem;
    font-size: 0.95rem;
  }
  #pharmacyExpert .feature-card .btn {
    background: var(--pharm-primary-alt);
    color: #fff;
    padding: 0.6rem 1.2rem;
    border-radius: var(--radius);
    font-weight: 600;
    transition: background var(--transition), transform var(--transition);
  }
  #pharmacyExpert .feature-card .btn:hover {
    background: var(--pharm-primary);
    transform: translateY(-2px);
  }

  /*──────────────────────────────────────────────────────────────────────────────
    FOOTER
  ──────────────────────────────────────────────────────────────────────────────*/
  footer {
    margin-top: 2rem;
    text-align: center;
    color: var(--pharm-muted);
    font-size: 0.9rem;
  }

  /*──────────────────────────────────────────────────────────────────────────────
    RESPONSIVE ADJUSTMENTS
  ──────────────────────────────────────────────────────────────────────────────*/
  @media (max-width: 1024px) {
    #hero {
      grid-template-columns: 1fr;
    }
    .hero-image {
      margin-top: 1rem;
    }
    #pharmacyExpert .expert-features {
      grid-template-columns: 1fr;
    }
    section.module {
      padding: 0.75rem;
    }
  }
  @media (max-width: 768px) {
    header {
      left: 0 !important;
    }
    aside#sidebar {
      transform: translateX(-100%);
      transition: transform var(--transition);
    }
    body.sidebar-open aside#sidebar {
      transform: translateX(0);
    }
    main {
      margin-left: 0 !important;
      padding: 0.75rem;
    }
    #shrinkSidebar {
      display: none;
    }
    #hero h2 {
      font-size: 1.8rem;
    }
    .hero-actions a.btn {
      flex: 1 1 100%;
      justify-content: center;
    }
    #pharmacyExpert .feature-card {
      padding: 0.75rem;
    }
  }
  @media (max-width: 480px) {
    html {
      font-size: 14px;
    }
    header h1 {
      font-size: 1rem;
    }
    #hero h2 {
      font-size: 1.5rem;
    }
    .hero-actions a.btn {
      font-size: 0.9rem;
      padding: 0.6rem 1rem;
    }
    #hero p.desc,
    section.module p.desc {
      font-size: 0.9rem;
    }
    section.module h2 {
      font-size: 1.25rem;
    }
    .chat-controls button,
    .chat-input button {
      width: 100%;
      margin-top: 0.5rem;
      border-radius: var(--radius);
    }
    #pharmacyExpert .expert-features {
      grid-template-columns: 1fr;
      gap: 1rem;
    }
  }
</style>


</head>

<body>
  <!-- Sidebar -->
  <aside id="sidebar">
    <div class="brand">
      <i class="fas fa-prescription-bottle-alt"></i>
      <span>Vitra AI E-Pharmacy</span>
    </div>
    <nav>
      <ul>
        <li><a href="herbal.html"><i class="fas fa-seedling"></i> <span>Herbal Medicine</span></a></li>
        <li><a href="psychology.html"><i class="fas fa-brain"></i> <span>Psychology & MH</span></a></li>
        <li class="active"><a href="#"><i class="fas fa-prescription-bottle-alt"></i> <span>E-Pharmacy</span></a></li>
        <li><a href="dietetics.html"><i class="fas fa-apple-alt"></i> <span>Dietetics</span></a></li>
        <li><a href="consult.html"><i class="fas fa-calendar-check"></i> <span>Consult Booking</span></a></li>
      </ul>
    </nav>
    <button id="shrinkSidebar" title="Toggle sidebar" style="margin:0.5rem; background:none; border:none; cursor:pointer;">
      <i class="fas fa-chevron-left"></i>
    </button>
  </aside>

  <!-- Header -->
  <header>
    <i id="hamburger" class="fas fa-bars"></i>
    <h1>E-Pharmacy AI Suite</h1>
    <i id="themeToggle" class="fas fa-moon"></i>
  </header>


  <main>

      <!-- Hero Section -->
  <section id="hero" class="module">
    <div class="hero-text">
      <h2><i class="fas fa-prescription"></i> Empower Your E-Pharmacy Experience</h2>
      <p class="desc">AI-powered tools for prescription scanning, drug lookup, interaction checking, dosage planning & more.</p>
      <div class="hero-actions">
        <a href="#prescriptionScanner" class="btn"><i class="fas fa-camera"></i> Scan Prescription</a>
        <a href="#drugInfo" class="btn"><i class="fas fa-search"></i> Lookup Drug</a>
        <a href="#interactionChecker" class="btn"><i class="fas fa-shield-alt"></i> Check Interactions</a>
        <a href="#dosageCalculator" class="btn"><i class="fas fa-calculator"></i> Plan Dosage</a>
      </div>
    </div>
    <div class="hero-image">
      <img src="pills.jpg" alt="E-Pharmacy Illustration">
    </div>
    <!-- Decorative stickers -->
    <i class="fas fa-capsules sticker sticker-1" style="top:10%; left:15%;"></i>
    <i class="fas fa-vial sticker sticker-2" style="top:5%; right:20%;"></i>
    <i class="fas fa-notes-medical sticker sticker-3" style="bottom:10%; left:20%;"></i>
    <i class="fas fa-tag sticker sticker-4" style="bottom:15%; right:10%;"></i>
    <i class="fas fa-flask sticker sticker-5" style="top:50%; left:60%;"></i>
    <i class="fas fa-robot sticker sticker-6" style="top:30%; right:50%;"></i>
  </section>

    <!-- 0. Prescription Scanner & OCR -->
    <section id="prescriptionScanner" class="module">
      <h2><i class="fas fa-microscope"></i> Smart Prescription Builder</h2>
      <p class="desc">Upload or scan a handwritten prescription; AI will decode and structure it for you.</p>
      <label>Upload Prescription Image:
        <input type="file" id="rxImage" accept="image/*">
      </label>
      <label>Patient Age:
        <input type="number" id="rxAge" placeholder="e.g. 45">
      </label>
      <label>Weight (kg):
        <input type="number" id="rxWeight" placeholder="e.g. 70">
      </label>
      <label>Diagnosis:
        <select id="rxDiagnosis">
          <option>Asthma</option>
          <option>Malaria</option>
          <option>Hypertension</option>
          <option>Diabetes</option>
          <option>Typhoid</option>
          <option>Yellow Fever</option>
          <option>Hepatitis B</option>
          <option>HIV/AIDS</option>
          <option>Tuberculosis</option>
          <option>Cholera</option>
          <option>Sickle Cell</option>
          <option>Pneumonia</option>
          <option>Diarrhea</option>
          <option>Meningitis</option>
          <option>COVID-19</option>
          <option>Measles</option>
          <option>Polio</option>
          <option>Lassa Fever</option>
          <option>Dengue</option>
          <option>Other</option>
        </select>
        <input type="text" id="rxDiagOther" class="other-input" placeholder="Specify diagnosis…" style="display:none; margin-top:0.5rem;" required>
      </label>
      <label>Medication Type:
        <select id="rxMode">
          <option>Tablet</option>
          <option>Syrup</option>
          <option>Injection</option>
          <option>Cream</option>
          <option>Other</option>
        </select>
        <input type="text" id="rxModeOther" class="other-input" placeholder="Specify form…" style="display:none; margin-top:0.5rem;">
      </label>
      <label>Dosage Frequency:
        <select id="rxFreq">
          <option>Once daily</option>
          <option>Twice daily</option>
          <option>Every 8 hours</option>
          <option>As needed</option>
        </select>
      </label>
      <label>Additional Notes:
        <textarea id="rxNotes" rows="2" placeholder="e.g. take with food…"></textarea>
      </label>
      <button id="scanRx" class="btn"><i class="fas fa-cogs"></i> Build Prescription</button>
      <div id="scannerPanel" class="response" hidden>
        <button class="close-btn"><i class="fas fa-times"></i></button>
        <div class="result-content"></div>
      </div>
    </section>

    <!-- 1. Drug Information Lookup -->
    <section id="drugInfo" class="module">
      <h2><i class="fas fa-pills"></i> Drug Information Lookup</h2>
      <p class="desc">Search any medication to get monographs, dosage guidelines, side-effects, and safety data.</p>
      <label>Drug Name:
        <input list="drug-list" id="drugInput" placeholder="Type or select a drug…">
        <datalist id="drug-list">
          <option>Metformin</option><option>Lisinopril</option><option>Atorvastatin</option>
          <option>Omeprazole</option><option>Albuterol</option><option>Levothyroxine</option>
          <option>Amlodipine</option><option>Simvastatin</option><option>Gabapentin</option>
          <option>Citalopram</option><option>Losartan</option><option>Sertraline</option>
          <option>Furosemide</option><option>Hydrochlorothiazide</option><option>Prednisone</option>
          <option>Amoxicillin</option><option>Azithromycin</option><option>Clopidogrel</option>
          <option>Warfarin</option><option>Other</option>
        </datalist>
      </label>
      <button id="lookupDrug" class="btn"><i class="fas fa-search"></i> Lookup</button>
      <div id="drugInfoPanel" class="response" hidden>
        <button class="close-btn"><i class="fas fa-times"></i></button>
        <div class="result-content"></div>
      </div>
    </section>

    <!-- 2. Interaction Checker -->
    <section id="interactionChecker" class="module">
      <h2><i class="fas fa-exchange-alt"></i> Drug–Drug & Drug–Food Interaction Checker</h2>
      <p class="desc">Enter up to two medications and any food or supplement to check for potential interactions.</p>
      <label>Drug 1:
        <input list="drug-list" id="intDrug1" placeholder="e.g. Paracetamol">
      </label>
      <label>Drug 2:
        <input list="drug-list" id="intDrug2" placeholder="e.g. Aspirin">
      </label>
      <label>Food/Supplement:
        <input list="food-list" id="intFood" placeholder="e.g. Grapefruit, Milk…">
        <datalist id="food-list">
          <option>Grapefruit</option><option>Milk</option><option>Alcohol</option>
          <option>Iron supplement</option><option>Other</option>
        </datalist>
      </label>
      <button id="checkInteractions" class="btn"><i class="fas fa-shield-alt"></i> Check Interactions</button>
      <div id="interactionPanel" class="response" hidden>
        <button class="close-btn"><i class="fas fa-times"></i></button>
        <div class="result-content"></div>
      </div>
    </section>

    <!-- 3. Dosage Calculator & Titration Planner -->
    <section id="dosageCalculator" class="module">
      <h2><i class="fas fa-calculator"></i> Dosage & Titration Planner</h2>
      <p class="desc">Input patient metrics; AI will compute initial dose, titration schedule, and monitoring intervals.</p>
      <small>⦿ Titration: step-wise adjustments over time<br>⦿ Monitoring: when to check labs/vitals</small>
      <label>Weight (kg):
        <input type="number" id="patientWeight" placeholder="e.g. 70">
      </label>
      <label>Creatinine Clearance (mL/min):
        <input type="number" id="crCl" placeholder="e.g. 85">
      </label>
      <label>Liver Function (ALT U/L):
        <input type="number" id="altValue" placeholder="e.g. 30">
      </label>
      <button id="computeDose" class="btn"><i class="fas fa-cogs"></i> Compute Dose</button>
      <div id="dosagePanel" class="response" hidden>
        <button class="close-btn"><i class="fas fa-times"></i></button>
        <div class="result-content"></div>
      </div>
    </section>

    <!-- 4. Symptom-Based Drug Advisor -->
    <section id="symptomAdvisor" class="module">
      <h2><i class="fas fa-notes-medical"></i> Symptom-Based Drug Advisor</h2>
      <p class="desc">Describe your symptoms, and the AI suggests appropriate medications with dosages and follow-up advice.</p>
      <textarea id="symptomInput" rows="3" placeholder="e.g. headache, fever, cough…"></textarea>
      <button id="adviseDrug" class="btn"><i class="fas fa-stethoscope"></i> Recommend Medication</button>
      <div id="advisePanel" class="response" hidden>
        <button class="close-btn"><i class="fas fa-times"></i></button>
        <div class="result-content"></div>
      </div>
    </section>

    <!-- 5. Price Predictor & Locator -->
    <section id="pricePredictor" class="module">
      <h2><i class="fas fa-tag"></i> Price Predictor & Nearby Pharmacies</h2>
      <p class="desc">Get real-time price estimates in your chosen currency and view a map of nearby pharmacies.</p>
      <label>Drug:
        <input list="drug-list" id="priceDrugInput" placeholder="Select or type drug…">
      </label>
      <label>Currency:
        <input list="currency-list" id="currencyInput" placeholder="Currency…">
        <datalist id="currency-list">
          <option>USD</option><option>EUR</option><option>GBP</option><option>NGN</option>
          <option>GHS</option><option>CAD</option><option>AUD</option><option>JPY</option>
          <option>INR</option><option>CNY</option><option>Other</option>
        </datalist>
      </label>
      <button id="predictPrice" class="btn"><i class="fas fa-dollar-sign"></i> Predict Price</button>
      <div id="pricePanel" class="response" hidden>
        <button class="close-btn"><i class="fas fa-times"></i></button>
        <div class="result-content"></div>
        <div id="pharmacyMap" style="height:200px; margin-top:1rem;"></div>
      </div>
    </section>

    <!-- 6. Compound Formulation Advisor -->
    <section id="compoundAdvisor" class="module">
      <h2><i class="fas fa-flask"></i> Compound Formulation Advisor</h2>
      <p class="desc">List active ingredients & desired strength; AI returns a detailed compounding protocol with excipients, mixing order, and storage guidelines.</p>
      <small>⦿ Excipients: fillers, binders<br>⦿ Stability: shelf life, storage conditions</small>
      <textarea id="compoundList" rows="3" placeholder="e.g. Amoxicillin 125mg/mL, Glycerin…"></textarea>
      <label>Desired Strength:
        <input type="text" id="compoundStrength" placeholder="e.g. 20mg/mL">
      </label>
      <button id="adviseCompound" class="btn"><i class="fas fa-tools"></i> Advise Formulation</button>
      <div id="compoundPanel" class="response" hidden>
        <button class="close-btn"><i class="fas fa-times"></i></button>
        <div class="result-content"></div>
      </div>
    </section>

    <!-- 7. Side-Effect & Adverse Event Predictor -->
    <section id="sideEffectPredictor" class="module">
      <h2><i class="fas fa-exclamation-circle"></i> Side-Effect Predictor</h2>
      <p class="desc">Enter patient age, comorbidities, and chosen medications; AI predicts likely side-effects, severity grading, and monitoring advice.</p>
      <label>Age:
        <input type="number" id="patientAge" placeholder="e.g. 65">
      </label>
      <label>Comorbidities:
        <select id="comorbiditySelect">
          <option>Diabetes</option><option>Hypertension</option><option>CKD</option>
          <option>CHF</option><option>COPD</option><option>Other</option>
        </select>
        <input class="other-input" placeholder="Specify…" style="display:none; margin-top:0.5rem;">
      </label>
      <label>Medications:
        <input list="drug-list" id="sideEffectDrugs" placeholder="Select or type meds…">
      </label>
      <button id="predictSideEffects" class="btn"><i class="fas fa-heartbeat"></i> Predict Risks</button>
      <div id="sideEffectPanel" class="response" hidden>
        <button class="close-btn"><i class="fas fa-times"></i></button>
        <div class="result-content"></div>
      </div>
    </section>

    <!-- 8. Drug Education Chatbot -->
    <section id="drugChatbot" class="module">
      <h2><i class="fas fa-robot"></i> Drug-Education Chatbot</h2>
      <p class="desc">Ask any question about medications—AI provides answers with citations, dosing charts, and follow-ups.</p>
      <div class="chat-controls">
      <button id="clearPharmaChat" class="btn-secondary" type="button"><i class="fas fa-trash"></i> Clear Chat</button>
    <button id="historyBtn" class="btn" type="button" style="margin-left:0.5rem;"><i class="fas fa-history"></i> History</button>
      </div>
      <div id="pharmaChatBox" class="chat-box"></div>
      <form id="pharma-form" class="chat-input">
        <input id="pharmaInput" type="text" placeholder="Ask me anything about meds…">
        <button id="sendPharma" class="btn"><i class="fas fa-paper-plane"></i></button>
      </form>
    </section>

    <!-- History Modal -->
    <div id="historyModal" class="modal" hidden>
      <div class="modal-content">
        <span class="close-modal">&times;</span>
        <div class="modal-header">
          <h3>Chat History</h3>
           <button id="clearHistory" class="btn" type="button" style="float:right;"><i class="fas fa-trash-alt"></i></button>
        </div>
        <div id="historyList" style="max-height:400px; overflow-y:auto;"></div>
      </div>
    </div>

    <!-- 9. Bulk Refill Scheduler -->
    <section id="refillScheduler" class="module">
      <h2><i class="fas fa-sync-alt"></i> Bulk Refill Scheduler</h2>
      <p class="desc">Upload your medication list or select from options; AI will schedule refills, set reminders, and optimize dates.</p>
      <label>Upload CSV/XLSX:
        <input type="file" id="refillList" accept=".csv,.xlsx">
      </label>
      <label>Or Select Medications:
        <select id="refillSelect" multiple>
          <option>Amoxicillin</option>
          <option>Metformin</option>
          <option>Lisinopril</option>
          <option>Amlodipine</option>
          <option>Omeprazole</option>
          <option>Simvastatin</option>
          <option>Atorvastatin</option>
          <option>Albuterol</option>
          <option>Gabapentin</option>
          <option>Warfarin</option>
          <option>Prednisone</option>
          <option>Azithromycin</option>
          <option>Clopidogrel</option>
          <option>Citalopram</option>
          <option>Sertraline</option>
          <option>Furosemide</option>
          <option>Hydrochlorothiazide</option>
          <option>Levothyroxine</option>
          <option>Other</option>
        </select>
        <input type="text" id="refillOther" class="other-input" placeholder="Specify other medication…" style="display:none; margin-top:0.5rem;">
      </label>
      <button id="scheduleRefill" class="btn"><i class="fas fa-calendar-check"></i> Schedule Refills</button>
      <div id="refillPanel" class="response" hidden>
        <button class="close-btn"><i class="fas fa-times"></i></button>
        <div class="result-content"></div>
      </div>
    </section>

    <!-- 10. Usage Statistics (Real-Time Charts) -->
    <section id="charts" class="module">
      <h2><i class="fas fa-chart-line"></i> Usage Statistics</h2>
      <p class="desc">These charts update in real time—showing this month’s prescription scans and weekly drug lookups.</p>
      <div class="chart-wrapper">
        <h3>Monthly Prescription Scans</h3>
        <canvas id="chart1"></canvas>
      </div>
      <div class="chart-wrapper" style="margin-top:1.5rem;">
        <h3>Weekly Drug Lookups</h3>
        <canvas id="chart2"></canvas>
      </div>
      <button id="exportChartsData" class="btn" style="margin-top:1.5rem;"><i class="fas fa-file-export"></i> Export Data (CSV)</button>
    </section>

    <!-- 11. Talk to a Licensed Pharmacist -->
    <section id="pharmacyExpert" class="module">
      <h2><i class="fas fa-user-md"></i> Talk to a Licensed Pharmacist</h2>
      <p class="desc">Connect with one of our certified pharmacists in real time—get personalized advice, medication counseling, and follow-up recommendations.</p>
      <div class="expert-features">
        <div class="feature-card">
          <i class="fas fa-video"></i>
          <h3>Live Video Consultation</h3>
          <p>Speak face-to-face with a pharmacist for urgent questions or complex therapies.</p>
          <a class="btn" href="video-consult.html"><i class="fas fa-play"></i> Start Video Call</a>
        </div>
        <div class="feature-card">
          <i class="fas fa-comments"></i>
          <h3>Secure Chat Support</h3>
          <p>Chat with a pharmacist to clarify drug interactions, side-effects, or dosage queries.</p>
          <a class="btn" href="chat-consult.html"><i class="fas fa-comment"></i> Open Chat</a>
        </div>
        <div class="feature-card">
          <i class="fas fa-calendar-plus"></i>
          <h3>Schedule Appointment</h3>
          <p>Book a one-on-one session for comprehensive medication management and therapy reviews.</p>
          <a class="btn" href="consult.html"><i class="fas fa-calendar-check"></i> Book Now</a>
        </div>
      </div>
    </section>

    <!-- Footer -->
    <footer>
      <p style="text-align:center; margin-top:2rem; color:var(--pharm-muted);">
        &copy; 2025 Vitra AI E-Pharmacy. All Rights Reserved.
      </p>
    </footer>
  </main>


<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  //──────────────────────────────────────────────────────────────────────────────
  // TOAST HELPER
  //──────────────────────────────────────────────────────────────────────────────
  function showToast(message) {
    const toast = document.createElement('div');
    toast.className = 'toast';
    toast.textContent = message;
    document.body.appendChild(toast);
    requestAnimationFrame(() => toast.classList.add('visible'));
    setTimeout(() => {
      toast.classList.remove('visible');
      setTimeout(() => toast.remove(), 300);
    }, 2000);
  }

  //──────────────────────────────────────────────────────────────────────────────
  // SANITIZE & FORMAT SIMPLE MARKDOWN-LIKE AI RESPONSES
  //──────────────────────────────────────────────────────────────────────────────
  function sanitizeAIContent(raw) {
    let inTable = false;
    return raw
      .replace(/```([\s\S]+?)```/g, (_, code) => `<pre>${code.trim()}</pre>`)
      .replace(/^#### (.+)$/gm, '<h4>$1</h4>')
      .replace(/^### (.+)$/gm, '<h3>$1</h3>')
      .replace(/^## (.+)$/gm, '<h2>$1</h2>')
      .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
      .replace(/\*(.+?)\*/g, '<em>$1</em>')
      .replace(/^\|(.+)\|$/gm, (_, row) => {
        const cols = row.split('|').map(c => c.trim());
        if (!inTable) {
          inTable = true;
          return '<table><thead><tr>' +
            cols.map(c => `<th>${c}</th>`).join('') +
            '</tr></thead><tbody>';
        }
        return '<tr>' + cols.map(c => `<td>${c}</td>`).join('') + '</tr>';
      })
      .replace(/$/, () => {
        if (inTable) {
          inTable = false;
          return '</tbody></table>';
        }
        return '';
      });
  }

  //──────────────────────────────────────────────────────────────────────────────
  // GENERIC AI CALL FUNCTION
  //──────────────────────────────────────────────────────────────────────────────
  async function callAI(messages, retries = 1) {
    try {
      const response = await fetch('/.netlify/functions/openai-proxy', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ messages })
      });
      if (!response.ok) {
        const errText = await response.text();
        throw new Error(`OpenAI error ${response.status}: ${errText}`);
      }
      const data = await response.json();
      const content = data.choices?.[0]?.message?.content;
      if (!content) throw new Error('Malformed AI response');
      return content.trim();
    } catch (err) {
      if (retries > 0 && err.message.includes('Timedout')) {
        await new Promise(r => setTimeout(r, 1000));
        return callAI(messages, retries - 1);
      }
      return `⚠️ ${err.message}`;
    }
  }

  //──────────────────────────────────────────────────────────────────────────────
  // SPINNER & PHASE TEXT
  //──────────────────────────────────────────────────────────────────────────────
  const PHASE_TEXT = {
    scanRx: 'Decoding prescription…',
    lookupDrug: 'Retrieving drug data…',
    checkInteractions: 'Analyzing interactions…',
    computeDose: 'Calculating dosage…',
    adviseDrug: 'Formulating recommendation…',
    predictPrice: 'Estimating price…',
    adviseCompound: 'Designing formulation…',
    predictSideEffects: 'Predicting side-effects…',
    scheduleRefill: 'Scheduling refills…'
  };

  function startThinking(panel, btnId) {
    panel.hidden = false;
    panel.classList.add('loading');
   const contentDiv = panel.querySelector('.result-content');
   contentDiv.innerHTML = `
     <div style="display:flex; align-items:center; gap:0.5rem;">
        <div class="spinner" style="width:1rem; height:1rem; border-width:2px;"></div>
     </div>`;
   const oldTools = panel.querySelector('.tool-row');
    if (oldTools) oldTools.remove();
    panel.querySelector('.close-btn').style.display = 'none';
  }

  function injectTools(panel) {
    panel.classList.remove('loading');
    if (panel.querySelector('.tool-row')) return;
    const tools = document.createElement('div');
    tools.className = 'tool-row';
    tools.innerHTML = `
      <button class="copy-btn"><i class="fas fa-copy"></i></button>
      <button class="dl-btn"><i class="fas fa-download"></i></button>
    `;
    panel.appendChild(tools);
    panel.querySelector('.close-btn').style.display = 'block';
  }

  //──────────────────────────────────────────────────────────────────────────────
  // SIDEBAR TOGGLE & COLLAPSE
  //──────────────────────────────────────────────────────────────────────────────
  document.getElementById('hamburger').onclick = () => {
    document.body.classList.toggle('sidebar-open');
  };
  const shrinkBtn = document.getElementById('shrinkSidebar');
  shrinkBtn.onclick = () => {
    const sb = document.getElementById('sidebar');
    sb.classList.toggle('collapsed');
    const icon = shrinkBtn.querySelector('i');
    icon.classList.toggle('fa-chevron-left');
    icon.classList.toggle('fa-chevron-right');
    document.querySelector('header').style.left =
      sb.classList.contains('collapsed') ? '60px' : '220px';
    document.querySelector('main').style.marginLeft =
      sb.classList.contains('collapsed') ? '70px' : '240px';
  };
document.addEventListener('click', e => {
    const sb = document.getElementById('sidebar');
    if (document.body.classList.contains('sidebar-open')) {
     if (!sb.contains(e.target) && !document.getElementById('hamburger').contains(e.target)) {
        document.body.classList.remove('sidebar-open');
     }
    }
  });


  //──────────────────────────────────────────────────────────────────────────────
  // THEME TOGGLE
  //──────────────────────────────────────────────────────────────────────────────
  document.getElementById('themeToggle').onclick = () => {
    document.documentElement.classList.toggle('dark');
    document.getElementById('themeToggle').classList.toggle('fa-moon');
    document.getElementById('themeToggle').classList.toggle('fa-sun');
  };

  //──────────────────────────────────────────────────────────────────────────────
  // SMOOTH SCROLL FOR HERO ACTION LINKS
  //──────────────────────────────────────────────────────────────────────────────
  document.querySelectorAll('.hero-actions a[href^="#"]').forEach(anchor => {
    anchor.addEventListener('click', e => {
      e.preventDefault();
      const target = document.querySelector(anchor.getAttribute('href'));
      if (!target) return;
      const offset = target.getBoundingClientRect().top + window.pageYOffset - 70;
      window.scrollTo({ top: offset, behavior: 'smooth' });
    });
  });

  //──────────────────────────────────────────────────────────────────────────────
  // “OTHER” INPUT LOGIC FOR SELECT FIELDS
  //──────────────────────────────────────────────────────────────────────────────
  document.getElementById('rxDiagnosis').onchange = () => {
    document.getElementById('rxDiagOther').style.display =
      document.getElementById('rxDiagnosis').value === 'Other' ? 'block' : 'none';
  };
  document.getElementById('rxMode').onchange = () => {
    document.getElementById('rxModeOther').style.display =
      document.getElementById('rxMode').value === 'Other' ? 'block' : 'none';
  };
  document.getElementById('comorbiditySelect').onchange = () => {
    const otherInput = document.querySelector('#comorbiditySelect + .other-input');
    if (otherInput) {
      otherInput.style.display =
        document.getElementById('comorbiditySelect').value === 'Other' ? 'block' : 'none';
    }
  };
  document.getElementById('refillSelect').addEventListener('change', e => {
    document.getElementById('refillOther').style.display =
      Array.from(e.target.selectedOptions).some(o => o.value === 'Other') ? 'block' : 'none';
  });

  //──────────────────────────────────────────────────────────────────────────────
  // WIRE HERO ACTIONS TO MODULE PROMPTS
  //──────────────────────────────────────────────────────────────────────────────
  function wireHero(btnSelector, panelId, buildPrompt) {
    document.getElementById(btnSelector).addEventListener('click', async e => {
      e.preventDefault();
      const panel = document.getElementById(panelId);
      startThinking(panel, btnSelector);
      const aiResponse = await callAI([
        { role: 'system', content: `You are a helpful e-pharmacy AI.` },
        { role: 'user', content: buildPrompt() }
      ]);
      if (aiResponse.startsWith('⚠️')) {
       panel.classList.add('error');
        panel.querySelector('.result-content').textContent = aiResponse;
      } else {
       panel.classList.remove('error');
       panel.querySelector('.result-content').innerHTML = sanitizeAIContent(aiResponse);
      }

      injectTools(panel);
      savePanelsToStorage();
    });
  }

  wireHero('scanRx', 'scannerPanel', () => {
    const fileInput = document.getElementById('rxImage').files[0];
    const age = document.getElementById('rxAge').value.trim();
    const weight = document.getElementById('rxWeight').value.trim();
    let diag = document.getElementById('rxDiagnosis').value;
    if (diag === 'Other') diag = document.getElementById('rxDiagOther').value.trim();
    let mode = document.getElementById('rxMode').value;
    if (mode === 'Other') mode = document.getElementById('rxModeOther').value.trim();
    const freq = document.getElementById('rxFreq').value;
    const notes = document.getElementById('rxNotes').value.trim();
    if ((!fileInput && (!age || !weight || !diag || !mode || !freq))) {
      return '⚠️ Please upload an image or fill all required fields (age, weight, diagnosis, form, frequency).';
   }
    let prompt = 'Build a structured prescription:';
    if (fileInput) prompt += ' [OCR IMAGE SCAN]';
    prompt += ` Patient Age: ${age || 'N/A'}, Weight: ${weight || 'N/A'}kg, Diagnosis: ${diag}, Form: ${mode}, Frequency: ${freq}. Notes: ${notes || 'None'}.`;
    return prompt;
  });

  wireHero('lookupDrug', 'drugInfoPanel', () => {
    const drug = document.getElementById('drugInput').value.trim();
    if (!drug) return '⚠️ Please specify a drug.';
   return `You are a pharmacy expert AI. Provide a detailed monograph for "${drug}", covering: 1) Mechanism of action 2) Typical adult dosing (including renal/hepatic adjustments) 3) Major side effects and monitoring recommendations 4) Key patient counseling points 5) Contraindications and precautions.`;
  });

  wireHero('checkInteractions', 'interactionPanel', () => {
    const d1 = document.getElementById('intDrug1').value.trim();
    const d2 = document.getElementById('intDrug2').value.trim();
    const food = document.getElementById('intFood').value.trim();
    if (!d1 || !d2) return '⚠️ Please enter two drugs to check interactions.';
    let prompt = `Check interactions between ${d1} and ${d2}.`;
    if (food) prompt += ` Also consider when taken with ${food}.`;
    return prompt;
  });

  wireHero('computeDose', 'dosagePanel', () => {
    const w = document.getElementById('patientWeight').value.trim();
    const c = document.getElementById('crCl').value.trim();
    const a = document.getElementById('altValue').value.trim();
    if (!w || !c || !a) return '⚠️ Please fill weight, creatinine clearance, and ALT values.';
    return `Calculate initial dose and titration schedule for a patient weighing ${w}kg, CrCl ${c}mL/min, ALT ${a}U/L.`;
  });

  wireHero('adviseDrug', 'advisePanel', () => {
    const symptoms = document.getElementById('symptomInput').value.trim();
    if (!symptoms) return '⚠️ Please describe your symptoms.';
    return `Recommend appropriate medications (with dosages and follow-up advice) for symptoms: ${symptoms}.`;
  });

  wireHero('predictPrice', 'pricePanel', () => {
    const d = document.getElementById('priceDrugInput').value.trim();
    const ccy = document.getElementById('currencyInput').value.trim();
    if (!d || !ccy) return '⚠️ Please select a drug and currency.';
    return `Provide real-time price estimate for ${d} in ${ccy}, and list nearby pharmacies to purchase it.`;
  });

  wireHero('adviseCompound', 'compoundPanel', () => {
    const ingredients = document.getElementById('compoundList').value.trim();
    const strength = document.getElementById('compoundStrength').value.trim();
    if (!ingredients || !strength) return '⚠️ Please list ingredients and desired strength.';
    return `Design a compounding protocol for: ${ingredients}, final strength ${strength}, including excipients, mixing order, and storage guidelines.`;
  });

  wireHero('predictSideEffects', 'sideEffectPanel', () => {
    const age = document.getElementById('patientAge').value.trim();
    const comorbid = document.getElementById('comorbiditySelect').value;
    const comorbidOtherEl = document.querySelector('#comorbiditySelect + .other-input');
    let finalComorb = comorbid;
    if (comorbid === 'Other' && comorbidOtherEl) finalComorb = comorbidOtherEl.value.trim();
    const meds = document.getElementById('sideEffectDrugs').value.trim();
    if (!age || !meds) return '⚠️ Please enter patient age and medications.';
    return `Predict likely side-effects (severity and monitoring advice) for a ${age}-year-old with comorbidities: ${finalComorb || 'None'}, taking: ${meds}.`;
  });

  //──────────────────────────────────────────────────────────────────────────────
  // BULK REFILL SCHEDULER WIRING
  //──────────────────────────────────────────────────────────────────────────────
  document.getElementById('scheduleRefill').onclick = async e => {
    e.preventDefault();
    const file = document.getElementById('refillList').files[0];
    const selected = Array.from(document.getElementById('refillSelect').selectedOptions).map(o => o.value);
    const otherText = document.getElementById('refillOther').value.trim();
    if (!file && selected.length === 0 && !otherText) {
      return showToast('⚠️ Upload a file or select/type at least one medication.');
    }
    let meds = selected.filter(m => m !== 'Other');
    if (selected.includes('Other') && otherText) meds.push(otherText);
    if (meds.length === 0 && file) {
      const text = await file.text();
      meds = text.split('\n').slice(1).map(l => l.split(',')[0]).filter(Boolean);
    }
    const panel = document.getElementById('refillPanel');
    startThinking(panel, 'scheduleRefill');
    const prompt = `Schedule refill reminders and generate a refill calendar for: ${meds.join(', ')}.`;
    const aiReply = await callAI([
      { role: 'system', content: 'You are a pharmacy scheduler AI.' },
      { role: 'user', content: prompt }
    ]);
     if (aiReply.startsWith('⚠️')) {
     panel.classList.add('error');
      panel.querySelector('.result-content').textContent = aiReply;
     } else {
     panel.classList.remove('error');
     panel.querySelector('.result-content').innerHTML = sanitizeAIContent(aiReply);
    }
     injectTools(panel);
  };

  //──────────────────────────────────────────────────────────────────────────────
  // COPY / DOWNLOAD / CLOSE FOR RESPONSE PANELS
  //──────────────────────────────────────────────────────────────────────────────
  document.body.addEventListener('click', e => {
    const panel = e.target.closest('.response');
    if (!panel) return;
    // Copy
    if (e.target.closest('.copy-btn')) {
      const text = panel.querySelector('.result-content').innerText;
      navigator.clipboard.writeText(text).then(() => showToast('Copied!'));
    }
    // Download
    if (e.target.closest('.dl-btn')) {
      const text = panel.querySelector('.result-content').innerText;
      const blob = new Blob([text], { type: 'text/plain' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'response.txt';
      a.click();
    }
    // Close
    if (e.target.closest('.close-btn')) {
      panel.hidden = true;
    }
  });

  //──────────────────────────────────────────────────────────────────────────────
  // DRUG-EDUCATION CHATBOT + HISTORY
  //──────────────────────────────────────────────────────────────────────────────
  const chatBox = document.getElementById('pharmaChatBox');
  const chatInput = document.getElementById('pharmaInput');
  const sendChatBtn = document.getElementById('sendPharma');
  const clearChatBtn = document.getElementById('clearPharmaChat');
  const historyBtn = document.getElementById('historyBtn');
  const historyModal = document.getElementById('historyModal');
  const historyList = document.getElementById('historyList');
  const closeModalBtn = document.querySelector('.close-modal');
  let lastDateKey = null;
  const chatHistory = [];

  function formatDateSeparator(date) {
    const today = new Date();
    const diffDays = Math.floor((today.setHours(0,0,0,0) - date.setHours(0,0,0,0)) / 86400000);
    if (diffDays === 0) return 'Today';
    if (diffDays === 1) return 'Yesterday';
    return date.toLocaleDateString();
  }

  function addChatMessage(role, text) {
    const now = new Date();
    const dateKey = now.toDateString();
    if (dateKey !== lastDateKey) {
      const sep = document.createElement('div');
      sep.className = 'chat-date';
      sep.textContent = formatDateSeparator(now);
      chatBox.append(sep);
      lastDateKey = dateKey;
    }
    const wrapper = document.createElement('div');
    wrapper.className = role === 'user' ? 'user-msg' : 'bot-msg';
    wrapper.innerHTML = `
      <div class="msg-text">${text}</div>
      <div class="msg-ts">${now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</div>
    `;
    chatBox.append(wrapper);
    chatBox.scrollTop = chatBox.scrollHeight;
    chatHistory.push({ role, text, time: `${now.toDateString()} ${now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}` });
 saveChatToStorage();
  }

  sendChatBtn.onclick = async e => {
    e.preventDefault();
    const question = chatInput.value.trim();
    if (!question) return showToast('⚠️ Please type a question.');
    addChatMessage('user', question);
    chatInput.value = '';
    // Show spinner
    addChatMessage('bot', `<div style="display:flex; justify-content:center;"><div class="spinner" style="width:1rem; height:1rem; border-width:2px;"></div></div>`);

    // Call AI
    const aiReply = await callAI([
      { role: 'system', content: 'You are a knowledgeable pharmacy AI.' },
      { role: 'user', content: question }
    ]);
    const lastMsg = chatBox.querySelectorAll('.bot-msg');
   if (lastMsg.length) lastMsg[lastMsg.length - 1].remove();
    addChatMessage('bot', sanitizeAIContent(aiReply));
  };

  clearChatBtn.onclick = () => {
    chatBox.innerHTML = '';
    lastDateKey = null;
    chatHistory.length = 0;
  };

  historyBtn.onclick = e => {
    e.preventDefault();
    historyList.innerHTML = chatHistory.map((entry, i) => `
      <div class="history-item">
        <strong>${entry.role === 'user' ? 'You:' : 'Bot:'}</strong> ${entry.text}
        <div class="msg-ts">${entry.time}</div>
        <button class="delete-history" data-index="${i}">×</button>
      </div>
    `).join('');
    historyModal.hidden = false;
    localStorage.setItem('historyOpen', 'true');
  };

  closeModalBtn.onclick = () => {
    historyModal.hidden = true;
    localStorage.setItem('historyOpen', 'false');

  };

  historyList.addEventListener('click', e => {
    if (!e.target.matches('.delete-history')) return;
    const idx = +e.target.dataset.index;
    chatHistory.splice(idx, 1);
    e.target.closest('.history-item').remove();
  });

  //──────────────────────────────────────────────────────────────────────────────
  // CHARTS SETUP & REAL-TIME UPDATES
  //──────────────────────────────────────────────────────────────────────────────
  const ctx1 = document.getElementById('chart1').getContext('2d');
  const ctx2 = document.getElementById('chart2').getContext('2d');

  // Initial dummy data
  const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  const days = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];

  const data1 = {
    labels: months.slice(new Date().getMonth()), // from current month to year-end
    datasets: [{ label: 'Rx Scans', data: [], borderWidth: 2 }]
  };
  const data2 = {
    labels: days,
    datasets: [{ label: 'Drug Lookups', data: [], backgroundColor: [] }]
  };

 //──────────────────────────────────────────────────────────────────────────────
  // STATE PERSISTENCE: LOAD FROM localStorage
 //──────────────────────────────────────────────────────────────────────────────
  if (localStorage.getItem('darkMode') === 'true') {
    document.documentElement.classList.add('dark');
   document.getElementById('themeToggle').classList.replace('fa-moon', 'fa-sun');
 }
  function restorePanels() {
   const panelsData = JSON.parse(localStorage.getItem('panels') || '{}');
   Object.entries(panelsData).forEach(([id, html]) => {
     const panel = document.getElementById(id);
     if (panel && html) {
        panel.hidden = false;
       panel.querySelector('.result-content').innerHTML = html;
        injectTools(panel);
      }
    });
 }
 function savePanelsToStorage() {
    const panels = {};
   document.querySelectorAll('.response').forEach(panel => {
     if (!panel.hidden) {
       panels[panel.id] = panel.querySelector('.result-content').innerHTML;
     }
   });
   localStorage.setItem('panels', JSON.stringify(panels));
 }
 function restoreChat() {
   const stored = JSON.parse(localStorage.getItem('chatHistory') || '[]');
   stored.forEach(entry => addChatMessage(entry.role, entry.text));
 }
  function saveChatToStorage() {
    localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
  }
 // Restore chat history & panels
 restoreChat();
 restorePanels();
 if (localStorage.getItem('historyOpen') === 'true') {
   historyBtn.click();
 }

  
  // Populate with random initial values
  for (let i = 0; i < data1.labels.length; i++) {
    data1.datasets[0].data.push(Math.floor(Math.random() * 400) + 600);
  }
  for (let i = 0; i < data2.labels.length; i++) {
    data2.datasets[0].data.push(Math.floor(Math.random() * 50) + 20);
    data2.datasets[0].backgroundColor.push(getComputedStyle(document.documentElement).getPropertyValue('--pharm-primary-alt').trim());
  }

  const chart1Instance = new Chart(ctx1, {
    type: 'line',
    data: data1,
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { title: { display: true, text: 'Monthly Prescription Scans' } },
      scales: {
        x: { title: { display: true, text: 'Month' } },
        y: { title: { display: true, text: 'Scans' }, beginAtZero: true }
      }
    }
  });

  const chart2Instance = new Chart(ctx2, {
    type: 'bar',
    data: data2,
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { title: { display: true, text: 'Weekly Drug Lookups' } },
      scales: {
        x: { title: { display: true, text: 'Day' } },
        y: { title: { display: true, text: 'Lookups' }, beginAtZero: true }
      }
    }
  });

  // Simulate real-time updates every 30 seconds
  setInterval(() => {
    // Update chart1: push a new value for next month, shift if needed
    const nextMonthIndex = (months.indexOf(data1.labels[data1.labels.length - 1]) + 1) % 12;
    const newMonth = months[nextMonthIndex];
    const newScanValue = Math.floor(Math.random() * 400) + 600;
    data1.labels.push(newMonth);
    data1.datasets[0].data.push(newScanValue);
    if (data1.labels.length > 12) {
      data1.labels.shift();
      data1.datasets[0].data.shift();
    }
    chart1Instance.update();

    // Update chart2: shift data array by one day and push a new random value
    data2.datasets[0].data.shift();
    data2.datasets[0].data.push(Math.floor(Math.random() * 50) + 20);
    chart2Instance.update();
  }, 30000);

  // Export combined CSV
  document.getElementById('exportChartsData').onclick = () => {
    let csv = 'Month,Scans\n';
    data1.labels.forEach((lbl, i) => {
      csv += `"${lbl}",${data1.datasets[0].data[i]}\n`;
    });
    csv += '\nDay,Lookups\n';
    data2.labels.forEach((lbl, i) => {
      csv += `"${lbl}",${data2.datasets[0].data[i]}\n`;
    });
    const blob = new Blob([csv], { type: 'text/csv' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'epharmacy_usage_stats.csv';
    a.click();
  };

});
</script>

</body>
</html>
