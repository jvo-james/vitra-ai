<!DOCTYPE html>
<html lang="en" aria-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>E-Pharmacy AI Portal</title>

  <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;700&display=swap" rel="stylesheet">
  <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">


  <!-- Shared Styles -->
<style>
  /*──────────────────── Pharmacy Theme Colors ────────────────────*/
  :root {
    --pharm-primary: #005f73;
    --pharm-primary-alt: #0a9396;
    --pharm-secondary: #94d2bd;
    --pharm-accent: #e9d8a6;
    --pharm-bg: #f0efeb;
    --pharm-surface: #ffffff;
    --pharm-text: #001219;
    --pharm-muted: #555;
    --radius: 0.75rem;
    --padding: 1rem;
    --transition: 0.3s ease;
    --shadow: 0 4px 12px rgba(0,0,0,0.1);
  }
  html.dark {
    --pharm-bg: #001219;
    --pharm-surface: #002e2e;
    --pharm-text: #e0fbfc;
    --pharm-muted: #889;
  }

  /*──────────────────── Reset & Base ────────────────────*/
  * { margin:0; padding:0; box-sizing:border-box; }
  body {
    font-family: 'Montserrat', sans-serif;
    background: var(--pharm-bg);
    color: var(--pharm-text);
    transition: background var(--transition), color var(--transition);
  }
  a { text-decoration:none; color: inherit; }
  h1,h2,h3,h4 { color: var(--pharm-primary); }
  p.desc { color: var(--pharm-muted); margin-bottom:0.75rem; }
  button, input, select, textarea { font-family:inherit; transition: var(--transition); }
  :focus { outline:2px solid var(--pharm-primary-alt); }

  /*──────────────────── Sidebar ────────────────────*/
  aside#sidebar {
    position:fixed; top:0; left:0; bottom:0;
    width:220px; background: var(--pharm-surface);
    box-shadow: var(--shadow); z-index:1000;
    display:flex; flex-direction:column;
  }
  aside#sidebar .brand {
    display:flex; align-items:center; gap:0.5rem;
    padding:var(--padding); font-size:1.25rem;
    background: var(--pharm-primary); color:#fff;
  }
  aside#sidebar nav ul { list-style:none; flex:1; overflow-y:auto; }
  aside#sidebar nav li { }
  aside#sidebar nav li a {
    display:flex; align-items:center; gap:0.75rem;
    padding:0.75rem var(--padding); border-radius:var(--radius);
    color: var(--pharm-text);
  }
  aside#sidebar nav li.active a,
  aside#sidebar nav li a:hover {
    background: var(--pharm-primary-alt);
    color:#fff;
  }

  /*──────────────────── Header ────────────────────*/
  header {
    position: sticky; /* now sticky */
   top: 0; left: 220px; right: 0;
  z-index: 1001;
    height:60px; background: var(--pharm-surface);
    display:flex; align-items:center; justify-content:space-between;
    padding:0 var(--padding); box-shadow:var(--shadow);
    transition:left var(--transition);
  }
  #hamburger, #themeToggle {
    font-size:1.5rem; color: var(--pharm-primary); cursor:pointer;
  }
  @media(max-width:768px) {
    header { left:0; }
    aside#sidebar { transform:translateX(-100%); transition:transform .3s; }
    body.sidebar-open aside#sidebar { transform:none; }
  }

  /*──────────────────── Main Modules ────────────────────*/
  main {
    margin:80px var(--padding) var(--padding) 240px;
    transition:margin-left var(--transition);
  }
  section.module {
    background: var(--pharm-surface);
    border-radius: var(--radius);
    padding: var(--padding);
    margin-bottom:1.5rem;
    box-shadow:var(--shadow);
    transition: transform var(--transition);
  }
  section.module:hover { transform: translateY(-4px); }

  /*──────────────────── Hero Section ────────────────────*/
  #hero {
    position:relative; overflow:hidden;
    background: linear-gradient(120deg, var(--pharm-primary), var(--pharm-primary-alt));
    color:#fff; padding:2rem var(--padding);
    border-radius: var(--radius); margin-bottom:2rem;
  }
  #hero h2 { font-size:2rem; display:flex; align-items:center; gap:0.5rem; }
  #hero p.desc { color:rgba(255,255,255,0.9); }
  .hero-features {
    display:grid;
    grid-template-columns: repeat(auto-fit,minmax(180px,1fr));
    gap:1rem; margin-top:1.5rem;
  }
  .feature-card {
    background:rgba(255,255,255,0.1);
    padding:1rem; border-radius:var(--radius);
    text-align:center; box-shadow:0 2px 8px rgba(0,0,0,0.2);
    transition:background .3s, transform .3s;
  }
  .feature-card:hover {
    background:rgba(255,255,255,0.2);
    transform: translateY(-6px);
  }
  .feature-card i {
    font-size:2.5rem; margin-bottom:0.5rem;
  }
  .feature-card h3 { margin-bottom:0.75rem; }
  .feature-card .btn {
    background:#fff; color:var(--pharm-primary);
    border:none; padding:0.5rem 1rem; border-radius:var(--radius);
  }
  .feature-card .btn:hover {
    background: var(--pharm-secondary); color:#000;
  }

  /* Stickers */
  .sticker {
    position:absolute; font-size:3rem; opacity:0.15;
    color:#fff; transition:transform .3s;
  }
  .sticker:hover { transform:scale(1.1); opacity:0.25; }

  /*──────────────────── Forms & Inputs ────────────────────*/
  input[type="text"], input[type="number"], input[type="file"],
  input[list], select, textarea {
    width:100%; padding:0.75rem; margin-top:0.5rem;
    border:2px solid var(--pharm-primary-alt);
    border-radius:var(--radius);
    background:var(--pharm-bg); color:var(--pharm-text);
  }
  input:focus, select:focus, textarea:focus {
    border-color:var(--pharm-secondary); box-shadow:0 0 0 3px rgba(148,210,189,0.3);
  }
  label { display:block; margin-bottom:1rem; color:var(--pharm-text); }
  button.btn {
    display:inline-flex; align-items:center; gap:0.5rem;
    background:var(--pharm-primary); color:#fff;
    border:none; padding:0.75rem 1.25rem;
    border-radius:var(--radius); box-shadow:var(--shadow);
    cursor:pointer; transition:background var(--transition);
  }
  button.btn:hover { background:var(--pharm-primary-alt); }

  /*──────────────────── Response Panels ────────────────────*/
  .response {
    background: var(--pharm-surface);
    border-left:4px solid var(--pharm-secondary);
    margin-top:1rem; padding:var(--padding);
    position:relative; box-shadow:var(--shadow);
  }
  .response .close-btn {
    position:absolute; top:0.5rem; right:0.5rem;
    background:none; border:none; font-size:1.1rem; cursor:pointer;
  }
  .response .result-content {
    margin-top:1.5rem; line-height:1.5; white-space:pre-wrap;
  }

  /*──────────────────── Interaction & Chatbot ────────────────────*/
  .chat-box {
    background:var(--pharm-bg); border:2px solid var(--pharm-primary-alt);
    border-radius:var(--radius); padding:var(--padding);
    max-height:300px; overflow-y:auto; margin-bottom:0.5rem;
  }
  .chat-input { display:flex; gap:0.5rem; }
  .chat-input input {
    flex:1; border-radius:var(--radius) 0 0 var(--radius);
  }
  .chat-input button {
    border-radius:0 var(--radius) var(--radius) 0;
  }

  /*──────────────────── Tables Styling ────────────────────*/
  table { width:100%; border-collapse:collapse; margin-top:1rem;}
  th, td {
    border:1px solid var(--pharm-primary-alt); padding:0.5rem; text-align:left;
  }
  th { background:var(--pharm-secondary); color:#000; }
  tr:nth-child(even) { background:rgba(148,210,189,0.2); }

  /*──────────────────── Dark Mode Tweaks ────────────────────*/
  html.dark body {
    background:var(--pharm-bg); color:var(--pharm-text);
  }
  html.dark section.module, html.dark .response {
    background:var(--pharm-surface); box-shadow:0 4px 12px rgba(0,0,0,0.3);
  }
  html.dark input, html.dark select, html.dark textarea {
    background:#004f4f; color:#e0fbfc; border-color:#0a6868;
  }
  html.dark button.btn { background:var(--pharm-primary-alt); }
  html.dark th { background:#0a9396; }
  @media(max-width:420px) {
  body { font-size: 0.9rem; }
  aside#sidebar { width: 60px; }
  header { left: 60px; }
  main { margin: 80px 1rem 1rem 70px; }
  .feature-card { padding: 0.75rem; }
  .hero-features { grid-template-columns: 1fr; }
  section.module { padding: 0.75rem; }
  input, textarea, select, button { font-size: 0.9rem; }
  .tool-row { bottom:0.5rem; right:0.5rem; flex-direction: column; }
}
/* Sidebar collapsed */
  aside#sidebar.collapsed { width:60px !important; }
  /* Header and main adjustments handled inline in JS */

  /* Chat timestamps */
  .msg-ts { font-size:0.75rem; color:var(--pharm-muted); margin-top:0.25rem; }

  /* History modal */
  .modal {
   position: fixed; top:0; left:0; width:100%; height:100%;
    background: rgba(0,0,0,0.5); display:flex; align-items:center;
    justify-content:center; z-index:2000;
  }
  .modal-content {
    background: var(--pharm-surface); padding:1.5rem;
    border-radius: var(--radius); width:90%; max-width:500px;
    position:relative;
  }
  .close-modal {
    position:absolute; top:0.5rem; right:0.75rem; font-size:1.5rem;
   cursor:pointer;
  }
  .history-item { margin-bottom:1rem; }
</style>

</head>
<body>
  <!-- Sidebar -->
  <aside id="sidebar">
    <div class="brand">
      <i class="fas fa-prescription-bottle-alt"></i>
      <span>Vitra AI E-Pharmacy</span>
    </div>
   <nav>
      <ul>
        <li><a href="herbal.html"><i class="fas fa-seedling"></i> <span>Herbal Medicine</span></a></li>
        <li><a href="psychology.html"><i class="fas fa-brain"></i> <span>Psychology & MH</span></a></li>
        <li class="active"><a href="#"><i class="fas fa-prescription-bottle-alt"></i> <span>E-Pharmacy</span></a></li>
        <li><a href="dietetics.html"><i class="fas fa-apple-alt"></i> <span>Dietetics</span></a></li>
        <li><a href="consult.html"><i class="fas fa-calendar-check"></i> <span>Consult Booking</span></a></li>
      </ul>
   </nav>
    <button id="shrinkSidebar" title="Toggle sidebar" style="margin:0.5rem; background:none; border:none; cursor:pointer;">
    <i class="fas fa-chevron-left"></i>
    </button>
  </aside>

  <!-- Header -->
  <header>
    <i id="hamburger" class="fas fa-bars"></i>
    <h1>E-Pharmacy AI Suite</h1>
    <i id="themeToggle" class="fas fa-moon"></i>
  </header>

  <!-- Hero -->
  <section id="hero" class="module">
    <h2><i class="fas fa-prescription"></i> Empower Your E-Pharmacy Experience</h2>
    <p class="desc">AI-powered tools for scanning, checking interactions, dosage planning & more.</p>
    <div class="hero-features">
      <div class="feature-card">
        <i class="fas fa-camera"></i>
        <h3>Rx Scanner</h3>
        <button class="btn" id="heroScanBtn">Scan Prescription</button>
      </div>
      <div class="feature-card">
        <i class="fas fa-pills"></i>
        <h3>Drug Lookup</h3>
        <button class="btn" id="heroDrugBtn">Lookup Drug</button>
      </div>
      <div class="feature-card">
       <i class="fas fa-exchange-alt"></i>
        <h3>Interaction Checker</h3>
      <button class="btn" id="heroInteractBtn">Check Interactions</button>
     </div>
     <div class="feature-card">
        <i class="fas fa-calculator"></i>
        <h3>Dosage Planner</h3>
       <button class="btn" id="heroDoseBtn">Plan Dosage</button>
      </div>
      <!-- add as many feature-card blocks as you like -->
    </div>
    <!-- decorative stickers -->
    <i class="fas fa-capsules sticker sticker-1" style="top:10%; left:15%;"></i>
    <i class="fas fa-vial sticker sticker-2" style="top:5%; right:20%;"></i>
    <i class="fas fa-notes-medical sticker sticker-3" style="bottom:10%; left:20%;"></i>
   <i class="fas fa-tag sticker sticker-4" style="bottom:15%; right:10%;"></i>
    <i class="fas fa-flask sticker sticker-5" style="top:50%; left:60%;"></i>
   <i class="fas fa-robot sticker sticker-6" style="top:30%; right:50%;"></i>
  </section>

  <main>
    <!-- 0. Prescription Scanner & OCR -->
    <section id="prescriptionScanner" class="module">
      <h2><i class="fas fa-camera"></i> Prescription Scanner</h2>
      <p class="desc">Upload a photo of your prescription and let AI decode it.</p>
      <input type="file" id="rxImage" accept="image/*">
      <button id="scanRx" class="btn"><i class="fas fa-magic"></i> Scan Rx</button>
      <div id="scannerPanel" class="response" hidden>
        <button class="close-btn"><i class="fas fa-times"></i></button>
        <div class="result-content"></div>
      </div>
    </section>

    <!-- 1. Drug Information -->
    <section id="drugInfo" class="module">
      <h2><i class="fas fa-pills"></i> Drug Information Lookup</h2>
      <p class="desc">Paste or select your drug, and get monographs, dosages, & safety info.</p>
      <input list="drug-list" id="drugInput" placeholder="Type or select a drug…">
      <datalist id="drug-list">
        <option>Metformin</option><option>Lisinopril</option><option>Atorvastatin</option>
        <option>Omeprazole</option><option>Albuterol</option><option>Levothyroxine</option>
        <option>Amlodipine</option><option>Simvastatin</option><option>Gabapentin</option>
        <option>Citalopram</option><option>Losartan</option><option>Sertraline</option>
        <option>Furosemide</option><option>Hydrochlorothiazide</option><option>Prednisone</option>
        <option>Amoxicillin</option><option>Azithromycin</option><option>Clopidogrel</option>
        <option>Warfarin</option><option>Other</option>
      </datalist>
      <button id="lookupDrug" class="btn"><i class="fas fa-search"></i> Lookup</button>
      <div id="drugInfoPanel" class="response" hidden>
        <button class="close-btn"><i class="fas fa-times"></i></button>
        <div class="result-content"></div>
      </div>
    </section>

    <!-- 2. Interaction Checker -->
    <section id="interactionChecker" class="module">
      <h2><i class="fas fa-exchange-alt"></i> Drug–Drug & Drug–Food Interaction Checker</h2>
      <p class="desc">Enter your meds and foods/supplements to see risk alerts.</p>
      <textarea id="interactionList" rows="3" placeholder="e.g. Metformin, Grapefruit, Warfarin…"></textarea>
      <button id="checkInteractions" class="btn"><i class="fas fa-shield-alt"></i> Check Interactions</button>
      <div id="interactionPanel" class="response" hidden>
        <button class="close-btn"><i class="fas fa-times"></i></button>
        <div class="result-content"></div>
      </div>
    </section>

    <!-- 3. Dosage Calculator & Titration Planner -->
    <section id="dosageCalculator" class="module">
      <h2><i class="fas fa-calculator"></i> Dosage & Titration Planner</h2>
      <p class="desc">Enter patient metrics, and get dosing schedules & monitoring checklists.</p>
      <label>Weight (kg): <input type="number" id="patientWeight"></label>
      <label>Creatinine Clearance (mL/min): <input type="number" id="crCl"></label>
      <label>Liver Function (ALT U/L): <input type="number" id="altValue"></label>
      <button id="computeDose" class="btn"><i class="fas fa-cogs"></i> Compute Dose</button>
      <div id="dosagePanel" class="response" hidden>
        <button class="close-btn"><i class="fas fa-times"></i></button>
        <div class="result-content"></div>
      </div>
    </section>

    <!-- 4. Symptom-Based Drug Advisor -->
    <section id="symptomAdvisor" class="module">
      <h2><i class="fas fa-notes-medical"></i> Symptom-Based Drug Advisor</h2>
      <p class="desc">Describe your symptoms; AI suggests meds, dosages, and follow-up.</p>
      <textarea id="symptomInput" rows="3" placeholder="e.g. headache, fever, cough…"></textarea>
      <button id="adviseDrug" class="btn"><i class="fas fa-stethoscope"></i> Recommend</button>
      <div id="advisePanel" class="response" hidden>
        <button class="close-btn"><i class="fas fa-times"></i></button>
        <div class="result-content"></div>
      </div>
    </section>

    <!-- 5. Price Predictor & Locator -->
    <section id="pricePredictor" class="module">
      <h2><i class="fas fa-tag"></i> Price Predictor & Nearby Pharmacies</h2>
      <p class="desc">Get price estimates in your currency and map nearest suppliers.</p>
      <input list="drug-list" id="priceDrugInput" placeholder="Select or type drug…">
      <datalist id="currency-list">
        <option>USD</option><option>EUR</option><option>GBP</option><option>NGN</option>
        <option>GHS</option><option>CAD</option><option>AUD</option><option>JPY</option>
        <option>INR</option><option>CNY</option><option>Other</option>
      </datalist>
      <input list="currency-list" id="currencyInput" placeholder="Currency…">
      <button id="predictPrice" class="btn"><i class="fas fa-dollar-sign"></i> Predict Price</button>
      <div id="pricePanel" class="response" hidden>
        <button class="close-btn"><i class="fas fa-times"></i></button>
        <div class="result-content"></div>
        <div id="pharmacyMap" style="height:200px;"></div>
      </div>
    </section>

    <!-- 6. Compound Formulation Advisor -->
    <section id="compoundAdvisor" class="module">
      <h2><i class="fas fa-flask"></i> Compound Formulation Advisor</h2>
      <p class="desc">Enter ingredients & strength; get compounding recipes & stability notes.</p>
      <textarea id="compoundList" rows="3" placeholder="e.g. Amoxicillin 125mg/mL, Glycerin…"></textarea>
      <input type="text" id="compoundStrength" placeholder="Desired strength (e.g. 20mg/mL)">
      <button id="adviseCompound" class="btn"><i class="fas fa-tools"></i> Advise Formulation</button>
      <div id="compoundPanel" class="response" hidden>
        <button class="close-btn"><i class="fas fa-times"></i></button>
        <div class="result-content"></div>
      </div>
    </section>

    <!-- 7. Side-Effect & Adverse Event Predictor -->
    <section id="sideEffectPredictor" class="module">
      <h2><i class="fas fa-exclamation-circle"></i> Side-Effect Predictor</h2>
      <p class="desc">Select patient profile & meds to see high-risk adverse events.</p>
      <label>Age: <input type="number" id="patientAge"></label>
      <label>Comorbidities:
        <select id="comorbiditySelect">
          <option>Diabetes</option><option>Hypertension</option><option>CKD</option>
          <option>CHF</option><option>COPD</option><option>Other</option>
        </select>
        <input class="other-input" placeholder="Specify…" style="display:none;">
      </label>
      <input list="drug-list" id="sideEffectDrugs" placeholder="Select or type meds…">
      <button id="predictSideEffects" class="btn"><i class="fas fa-heartbeat"></i> Predict Risks</button>
      <div id="sideEffectPanel" class="response" hidden>
        <button class="close-btn"><i class="fas fa-times"></i></button>
        <div class="result-content"></div>
      </div>
    </section>

    <!-- 8. Drug Education Chatbot -->
    <section id="drugChatbot" class="module">
      <h2><i class="fas fa-robot"></i> Drug-Education Chatbot</h2>
      <p class="desc">Ask any drug question—AI provides answers with citations & follow-ups.</p>
      <div class="chat-controls">
        <button id="clearPharmaChat" class="btn-secondary"><i class="fas fa-trash"></i> Clear</button>
         <button id="historyBtn" class="btn" style="margin-bottom:0.5rem;">
      <i class="fas fa-history"></i> History
   </button
      </div>
      <div id="pharmaChatBox" class="chat-box"></div>
      <form id="pharma-form" class="chat-input">
        <input id="pharmaInput" type="text" placeholder="Ask me anything about meds…">
        <button id="sendPharma" class="btn"><i class="fas fa-paper-plane"></i></button>
      </form>
    </section>

    <!-- History Modal -->
  <div id="historyModal" class="modal" hidden>
   <div class="modal-content">
     <span class="close-modal">&times;</span>
      <h3>Chat History</h3>
      <div id="historyList" style="max-height:400px; overflow-y:auto;"></div>
    </div>
  </div>
    
    <!-- 9. [Your Creative Extra] Bulk Refill Scheduler -->
    <section id="refillScheduler" class="module">
      <h2><i class="fas fa-sync-alt"></i> Bulk Refill Scheduler</h2>
      <p class="desc">Upload your med list and let AI schedule refills & reminders.</p>
      <input type="file" id="refillList" accept=".csv,.xlsx">
      <button id="scheduleRefill" class="btn"><i class="fas fa-calendar-check"></i> Schedule Refills</button>
      <div id="refillPanel" class="response" hidden>
        <button class="close-btn"><i class="fas fa-times"></i></button>
        <div class="result-content"></div>
      </div>
    </section>

    <!-- Two Charts Section -->
  <section id="charts" class="module">
    <h2><i class="fas fa-chart-line"></i> Usage Statistics</h2>
   <canvas id="chart1"></canvas>
    <canvas id="chart2" style="margin-top:1rem;"></canvas>
    <button id="exportChartsData" class="btn" style="margin-top:1rem;">
     <i class="fas fa-file-export"></i> Export Data (CSV)
    </button>
 </section>
      <footer>
    <small>© 2025 AI-Pharmacy Chain</small>
  </footer>
  </main>



  <!-- Shared Scripts -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  //──────────────────── Toast Helper ────────────────────
  function showToast(msg) {
    const t = document.createElement('div');
    t.className = 'toast';
    t.innerText = msg;
    document.body.append(t);
    requestAnimationFrame(() => t.classList.add('visible'));
    setTimeout(() => t.remove(), 2000);
  }

  //──────────────────── “Thinking…” Texts ────────────────────
  const PHASE_TEXT = {
    heroScanBtn:      'Decoding prescription…',
    heroDrugBtn:      'Fetching drug info…',
    heroInteractBtn:  'Analyzing interactions…',
    heroDoseBtn:      'Calculating dosage…',
    scanRx:           'Decoding prescription…',
    lookupDrug:       'Retrieving monograph…',
    checkInteractions:'Checking interactions…',
    computeDose:      'Computing dose…',
    adviseDrug:       'Formulating recommendation…',
    predictPrice:     'Estimating price…',
    adviseCompound:   'Designing formulation…',
    predictSideEffects:'Predicting side-effects…'
  };

  //──────────────────── Sanitize AI Content ────────────────────
  function sanitizeAIContent(raw) {
    // track table state
    let inTable = false;
    return raw
      .replace(/^#### (.+)$/gm, '<h4>$1</h4>')
      .replace(/^### (.+)$/gm, '<h3>$1</h3>')
      .replace(/^## (.+)$/gm, '<h2>$1</h2>')
      .replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>')
      .replace(/\*(.+?)\*/g,    '<em>$1</em>')
      .replace(/^\|(.+)\|$/gm, function(_, row) {
        const cols = row.split('|').map(c=>c.trim());
        if (!inTable) {
          inTable = true;
          return '<table><thead><tr>' +
                 cols.map(c=>`<th>${c}</th>`).join('') +
                 '</tr></thead><tbody>';
        } else {
          return '<tr>' +
                 cols.map(c=>`<td>${c}</td>`).join('') +
                 '</tr>';
        }
      })
      .replace(/$/, function() {
        if (inTable) { inTable = false; return '</tbody></table>'; }
        return '';
      });
  }

  //──────────────────── Generic AI Caller ────────────────────
  async function callAI(prompt) {
    try {
      const res = await fetch('/.netlify/functions/openai-proxy', {
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify({ messages:[
          { role:'system', content:'You are a helpful pharmacy AI.' },
          { role:'user',   content:prompt }
        ]})
      });
      if (!res.ok) {
        const err = await res.text();
        throw new Error(err);
      }
      const j = await res.json();
      return j.choices?.[0]?.message?.content
             ?? '⚠️ Unexpected AI response format.';
    } catch (err) {
      if (err.message.includes('Sandbox.Timedout')) {
        return '⚠️ Sorry, the AI is taking longer than usual—please try again in a moment.';
      }
      return '⚠️ Error: ' + err.message;
    }
  }

  //──────────────────── Helper: show spinner + text ────────────────────
  function startThinking(panel, btnId) {
    panel.hidden = false;
    panel.querySelector('.result-content').innerHTML =
      `<div class="spin-header">${PHASE_TEXT[btnId]||'Thinking…'}</div>
       <div class="spinner"></div>`;
    // remove any existing tool-row
    const old = panel.querySelector('.tool-row');
    if (old) old.remove();
  }

  //──────────────────── Helper: inject copy/download ────────────────────
  function injectTools(panel) {
    // avoid duplicate
    if (panel.querySelector('.tool-row')) return;
    const tools = document.createElement('div');
    tools.className = 'tool-row';
    tools.innerHTML = `
      <button class="copy-btn"><i class="fas fa-copy"></i></button>
      <button class="dl-btn"><i class="fas fa-download"></i></button>
    `;
    panel.appendChild(tools);
  }

  //──────────────────── Sidebar & Dark Mode ────────────────────
  document.getElementById('hamburger').onclick =
    () => document.body.classList.toggle('sidebar-open');
 const shrinkBtn = document.getElementById('shrinkSidebar');
  shrinkBtn.onclick = () => {
    const sb = document.getElementById('sidebar');
    sb.classList.toggle('collapsed');
    shrinkBtn.querySelector('i').classList.toggle('fa-chevron-left');
    shrinkBtn.querySelector('i').classList.toggle('fa-chevron-right');
    document.querySelector('header').style.left = sb.classList.contains('collapsed') ? '60px' : '220px';
    document.querySelector('main').style.marginLeft = sb.classList.contains('collapsed') ? '70px' : '240px';
  };
  document.getElementById('themeToggle').onclick = () => {
    document.documentElement.classList.toggle('dark');
    document.getElementById('themeToggle').classList.toggle('fa-moon');
    document.getElementById('themeToggle').classList.toggle('fa-sun');
  };

  //──────────────────── Generic wiring for hero cards ────────────────────
  function wireHero(btnId, panelId, promptFn) {
    document.getElementById(btnId).onclick = async () => {
      const panel = document.getElementById(panelId);
      startThinking(panel, btnId);
      const txt = await callAI(promptFn());
      panel.querySelector('.result-content').innerHTML = sanitizeAIContent(txt);
      injectTools(panel);
    };
  }

  wireHero('heroScanBtn','scannerPanel', () => 'OCR and decode this prescription image');
  wireHero('heroDrugBtn','drugInfoPanel', () => {
    const d = document.getElementById('drugInput').value.trim();
    return d ? `Lookup drug: ${d}` : 'Please specify a drug.';
  });
  wireHero('heroInteractBtn','interactionPanel', () => {
    const v = document.getElementById('interactionList').value.trim();
    return v ? `Check interactions: ${v}` : 'Please list meds/foods to check.';
  });
  wireHero('heroDoseBtn','dosagePanel', () => {
    const w = document.getElementById('patientWeight').value,
          c = document.getElementById('crCl').value,
          a = document.getElementById('altValue').value;
    return (w&&c&&a)
      ? `Compute dosage for weight=${w}, CrCl=${c}, ALT=${a}`
      : 'Please fill all patient metrics.';
  });

  //──────────────────── Generic wiring for modules ────────────────────
  function wire(btnId, inputIds, panelId, buildPrompt) {
    document.getElementById(btnId).onclick = async () => {
      const panel = document.getElementById(panelId);
      startThinking(panel, btnId);
      const vals = inputIds.map(id => document.getElementById(id).value.trim());
      const prompt = buildPrompt(vals);
      const txt = await callAI(prompt);
      panel.querySelector('.result-content').innerHTML = sanitizeAIContent(txt);
      injectTools(panel);
    };
  }

  wire('scanRx',          [],               'scannerPanel',   ()=>'OCR and decode the uploaded image');
  wire('lookupDrug',      ['drugInput'],    'drugInfoPanel',  ([d])=> d?`Give me monograph for ${d}`:'Enter a drug.');
  wire('checkInteractions',['interactionList'],'interactionPanel',([l])=>l?`Check interactions for ${l}`:'Enter a list.');
  wire('computeDose',     ['patientWeight','crCl','altValue'],'dosagePanel',
       ([w,c,a])=> (w&&c&&a)?`Plan dosage for weight=${w},CrCl=${c},ALT=${a}`:'Fill all fields.');
  wire('adviseDrug',      ['symptomInput'], 'advisePanel',    ([s])=>s?`Recommend meds for symptoms: ${s}`:'Describe symptoms.');
  wire('predictPrice',    ['priceDrugInput','currencyInput'],'pricePanel',
       ([d,c])=>d&&c?`Predict price of ${d} in ${c}, list nearby pharmacies`:'Select drug & currency.');
  wire('adviseCompound',  ['compoundList','compoundStrength'],'compoundPanel',
       ([l,s])=>l&&s?`Formulate ${s} from ingredients: ${l}`:'Enter ingredients & strength.');
  wire('predictSideEffects',['patientAge','sideEffectDrugs'],'sideEffectPanel',
       ([age,drugs])=>age&&drugs?`Predict side-effects for age ${age} on drugs: ${drugs}`:'Enter age & meds.');

  //──────────────────── Copy / Download Handlers ────────────────────
  document.body.addEventListener('click', e => {
    const rp = e.target.closest('.response');
    if (!rp) return;
    if (e.target.closest('.copy-btn')) {
      const txt = rp.querySelector('.result-content').innerText;
      navigator.clipboard.writeText(txt).then(()=>showToast('Copied!'));
    }
    if (e.target.closest('.dl-btn')) {
      const txt = rp.querySelector('.result-content').innerText;
      const blob = new Blob([txt],{type:'text/plain'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'response.txt';
      a.click();
    }
    if (e.target.closest('.close-btn')) {
      rp.hidden = true;
    }
  });

  //──────────────────── Chatbot Wiring ────────────────────
  const chatBox = document.getElementById('pharmaChatBox');
  document.getElementById('sendPharma').onclick = async () => {
    const q = document.getElementById('pharmaInput').value.trim();
    if (!q) return showToast('Type a question');
    // user message
    const u = document.createElement('div');
    u.className = 'user-msg'; u.innerText = q;
    chatBox.append(u);
    document.getElementById('pharmaInput').value = '';
    // thinking indicator
    const spinner = document.createElement('div');
    spinner.className = 'spinner'; chatBox.append(spinner);
    // call AI
    const a = await callAI(q);
    spinner.remove();
    const b = document.createElement('div');
    b.className = 'bot-msg'; b.innerHTML = sanitizeAIContent(a);
    chatBox.append(b);
    chatBox.scrollTop = chatBox.scrollHeight;
  };
  document.getElementById('clearPharmaChat').onclick = () => {
    chatBox.innerHTML = '';
  };

  // Add timestamps and history storage
  const history = [];
  function addMessage(type, text) {
    const wrapper = document.createElement('div');
    const ts = new Date().toLocaleString();
    wrapper.className = type === 'user' ? 'user-msg' : 'bot-msg';
    wrapper.innerHTML = `<div class="msg-text">${text}</div>
                         <div class="msg-ts">${ts}</div>`;
   chatBox.append(wrapper);
    chatBox.scrollTop = chatBox.scrollHeight;
    history.push({ role: type, text, time: ts });
  }
  // Override original sendPharma to use addMessage
 document.getElementById('sendPharma').onclick = async () => {
   const q = document.getElementById('pharmaInput').value.trim();
    if (!q) return showToast('Type a question');
   addMessage('user', q);
   document.getElementById('pharmaInput').value = '';
    const spinner = document.createElement('div');
   spinner.className = 'spinner'; chatBox.append(spinner);
   const a = await callAI(q);
    spinner.remove();
    addMessage('bot', sanitizeAIContent(a));
  };

  // History modal
  const modal = document.getElementById('historyModal');
  document.getElementById('historyBtn').onclick = () => {
    const list = document.getElementById('historyList');
    list.innerHTML = history.map(h => `
     <div class="history-item">
       <strong>${h.role === 'user' ? 'You' : 'Bot'}:</strong> ${h.text}
       <div class="msg-ts">${h.time}</div>
     </div>`).join('');
   modal.hidden = false;
  };
  modal.querySelector('.close-modal').onclick = () => modal.hidden = true;

  //──────────────────── Charts Setup ────────────────────
  const data1 = { labels:['Jan','Feb','Mar','Apr'], datasets:[{ label:'Scans', data:[120,150,170,200] }] };
  const data2 = { labels:['Mon','Tue','Wed','Thu','Fri'], datasets:[{ label:'Lookups', data:[30,45,60,55,70] }] };
  const ctx1 = document.getElementById('chart1').getContext('2d');
  const ctx2 = document.getElementById('chart2').getContext('2d');
  new Chart(ctx1, { type:'line', data:data1, options:{ responsive:true } });
  new Chart(ctx2, { type:'bar', data:data2, options:{ responsive:true } });

  // Export to CSV
 document.getElementById('exportChartsData').onclick = () => {
    const rows = [['Month','Scans'], ...data1.labels.map((lbl,i)=>[lbl, data1.datasets[0].data[i]])];
    const csv = rows.map(r=>r.join(',')).join('\n');
    const blob = new Blob([csv],{type:'text/csv'});
   const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
   a.download = 'scans_by_month.csv';
    a.click();
  };
  
  //──────────────────── “Other” Inputs ────────────────────
  document.querySelectorAll('select').forEach(sel => {
    sel.onchange = () => {
      const oi = sel.parentElement.querySelector('.other-input');
      if (oi) oi.style.display = sel.value==='Other'?'block':'none';
    };
  });

});
</script>
</body>
</html>
