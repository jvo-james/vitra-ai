 <!DOCTYPE html>
<html lang="en" aria-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Vitra AI – Neuropharma Command Center</title>

    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;700&display=swap" rel="stylesheet">
  <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

 <style>
  /*--------------------------------------
    0. Color Palette & Typography
  --------------------------------------*/
  :root {
    /* Primary Brand Colors */
    --color-primary: #4A90E2;
    --color-primary-hover: #357ABD;
    --color-secondary: #50C878;
    --color-secondary-hover: #3EA664;
    /* Neutrals */
    --color-bg: #F3F6FB;
    --color-surface: #FFFFFF;
    --color-text: #333333;
    --color-muted: #777777;
    --color-error: #E24A4A;
    /* Accents */
    --color-info: #4A90E2;
    --color-success: #50C878;
    --radius: 0.75rem;
    --spacing: 1rem;
    --transition: 0.3s ease;
    /* Typography */
    --font-base: 'Montserrat', sans-serif;
    --font-size-base: 1rem;
    --font-size-lg: 1.125rem;
    --font-size-sm: 0.875rem;
    --line-height: 1.5;
  }

  * {
    margin: 0; padding: 0; box-sizing: border-box;
  }
  body {
    font-family: var(--font-base);
    font-size: var(--font-size-base);
    line-height: var(--line-height);
    background: var(--color-bg);
    color: var(--color-text);
    display: flex;
    height: 100vh;
    overflow: hidden;
  }
  h1, h2, h3, h4, h5 { font-weight: 600; color: var(--color-primary); }

  a {
    color: var(--color-primary);
    text-decoration: none;
    transition: color var(--transition);
  }
  a:hover {
    color: var(--color-primary-hover);
  }

  /*--------------------------------------
    1. Header
  --------------------------------------*/
  #therapyHeader {
    position: fixed; top: 0; left: 0; right: 0;
    height: 64px; background: var(--color-surface);
    display: flex; align-items: center; justify-content: space-between;
    padding: 0 var(--spacing); box-shadow: 0px 2px 8px rgba(0,0,0,0.05);
    z-index: 1000;
  }
  #collapseBtn {
    font-size: 1.2rem; color: var(--color-primary);
    background: none; border: 2px solid var(--color-primary);
    border-radius: 50%; width: 36px; height: 36px;
    cursor: pointer; transition: all var(--transition);
  }
  #collapseBtn:hover {
    background: var(--color-primary-hover);
    color: var(--color-surface);
    border-color: var(--color-primary-hover);
  }
  .therapist-info {
    display: flex; align-items: center; gap: 0.75rem;
  }
  .therapist-info .avatar {
    width: 40px; height: 40px; border-radius: 50%;
    object-fit: cover; border: 2px solid var(--color-primary);
  }
  .session-meta {
    display: flex; align-items: center; gap: var(--spacing);
    font-size: var(--font-size-sm); color: var(--color-muted);
  }

  /*--------------------------------------
    2. Sidebar / Session List
  --------------------------------------*/
  #sessionList {
    position: fixed; top: 64px; left: 0;
    width: 280px; height: calc(100% - 64px);
    background: var(--color-surface);
    padding: var(--spacing);
    box-shadow: 2px 0 8px rgba(0,0,0,0.05);
    overflow-y: auto;
  }
  #sessionList .session-search {
    display: flex; gap: 0.5rem; margin-bottom: var(--spacing);
  }
  #searchSessions {
    flex: 1; padding: 0.5rem; border: 1px solid var(--color-muted);
    border-radius: var(--radius);
  }
  #filterBtn {
    background: var(--color-primary); color: #fff;
    border: none; border-radius: var(--radius);
    padding: 0 0.75rem; cursor: pointer;
    transition: background var(--transition);
  }
  #filterBtn:hover {
    background: var(--color-primary-hover);
  }
  #sessionList ul { list-style: none; }
  #sessionList li {
    display: flex; flex-direction: column;
    padding: 0.75rem; margin-bottom: 0.5rem;
    border-radius: var(--radius);
    cursor: pointer; transition: background var(--transition);
  }
  #sessionList li.unread {
    background: var(--color-primary-light, rgba(74,144,226,0.1));
  }
  #sessionList li:hover {
    background: var(--color-primary-light, rgba(74,144,226,0.1));
  }
  #sessionList li strong {
    font-size: var(--font-size-sm); margin-bottom: 0.25rem;
  }
  #sessionList li .snippet {
    font-size: var(--font-size-sm); color: var(--color-muted);
  }
  #sessionList li time {
    font-size: var(--font-size-sm); color: var(--color-muted);
    align-self: flex-end;
  }
  #newSession {
    display: block; width: 100%; padding: 0.75rem;
    background: var(--color-secondary); color: #fff;
    border: none; border-radius: var(--radius);
    font-weight: 600; cursor: pointer;
    transition: background var(--transition);
  }
  #newSession:hover {
    background: var(--color-secondary-hover);
  }

  /*--------------------------------------
    3. Main Chat Layout
  --------------------------------------*/
  #chatArea {
    margin-top: 64px; margin-left: 280px;
    flex: 1; display: flex; flex-direction: column;
    background: var(--color-bg); padding: var(--spacing);
    position: relative;
  }
  #chatLog {
    flex: 1; overflow-y: auto; padding-right: 1rem;
  }
  .date-separator {
    text-align: center; margin: var(--spacing) 0;
    font-size: var(--font-size-sm); color: var(--color-muted);
  }

  /*--------------------------------------
    4. Message Bubbles
  --------------------------------------*/
  .message {
    display: flex; align-items: flex-end; margin-bottom: 0.75rem;
    max-width: 75%;
  }
  .therapist-msg {
    flex-direction: row;
  }
  .user-msg {
    margin-left: auto; flex-direction: row-reverse;
  }
  .avatar-small {
    width: 32px; height: 32px; border-radius: 50%;
    margin: 0 0.5rem;
  }
  .bubble {
    position: relative;
    padding: 0.75rem; border-radius: var(--radius);
    background: var(--color-surface);
    box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    color: var(--color-text);
    line-height: 1.4;
  }
  .user-msg .bubble {
    background: var(--color-primary);
    color: #fff;
  }
  .bubble time {
    position: absolute; bottom: -1.25rem; right: 0.5rem;
    font-size: var(--font-size-sm); color: var(--color-muted);
  }

  /*--------------------------------------
    5. Typing Indicator
  --------------------------------------*/
  #typingIndicator {
    display: flex; align-items: center; gap: 0.5rem;
    font-size: var(--font-size-sm); color: var(--color-muted);
    margin-bottom: 0.75rem;
  }
  #typingIndicator .dots {
    display: inline-block; width: 1rem; text-align: left;
    animation: typing 1s steps(3,end) infinite;
  }
  @keyframes typing {
    0%,100% { content: ''; }
    33% { content: '.'; }
    66% { content: '..'; }
  }

  /*--------------------------------------
    6. Chat Controls & Quick Replies
  --------------------------------------*/
  #chatControls {
    display: flex; gap: 0.5rem; margin-bottom: 0.5rem;
  }
  #chatControls button {
    background: var(--color-surface); color: var(--color-muted);
    border: 1px solid var(--color-muted); border-radius: 50%;
    width: 36px; height: 36px; cursor: pointer;
    transition: all var(--transition);
  }
  #chatControls button:hover {
    background: var(--color-primary);
    color: #fff; border-color: var(--color-primary);
  }
  #quickReplies {
    display: flex; gap: 0.5rem; margin-bottom: 0.75rem;
  }
  .quick-reply {
    background: var(--color-primary-light, rgba(74,144,226,0.1));
    color: var(--color-primary);
    border: none; padding: 0.5rem 1rem;
    border-radius: var(--radius); cursor: pointer;
    transition: background var(--transition), color var(--transition);
  }
  .quick-reply:hover {
    background: var(--color-primary);
    color: #fff;
  }

  /*--------------------------------------
    7. Input Area
  --------------------------------------*/
  #chatInputForm {
    display: flex; align-items: center; gap: 0.5rem;
  }
  #chatInputForm input {
    flex: 1; padding: 0.75rem;
    border: 1px solid var(--color-muted);
    border-radius: var(--radius);
    font-size: var(--font-size-base);
  }
  #chatInputForm button {
    background: var(--color-primary); color: #fff;
    width: 36px; height: 36px;
    border: none; border-radius: 50%; cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    transition: background var(--transition);
  }
  #chatInputForm button:hover {
    background: var(--color-primary-hover);
  }

  /*--------------------------------------
    8. Modal / Worksheet
  --------------------------------------*/
  .modal {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.4);
    display: flex; align-items: center; justify-content: center;
    padding: var(--spacing);
    z-index: 2000;
  }
  .modal-content {
    background: var(--color-surface);
    border-radius: var(--radius);
    width: 100%; max-width: 500px;
    padding: var(--spacing);
    box-shadow: 0 4px 16px rgba(0,0,0,0.1);
    position: relative;
  }
  .modal-content h2 {
    margin-bottom: 0.75rem;
  }
  .close-modal {
    position: absolute; top: 0.75rem; right: 0.75rem;
    font-size: 1.2rem; color: var(--color-muted);
    background: none; border: none; cursor: pointer;
    transition: color var(--transition);
  }
  .close-modal:hover {
    color: var(--color-error);
  }
  #worksheetForm label {
    display: block; margin-bottom: var(--spacing);
    font-size: var(--font-size-sm);
  }
  #worksheetForm textarea {
    width: 100%; padding: 0.5rem;
    border: 1px solid var(--color-muted);
    border-radius: var(--radius);
    resize: vertical;
  }
  #worksheetForm input[type="range"] {
    width: 100%;
  }
  #worksheetForm button {
    display: block; margin-top: var(--spacing);
    background: var(--color-secondary); color: #fff;
    border: none; padding: 0.75rem 1rem;
    border-radius: var(--radius); cursor: pointer;
    transition: background var(--transition);
  }
  #worksheetForm button:hover {
    background: var(--color-secondary-hover);
  }

  /*--------------------------------------
    9. Rich Content Placeholders
  --------------------------------------*/
  #guidedAudio {
    margin-top: var(--spacing); width: 100%;
  }
  #moodWheel {
    display: block; margin: var(--spacing) auto;
    border-radius: 50%; box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }

  /*--------------------------------------
    10. Session Summary
  --------------------------------------*/
  #sessionSummary {
    position: absolute; bottom: 80px; right: var(--spacing);
    background: var(--color-surface); padding: var(--spacing);
    border-radius: var(--radius);
    box-shadow: 0 4px 16px rgba(0,0,0,0.1);
    width: 240px; display: none;
  }
  #sessionSummary[hidden] { display: none !important; }
  #sessionSummary ul { list-style: disc; padding-left: 1.25rem; }
  #exportSummary {
    display: block; margin-top: var(--spacing);
    width: 100%; padding: 0.5rem;
    background: var(--color-primary); color: #fff;
    border: none; border-radius: var(--radius);
    cursor: pointer; transition: background var(--transition);
  }
  #exportSummary:hover {
    background: var(--color-primary-hover);
  }

  /*--------------------------------------
    11. Notifications & Reminders
  --------------------------------------*/
  #reminderBanner {
    position: fixed; top: 64px; right: var(--spacing);
    background: var(--color-info-light, rgba(74,144,226,0.1));
    padding: var(--spacing); border-radius: var(--radius);
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    display: none;
  }
  #reminderBanner[hidden] { display: none !important; }
  #checkInNow {
    background: var(--color-primary); color: #fff;
    border: none; padding: 0.5rem 1rem;
    border-radius: var(--radius); cursor: pointer;
    transition: background var(--transition);
  }
  #checkInNow:hover {
    background: var(--color-primary-hover);
  }

  /*--------------------------------------
    12. Consent Banner
  --------------------------------------*/
  #consentBanner {
    position: fixed; bottom: 0; left: 0; width: 100%;
    background: var(--color-surface); padding: var(--spacing);
    box-shadow: 0 -2px 8px rgba(0,0,0,0.1);
    display: flex; flex-wrap: wrap; align-items: center;
    gap: var(--spacing); font-size: var(--font-size-sm);
  }
  #consentBanner[hidden] { display: none !important; }
  #consentBanner p { flex: 1; }
  #consentCheckbox { margin-right: 0.5rem; }
  #startChat {
    background: var(--color-secondary); color: #fff;
    border: none; padding: 0.5rem 1rem;
    border-radius: var(--radius); cursor: pointer;
    transition: background var(--transition);
  }
  #startChat:hover {
    background: var(--color-secondary-hover);
  }

  /*--------------------------------------
    13. Offline Indicator & Data Controls
  --------------------------------------*/
  .toast {
    position: fixed; bottom: 80px; left: 50%;
    transform: translateX(-50%);
    background: var(--color-error); color: #fff;
    padding: 0.5rem 1rem; border-radius: var(--radius);
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    display: none;
  }
  .toast[hidden] { display: none !important; }

  #dataControls {
    position: fixed; bottom: 0; right: var(--spacing);
    display: flex; gap: 0.5rem; padding: var(--spacing);
  }
  #clearHistory, #exportTranscript {
    background: var(--color-surface); color: var(--color-text);
    border: 1px solid var(--color-muted);
    padding: 0.5rem; border-radius: var(--radius);
    cursor: pointer; transition: all var(--transition);
  }
  #clearHistory:hover, #exportTranscript:hover {
    background: var(--color-primary); color: #fff;
    border-color: var(--color-primary);
  }

  /*--------------------------------------
    Responsive Breakpoints
  --------------------------------------*/
  @media (max-width: 1024px) {
    #sessionList { display: none; }
    #chatArea { margin-left: 0; }
  }
  @media (max-width: 600px) {
    #therapyHeader { flex-direction: column; align-items: flex-start; height: auto; padding: 0.5rem; }
    .session-meta { display: none; }
    #chatInputForm { flex-direction: column; }
    #chatInputForm input { width: 100%; }
  }
</style>

</head>

<body>
  <!-- 1. Goals & Overview (hidden metadata or data-attributes for JS) -->
  <div id="fullTherapy" data-goals="transform,chatgpt-whatsapp,empathic">
    
    <!-- 2. Header -->
    <header id="therapyHeader" role="banner">
      <button id="collapseBtn" aria-label="Back to dashboard">← Dashboard</button>
      <div class="therapist-info">
        <img src="avatar-therapist.jpg" alt="Dr. Amina Mensah avatar" class="avatar">
        <h1>Dr. Amina Mensah, Clinical Psychologist</h1>
      </div>
      <div class="session-meta">
        <span id="sessionNumber">Session #<span>3</span></span>
        <span id="sessionTimer">00:00:00</span>
      </div>
    </header>
    
    <!-- 2. Sidebar / Home (ChatGPT-style) -->
    <aside id="sessionList" role="navigation" aria-label="Previous sessions">
      <div class="session-search">
        <input type="search" id="searchSessions" placeholder="Search sessions…" aria-label="Search sessions">
        <button id="filterBtn" aria-label="Filter by date/topic">⚙️</button>
      </div>
      <ul>
        <li data-session="1" class="unread">
          <strong>Anxiety check-in</strong>
          <span class="snippet">“…and then I felt my heart racing…”</span>
          <time datetime="2025-07-01">Jul 1</time>
        </li>
        <li data-session="2">
          <strong>Sleep issues</strong>
          <span class="snippet">“…couldn’t fall asleep until 3 AM…”</span>
          <time datetime="2025-07-03">Jul 3</time>
        </li>
      </ul>
      <button id="newSession">+ New Session</button>
    </aside>
    
    <!-- 4. Main Chat Area -->
    <main id="chatArea" role="main">
      <div id="chatLog" role="log" aria-live="polite">
        <!-- Date separator -->
        <div class="date-separator">Today</div>
        
        <!-- Therapist bubble -->
        <div class="message therapist-msg" data-status="read">
          <img src="avatar-therapist.jpg" alt="" class="avatar-small">
          <div class="bubble">
            <p>Hi there! How have you been since our last session?</p>
            <time datetime="2025-07-05T19:00">7:00 PM</time>
          </div>
        </div>
        
        <!-- User bubble -->
        <div class="message user-msg" data-status="✓✓">
          <div class="bubble">
            <p>I’ve been feeling more anxious at work.</p>
            <time datetime="2025-07-05T19:02">7:02 PM</time>
          </div>
        </div>
        
        <!-- Typing indicator -->
        <div id="typingIndicator" class="typing">
          <span>Dr. Mensah is typing</span><span class="dots">…</span>
        </div>
      </div>
      
      <!-- 5. Conversation controls (ChatGPT-style) -->
      <div id="chatControls">
        <button id="regenerateReply" title="Regenerate reply">⟳</button>
        <button id="editLast" title="Edit last message">✎</button>
      </div>
      
      <!-- 5. Quick-reply suggestions -->
      <div id="quickReplies" role="region" aria-label="Suggested replies">
        <button class="quick-reply">Tell me more about that.</button>
        <button class="quick-reply">Show me a breathing exercise.</button>
      </div>
      
      <!-- 5. Input Area -->
      <form id="chatInputForm" autocomplete="off">
        <button id="attachBtn" type="button" aria-label="Attach file">📎</button>
        <input type="text" id="chatInput" placeholder="Type your message…" aria-label="Chat input">
        <button id="micBtn" type="button" aria-label="Speak">🎤</button>
        <button id="sendBtn" type="submit" aria-label="Send message">➤</button>
      </form>
    </main>
    
    <!-- 6. Modal/Overlay for Journaling & Worksheets -->
    <div id="worksheetModal" class="modal" role="dialog" aria-modal="true" hidden>
      <div class="modal-content">
        <button class="close-modal" aria-label="Close">×</button>
        <h2>CBT Thought Record</h2>
        <form id="worksheetForm">
          <label>
            Situation:
            <textarea name="situation" required></textarea>
          </label>
          <label>
            Thoughts:
            <textarea name="thoughts" required></textarea>
          </label>
          <label>
            Emotions (rate 1–10):
            <input type="range" name="emotionRating" min="1" max="10" value="5">
          </label>
          <button type="submit">Save Worksheet</button>
        </form>
      </div>
    </div>
    
    <!-- 8. Rich Content Rendering Placeholders -->
    <audio id="guidedAudio" controls hidden>
      <source src="breathing-exercise.mp3" type="audio/mpeg">
      Your browser does not support the audio element.
    </audio>
    <canvas id="moodWheel" width="300" height="300" hidden></canvas>
    
    <!-- 9. Session Summary & Controls -->
    <section id="sessionSummary" hidden>
      <h2>Session Summary</h2>
      <ul>
        <li>Key insight: Identified negative thought patterns</li>
        <li>Homework: Practice 5-minute breathing daily</li>
      </ul>
      <button id="exportSummary">Download Summary</button>
    </section>
    
    <!-- 10. Notifications & Reminders -->
    <aside id="reminderBanner" role="region" aria-live="assertive" hidden>
      It’s been 3 days since your last session. <button id="checkInNow">Check in now</button>
    </aside>
    
    <!-- 12. Privacy & Security -->
    <div id="consentBanner" class="banner" role="alertdialog" hidden>
      <p>This chat is confidential but not a substitute for emergency care. By continuing, you consent to anonymized data use.</p>
      <label><input type="checkbox" id="consentCheckbox"> I agree</label>
      <button id="startChat" disabled>Start Chat</button>
    </div>
    
    <!-- 11. Offline Drafts Indicator -->
    <div id="offlineToast" class="toast" hidden>
      You’re offline. Messages will send when you reconnect.
    </div>
    
    <!-- 13. Data Controls -->
    <footer id="dataControls">
      <button id="clearHistory">Clear History</button>
      <button id="exportTranscript">Export Transcript</button>
    </footer>
    
  </div>

  <script>
document.addEventListener('DOMContentLoaded', () => {
  // --- Helpers ---
  const $$ = s => Array.from(document.querySelectorAll(s));
  const $  = s => document.querySelector(s);
  const log = (...args) => console.log('[TherapyBot]', ...args);

  // --- Section 1: Goals & Metadata ---
  const fullTherapy = $('#fullTherapy');
  log('Goals:', fullTherapy.dataset.goals);

  // --- Section 2: Header & Collapse ---
  $('#collapseBtn').addEventListener('click', () => {
    window.location.href = 'dashboard.html';
  });

  // Timer
  const sessionTimer = $('#sessionTimer');
  let start = Date.now();
  setInterval(() => {
    const d = Date.now() - start;
    const h = String(Math.floor(d/3600000)).padStart(2,'0'),
          m = String(Math.floor(d%3600000/60000)).padStart(2,'0'),
          s = String(Math.floor(d%60000/1000)).padStart(2,'0');
    sessionTimer.textContent = `${h}:${m}:${s}`;
  }, 1000);

  // --- Section 2: Sessions List ---
  $$('#sessionList li').forEach(li => li.addEventListener('click', () => {
    $$('#sessionList li.unread').forEach(u => u.classList.remove('unread'));
    li.classList.remove('unread');
    log('Load session', li.dataset.session);
    alert(`Loading session ${li.dataset.session}`);
  }));
  $('#newSession').addEventListener('click', () => {
    chatHistory = [];
    saveHistory();
    renderHistory();
    alert('New session!');
  });

  // --- Section 12: Consent Banner ---
  const consentBanner = $('#consentBanner');
  const consentCheckbox = $('#consentCheckbox');
  const startChat = $('#startChat');
  consentBanner.hidden = true;  // start hidden
  consentCheckbox.addEventListener('change', () => {
    startChat.disabled = !consentCheckbox.checked;
  });
  startChat.addEventListener('click', () => {
    consentBanner.hidden = true;
  });

  // --- Section 4/5/6: Chat Setup ---
  const chatLog = $('#chatLog'),
        chatForm = $('#chatInputForm'),
        chatInput = $('#chatInput'),
        micBtn    = $('#micBtn'),
        attachBtn = $('#attachBtn'),
        typing    = $('#typingIndicator');

  let chatHistory = JSON.parse(localStorage.getItem('chatHistory') || '[]'),
      lastUserMsg = '';

  function saveHistory() {
    localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
  }
  function appendMessage(who, text, time = new Date().toISOString(), status = '') {
    const div = document.createElement('div');
    div.className = `message ${who}-msg`;
    if (status) div.dataset.status = status;
    div.innerHTML = `
      ${who==='therapist' ? '<img src="avatar-therapist.jpg" class="avatar-small">' : ''}
      <div class="bubble">
        <p>${text}</p>
        <time>${new Date(time).toLocaleTimeString()}</time>
      </div>`;
    chatLog.append(div);
    chatLog.scrollTop = chatLog.scrollHeight;
  }
  function renderHistory() {
    chatLog.innerHTML = '';
    chatHistory.forEach(m => appendMessage(m.who, m.text, m.time, m.status));
  }
  renderHistory();

  function isHighRisk(txt) {
    return /suicidal|kill myself|harm myself/i.test(txt);
  }

  async function callAI(messages) {
    const res = await fetch('/.netlify/functions/openai-proxy', {
      method: 'POST',
      headers: { 'Content-Type':'application/json' },
      body: JSON.stringify({ messages })
    });
    const { choices } = await res.json();
    return choices[0].message.content.trim();
  }

  chatForm.addEventListener('submit', async e => {
    e.preventDefault();
    const txt = chatInput.value.trim();
    if (!txt) return;
    const now = new Date().toISOString();
    appendMessage('user', txt, now, '✓');
    chatHistory.push({ who:'user', text:txt, time:now, status:'✓' });
    saveHistory();
    chatInput.value = '';
    lastUserMsg = txt;

    if (isHighRisk(txt)) {
      appendMessage('therapist',
        "I'm so sorry you feel this way. Please reach out to emergency services or someone you trust right now.",
        new Date().toISOString(),'✓✓'
      );
      return;
    }

    typing.hidden = false;
    const sys = "You are a licensed clinical psychologist..."; // full prompt here
    const msgs = [{ role:'system', content:sys }, ...chatHistory.map(m=>({
      role: m.who==='user'?'user':'assistant', content: m.text
    })), { role:'user', content: txt }];

    try {
      const reply = await callAI(msgs);
      typing.hidden = true;
      const rTime = new Date().toISOString();
      appendMessage('therapist', reply, rTime, '✓✓');
      chatHistory.push({ who:'therapist', text:reply, time:rTime, status:'✓✓' });
      saveHistory();
      // TTS
      const utt = new SpeechSynthesisUtterance(reply);
      utt.voice = speechSynthesis.getVoices().find(v=>/female/i.test(v.name)) || speechSynthesis.getVoices()[0];
      speechSynthesis.speak(utt);
    } catch {
      typing.hidden = true;
      appendMessage('therapist', "⚠️ Something went wrong.", new Date().toISOString(),'✓✓');
    }
  });

  // Speech Rec
  if ('SpeechRecognition' in window || 'webkitSpeechRecognition' in window) {
    const Rec = window.SpeechRecognition||window.webkitSpeechRecognition;
    const rec = new Rec();
    rec.lang = 'en-US';
    micBtn.addEventListener('click', ()=>rec.start());
    rec.onresult = e => chatInput.value = e.results[0][0].transcript;
  }

  // Quick replies
  $$('.quick-reply').forEach(b=>b.addEventListener('click', ()=>{
    chatInput.value = b.textContent;
    chatForm.dispatchEvent(new Event('submit'));
  }));

  // Regenerate & edit
  $('#regenerateReply').addEventListener('click', ()=> {
    if (lastUserMsg) {
      chatInput.value = lastUserMsg;
      chatForm.dispatchEvent(new Event('submit'));
    }
  });
  $('#editLast').addEventListener('click', ()=> {
    if (!chatHistory.length) return;
    const last = chatHistory.pop();
    if (last.who==='user') {
      chatInput.value = last.text;
      saveHistory();
      renderHistory();
    }
  });

  // Worksheet Modal
  worksheetModal.hidden = true;
  attachBtn.addEventListener('click', ()=> worksheetModal.hidden = false);
  $('.close-modal').addEventListener('click', ()=> worksheetModal.hidden = true);
  $('#worksheetForm').addEventListener('submit', e=>{
    e.preventDefault();
    alert('Saved!');
    worksheetModal.hidden = true;
  });

  // Session Summary
  $('#exportSummary').addEventListener('click', ()=>{
    const blob = new Blob([$('#sessionSummary').textContent],{type:'text/plain'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href=url; a.download='summary.txt'; a.click();
  });
  $('#newSession').addEventListener('click', ()=> $('#sessionSummary').hidden=false);

  // Reminders
  setTimeout(()=> $('#reminderBanner').hidden=false, 3000);
  $('#checkInNow').addEventListener('click', ()=>{
    $('#reminderBanner').hidden = true;
    chatInput.value = 'Checking in now.';
    chatForm.dispatchEvent(new Event('submit'));
  });

  // Offline
  window.addEventListener('offline', ()=> $('#offlineToast').hidden=false);
  window.addEventListener('online', ()=> $('#offlineToast').hidden=true);

  // Data controls
  $('#clearHistory').addEventListener('click', ()=>{
    if (confirm('Clear history?')) {
      chatHistory=[]; saveHistory(); renderHistory();
    }
  });
  $('#exportTranscript').addEventListener('click', ()=>{
    const txt = chatHistory.map(m=>`${m.who}: ${m.text}`).join('\n');
    const blob = new Blob([txt],{type:'text/plain'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href=url; a.download='transcript.txt'; a.click();
  });

  log('All bindings complete.');
});
</script>

</body>
</html>
