<!DOCTYPE html>
<html lang="en" aria-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>E-Pharmacy AI Portal</title>

  <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;700&display=swap" rel="stylesheet">
  <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
  /*──────────────────── Consultation Booking Theme ────────────────────*/
  :root {
    --cb-primary: #3b3f88;         /* deep indigo */
    --cb-primary-alt: #5c4d99;     /* lighter indigo */
    --cb-accent: #f08a5d;          /* warm coral */
    --cb-bg: #f7f6f9;              /* very light lavender */
    --cb-surface: #ffffff;         /* white cards */
    --cb-text: #2d2d2d;            /* almost black */
    --cb-muted: #777777;           /* gray for secondary text */
    --radius: 0.75rem;
    --padding: 1rem;
    --shadow: 0 4px 12px rgba(0,0,0,0.08);
    --transition: 0.3s ease;
  }
  html.dark {
    --cb-bg: #1a1b2e;
    --cb-surface: #2d2d44;
    --cb-text: #e0e0e0;
    --cb-muted: #aaaaaa;
    --shadow: 0 4px 12px rgba(0,0,0,0.4);
  }

  /*──────────────────── Reset & Base ────────────────────*/
  * { margin:0; padding:0; box-sizing:border-box; }
  body {
    font-family: 'Montserrat', sans-serif;
    background: var(--cb-bg);
    color: var(--cb-text);
    transition: background var(--transition), color var(--transition);
  }
  a { text-decoration:none; color: inherit; }
  h1,h2,h3,h4 { color: var(--cb-primary); }
  p.desc { color: var(--cb-muted); margin-bottom:0.75rem; }
  button, input, select, textarea { font-family:inherit; transition: var(--transition); }
  :focus { outline:2px solid var(--cb-accent); }

  /*──────────────────── Sidebar ────────────────────*/
  aside#sidebar {
    position: fixed; top: 0; left: 0; bottom: 0;
    width: 220px; background: var(--cb-surface);
    box-shadow: var(--shadow); z-index:1000;
    display: flex; flex-direction: column;
  }
  aside#sidebar .brand {
    display: flex; align-items: center; gap: 0.5rem;
    padding: var(--padding); font-size:1.25rem;
    background: var(--cb-primary); color: #fff;
  }
  aside#sidebar nav ul { list-style:none; flex:1; overflow-y:auto; }
  aside#sidebar nav li a {
    display:flex; align-items:center; gap:0.75rem;
    padding:0.75rem var(--padding); border-radius:var(--radius);
    color: var(--cb-text);
  }
  aside#sidebar nav li.active a,
  aside#sidebar nav li a:hover {
    background: var(--cb-primary-alt);
    color: #fff;
  }
  #shrinkSidebar {
    margin: var(--padding);
    background: none; border: none;
    cursor: pointer; color: var(--cb-primary);
    font-size:1.25rem;
  }

  /*──────────────────── Header ────────────────────*/
  header {
    position: sticky; top:0; left:220px; right:0;
    height:60px; background: var(--cb-surface);
    display:flex; align-items:center; justify-content:space-between;
    padding: 0 var(--padding); box-shadow:var(--shadow);
    transition: left var(--transition);
    z-index:1001;
  }
  #hamburger, #themeToggle {
    font-size:1.5rem; color: var(--cb-primary); cursor:pointer;
  }

  /*──────────────────── Main & Modules ────────────────────*/
  main {
    margin: 100px var(--padding) var(--padding) 240px;
    transition: margin-left var(--transition);
  }
  section.module {
    background: var(--cb-surface);
    border-radius: var(--radius);
    padding: var(--padding);
    margin-bottom:1.5rem;
    box-shadow:var(--shadow);
    transition: transform var(--transition);
  }
  section.module:hover { transform: translateY(-4px); }

  /*──────────────────── Hero Section ────────────────────*/
  #hero {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--padding);
    background: var(--cb-primary-alt);
    color: #fff;
    padding: 2rem var(--padding);
    border-radius: var(--radius);
    box-shadow:var(--shadow);
    margin-bottom:2rem;
  }
  #hero .hero-text h2 { font-size:2.25rem; margin-bottom:0.5rem; }
  #hero .hero-text p { color: rgba(255,255,255,0.9); }
  #hero .hero-features {
    display: flex; flex-direction: column; gap:1rem;
  }
  #hero .feature-card {
    background: #fff; color: var(--cb-primary);
    padding:1rem; border-radius:var(--radius);
    box-shadow:0 2px 8px rgba(0,0,0,0.1);
    display:flex; align-items:center; justify-content:space-between;
    transition: background var(--transition), transform var(--transition);
  }
  #hero .feature-card:hover {
    background: var(--cb-accent); color:#fff;
    transform: translateY(-3px);
  }
  #hero .feature-card i {
    font-size:2rem;
  }
  #hero .feature-card .btn {
    background: var(--cb-primary); color:#fff;
    padding:0.5rem 1rem; border-radius:var(--radius);
  }

  /*──────────────────── Forms & Inputs ────────────────────*/
  input[type="text"], input[type="date"], select, textarea {
    width:100%; padding:0.75rem; margin-top:0.5rem;
    border:2px solid var(--cb-primary-alt);
    border-radius:var(--radius);
    background: var(--cb-bg); color: var(--cb-text);
  }
  input:focus, select:focus, textarea:focus {
    border-color: var(--cb-accent);
    box-shadow: 0 0 0 3px rgba(240,138,93,0.3);
  }
  button.btn {
    background: var(--cb-accent); color:#fff;
    border:none; padding:0.75rem 1.25rem;
    border-radius:var(--radius); box-shadow:var(--shadow);
    cursor:pointer; transition: background var(--transition);
  }
  button.btn:hover {
    background: #d4724f;
  }

  /*──────────────────── Response Panels ────────────────────*/
  .response {
    background: var(--cb-surface);
    border-left: 4px solid var(--cb-accent);
    margin-top:1rem; padding:var(--padding);
    position:relative; box-shadow:var(--shadow);
  }
  .response .close-btn {
    position:absolute; top:0.5rem; right:0.5rem;
    background:none; border:none; font-size:1.1rem; cursor:pointer;
    color: var(--cb-muted);
  }
  .response .result-content { margin-top:1rem; }

  /*──────────────────── Chat & History ────────────────────*/
  .chat-box {
    background: var(--cb-bg); border:2px solid var(--cb-primary-alt);
    border-radius:var(--radius); padding:var(--padding);
    max-height:300px; overflow-y:auto; margin-bottom:1rem;
  }
  .chat-input { display:flex; gap:0.5rem; }
  .user-msg, .bot-msg {
    max-width:70%; padding:0.75rem; border-radius:var(--radius);
    position:relative; word-wrap:break-word;
  }
  .user-msg {
    align-self:flex-end; background:var(--cb-primary); color:#fff;
    border-bottom-right-radius:0;
  }
  .bot-msg {
    align-self:flex-start; background:var(--cb-surface); color:var(--cb-text);
    border-bottom-left-radius:0;
  }
  .chat-date {
    text-align:center; margin:1rem 0; font-size:0.9rem;
    color:var(--cb-muted); font-weight:600;
  }
  .msg-ts {
    font-size:0.75rem; color:var(--cb-muted); margin-top:0.25rem;
  }

  /*──────────────────── Modals ────────────────────*/
  .modal {
    position: fixed; top:0; left:0; width:100%; height:100%;
    background: rgba(0,0,0,0.5); display:flex;
    align-items:center; justify-content:center; z-index:2000;
  }
  .modal-content {
    background: var(--cb-surface); padding:1.5rem;
    border-radius: var(--radius); width:90%; max-width:500px;
    box-shadow:var(--shadow); position:relative;
  }
  .close-modal {
    position:absolute; top:0.5rem; right:0.75rem;
    font-size:1.5rem; color:var(--cb-muted); cursor:pointer;
  }
  .history-item {
    background: var(--cb-bg); padding:0.75rem; margin-bottom:0.75rem;
    border-radius:var(--radius); display:flex; justify-content:space-between;
    align-items:center;
  }
  .delete-history {
    background: var(--cb-primary-alt); color:#fff;
    border:none; padding:0.3rem 0.6rem; border-radius:var(--radius);
    cursor:pointer; transition: background var(--transition);
  }
  .delete-history:hover {
    background: var(--cb-primary);
  }

  /*──────────────────── Media Queries ────────────────────*/
  @media (max-width: 768px) {
    aside#sidebar { transform: translateX(-100%); }
    body.sidebar-open aside#sidebar { transform: none; }
    header { left: 0; }
    main { margin-left: 1rem; margin-top: 100px; }
    #hero { grid-template-columns: 1fr; }
  }
</style>
</head>
  <body>
  <!-- Sidebar -->
  <aside id="sidebar">
    <div class="brand">
      <i class="fas fa-calendar-check"></i>
      <span>Vitra AI Consult</span>
    </div>
    <nav>
      <ul>
        <li><a href="herbal.html"><i class="fas fa-seedling"></i> <span>Herbal Medicine</span></a></li>
        <li><a href="psychology.html"><i class="fas fa-brain"></i> <span>Psychology & MH</span></a></li>
        <li><a href="epharmacy.html"><i class="fas fa-prescription-bottle-alt"></i> <span>E-Pharmacy</span></a></li>
        <li><a href="dietetics.html"><i class="fas fa-apple-alt"></i> <span>Dietetics</span></a></li>
        <li class="active"><a href="#"><i class="fas fa-calendar-check"></i> <span>Consult Booking</span></a></li>
      </ul>
    </nav>
    <button id="shrinkSidebar" title="Toggle sidebar">
      <i class="fas fa-chevron-left"></i>
    </button>
  </aside>

  <!-- Header -->
  <header>
    <i id="hamburger" class="fas fa-bars"></i>
    <h1>AI-Powered Consultation Booking</h1>
    <i id="themeToggle" class="fas fa-moon"></i>
  </header>

  <!-- Hero -->
  <section id="hero" class="module">
    <div class="hero-text">
      <h2><i class="fas fa-stethoscope"></i> Book Your Consultation</h2>
      <p class="desc">AI-driven scheduling, provider matching, and automated follow-up—right at your fingertips.</p>
    </div>
    <div class="hero-features">
      <div class="feature-card">
        <i class="fas fa-user-md"></i>
        <h3>Intelligent Provider Match</h3>
        <a class="btn" href="#providerMatch">Match Now</a>
      </div>
      <div class="feature-card">
        <i class="fas fa-calendar-alt"></i>
        <h3>Smart Calendar</h3>
        <a class="btn" href="#calendar">View Slots</a>
      </div>
      <div class="feature-card">
        <i class="fas fa-video"></i>
        <h3>Telehealth Modes</h3>
        <a class="btn" href="#telehealth">Choose Mode</a>
      </div>
      <div class="feature-card">
        <i class="fas fa-bell"></i>
        <h3>Auto Reminders</h3>
        <a class="btn" href="#reminders">Configure</a>
      </div>
    </div>
  </section>

  <main>
    <!-- 1. Provider Matching -->
    <section id="providerMatch" class="module">
      <h2><i class="fas fa-user-md"></i> Intelligent Provider Match</h2>
      <p class="desc">Answer a few questions and let our AI suggest the best specialist for your needs.</p>
      <label>Your Concern:
        <select id="matchConcern">
          <option>General Consultation</option>
          <option>Chronic Disease</option>
          <option>Mental Health</option>
          <option>Nutrition Advice</option>
          <option>Herbal Remedies</option>
          <option>Other</option>
        </select>
      </label>
      <label>Preferred Language:
        <select id="matchLanguage">
          <option>English</option>
          <option>Spanish</option>
          <option>French</option>
          <option>Other</option>
        </select>
      </label>
      <button id="findProvider" class="btn"><i class="fas fa-search"></i> Find Providers</button>
      <div id="providerResults" class="response" hidden>
        <button class="close-btn"><i class="fas fa-times"></i></button>
        <div class="result-content"></div>
      </div>
    </section>

    <!-- 2. Smart Calendar -->
    <section id="calendar" class="module">
      <h2><i class="fas fa-calendar-alt"></i> Smart Calendar & Availability</h2>
      <p class="desc">See opening slots for all matched providers. Filter by date, time, and consultation type.</p>
      <label>Select Provider:
        <select id="calendarProvider">
          <option>Dr. Smith (General)</option>
          <option>Dr. Patel (Cardiology)</option>
          <option>Dr. Lopez (Psychiatry)</option>
        </select>
      </label>
      <label>Pick Date:
        <input type="date" id="calendarDate">
      </label>
      <button id="loadSlots" class="btn"><i class="fas fa-sync-alt"></i> Load Slots</button>
      <div id="slotList" class="response" hidden>
        <button class="close-btn"><i class="fas fa-times"></i></button>
        <div class="result-content"></div>
      </div>
    </section>

    <!-- 3. Telehealth Mode Selection -->
    <section id="telehealth" class="module">
      <h2><i class="fas fa-video"></i> Telehealth Modes</h2>
      <p class="desc">Choose how you’d like to connect: video call, phone call, or in-person.</p>
      <label>
        <input type="radio" name="mode" value="video" checked> Video Call
      </label>
      <label>
        <input type="radio" name="mode" value="phone"> Phone Call
      </label>
      <label>
        <input type="radio" name="mode" value="inperson"> In-Person Visit
      </label>
      <button id="confirmMode" class="btn"><i class="fas fa-check"></i> Confirm Mode</button>
    </section>

    <!-- 4. Auto Reminders & Follow-Up -->
    <section id="reminders" class="module">
      <h2><i class="fas fa-bell"></i> Auto Reminders & Follow-Up</h2>
      <p class="desc">Never miss an appointment, and get AI-driven follow-up recommendations.</p>
      <label>Reminder Channels:</label>
      <label><input type="checkbox" value="email" checked> Email</label>
      <label><input type="checkbox" value="sms"> SMS</label>
      <label><input type="checkbox" value="app"> App Notification</label>
      <label>Follow-Up Interval:
        <select id="followUpInterval">
          <option>1 Day</option>
          <option>3 Days</option>
          <option>1 Week</option>
          <option>2 Weeks</option>
        </select>
      </label>
      <button id="setReminders" class="btn"><i class="fas fa-cogs"></i> Set Reminders</button>
    </section>

    <!-- 5. Insurance & Payment -->
    <section id="payment" class="module">
      <h2><i class="fas fa-credit-card"></i> Insurance & Payment</h2>
      <p class="desc">Enter your insurance details or choose direct payment options.</p>
      <label>Insurance Provider:
        <input list="ins-list" id="insProvider" placeholder="Select or type…">
        <datalist id="ins-list">
          <option>HealthInsure Co.</option>
          <option>Medicare</option>
          <option>LifeCare</option>
          <option>Other</option>
        </datalist>
      </label>
      <label>Policy Number:
        <input type="text" id="insPolicy" placeholder="####-####-####">
      </label>
      <label>Or Pay Directly:
        <select id="payMethod">
          <option>Credit Card</option>
          <option>PayPal</option>
          <option>Mobile Wallet</option>
        </select>
      </label>
      <button id="processPayment" class="btn"><i class="fas fa-wallet"></i> Continue to Payment</button>
      <div id="paymentResponse" class="response" hidden>
        <button class="close-btn"><i class="fas fa-times"></i></button>
        <div class="result-content"></div>
      </div>
    </section>

    <!-- 6. Live Chat Support -->
    <section id="liveChat" class="module">
      <h2><i class="fas fa-comments"></i> Live AI Chat Support</h2>
      <p class="desc">Have questions? Chat with our AI assistant 24/7.</p>
      <div class="chat-box" id="consultChatBox"></div>
      <form id="consultChatForm" class="chat-input">
        <input id="consultInput" type="text" placeholder="Ask a question…">
        <button id="sendConsult" class="btn"><i class="fas fa-paper-plane"></i></button>
      </form>
    </section>

    <!-- Footer -->
    <footer>
      <small>© 2025 AI-Pharmacy Chain — Consultation Booking Suite</small>
    </footer>
  </main>

    <script>
document.addEventListener('DOMContentLoaded', () => {
  //───────────────────── Toast Helper ─────────────────────
  function showToast(msg) {
    const t = document.createElement('div');
    t.className = 'toast';
    t.innerText = msg;
    document.body.append(t);
    requestAnimationFrame(() => t.classList.add('visible'));
    setTimeout(() => t.remove(), 3000);
  }

  //───────────────────── Sanitize AI Content ─────────────────────
  function sanitizeAIContent(raw) {
    let inTable = false;
    return raw
      // code blocks
      .replace(/```([\s\S]+?)```/g, (_, code) => `<pre>${code.trim()}</pre>`)
      // headers
      .replace(/^#### (.+)$/gm, '<h4>$1</h4>')
      .replace(/^### (.+)$/gm, '<h3>$1</h3>')
      .replace(/^## (.+)$/gm, '<h2>$1</h2>')
      // bold & italic
      .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
      .replace(/\*(.+?)\*/g, '<em>$1</em>')
      // tables
      .replace(/^\|(.+)\|$/gm, (_, row) => {
        const cols = row.split('|').map(c => c.trim());
        if (!inTable) {
          inTable = true;
          return '<table><thead><tr>' +
            cols.map(c => `<th>${c}</th>`).join('') +
            '</tr></thead><tbody>';
        } else {
          return '<tr>' +
            cols.map(c => `<td>${c}</td>`).join('') +
            '</tr>';
        }
      })
      .replace(/$/, () => inTable ? '</tbody></table>' : '');
  }

  //───────────────────── AI Caller ─────────────────────
  async function callAI(prompt) {
    try {
      const res = await fetch('/.netlify/functions/openai-proxy', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          messages: [
            { role: 'system', content: 'You are a helpful consultation booking assistant.' },
            { role: 'user', content: prompt }
          ]
        })
      });
      if (!res.ok) throw new Error(await res.text());
      const json = await res.json();
      return json.choices?.[0]?.message?.content || '⚠️ Unexpected AI response.';
    } catch (err) {
      return err.message.includes('Sandbox.Timedout')
        ? '⚠️ The AI is taking longer than usual—please try again.'
        : '⚠️ Error: ' + err.message;
    }
  }

  //───────────────────── Spinner & Tools ─────────────────────
  const PHASE_TEXT = {
    heroBookBtn:       'Preparing booking interface…',
    bookAppointment:   'Booking appointment…',
    checkAvailability:'Checking availability…',
    rescheduleBtn:     'Rescheduling…',
    cancelBtn:         'Cancelling…',
    bulkUpload:        'Processing bulk upload…',
    sendScheduler:     'Consulting scheduler…'
  };

  function startThinking(panel, key) {
    panel.hidden = false;
    panel.querySelector('.result-content').innerHTML = `
      <div class="spin-header">${PHASE_TEXT[key]||'Thinking…'}</div>
      <div class="spinner"></div>`;
    const old = panel.querySelector('.tool-row');
    if (old) old.remove();
    panel.querySelector('.close-btn').style.display = 'none';
  }

  function injectTools(panel) {
    if (panel.querySelector('.tool-row')) return;
    const tools = document.createElement('div');
    tools.className = 'tool-row';
    tools.innerHTML = `
      <button class="copy-btn"><i class="fas fa-copy"></i></button>
      <button class="dl-btn"><i class="fas fa-download"></i></button>`;
    panel.appendChild(tools);
    panel.querySelector('.close-btn').style.display = 'block';
  }

  //───────────────────── Sidebar & Theme ─────────────────────
  document.getElementById('hamburger').onclick = () =>
    document.body.classList.toggle('sidebar-open');

  const shrinkBtn = document.getElementById('shrinkSidebar');
  shrinkBtn.onclick = () => {
    const sb = document.getElementById('sidebar');
    sb.classList.toggle('collapsed');
    shrinkBtn.querySelector('i').classList.toggle('fa-chevron-left');
    shrinkBtn.querySelector('i').classList.toggle('fa-chevron-right');
    document.querySelector('header').style.left = sb.classList.contains('collapsed') ? '60px' : '220px';
    document.querySelector('main').style.marginLeft = sb.classList.contains('collapsed') ? '70px' : '240px';
  };

  document.getElementById('themeToggle').onclick = () => {
    document.documentElement.classList.toggle('dark');
    document.getElementById('themeToggle').classList.toggle('fa-moon');
    document.getElementById('themeToggle').classList.toggle('fa-sun');
  };

  //───────────────────── Hero Button ─────────────────────
  document.getElementById('heroBookBtn').addEventListener('click', async e => {
    e.preventDefault();
    const panel = document.getElementById('bookingPanel');
    startThinking(panel, 'heroBookBtn');
    const txt = await callAI('Show me the booking form for a new consultation with all options.');
    panel.querySelector('.result-content').innerHTML = sanitizeAIContent(txt);
    injectTools(panel);
  });

  //───────────────────── Module Handlers ─────────────────────
  // helper to wire form button
  function wire(buttonId, panelId, gatherPrompt) {
    document.getElementById(buttonId).onclick = async e => {
      e.preventDefault();
      const panel = document.getElementById(panelId);
      startThinking(panel, buttonId);
      const prompt = gatherPrompt();
      const txt = await callAI(prompt);
      panel.querySelector('.result-content').innerHTML = sanitizeAIContent(txt);
      injectTools(panel);
    };
  }

  // Book single appointment
  wire('bookAppointment', 'bookingPanel', () => {
    const name = document.getElementById('clientName').value.trim();
    const svc  = document.getElementById('serviceType').value;
    const dr   = document.getElementById('providerSelect').value;
    const date = document.getElementById('apptDate').value;
    const time = document.getElementById('apptTime').value;
    if (!name || !svc || !dr || !date || !time) {
      return 'Please fill all required booking fields.';
    }
    return `Book a ${svc} consultation for ${name} with ${dr} on ${date} at ${time}.`;
  });

  // Check availability
  wire('checkAvailability', 'availabilityPanel', () => {
    const svc  = document.getElementById('availService').value;
    const dr   = document.getElementById('availProvider').value;
    const date = document.getElementById('availDate').value;
    if (!svc || !dr || !date) {
      return 'Select service, provider and date to check availability.';
    }
    return `List available slots for ${svc} with ${dr} on ${date}.`;
  });

  // Reschedule
  wire('rescheduleBtn', 'reschedulePanel', () => {
    const apptId = document.getElementById('rescheduleId').value.trim();
    const date   = document.getElementById('newDate').value;
    const time   = document.getElementById('newTime').value;
    if (!apptId || !date || !time) {
      return 'Please provide appointment ID, new date, and new time.';
    }
    return `Reschedule appointment ${apptId} to ${date} at ${time}.`;
  });

  // Cancel
  wire('cancelBtn', 'cancelPanel', () => {
    const apptId = document.getElementById('cancelId').value.trim();
    if (!apptId) return 'Enter the appointment ID to cancel.';
    return `Cancel appointment ${apptId}.`;
  });

  // Bulk upload CSV of appointments
  document.getElementById('bulkUpload').onclick = async e => {
    e.preventDefault();
    const file = document.getElementById('bulkFile').files[0];
    const panel = document.getElementById('bulkPanel');
    if (!file) {
      showToast('Please select a CSV file to upload.');
      return;
    }
    startThinking(panel, 'bulkUpload');
    const text = await file.text();
    // extract lines of "name,date,time,service,provider"
    const lines = text.split('\n').slice(1).filter(l => l.trim());
    const meds  = lines.join('; ');
    const prompt = `Bulk book these appointments:\n${meds}`;
    const res = await callAI(prompt);
    panel.querySelector('.result-content').innerHTML = sanitizeAIContent(res);
    injectTools(panel);
  };

  // Copy / Download / Close controls
  document.body.addEventListener('click', e => {
    const rsp = e.target.closest('.response');
    if (!rsp) return;
    if (e.target.closest('.copy-btn')) {
      const txt = rsp.querySelector('.result-content').innerText;
      navigator.clipboard.writeText(txt).then(() => showToast('Copied to clipboard'));
    }
    if (e.target.closest('.dl-btn')) {
      const txt = rsp.querySelector('.result-content').innerText;
      const blob = new Blob([txt], { type: 'text/plain' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'response.txt';
      a.click();
    }
    if (e.target.closest('.close-btn')) {
      rsp.hidden = true;
    }
  });

  //───────────────────── Scheduler Chat ─────────────────────
  const chatBox = document.getElementById('schedulerChatBox');
  let lastDate  = null;
  const chatHistory = [];

  function addChat(role, text) {
    const now = new Date();
    const dateKey = now.toDateString();
    // date separator
    if (dateKey !== lastDate) {
      const sep = document.createElement('div');
      sep.className = 'chat-date';
      // Today / Yesterday / actual date
      const diffDays = Math.floor((new Date() - now.setHours(0,0,0,0)) / 864e5);
      sep.innerText = diffDays === 0 ? 'Today'
        : diffDays === 1 ? 'Yesterday'
        : new Date(dateKey).toLocaleDateString();
      chatBox.append(sep);
      lastDate = dateKey;
    }
    const ts = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    const msg = document.createElement('div');
    msg.className = role === 'user' ? 'user-msg' : 'bot-msg';
    msg.innerHTML = `<div class="msg-text">${text}</div><div class="msg-ts">${ts}</div>`;
    chatBox.append(msg);
    chatBox.scrollTop = chatBox.scrollHeight;
    chatHistory.push({ role, text, time: `${dateKey} ${ts}` });
  }

  document.getElementById('sendScheduler').onclick = async e => {
    e.preventDefault();
    const q = document.getElementById('schedulerInput').value.trim();
    if (!q) return showToast('Type a message');
    addChat('user', q);
    document.getElementById('schedulerInput').value = '';
    const spinner = document.createElement('div');
    spinner.className = 'spinner';
    chatBox.append(spinner);
    const resp = await callAI(q);
    spinner.remove();
    addChat('bot', sanitizeAIContent(resp));
  };

  document.getElementById('clearSchedulerChat').onclick = () => {
    chatBox.innerHTML = '';
    lastDate = null;
    chatHistory.length = 0;
  };

  // History modal
  const histModal = document.getElementById('historyModal');
  document.getElementById('historyBtn').onclick = e => {
    e.preventDefault();
    const list = document.getElementById('historyList');
    list.innerHTML = chatHistory.map((h,i) => `
      <div class="history-item">
        <strong>${h.role==='user'?'You':'Scheduler'}:</strong> ${h.text}
        <div class="msg-ts">${h.time}</div>
        <button class="delete-history" data-index="${i}">&times;</button>
      </div>`).join('');
    histModal.hidden = false;
  };
  document.querySelector('.close-modal').onclick = () => histModal.hidden = true;
  document.getElementById('historyList').addEventListener('click', e => {
    if (!e.target.matches('.delete-history')) return;
    const i = +e.target.dataset.index;
    chatHistory.splice(i, 1);
    e.target.closest('.history-item').remove();
  });

});
</script>
</body>
</html>
