<!DOCTYPE html>
<html lang="en" aria-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>E-Pharmacy AI Portal</title>

  <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;700&display=swap" rel="stylesheet">
  <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>

<style>
  /*──────────────────── Global Theme ────────────────────*/
  :root {
    --cb-primary: #3b3f88;       /* deep indigo */
    --cb-primary-alt: #5c4d99;   /* lighter indigo */
    --cb-accent: #f08a5d;        /* warm coral */
    --cb-bg: #f7f6f9;            /* light lavender */
    --cb-surface: #ffffff;       /* card backgrounds */
    --cb-text: #2d2d2d;          /* dark text */
    --cb-muted: #777777;         /* secondary text */
    --radius: 0.75rem;
    --padding: 1rem;
    --shadow: 0 4px 12px rgba(0,0,0,0.1);
    --transition: 0.3s ease;
  }
  html.dark {
    --cb-bg: #1a1b2e;
    --cb-surface: #2d2d44;
    --cb-text: #e0e0e0;
    --cb-muted: #aaaaaa;
    --shadow: 0 4px 12px rgba(0,0,0,0.4);
  }
  *, *::before, *::after {
    box-sizing: border-box;
    transition: var(--transition);
  }
  body {
    margin: 0; padding: 0;
    font-family: 'Montserrat', sans-serif;
    background: var(--cb-bg);
    color: var(--cb-text);
    line-height: 1.5;
  }
  a { color: inherit; text-decoration: none; }
  h1,h2,h3,h4 { margin-bottom: 0.5rem; color: var(--cb-primary); }
  p.desc { color: var(--cb-muted); margin-bottom: 1rem; }

  /*──────────────────── Layout ────────────────────*/
  aside#sidebar {
    position: fixed; top: 0; left: 0; bottom: 0;
    width: 220px; background: var(--cb-surface);
    box-shadow: var(--shadow); z-index: 1000;
    display: flex; flex-direction: column;
  }
  aside#sidebar .brand {
    padding: var(--padding);
    font-size: 1.25rem;
    background: var(--cb-primary);
    color: #fff;
    display: flex; align-items: center; gap: 0.5rem;
  }
  aside#sidebar nav ul {
    flex: 1; overflow-y: auto; margin: 0; padding: 0; list-style: none;
  }
  aside#sidebar nav li a {
    display: flex; align-items: center; gap: 0.75rem;
    padding: 0.75rem var(--padding);
    border-radius: var(--radius);
  }
  aside#sidebar nav li.active a,
  aside#sidebar nav li a:hover {
    background: var(--cb-primary-alt);
    color: #fff;
  }
  #shrinkSidebar {
    background: none; border: none; font-size: 1.25rem;
    color: var(--cb-primary); cursor: pointer;
    margin: var(--padding);
  }

  header {
    position: sticky; top: 0; left: 220px; right: 0;
    height: 60px; background: var(--cb-surface);
    display: flex; align-items: center; justify-content: space-between;
    padding: 0 var(--padding); flex-wrap: wrap;
    box-shadow: var(--shadow); z-index: 1001;
  }
  header h1 {
    flex: 1 1 auto;          /* + let the title shrink/grow */
    margin: 0.5rem 0;        /* + some vertical breathing room */
    word-break: break-word;  /* + wrap long titles */
    font-size: 1.25rem;      /* + a slightly smaller base size */
  }
  #hamburger, #themeToggle {
    font-size: 1.5rem; color: var(--cb-primary); cursor: pointer;
  }

  main {
    margin: 100px var(--padding) var(--padding) 240px;
    transition: margin-left var(--transition);
  }
  section.module {
    background: var(--cb-surface);
    border-radius: var(--radius);
    padding: var(--padding);
    margin-bottom: 1.5rem;
    box-shadow: var(--shadow);
  }

  /*──────────────────── Hero ────────────────────*/
  #hero {
    display: grid; grid-template-columns: 1fr 1fr; gap: var(--padding);
    background: var(--cb-primary-alt); color: #fff;
    padding: 2rem var(--padding);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    margin-bottom: 2rem;
  }
  #hero .hero-text h2 { font-size: 2.25rem; margin-bottom: 0.5rem; }
  #hero .hero-features {
    display: flex; flex-direction: column; gap: 1rem;
  }
  #hero .feature-card {
    background: #fff; color: var(--cb-primary);
    padding: 1rem; border-radius: var(--radius);
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    display: flex; align-items: center; justify-content: space-between;
    cursor: pointer;
  }
  #hero .feature-card:hover {
    background: var(--cb-accent); color: #fff;
    transform: translateY(-3px);
  }
  #hero .feature-card i { font-size: 2rem; }
  #hero .feature-card .btn {
    background: var(--cb-primary); color: #fff;
    padding: 0.5rem 1rem; border-radius: var(--radius);
  }

  /*──────────────────── Forms & Inputs ────────────────────*/
  label { display: block; margin-bottom: 1rem; }
  input, select, textarea {
    width: 100%; padding: 0.75rem; margin-top: 0.5rem;
    border: 2px solid var(--cb-primary-alt);
    border-radius: var(--radius);
    background: var(--cb-bg);
    color: var(--cb-text);
  }
  input:focus, select:focus, textarea:focus {
    border-color: var(--cb-accent);
    box-shadow: 0 0 0 3px rgba(240,138,93,0.3);
  }
  button.btn {
    background: var(--cb-accent); color: #fff;
    border: none; padding: 0.75rem 1.25rem;
    border-radius: var(--radius); box-shadow: var(--shadow);
    cursor: pointer;
  }
  button.btn:hover { background: #d4724f; }

  /*──────────────────── Response Panels ────────────────────*/
  .response {
    background: var(--cb-surface);
    border-left: 4px solid var(--cb-accent);
    padding: var(--padding);
    margin-top: 1rem;
    position: relative;
    box-shadow: var(--shadow);
  }
  .response .close-btn {
    position: absolute; top: 0.5rem; right: 0.5rem;
    background: none; border: none; font-size: 1.1rem; cursor: pointer;
    color: var(--cb-muted);
  }

  /*──────────────────── Chat & History ────────────────────*/
  .chat-box {
    background: var(--cb-bg);
    border: 2px solid var(--cb-primary-alt);
    border-radius: var(--radius);
    padding: var(--padding);
    max-height: 300px; overflow-y: auto;
    margin-bottom: 1rem;
  }
  .chat-input { display: flex; gap: 0.5rem; }
  .chat-input input { flex: 1; border-radius: var(--radius) 0 0 var(--radius); }
  .chat-input button { border-radius: 0 var(--radius) var(--radius) 0; }
  .user-msg, .bot-msg {
    max-width: 70%; padding: 0.75rem; border-radius: var(--radius);
    margin-bottom: 0.5rem; word-wrap: break-word;
  }
  .user-msg {
    align-self: flex-end; background: var(--cb-primary); color: #fff;
    border-bottom-right-radius: 0;
  }
  .bot-msg {
    align-self: flex-start; background: var(--cb-surface); color: var(--cb-text);
    border-bottom-left-radius: 0;
  }
  .chat-date {
    text-align: center; margin: 1rem 0; font-size: 0.9rem;
    color: var(--cb-muted); font-weight: 600;
  }
  .msg-ts { font-size: 0.75rem; color: var(--cb-muted); }

  /*──────────────────── Modals & History ────────────────────*/
 .modal {
  position: fixed; top: 0; left: 0; width: 100%; height: 100%;
   background: rgba(0,0,0,0.5);
   display: flex;                  /* show container as flex */
   align-items: center; justify-content: center;
    z-index: 2000;
 }
  /* hide when [hidden] is present */
  .modal[hidden] {
   display: none !important;
  }
  .modal-content {
    background: var(--cb-surface); padding: 1.5rem;
    border-radius: var(--radius); width: 90%; max-width: 600px;
    box-shadow: var(--shadow); position: relative;
  }
  .close-modal {
    position: absolute; top: 0.5rem; right: 0.75rem;
    font-size: 1.5rem; cursor: pointer; color: var(--cb-muted);
  }
  .history-item {
    background: var(--cb-bg); padding: 0.75rem; margin-bottom: 0.75rem;
    border-radius: var(--radius); display: flex;
    justify-content: space-between; align-items: center;
  }
  .delete-history {
    background: var(--cb-primary-alt); color: #fff;
    border: none; padding: 0.3rem 0.6rem; border-radius: var(--radius);
    cursor: pointer;
  }
  .delete-history:hover { background: var(--cb-primary); }

  /*──────────────────── Analytics Cards & Calendar ────────────────────*/
  .analytics-grid {
    display: grid; grid-template-columns: repeat(auto-fit, minmax(240px,1fr));
    gap: var(--padding);
  }
  .analytics-card {
    background: var(--cb-surface);
    border-radius: var(--radius);
    padding: var(--padding);
    box-shadow: var(--shadow);
  }
  .calendar {
    width: 100%; background: var(--cb-surface);
    border-radius: var(--radius); overflow: hidden;
    box-shadow: var(--shadow);
  }
  .calendar .row {
    display: flex;
  }
  .calendar .cell {
    flex: 1; padding: 0.5rem; border: 1px solid var(--cb-bg);
    text-align: center; cursor: pointer;
  }
  .calendar .cell.closed { background: #eee; color: #999; cursor: not-allowed; }
  .calendar .cell.open { background: var(--cb-accent); color: #fff; }
  .calendar .cell.today { border: 2px solid var(--cb-primary); }

  /*──────────────────── Responsive ────────────────────*/
  @media (max-width: 1024px) {
    header { left: 60px; }
    main { margin-left: 80px; }
  }
  @media (max-width: 768px) {
    aside#sidebar { transform: translateX(-100%); }
    body.sidebar-open aside#sidebar { transform: none; }
    header { left: 0; }
    main { margin-left: 1rem; margin-top: 100px; }
    #hero { grid-template-columns: 1fr; }
  }
    /* make our generated calendar look like your cells */
  #calendar {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 1px;
    background: var(--cb-bg);
    border: 1px solid var(--cb-bg);
  }
  /* Spinner */
.spinner {
  border: 4px solid rgba(0,0,0,0.1);
  border-left-color: var(--cb-primary);
  border-radius: 50%;
  width: 24px; height: 24px;
  animation: spin 1s linear infinite;
  margin: .5rem auto;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* Toast */
.toast {
  position: fixed; bottom: 1rem; left: 50%;
  transform: translateX(-50%) translateY(100%);
  background: var(--cb-primary-alt); color: #fff;
  padding: .75rem 1.5rem; border-radius: var(--radius);
  box-shadow: var(--shadow); opacity: 0;
  transition: transform .3s, opacity .3s;
  z-index: 2000;
}
.toast.visible {
  transform: translateX(-50%) translateY(0);
  opacity: 1;
}
</style>
</head>
<body>
  <!-- Sidebar -->
  <aside id="sidebar">
    <div class="brand">
      <i class="fas fa-calendar-check"></i>
      <span>Vitra AI Consult</span>
    </div>
    <nav>
      <ul>
        <li class="active"><a href="#providerMatch"><i class="fas fa-user-md"></i><span>Provider Match</span></a></li>
        <li><a href="#availabilityCalendar"><i class="fas fa-calendar-alt"></i><span>Availability</span></a></li>
        <li><a href="#bookAppointment"><i class="fas fa-book-medical"></i><span>Book Appointment</span></a></li>
        <li><a href="#dashboard"><i class="fas fa-tachometer-alt"></i><span>Dashboard</span></a></li>
        <li><a href="#feedback"><i class="fas fa-star"></i><span>Feedback</span></a></li>
        <li><a href="#analytics"><i class="fas fa-chart-line"></i><span>Analytics</span></a></li>
        <li><a href="#liveChat"><i class="fas fa-comments"></i><span>Live Chat</span></a></li>
      </ul>
    </nav>
    <button id="shrinkSidebar" title="Toggle sidebar"><i class="fas fa-chevron-left"></i></button>
  </aside>

  <!-- Header -->
  <header>
    <i id="hamburger" class="fas fa-bars"></i>
    <h1>AI-Powered Consultation Booking</h1>
    <i id="themeToggle" class="fas fa-moon"></i>
  </header>

  <!-- Hero -->
  <section id="hero" class="module">
    <div class="hero-text">
      <h2><i class="fas fa-stethoscope"></i> Seamless Consultation Booking</h2>
      <p class="desc">From instant provider match to one-click appointment, powered by AI.</p>
      <a href="#providerMatch" class="btn hero-btn"><i class="fas fa-user-md"></i> Get Matched Now</a>
    </div>
    <div class="hero-graphic">
      <!-- You can replace this with an illustrative SVG or image -->
      <img src="hero-consult.svg" alt="Consultation illustration" />
    </div>
  </section>

  <!-- 1. Personalized AI Provider Matching -->
  <section id="providerMatch" class="module">
    <h2><i class="fas fa-user-md"></i> Personalized Provider Matching</h2>
    <p class="desc">Answer a few questions and get instantly matched to the best in-network specialist.</p>
    <form id="matchForm">
      <label>Chief Concern:
        <input type="text" id="concernInput" placeholder="e.g. persistent cough">
      </label>
      <label>Urgency:
        <select id="urgencyInput">
          <option>Low</option>
          <option>Medium</option>
          <option>High</option>
        </select>
      </label>
      <label>Preferred Language:
        <select id="languageInput">
          <option>English</option>
          <option>Twi</option>
          <option>Ga</option>
          <option>Ewe</option>
        </select>
      </label>
      <button type="button" id="findMatch" class="btn"><i class="fas fa-search"></i> Find My Specialist</button>
    </form>

    <div id="matchResults" class="response" hidden>
      <button class="close-btn"><i class="fas fa-times"></i></button>
      <div class="result-content">
        <!-- AI will choose among these pseudo-providers -->
        <ul id="providerList">
          <li data-id="p1"><strong>Dr. Kwame Asante</strong> – Pulmonologist, Korle Bu Teaching Hospital</li>
          <li data-id="p2"><strong>Dr. Abena Owusu</strong> – Cardiologist, 37 Military Hospital</li>
          <li data-id="p3"><strong>Dr. Kojo Mensah</strong> – Psychiatrist, Ridge Hospital</li>
          <li data-id="p4"><strong>Dr. Yaa Dufie</strong> – Dietitian, Nyaho Medical Centre</li>
          <li data-id="p5"><strong>Dr. Nana Adjei</strong> – General Practitioner, Cape Coast Polyclinic</li>
          <li data-id="p6"><strong>Dr. Efua Amponsah</strong> – Endocrinologist, LEKMA Hospital</li>
          <li data-id="p7"><strong>Dr. Michael Addo</strong> – Neurologist, 37 Military Hospital</li>
          <li data-id="p8"><strong>Dr. Grace Ofori</strong> – Dermatologist, Accra Dermatology Centre</li>
          <li data-id="p9"><strong>Dr. Joseph Kumi</strong> – Orthopedic Surgeon, Komfo Anokye Teaching Hospital</li>
          <li data-id="p10"><strong>Dr. Ama Brew</strong> – Pediatrician, Trust Hospital</li>
        </ul>
      </div>
    </div>
  </section>

  <!-- 2. Real-Time Availability Calendar -->
  <section id="availabilityCalendar" class="module">
    <h2><i class="fas fa-calendar-alt"></i> Real-Time Availability</h2>
    <p class="desc">Browse open slots, filter by date/time/consultation type, or jump to your next available.</p>
    <div class="calendar-controls">
      <label>Date:
        <input type="date" id="calendarDateInput">
      </label>
      <label>Time of Day:
        <select id="timeOfDayInput">
          <option>Morning</option>
          <option>Afternoon</option>
          <option>Evening</option>
        </select>
      </label>
      <label>Type:
        <select id="visitTypeInput">
          <option>Telehealth</option>
          <option>In-Person</option>
        </select>
      </label>
      <button type="button" id="filterSlots" class="btn"><i class="fas fa-filter"></i> Filter</button>
      <button type="button" id="nextAvailable" class="btn"><i class="fas fa-forward"></i> Next Available</button>
    </div>
  <div id="calendarGrid">
      <div id="calendar"></div>
   </div>
  </section>

  <!-- 3. Book an Appointment -->
  <section id="bookAppointment" class="module">
    <h2><i class="fas fa-book-medical"></i> Book Your Appointment</h2>
    <p class="desc">Select from our roster of specialists and schedule in seconds.</p>
    <form id="appointmentForm">
      <label>Your Name:
        <input type="text" id="clientName" placeholder="John Doe">
      </label>
      <label>Select Professional:
        <select id="professionalSelect">
          <option>Dr. Kwame Asante (Pulmonologist)</option>
          <option>Dr. Abena Owusu (Cardiologist)</option>
          <option>Dr. Kojo Mensah (Psychiatrist)</option>
          <option>Ms. Akosua Baah (Physical Therapist)</option>
          <option>Mr. Daniel Boakye (Pharmacist)</option>
          <option>Dr. Yaa Dufie (Dietitian)</option>
          <option>Dr. Michael Addo (Neurologist)</option>
          <option>Mrs. Esther Kumi (Occupational Therapist)</option>
          <option>Dr. Grace Ofori (Dermatologist)</option>
          <option>Mr. Stephen Tetteh (Speech Therapist)</option>
          <option>Dr. Joseph Kumi (Orthopedic Surgeon)</option>
          <option>Dr. Ama Brew (Pediatrician)</option>
        </select>
      </label>
      <label>Date:
        <input type="date" id="apptDate">
      </label>
      <label>Time:
        <input type="time" id="apptTime">
      </label>
      <button type="button" id="bookNow" class="btn"><i class="fas fa-check"></i> Book Now</button>
    </form>
    <!-- booking confirmation modal -->
    <div id="bookingModal" class="modal" hidden>
      <div class="modal-content">
        <span class="close-modal">&times;</span>
        <h3>Confirm Your Appointment</h3>
        <div class="result-content" id="bookingSummary">
          <!-- AI will fill summary and recommendation -->
        </div>
        <button type="button" id="confirmBooking" class="btn">Confirm</button>
      </div>
    </div>
  </section>

  <!-- 4. Patient Dashboard & History -->
  <section id="dashboard" class="module">
    <h2><i class="fas fa-tachometer-alt"></i> Your Dashboard</h2>
    <p class="desc">Manage upcoming visits, review past appointments, download summaries.</p>
    <div class="dashboard-tabs">
      <button type="button" data-tab="upcoming" class="active">Upcoming</button>
      <button type="button" data-tab="past">Past</button>
    </div>
    <div id="upcoming" class="dashboard-list">
      <ul>
        <li>
          <strong>Dr. Abena Owusu</strong> – 2025-05-30 14:00  
          <button type="button" class="btn-sm rescheduleBtn">Reschedule</button>
          <button type="button" class="btn-sm cancelBtn">Cancel</button>
        </li>
        <!-- more items… -->
      </ul>
    </div>
    <div id="past" class="dashboard-list" hidden>
      <ul>
        <li>
          <strong>Dr. Kojo Mensah</strong> – 2025-04-12 10:00  
          <button type="button" class="btn-sm">Download Summary</button>
          <button type="button" class="btn-sm">Download Invoice</button>
        </li>
        <!-- more… -->
      </ul>
    </div>
  </section>

  <!-- 5. Feedback & Ratings -->
  <section id="feedback" class="module">
    <h2><i class="fas fa-star"></i> Feedback & Ratings</h2>
    <p class="desc">Help us improve—quick 1-min survey.</p>
    <label>Rate your last visit:  
      <select id="ratingInput">
        <option>⭐</option><option>⭐⭐</option><option>⭐⭐⭐</option><option>⭐⭐⭐⭐</option><option>⭐⭐⭐⭐⭐</option>
      </select>
    </label>
    <label>Comments:
      <textarea id="feedbackInput" rows="3" placeholder="Any suggestions?"></textarea>
    </label>
    <button type="button" id="submitFeedback" class="btn"><i class="fas fa-paper-plane"></i> Submit</button>
  </section>

  <!-- 6. Analytics & Optimization -->
  <section id="analytics" class="module">
    <h2><i class="fas fa-chart-line"></i> Analytics & Optimization</h2>
    <div class="chart-container">
      <canvas id="noShowChart"></canvas>
      <canvas id="peakTimesChart" style="margin-top:1rem;"></canvas>
    </div>
    <button type="button" id="optimizeStaffing" class="btn"><i class="fas fa-cogs"></i> AI Suggest Staffing</button>
    <div id="optimizationResult" class="response" hidden>
      <button class="close-btn"><i class="fas fa-times"></i></button>
      <div class="result-content"></div>
    </div>
  </section>

  <!-- 7. Live AI Chat Support -->
  <section id="liveChat" class="module">
    <h2><i class="fas fa-comments"></i> Live AI Chat Support</h2>
    <p class="desc">24/7 assistant for all your booking questions.</p>
    <div class="chat-controls">
      <button type="button" id="clearChat" class="btn-sm"><i class="fas fa-trash"></i> Clear</button>
      <button type="button" id="showHistory" class="btn-sm"><i class="fas fa-history"></i> History</button>
    </div>
    <div id="chatBox" class="chat-box"></div>
    <form id="chatForm" class="chat-input">
      <input id="chatInput" type="text" placeholder="Ask me anything…">
      <button type="button" id="sendChat" class="btn"><i class="fas fa-paper-plane"></i></button>
    </form>
    <!-- Chat history modal -->
    <div id="chatHistoryModal" class="modal" hidden>
      <div class="modal-content">
        <span class="close-modal">&times;</span>
        <h3>Chat History</h3>
        <div id="chatHistoryList"></div>
        <button type="button" id="clearHistoryChat" class="btn-sm">Clear All</button>
      </div>
    </div>
  </section>

  <!-- Footer -->
  <footer>
    <small>© 2025 AI-Pharmacy Chain — All rights reserved</small>
  </footer>


<script>
(async()=>{
  // ─── CORE AI CALLER & HELPERS ────────────────────────
  async function callOpenAI(messages) {
    try {
      const res = await fetch('/.netlify/functions/openai-proxy', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ messages })
      });
      if (!res.ok) {
        const err = await res.text();
        throw new Error(err);
      }
      const j = await res.json();
      return j.choices?.[0]?.message?.content.trim() || '⚠️ Unexpected AI response.';
    } catch(err) {
      if (err.message.includes('Sandbox.Timedout')) {
        return '⚠️ Server busy—please try again shortly.';
      }
      return '⚠️ Error: '+err.message;
    }
  }
  function showToast(msg) {
    const t = document.createElement('div');
    t.className = 'toast';
    t.innerText = msg;
    document.body.append(t);
    requestAnimationFrame(()=>t.classList.add('visible'));
    setTimeout(()=>t.remove(),3000);
  }
  function formatHTML(txt) {
    return txt
      .replace(/^#### (.*$)/gm,'<h4>$1</h4>')
      .replace(/^### (.*$)/gm,'<h3>$1</h3>')
      .replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>')
      .replace(/\*(.+?)\*/g,'<em>$1</em>')
      .replace(/```([\s\S]+?)```/g,'<pre><code>$1</code></pre>')
      .split(/\n{2,}/g).map(p=>`<p>${p.trim()}</p>`).join('');
  }
  function injectTools(panel) {
    if (panel.querySelector('.tool-row')) return;
    const row = document.createElement('div');
    row.className = 'tool-row';
    row.innerHTML = `
      <button class="copy-btn"><i class="fas fa-copy"></i></button>
      <button class="dl-btn"><i class="fas fa-download"></i></button>
    `;
    panel.append(row);
  }
  const PHASE = {
    findMatch: 'Matching…',
    filterSlots: 'Filtering…',
    bookNow: 'Preparing…',
    confirmBooking: 'Confirming…',
    submitFeedback: 'Submitting…',
    optimizeStaffing: 'Analyzing…',
    sendChat: 'Thinking…'
  };
  function startSpinner(panel, phase) {
    panel.hidden = false;
    panel.innerHTML = `
      <div class="spin-text">${PHASE[phase]||'Thinking…'}</div>
      <div class="spinner"></div>
    `;
  }

  document.addEventListener('DOMContentLoaded',()=>{

    // ─── 1. PROVIDER MATCHING ────────────────────────────
    const providers = [
      { id:'p1', name:'Dr. Kwame Asante', spec:'Pulmonologist, Korle Bu' },
      { id:'p2', name:'Dr. Abena Owusu', spec:'Cardiologist, 37 Military' },
      { id:'p3', name:'Dr. Kojo Mensah', spec:'Psychiatrist, Ridge' },
      { id:'p4', name:'Dr. Yaa Dufie', spec:'Dietitian, Nyaho Medical' },
      { id:'p5', name:'Dr. Nana Adjei', spec:'GP, Cape Coast' },
      { id:'p6', name:'Dr. Efua Amponsah', spec:'Endocrinologist, LEKMA' },
      { id:'p7', name:'Dr. Michael Addo', spec:'Neurologist, 37 Military' },
      { id:'p8', name:'Dr. Grace Ofori', spec:'Dermatologist, Accra Derm.' },
      { id:'p9', name:'Dr. Joseph Kumi', spec:'Ortho Surgeon, Komfo Anokye' },
      { id:'p10',name:'Dr. Ama Brew', spec:'Pediatrician, Trust Hosp.' },
      // + 8 more creative roles
      { id:'p11', name:'Ms. Akosua Baah', spec:'PT, Tema General' },
      { id:'p12', name:'Mr. Daniel Boakye', spec:'Pharmacist, Ridge' },
      { id:'p13', name:'Mrs. Esther Kumi', spec:'OT, Cape Coast' },
      { id:'p14', name:'Ms. Joy Mensah', spec:'Speech Therapist, LEKMA' },
      { id:'p15', name:'Dr. Paul Yeboah', spec:'Dermatologist, Korle Bu' },
      { id:'p16', name:'Dr. Linda Frimpong', spec:'Nephrologist, 37 Military' },
      { id:'p17', name:'Mr. Kwesi Owusu', spec:'Nutritionist, Nyaho Med.' },
      { id:'p18', name:'Ms. Abena Boateng', spec:'Psychologist, Accra Psych.' }
    ];
    document.getElementById('findMatch').onclick = async e=>{
      e.preventDefault();
      const btn = e.currentTarget;
      const concern = document.getElementById('concernInput').value.trim();
      if (!concern) return showToast('Enter your chief concern');
      const urgency = document.getElementById('urgencyInput').value;
      const lang = document.getElementById('languageInput').value;
      const sys = `You are AI match. Providers:\n${providers.map(p=>`- ${p.name}, ${p.spec}`).join('\n')}`;
      const user = `Concern="${concern}", urgency="${urgency}", lang="${lang}". Pick best provider.`;
      btn.disabled = true; btn.innerText = PHASE.findMatch;
      const panel = document.getElementById('matchResults');
      try {
        startSpinner(panel,'findMatch');
        const reply = await callOpenAI([
          {role:'system',content:sys},
          {role:'user',content:user}
        ]);
        panel.innerHTML = `<div class="result-content">${formatHTML(reply)}</div>`;
        injectTools(panel);
      } catch(err) {
        showToast(err);
      } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-search"></i> Find My Specialist';
      }
    };
    document.querySelector('#matchResults .close-btn').onclick = ()=> {
      document.getElementById('matchResults').hidden = true;
    };

    // ─── 2. AVAILABILITY CALENDAR ─────────────────────────
    const calEl = document.getElementById('calendar');
    function generateCalendar(yr,mth) {
      calEl.innerHTML = '';
      ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].forEach(d=>{
        const hd = document.createElement('div');
        hd.className='cell'; hd.style.fontWeight='600'; hd.innerText = d;
        calEl.append(hd);
      });
      const first = new Date(yr,mth,1).getDay();
      const days = new Date(yr,mth+1,0).getDate();
      for(let i=0;i<first;i++){
        const b=document.createElement('div');
        b.className='cell closed'; calEl.append(b);
      }
      for(let d=1;d<=days;d++){
        const cell=document.createElement('div');
        cell.className='cell '+(Math.random()<0.4?'closed':'open');
        cell.innerText=d;
        if(cell.classList.contains('open')){
          cell.onclick = ()=>{
            document.querySelectorAll('#calendar .selected').forEach(x=>x.classList.remove('selected'));
            cell.classList.add('selected');
            showToast(`Selected ${yr}-${mth+1}-${d}`);
          };
        }
        const today = new Date();
        if(today.getFullYear()===yr && today.getMonth()===mth && today.getDate()===d){
          cell.classList.add('today');
        }
        calEl.append(cell);
      }
    }
    let today = new Date();
    generateCalendar(today.getFullYear(),today.getMonth());
    document.getElementById('filterSlots').onclick = ()=>showToast('Filtered (stub)');
    document.getElementById('nextAvailable').onclick = ()=>showToast('Next available stub');
    document.getElementById('calendarDateInput').onchange = e=>{
      const d=new Date(e.target.value);
      if(!isNaN(d)) generateCalendar(d.getFullYear(),d.getMonth());
    };

    // ─── 3. BOOK APPOINTMENT ─────────────────────────────
    const modal = document.getElementById('bookingModal');
    document.getElementById('bookNow').onclick = e=>{
      e.preventDefault();
      const n=document.getElementById('clientName').value.trim();
      const p=document.getElementById('professionalSelect').value;
      const dt=document.getElementById('apptDate').value;
      const tm=document.getElementById('apptTime').value;
      if(!n||!dt||!tm) return showToast('Fill all fields');
      modal.hidden = false;
      document.getElementById('bookingSummary').innerHTML = `
        <p><strong>${n}</strong> → <em>${p}</em></p><p>${dt} @ ${tm}</p>`;
    };
    document.querySelector('#bookingModal .close-modal').onclick = ()=>modal.hidden=true;
    document.getElementById('confirmBooking').onclick = async ()=>{
      modal.hidden = true; showToast(PHASE.confirmBooking);
      const reply = await callOpenAI([
        {role:'system',content:'You are appointment assistant.'},
        {role:'user',content:'Confirm booking.'}
      ]);
      alert(reply);
    };

    // ─── 4. DASHBOARD TABS ────────────────────────────────
    let appointments = [
      { id:1, doc:'Dr. Abena Owusu', datetime:'2025-05-30T14:00', status:'upcoming' },
      { id:2, doc:'Dr. Kojo Mensah', datetime:'2025-04-12T10:00', status:'past' }
    ];
    function renderDashboard() {
      ['upcoming','past'].forEach(tab=>{
        const container = document.getElementById(tab);
        container.querySelector('ul').innerHTML = appointments
          .filter(a=>a.status===tab)
          .map(a=>`
            <li data-id="${a.id}">
              <strong>${a.doc}</strong> – ${a.datetime.replace('T',' ')}
              ${tab==='upcoming'
                ? `<button class="btn-sm rescheduleBtn">Reschedule</button>
                   <button class="btn-sm cancelBtn">Cancel</button>`
                : `<button class="btn-sm downloadSummary">Summary</button>
                   <button class="btn-sm downloadInvoice">Invoice</button>`
              }
            </li>`).join('');
      });
      // wire buttons
      document.querySelectorAll('.rescheduleBtn').forEach(btn=>{
        btn.type='button';
        btn.addEventListener('click', e=>{
          const li = e.target.closest('li');
          const id = +li.dataset.id;
          const newDt = prompt('New datetime (YYYY-MM-DDThh:mm):');
          if(newDt){
            appointments.find(a=>a.id===id).datetime=newDt;
            renderDashboard();
            showToast('Rescheduled');
          }
        });
      });
      document.querySelectorAll('.cancelBtn').forEach(btn=>{
        btn.type='button';
        btn.addEventListener('click', e=>{
          const id = +e.target.closest('li').dataset.id;
          appointments = appointments.filter(a=>a.id!==id);
          renderDashboard();
          showToast('Cancelled');
        });
      });
      document.querySelectorAll('.downloadSummary').forEach(btn=>{
        btn.type='button';
        btn.addEventListener('click', ()=> {
          const blob=new Blob(['Visit summary...'],'text/plain');
          const a=document.createElement('a');
          a.href=URL.createObjectURL(blob); a.download='summary.txt'; a.click();
        });
      });
      document.querySelectorAll('.downloadInvoice').forEach(btn=>{
        btn.type='button';
        btn.addEventListener('click', ()=> {
          const blob=new Blob(['Invoice pdf...'],'application/pdf');
          const a=document.createElement('a');
          a.href=URL.createObjectURL(blob); a.download='invoice.pdf'; a.click();
        });
      });
    }
    renderDashboard();
    document.querySelectorAll('.dashboard-tabs button').forEach(b=>{
      b.type='button';
      b.addEventListener('click',()=>{
        document.querySelectorAll('.dashboard-tabs button')
          .forEach(x=>x.classList.remove('active'));
        b.classList.add('active');
        document.querySelectorAll('.dashboard-list')
          .forEach(d=>d.hidden = d.id!==b.dataset.tab);
      });
    });


    // ─── 5. FEEDBACK ──────────────────────────────────────
    document.getElementById('submitFeedback').onclick = async ()=>{
      const r=document.getElementById('ratingInput').value;
      const c=document.getElementById('feedbackInput').value.trim();
      const panel=document.createElement('div');
      panel.className='response';
      startSpinner(panel,'submitFeedback');
      document.body.append(panel);
      const scan = await callOpenAI([
        {role:'system',content:'You are feedback analyzer.'},
        {role:'user',content:`Rating=${r}, Comment="${c}"`}
      ]);
      panel.innerHTML = `<div class="result-content">${scan.includes('red-flag')
        ? '⚠️ Red-flag feedback routed.' : 'Thanks for your feedback!'}</div>`;
      injectTools(panel);
    };

    // ─── 6. ANALYTICS & OPTIMIZATION ─────────────────────
    const noShowCtx = document.getElementById('noShowChart').getContext('2d');
    const peakCtx   = document.getElementById('peakTimesChart').getContext('2d');
    const noShowChart = new Chart(noShowCtx, {
      type:'bar',
      data:{labels:['W1','W2','W3','W4'],datasets:[{label:'No-Show %',data:[10,12,8,15]}]}
    });
    const peakChart = new Chart(peakCtx, {
      type:'line',
      data:{labels:['Mon','Tue','Wed','Thu','Fri'],datasets:[{label:'Bookings',data:[30,45,60,55,70]}]}
    });
    document.getElementById('optimizeStaffing').type='button';
    document.getElementById('optimizeStaffing').addEventListener('click', async ()=>{
      document.getElementById('optimizationResult').hidden = false;
      document.querySelector('#optimizationResult .result-content').innerText = 'Analyzing…';
      try {
        const advice = await callOpenAI([
          {role:'system',content:'You are a staffing optimization AI.'},
          {role:'user',content:'Provide staffing suggestions based on no-show & peak data.'}
        ]);
        document.querySelector('#optimizationResult .result-content').innerText = advice;
      } catch(e){
        showToast(e.message);
      }
    });
    document.querySelector('#optimizationResult .close-btn').addEventListener('click', ()=>{
      document.getElementById('optimizationResult').hidden = true;
    });
    // ─── 7. LIVE AI CHAT ──────────────────────────────────
    const chatBox = document.getElementById('chatBox');
    let lastDay = null;
    let chatHistory = JSON.parse(localStorage.getItem('liveChat')||'[]');
    function renderChat(who,txt,iso){
      const d=new Date(iso),day=d.toDateString();
      if(day!==lastDay){
        const sep=document.createElement('div');
        sep.className='chat-date';
        sep.innerText = (day===new Date().toDateString()?'Today':day);
        chatBox.append(sep);
        lastDay=day;
      }
      const m=document.createElement('div');
      m.className=who==='user'?'user-msg':'bot-msg';
      m.innerHTML=`<div class="msg-text">${formatHTML(txt)}</div>
                   <div class="msg-ts">${d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}</div>`;
      chatBox.append(m);
      chatBox.scrollTop=chatBox.scrollHeight;
    }
    chatHistory.forEach(m=>renderChat(m.role,m.text,m.iso));
    document.getElementById('sendChat').onclick = async ()=>{
      const txt=document.getElementById('chatInput').value.trim();
      if(!txt) return showToast('Type a question');
      const iso=new Date().toISOString();
      renderChat('user',txt,iso);
      chatHistory.push({role:'user',text:txt,iso});
      document.getElementById('chatInput').value='';
      const spinner=document.createElement('div');
      spinner.className='bot-msg';
      spinner.innerHTML=`<div class="spin-text">${PHASE.sendChat}</div>
                         <div class="spinner"></div>`;
      chatBox.append(spinner);
      const reply=await callOpenAI([
        {role:'system',content:'You are chat support.'},
        {role:'user',content:txt}
      ]);
      spinner.remove();
      renderChat('bot',reply,new Date().toISOString());
      chatHistory.push({role:'bot',text:reply,iso:new Date().toISOString()});
      localStorage.setItem('liveChat',JSON.stringify(chatHistory));
    };
    document.getElementById('clearChat').onclick = ()=>{
      chatBox.innerHTML=''; chatHistory=[]; lastDay=null;
      localStorage.removeItem('liveChat');
    };
    document.getElementById('showHistory').onclick = ()=>{
      const modal=document.getElementById('chatHistoryModal');
      const list=document.getElementById('chatHistoryList');
      list.innerHTML = chatHistory.map((m,i)=>`
        <div class="history-item">
          <span><strong>${m.role==='user'?'You':'AI'}:</strong> ${m.text}</span>
          <div class="msg-ts">${new Date(m.iso).toLocaleString()}</div>
          <button class="delete-history" data-i="${i}">&times;</button>
        </div>`).join('');
      list.querySelectorAll('.delete-history').forEach(btn=>{
        btn.onclick=e=>{
          const i=+e.target.dataset.i;
          chatHistory.splice(i,1);
          localStorage.setItem('liveChat',JSON.stringify(chatHistory));
          e.target.closest('.history-item').remove();
        };
      });
      modal.hidden=false;
    };
    document.querySelector('#chatHistoryModal .close-modal').onclick = ()=>{
      document.getElementById('chatHistoryModal').hidden=true;
    };

  }); // DOMContentLoaded
})(); // IIFE
</script>
  
</body>
</html>
